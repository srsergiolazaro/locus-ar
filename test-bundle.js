var Ki=Object.create;var cs=Object.defineProperty;var Ji=Object.getOwnPropertyDescriptor;var Zi=Object.getOwnPropertyNames;var Qi=Object.getPrototypeOf,tr=Object.prototype.hasOwnProperty;var W=(r,t)=>()=>(r&&(t=r(r=0)),t);var Vt=(r,t)=>()=>(t||r((t={exports:{}}).exports,t),t.exports),ls=(r,t)=>{for(var s in t)cs(r,s,{get:t[s],enumerable:!0})},er=(r,t,s,e)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of Zi(t))!tr.call(r,n)&&n!==s&&cs(r,n,{get:()=>t[n],enumerable:!(e=Ji(t,n))||e.enumerable});return r};var sr=(r,t,s)=>(s=r!=null?Ki(Qi(r)):{},er(t||!r||!r.__esModule?cs(s,"default",{value:r,enumerable:!0}):s,r));var Y,At=W(()=>{"use strict";Y={VIEWPORT_WIDTH:640,VIEWPORT_HEIGHT:480,DEFAULT_FOVY:60,DEFAULT_NEAR:1,DEFAULT_FAR:1e4,MAX_FEATURES_PER_BUCKET:24,USE_LSH:!0,HAMMING_THRESHOLD:.85,HDC_RATIO_THRESHOLD:.85,INLIER_THRESHOLD:15,MIN_NUM_INLIERS:6,MAX_MATCH_QUERY_POINTS:800,CLUSTER_MAX_POP:25,TRACKER_TEMPLATE_SIZE:6,TRACKER_SEARCH_SIZE:12,TRACKER_SIMILARITY_THRESHOLD:.65,MIN_IMAGE_PIXEL_SIZE:32,SCALE_STEP_EXPONENT:1,TRACKING_DOWNSCALE_LEVEL_1:256,TRACKING_DOWNSCALE_LEVEL_2:128,WARMUP_TOLERANCE:2,MISS_TOLERANCE:1,ONE_EURO_FILTER_CUTOFF:.5,ONE_EURO_FILTER_BETA:.1,USE_COMPACT_DESCRIPTORS:!0,COMPACT_HAMMING_THRESHOLD:8}});var ir,rr,or,ar,cr,us,Me,fs=W(()=>{"use strict";ir=()=>null,rr=(r,t,s)=>{let e=new Float32Array(t*s);for(let n=1;n<s-1;n++){let i=n*t,o=(n-1)*t,a=(n+1)*t;for(let c=1;c<t-1;c++){let l=i+c,u=(r[o+c+1]-r[o+c-1]+r[i+c+1]-r[i+c-1]+r[a+c+1]-r[a+c-1])/768,h=(r[a+c-1]-r[o+c-1]+r[a+c]-r[o+c]+r[a+c+1]-r[o+c+1])/768;e[l]=Math.sqrt((u*u+h*h)/2)}}return e},or=(r,t,s)=>{let e=new Uint8Array(t*s);for(let n=1;n<s-1;n++){let i=n*t;for(let o=1;o<t-1;o++){let a=i+o,c=r[a];c>0&&c>=r[a-1]&&c>=r[a+1]&&c>=r[a-t]&&c>=r[a+t]&&(e[a]=1)}}return e},ar=(r,t,s)=>{let e=new Float32Array(t*s),n=new Float32Array(t*s),i=1/16,o=4/16,a=6/16,c=t-1,l=s-1;for(let u=0;u<s;u++){let h=u*t;for(let f=0;f<t;f++){let m=f<2?0:f-2,d=f<1?0:f-1,y=f>c-1?c:f+1,p=f>c-2?c:f+2;n[h+f]=r[h+m]*i+r[h+d]*o+r[h+f]*a+r[h+y]*o+r[h+p]*i}}for(let u=0;u<s;u++){let h=(u<2?0:u-2)*t,f=(u<1?0:u-1)*t,m=u*t,d=(u>l-1?l:u+1)*t,y=(u>l-2?l:u+2)*t;for(let p=0;p<t;p++)e[m+p]=n[h+p]*i+n[f+p]*o+n[m+p]*a+n[d+p]*o+n[y+p]*i}return e},cr=(r,t,s)=>{let e=Math.floor(t/2),n=Math.floor(s/2),i=new Float32Array(e*n);for(let o=0;o<n;o++){let a=o*2;for(let c=0;c<e;c++){let l=c*2,u=a*t+l;i[o*e+c]=(r[u]+r[u+1]+r[u+t]+r[u+t+1])/4}}return{data:i,width:e,height:n}},us=class{constructor(){this.gpu=null,this.kernelCache=new Map,this.initialized=!1}init(){this.initialized||(this.gpu=ir(),this.initialized=!0)}computeGradients(t,s,e){return this.init(),rr(t,s,e)}findLocalMaxima(t,s,e){return this.init(),or(t,s,e)}edgeDetection(t,s,e){let n=this.computeGradients(t,s,e),i=this.findLocalMaxima(n,s,e);return{dValue:n,isCandidate:i}}gaussianBlur(t,s,e){return this.init(),ar(t,s,e)}downsample(t,s,e){return this.init(),cr(t,s,e)}buildPyramid(t,s,e,n=5){this.init();let i=[],o=t instanceof Float32Array?t:Float32Array.from(t),a=s,c=e;for(let l=0;l<n;l++){let u=this.gaussianBlur(o,a,c);if(i.push({data:u,width:a,height:c,scale:Math.pow(2,l)}),a>8&&c>8){let h=this.downsample(u,a,c);o=h.data,a=h.width,c=h.height}else break}return i}isGPUAvailable(){return this.init(),this.gpu!==null}destroy(){this.kernelCache.clear(),this.gpu&&this.gpu.destroy&&this.gpu.destroy(),this.gpu=null,this.initialized=!1}},Me=new us});var be,yt,ms=W(()=>{"use strict";be=[{sigma:.55,points:[[-1,0],[-.5,-.866025],[.5,-.866025],[1,-0],[.5,.866025],[-.5,.866025]]},{sigma:.475,points:[[0,.930969],[-.806243,.465485],[-.806243,-.465485],[-0,-.930969],[.806243,-.465485],[.806243,.465485]]},{sigma:.4,points:[[.847306,-0],[.423653,.733789],[-.423653,.733789],[-.847306,0],[-.423653,-.733789],[.423653,-.733789]]},{sigma:.325,points:[[-0,-.741094],[.641806,-.370547],[.641806,.370547],[0,.741094],[-.641806,.370547],[-.641806,-.370547]]},{sigma:.25,points:[[-.595502,0],[-.297751,-.51572],[.297751,-.51572],[.595502,-0],[.297751,.51572],[-.297751,.51572]]},{sigma:.175,points:[[0,.362783],[-.314179,.181391],[-.314179,-.181391],[-0,-.362783],[.314179,-.181391],[.314179,.181391]]},{sigma:.1,points:[[0,0]]}],yt=[];for(let r=0;r<be.length;r++){let t=be[r].sigma;for(let s=0;s<be[r].points.length;s++){let e=be[r].points[s];yt.push([t,e[0],e[1]])}}});function pn(r){let t=new Uint32Array(2);for(let s=0;s<64;s++){let e=Se[s*2],n=Se[s*2+1];if(r[e]<r[n]){let i=s>>5,o=s&31;t[i]|=1<<o}}return t}function wn(r){let t=new Uint8Array(84),s=0,e=0;for(let n=0;n<yt.length;n++)for(let i=n+1;i<yt.length;i++)r[n]<r[i]&&(t[e]|=1<<7-s),s++,s===8&&(e++,s=0);return t}function yn(r){let t=new Uint8Array(8),s=new DataView(t.buffer);return s.setUint32(0,r[0],!0),s.setUint32(4,r[1],!0),t}var Se,gn,mn,Ht,xn=W(()=>{"use strict";ms();Se=new Int32Array(128),gn=new Int32Array(64);for(let r=0;r<64;r++)gn[r]=Math.floor(r*(672/64));mn=0,Ht=0;for(let r=0;r<yt.length;r++)for(let t=r+1;t<yt.length;t++)Ht<64&&mn===gn[Ht]&&(Se[Ht*2]=r,Se[Ht*2+1]=t,Ht++),mn++});function Mn(r){let t=r.length,s=0,e=0;for(;e<t;){let n=r.charCodeAt(e++);if((n&4294967168)===0){s++;continue}else if((n&4294965248)===0)s+=2;else{if(n>=55296&&n<=56319&&e<t){let i=r.charCodeAt(e);(i&64512)===56320&&(++e,n=((n&1023)<<10)+(i&1023)+65536)}(n&4294901760)===0?s+=3:s+=4}}return s}function dr(r,t,s){let e=r.length,n=s,i=0;for(;i<e;){let o=r.charCodeAt(i++);if((o&4294967168)===0){t[n++]=o;continue}else if((o&4294965248)===0)t[n++]=o>>6&31|192;else{if(o>=55296&&o<=56319&&i<e){let a=r.charCodeAt(i);(a&64512)===56320&&(++i,o=((o&1023)<<10)+(a&1023)+65536)}(o&4294901760)===0?(t[n++]=o>>12&15|224,t[n++]=o>>6&63|128):(t[n++]=o>>18&7|240,t[n++]=o>>12&63|128,t[n++]=o>>6&63|128)}t[n++]=o&63|128}}function pr(r,t,s){mr.encodeInto(r,t.subarray(s))}function bn(r,t,s){r.length>gr?pr(r,t,s):dr(r,t,s)}function gs(r,t,s){let e=t,n=e+s,i=[],o="";for(;e<n;){let a=r[e++];if((a&128)===0)i.push(a);else if((a&224)===192){let c=r[e++]&63;i.push((a&31)<<6|c)}else if((a&240)===224){let c=r[e++]&63,l=r[e++]&63;i.push((a&31)<<12|c<<6|l)}else if((a&248)===240){let c=r[e++]&63,l=r[e++]&63,u=r[e++]&63,h=(a&7)<<18|c<<12|l<<6|u;h>65535&&(h-=65536,i.push(h>>>10&1023|55296),h=56320|h&1023),i.push(h)}else i.push(a);i.length>=wr&&(o+=String.fromCharCode(...i),i.length=0)}return i.length>0&&(o+=String.fromCharCode(...i)),o}function Mr(r,t,s){let e=r.subarray(t,t+s);return yr.decode(e)}function Sn(r,t,s){return s>xr?Mr(r,t,s):gs(r,t,s)}var mr,gr,wr,yr,xr,Ee=W(()=>{mr=new TextEncoder,gr=50;wr=4096;yr=new TextDecoder,xr=200});var It,En=W(()=>{It=class{type;data;constructor(t,s){this.type=t,this.data=s}}});var at,ps=W(()=>{at=class r extends Error{constructor(t){super(t);let s=Object.create(r.prototype);Object.setPrototypeOf(this,s),Object.defineProperty(this,"name",{configurable:!0,enumerable:!1,value:r.name})}}});function kn(r,t,s){let e=s/4294967296,n=s;r.setUint32(t,e),r.setUint32(t+4,n)}function ke(r,t,s){let e=Math.floor(s/4294967296),n=s;r.setUint32(t,e),r.setUint32(t+4,n)}function Ie(r,t){let s=r.getInt32(t),e=r.getUint32(t+4);return s*4294967296+e}function In(r,t){let s=r.getUint32(t),e=r.getUint32(t+4);return s*4294967296+e}var ve=W(()=>{});function kr({sec:r,nsec:t}){if(r>=0&&t>=0&&r<=Er)if(t===0&&r<=Sr){let s=new Uint8Array(4);return new DataView(s.buffer).setUint32(0,r),s}else{let s=r/4294967296,e=r&4294967295,n=new Uint8Array(8),i=new DataView(n.buffer);return i.setUint32(0,t<<2|s&3),i.setUint32(4,e),n}else{let s=new Uint8Array(12),e=new DataView(s.buffer);return e.setUint32(0,t),ke(e,4,r),s}}function Ir(r){let t=r.getTime(),s=Math.floor(t/1e3),e=(t-s*1e3)*1e6,n=Math.floor(e/1e9);return{sec:s+n,nsec:e-n*1e9}}function vr(r){if(r instanceof Date){let t=Ir(r);return kr(t)}else return null}function Tr(r){let t=new DataView(r.buffer,r.byteOffset,r.byteLength);switch(r.byteLength){case 4:return{sec:t.getUint32(0),nsec:0};case 8:{let s=t.getUint32(0),e=t.getUint32(4),n=(s&3)*4294967296+e,i=s>>>2;return{sec:n,nsec:i}}case 12:{let s=Ie(t,4),e=t.getUint32(0);return{sec:s,nsec:e}}default:throw new at(`Unrecognized data size for timestamp (expected 4, 8, or 12): ${r.length}`)}}function _r(r){let t=Tr(r);return new Date(t.sec*1e3+t.nsec/1e6)}var br,Sr,Er,vn,Tn=W(()=>{ps();ve();br=-1,Sr=4294967296-1,Er=17179869184-1;vn={type:br,encode:vr,decode:_r}});var Rt,ws=W(()=>{En();Tn();Rt=class r{static defaultCodec=new r;__brand;builtInEncoders=[];builtInDecoders=[];encoders=[];decoders=[];constructor(){this.register(vn)}register({type:t,encode:s,decode:e}){if(t>=0)this.encoders[t]=s,this.decoders[t]=e;else{let n=-1-t;this.builtInEncoders[n]=s,this.builtInDecoders[n]=e}}tryToEncode(t,s){for(let e=0;e<this.builtInEncoders.length;e++){let n=this.builtInEncoders[e];if(n!=null){let i=n(t,s);if(i!=null){let o=-1-e;return new It(o,i)}}}for(let e=0;e<this.encoders.length;e++){let n=this.encoders[e];if(n!=null){let i=n(t,s);if(i!=null){let o=e;return new It(o,i)}}}return t instanceof It?t:null}decode(t,s,e){let n=s<0?this.builtInDecoders[-1-s]:this.decoders[s];return n?n(t,s,e):new It(s,t)}}});function Cr(r){return r instanceof ArrayBuffer||typeof SharedArrayBuffer<"u"&&r instanceof SharedArrayBuffer}function Xt(r){return r instanceof Uint8Array?r:ArrayBuffer.isView(r)?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):Cr(r)?new Uint8Array(r):Uint8Array.from(r)}var ys=W(()=>{});var Ar,Rr,Te,_n=W(()=>{Ee();ws();ve();ys();Ar=100,Rr=2048,Te=class r{extensionCodec;context;useBigInt64;maxDepth;initialBufferSize;sortKeys;forceFloat32;ignoreUndefined;forceIntegerToFloat;pos;view;bytes;entered=!1;constructor(t){this.extensionCodec=t?.extensionCodec??Rt.defaultCodec,this.context=t?.context,this.useBigInt64=t?.useBigInt64??!1,this.maxDepth=t?.maxDepth??Ar,this.initialBufferSize=t?.initialBufferSize??Rr,this.sortKeys=t?.sortKeys??!1,this.forceFloat32=t?.forceFloat32??!1,this.ignoreUndefined=t?.ignoreUndefined??!1,this.forceIntegerToFloat=t?.forceIntegerToFloat??!1,this.pos=0,this.view=new DataView(new ArrayBuffer(this.initialBufferSize)),this.bytes=new Uint8Array(this.view.buffer)}clone(){return new r({extensionCodec:this.extensionCodec,context:this.context,useBigInt64:this.useBigInt64,maxDepth:this.maxDepth,initialBufferSize:this.initialBufferSize,sortKeys:this.sortKeys,forceFloat32:this.forceFloat32,ignoreUndefined:this.ignoreUndefined,forceIntegerToFloat:this.forceIntegerToFloat})}reinitializeState(){this.pos=0}encodeSharedRef(t){if(this.entered)return this.clone().encodeSharedRef(t);try{return this.entered=!0,this.reinitializeState(),this.doEncode(t,1),this.bytes.subarray(0,this.pos)}finally{this.entered=!1}}encode(t){if(this.entered)return this.clone().encode(t);try{return this.entered=!0,this.reinitializeState(),this.doEncode(t,1),this.bytes.slice(0,this.pos)}finally{this.entered=!1}}doEncode(t,s){if(s>this.maxDepth)throw new Error(`Too deep objects in depth ${s}`);t==null?this.encodeNil():typeof t=="boolean"?this.encodeBoolean(t):typeof t=="number"?this.forceIntegerToFloat?this.encodeNumberAsFloat(t):this.encodeNumber(t):typeof t=="string"?this.encodeString(t):this.useBigInt64&&typeof t=="bigint"?this.encodeBigInt64(t):this.encodeObject(t,s)}ensureBufferSizeToWrite(t){let s=this.pos+t;this.view.byteLength<s&&this.resizeBuffer(s*2)}resizeBuffer(t){let s=new ArrayBuffer(t),e=new Uint8Array(s),n=new DataView(s);e.set(this.bytes),this.view=n,this.bytes=e}encodeNil(){this.writeU8(192)}encodeBoolean(t){t===!1?this.writeU8(194):this.writeU8(195)}encodeNumber(t){!this.forceIntegerToFloat&&Number.isSafeInteger(t)?t>=0?t<128?this.writeU8(t):t<256?(this.writeU8(204),this.writeU8(t)):t<65536?(this.writeU8(205),this.writeU16(t)):t<4294967296?(this.writeU8(206),this.writeU32(t)):this.useBigInt64?this.encodeNumberAsFloat(t):(this.writeU8(207),this.writeU64(t)):t>=-32?this.writeU8(224|t+32):t>=-128?(this.writeU8(208),this.writeI8(t)):t>=-32768?(this.writeU8(209),this.writeI16(t)):t>=-2147483648?(this.writeU8(210),this.writeI32(t)):this.useBigInt64?this.encodeNumberAsFloat(t):(this.writeU8(211),this.writeI64(t)):this.encodeNumberAsFloat(t)}encodeNumberAsFloat(t){this.forceFloat32?(this.writeU8(202),this.writeF32(t)):(this.writeU8(203),this.writeF64(t))}encodeBigInt64(t){t>=BigInt(0)?(this.writeU8(207),this.writeBigUint64(t)):(this.writeU8(211),this.writeBigInt64(t))}writeStringHeader(t){if(t<32)this.writeU8(160+t);else if(t<256)this.writeU8(217),this.writeU8(t);else if(t<65536)this.writeU8(218),this.writeU16(t);else if(t<4294967296)this.writeU8(219),this.writeU32(t);else throw new Error(`Too long string: ${t} bytes in UTF-8`)}encodeString(t){let e=Mn(t);this.ensureBufferSizeToWrite(5+e),this.writeStringHeader(e),bn(t,this.bytes,this.pos),this.pos+=e}encodeObject(t,s){let e=this.extensionCodec.tryToEncode(t,this.context);if(e!=null)this.encodeExtension(e);else if(Array.isArray(t))this.encodeArray(t,s);else if(ArrayBuffer.isView(t))this.encodeBinary(t);else if(typeof t=="object")this.encodeMap(t,s);else throw new Error(`Unrecognized object: ${Object.prototype.toString.apply(t)}`)}encodeBinary(t){let s=t.byteLength;if(s<256)this.writeU8(196),this.writeU8(s);else if(s<65536)this.writeU8(197),this.writeU16(s);else if(s<4294967296)this.writeU8(198),this.writeU32(s);else throw new Error(`Too large binary: ${s}`);let e=Xt(t);this.writeU8a(e)}encodeArray(t,s){let e=t.length;if(e<16)this.writeU8(144+e);else if(e<65536)this.writeU8(220),this.writeU16(e);else if(e<4294967296)this.writeU8(221),this.writeU32(e);else throw new Error(`Too large array: ${e}`);for(let n of t)this.doEncode(n,s+1)}countWithoutUndefined(t,s){let e=0;for(let n of s)t[n]!==void 0&&e++;return e}encodeMap(t,s){let e=Object.keys(t);this.sortKeys&&e.sort();let n=this.ignoreUndefined?this.countWithoutUndefined(t,e):e.length;if(n<16)this.writeU8(128+n);else if(n<65536)this.writeU8(222),this.writeU16(n);else if(n<4294967296)this.writeU8(223),this.writeU32(n);else throw new Error(`Too large map object: ${n}`);for(let i of e){let o=t[i];this.ignoreUndefined&&o===void 0||(this.encodeString(i),this.doEncode(o,s+1))}}encodeExtension(t){if(typeof t.data=="function"){let e=t.data(this.pos+6),n=e.length;if(n>=4294967296)throw new Error(`Too large extension object: ${n}`);this.writeU8(201),this.writeU32(n),this.writeI8(t.type),this.writeU8a(e);return}let s=t.data.length;if(s===1)this.writeU8(212);else if(s===2)this.writeU8(213);else if(s===4)this.writeU8(214);else if(s===8)this.writeU8(215);else if(s===16)this.writeU8(216);else if(s<256)this.writeU8(199),this.writeU8(s);else if(s<65536)this.writeU8(200),this.writeU16(s);else if(s<4294967296)this.writeU8(201),this.writeU32(s);else throw new Error(`Too large extension object: ${s}`);this.writeI8(t.type),this.writeU8a(t.data)}writeU8(t){this.ensureBufferSizeToWrite(1),this.view.setUint8(this.pos,t),this.pos++}writeU8a(t){let s=t.length;this.ensureBufferSizeToWrite(s),this.bytes.set(t,this.pos),this.pos+=s}writeI8(t){this.ensureBufferSizeToWrite(1),this.view.setInt8(this.pos,t),this.pos++}writeU16(t){this.ensureBufferSizeToWrite(2),this.view.setUint16(this.pos,t),this.pos+=2}writeI16(t){this.ensureBufferSizeToWrite(2),this.view.setInt16(this.pos,t),this.pos+=2}writeU32(t){this.ensureBufferSizeToWrite(4),this.view.setUint32(this.pos,t),this.pos+=4}writeI32(t){this.ensureBufferSizeToWrite(4),this.view.setInt32(this.pos,t),this.pos+=4}writeF32(t){this.ensureBufferSizeToWrite(4),this.view.setFloat32(this.pos,t),this.pos+=4}writeF64(t){this.ensureBufferSizeToWrite(8),this.view.setFloat64(this.pos,t),this.pos+=8}writeU64(t){this.ensureBufferSizeToWrite(8),kn(this.view,this.pos,t),this.pos+=8}writeI64(t){this.ensureBufferSizeToWrite(8),ke(this.view,this.pos,t),this.pos+=8}writeBigUint64(t){this.ensureBufferSizeToWrite(8),this.view.setBigUint64(this.pos,t),this.pos+=8}writeBigInt64(t){this.ensureBufferSizeToWrite(8),this.view.setBigInt64(this.pos,t),this.pos+=8}}});function xs(r,t){return new Te(t).encodeSharedRef(r)}var Cn=W(()=>{_n()});function _e(r){return`${r<0?"-":""}0x${Math.abs(r).toString(16).padStart(2,"0")}`}var An=W(()=>{});var Ur,Fr,Ce,Rn=W(()=>{Ee();Ur=16,Fr=16,Ce=class{hit=0;miss=0;caches;maxKeyLength;maxLengthPerKey;constructor(t=Ur,s=Fr){this.maxKeyLength=t,this.maxLengthPerKey=s,this.caches=[];for(let e=0;e<this.maxKeyLength;e++)this.caches.push([])}canBeCached(t){return t>0&&t<=this.maxKeyLength}find(t,s,e){let n=this.caches[e-1];t:for(let i of n){let o=i.bytes;for(let a=0;a<e;a++)if(o[a]!==t[s+a])continue t;return i.str}return null}store(t,s){let e=this.caches[t.length-1],n={bytes:t,str:s};e.length>=this.maxLengthPerKey?e[Math.random()*e.length|0]=n:e.push(n)}decode(t,s,e){let n=this.find(t,s,e);if(n!=null)return this.hit++,n;this.miss++;let i=gs(t,s,e),o=Uint8Array.prototype.slice.call(t,s,s+e);return this.store(o,i),i}}});var Ms,$t,Fn,Dr,bs,Yt,Ss,Or,Un,Pr,Ae,Dn=W(()=>{An();ws();ve();Ee();ys();Rn();ps();Ms="array",$t="map_key",Fn="map_value",Dr=r=>{if(typeof r=="string"||typeof r=="number")return r;throw new at("The type of key must be string or number but "+typeof r)},bs=class{stack=[];stackHeadPosition=-1;get length(){return this.stackHeadPosition+1}top(){return this.stack[this.stackHeadPosition]}pushArrayState(t){let s=this.getUninitializedStateFromPool();s.type=Ms,s.position=0,s.size=t,s.array=new Array(t)}pushMapState(t){let s=this.getUninitializedStateFromPool();s.type=$t,s.readCount=0,s.size=t,s.map={}}getUninitializedStateFromPool(){if(this.stackHeadPosition++,this.stackHeadPosition===this.stack.length){let t={type:void 0,size:0,array:void 0,position:0,readCount:0,map:void 0,key:null};this.stack.push(t)}return this.stack[this.stackHeadPosition]}release(t){if(this.stack[this.stackHeadPosition]!==t)throw new Error("Invalid stack state. Released state is not on top of the stack.");if(t.type===Ms){let e=t;e.size=0,e.array=void 0,e.position=0,e.type=void 0}if(t.type===$t||t.type===Fn){let e=t;e.size=0,e.map=void 0,e.readCount=0,e.type=void 0}this.stackHeadPosition--}reset(){this.stack.length=0,this.stackHeadPosition=-1}},Yt=-1,Ss=new DataView(new ArrayBuffer(0)),Or=new Uint8Array(Ss.buffer);try{Ss.getInt8(0)}catch(r){if(!(r instanceof RangeError))throw new Error("This module is not supported in the current JavaScript engine because DataView does not throw RangeError on out-of-bounds access")}Un=new RangeError("Insufficient data"),Pr=new Ce,Ae=class r{extensionCodec;context;useBigInt64;rawStrings;maxStrLength;maxBinLength;maxArrayLength;maxMapLength;maxExtLength;keyDecoder;mapKeyConverter;totalPos=0;pos=0;view=Ss;bytes=Or;headByte=Yt;stack=new bs;entered=!1;constructor(t){this.extensionCodec=t?.extensionCodec??Rt.defaultCodec,this.context=t?.context,this.useBigInt64=t?.useBigInt64??!1,this.rawStrings=t?.rawStrings??!1,this.maxStrLength=t?.maxStrLength??4294967295,this.maxBinLength=t?.maxBinLength??4294967295,this.maxArrayLength=t?.maxArrayLength??4294967295,this.maxMapLength=t?.maxMapLength??4294967295,this.maxExtLength=t?.maxExtLength??4294967295,this.keyDecoder=t?.keyDecoder!==void 0?t.keyDecoder:Pr,this.mapKeyConverter=t?.mapKeyConverter??Dr}clone(){return new r({extensionCodec:this.extensionCodec,context:this.context,useBigInt64:this.useBigInt64,rawStrings:this.rawStrings,maxStrLength:this.maxStrLength,maxBinLength:this.maxBinLength,maxArrayLength:this.maxArrayLength,maxMapLength:this.maxMapLength,maxExtLength:this.maxExtLength,keyDecoder:this.keyDecoder})}reinitializeState(){this.totalPos=0,this.headByte=Yt,this.stack.reset()}setBuffer(t){let s=Xt(t);this.bytes=s,this.view=new DataView(s.buffer,s.byteOffset,s.byteLength),this.pos=0}appendBuffer(t){if(this.headByte===Yt&&!this.hasRemaining(1))this.setBuffer(t);else{let s=this.bytes.subarray(this.pos),e=Xt(t),n=new Uint8Array(s.length+e.length);n.set(s),n.set(e,s.length),this.setBuffer(n)}}hasRemaining(t){return this.view.byteLength-this.pos>=t}createExtraByteError(t){let{view:s,pos:e}=this;return new RangeError(`Extra ${s.byteLength-e} of ${s.byteLength} byte(s) found at buffer[${t}]`)}decode(t){if(this.entered)return this.clone().decode(t);try{this.entered=!0,this.reinitializeState(),this.setBuffer(t);let s=this.doDecodeSync();if(this.hasRemaining(1))throw this.createExtraByteError(this.pos);return s}finally{this.entered=!1}}*decodeMulti(t){if(this.entered){yield*this.clone().decodeMulti(t);return}try{for(this.entered=!0,this.reinitializeState(),this.setBuffer(t);this.hasRemaining(1);)yield this.doDecodeSync()}finally{this.entered=!1}}async decodeAsync(t){if(this.entered)return this.clone().decodeAsync(t);try{this.entered=!0;let s=!1,e;for await(let a of t){if(s)throw this.entered=!1,this.createExtraByteError(this.totalPos);this.appendBuffer(a);try{e=this.doDecodeSync(),s=!0}catch(c){if(!(c instanceof RangeError))throw c}this.totalPos+=this.pos}if(s){if(this.hasRemaining(1))throw this.createExtraByteError(this.totalPos);return e}let{headByte:n,pos:i,totalPos:o}=this;throw new RangeError(`Insufficient data in parsing ${_e(n)} at ${o} (${i} in the current buffer)`)}finally{this.entered=!1}}decodeArrayStream(t){return this.decodeMultiAsync(t,!0)}decodeStream(t){return this.decodeMultiAsync(t,!1)}async*decodeMultiAsync(t,s){if(this.entered){yield*this.clone().decodeMultiAsync(t,s);return}try{this.entered=!0;let e=s,n=-1;for await(let i of t){if(s&&n===0)throw this.createExtraByteError(this.totalPos);this.appendBuffer(i),e&&(n=this.readArraySize(),e=!1,this.complete());try{for(;yield this.doDecodeSync(),--n!==0;);}catch(o){if(!(o instanceof RangeError))throw o}this.totalPos+=this.pos}}finally{this.entered=!1}}doDecodeSync(){t:for(;;){let t=this.readHeadByte(),s;if(t>=224)s=t-256;else if(t<192)if(t<128)s=t;else if(t<144){let n=t-128;if(n!==0){this.pushMapState(n),this.complete();continue t}else s={}}else if(t<160){let n=t-144;if(n!==0){this.pushArrayState(n),this.complete();continue t}else s=[]}else{let n=t-160;s=this.decodeString(n,0)}else if(t===192)s=null;else if(t===194)s=!1;else if(t===195)s=!0;else if(t===202)s=this.readF32();else if(t===203)s=this.readF64();else if(t===204)s=this.readU8();else if(t===205)s=this.readU16();else if(t===206)s=this.readU32();else if(t===207)this.useBigInt64?s=this.readU64AsBigInt():s=this.readU64();else if(t===208)s=this.readI8();else if(t===209)s=this.readI16();else if(t===210)s=this.readI32();else if(t===211)this.useBigInt64?s=this.readI64AsBigInt():s=this.readI64();else if(t===217){let n=this.lookU8();s=this.decodeString(n,1)}else if(t===218){let n=this.lookU16();s=this.decodeString(n,2)}else if(t===219){let n=this.lookU32();s=this.decodeString(n,4)}else if(t===220){let n=this.readU16();if(n!==0){this.pushArrayState(n),this.complete();continue t}else s=[]}else if(t===221){let n=this.readU32();if(n!==0){this.pushArrayState(n),this.complete();continue t}else s=[]}else if(t===222){let n=this.readU16();if(n!==0){this.pushMapState(n),this.complete();continue t}else s={}}else if(t===223){let n=this.readU32();if(n!==0){this.pushMapState(n),this.complete();continue t}else s={}}else if(t===196){let n=this.lookU8();s=this.decodeBinary(n,1)}else if(t===197){let n=this.lookU16();s=this.decodeBinary(n,2)}else if(t===198){let n=this.lookU32();s=this.decodeBinary(n,4)}else if(t===212)s=this.decodeExtension(1,0);else if(t===213)s=this.decodeExtension(2,0);else if(t===214)s=this.decodeExtension(4,0);else if(t===215)s=this.decodeExtension(8,0);else if(t===216)s=this.decodeExtension(16,0);else if(t===199){let n=this.lookU8();s=this.decodeExtension(n,1)}else if(t===200){let n=this.lookU16();s=this.decodeExtension(n,2)}else if(t===201){let n=this.lookU32();s=this.decodeExtension(n,4)}else throw new at(`Unrecognized type byte: ${_e(t)}`);this.complete();let e=this.stack;for(;e.length>0;){let n=e.top();if(n.type===Ms)if(n.array[n.position]=s,n.position++,n.position===n.size)s=n.array,e.release(n);else continue t;else if(n.type===$t){if(s==="__proto__")throw new at("The key __proto__ is not allowed");n.key=this.mapKeyConverter(s),n.type=Fn;continue t}else if(n.map[n.key]=s,n.readCount++,n.readCount===n.size)s=n.map,e.release(n);else{n.key=null,n.type=$t;continue t}}return s}}readHeadByte(){return this.headByte===Yt&&(this.headByte=this.readU8()),this.headByte}complete(){this.headByte=Yt}readArraySize(){let t=this.readHeadByte();switch(t){case 220:return this.readU16();case 221:return this.readU32();default:{if(t<160)return t-144;throw new at(`Unrecognized array type byte: ${_e(t)}`)}}}pushMapState(t){if(t>this.maxMapLength)throw new at(`Max length exceeded: map length (${t}) > maxMapLengthLength (${this.maxMapLength})`);this.stack.pushMapState(t)}pushArrayState(t){if(t>this.maxArrayLength)throw new at(`Max length exceeded: array length (${t}) > maxArrayLength (${this.maxArrayLength})`);this.stack.pushArrayState(t)}decodeString(t,s){return!this.rawStrings||this.stateIsMapKey()?this.decodeUtf8String(t,s):this.decodeBinary(t,s)}decodeUtf8String(t,s){if(t>this.maxStrLength)throw new at(`Max length exceeded: UTF-8 byte length (${t}) > maxStrLength (${this.maxStrLength})`);if(this.bytes.byteLength<this.pos+s+t)throw Un;let e=this.pos+s,n;return this.stateIsMapKey()&&this.keyDecoder?.canBeCached(t)?n=this.keyDecoder.decode(this.bytes,e,t):n=Sn(this.bytes,e,t),this.pos+=s+t,n}stateIsMapKey(){return this.stack.length>0?this.stack.top().type===$t:!1}decodeBinary(t,s){if(t>this.maxBinLength)throw new at(`Max length exceeded: bin length (${t}) > maxBinLength (${this.maxBinLength})`);if(!this.hasRemaining(t+s))throw Un;let e=this.pos+s,n=this.bytes.subarray(e,e+t);return this.pos+=s+t,n}decodeExtension(t,s){if(t>this.maxExtLength)throw new at(`Max length exceeded: ext length (${t}) > maxExtLength (${this.maxExtLength})`);let e=this.view.getInt8(this.pos+s),n=this.decodeBinary(t,s+1);return this.extensionCodec.decode(n,e,this.context)}lookU8(){return this.view.getUint8(this.pos)}lookU16(){return this.view.getUint16(this.pos)}lookU32(){return this.view.getUint32(this.pos)}readU8(){let t=this.view.getUint8(this.pos);return this.pos++,t}readI8(){let t=this.view.getInt8(this.pos);return this.pos++,t}readU16(){let t=this.view.getUint16(this.pos);return this.pos+=2,t}readI16(){let t=this.view.getInt16(this.pos);return this.pos+=2,t}readU32(){let t=this.view.getUint32(this.pos);return this.pos+=4,t}readI32(){let t=this.view.getInt32(this.pos);return this.pos+=4,t}readU64(){let t=In(this.view,this.pos);return this.pos+=8,t}readI64(){let t=Ie(this.view,this.pos);return this.pos+=8,t}readU64AsBigInt(){let t=this.view.getBigUint64(this.pos);return this.pos+=8,t}readI64AsBigInt(){let t=this.view.getBigInt64(this.pos);return this.pos+=8,t}readF32(){let t=this.view.getFloat32(this.pos);return this.pos+=4,t}readF64(){let t=this.view.getFloat64(this.pos);return this.pos+=8,t}}});function Es(r,t){return new Ae(t).decode(r)}var On=W(()=>{Dn()});var Pn=W(()=>{Cn();On()});var Fe={};ls(Fe,{CURRENT_VERSION:()=>Re,HDC_SEED:()=>ks,columnarize:()=>Is,columnarizeCompact:()=>vs,compactTree:()=>Ue,decodeTaar:()=>Kt,encodeTaar:()=>Ts,expandTree:()=>Bn,getMorton:()=>Br,pack4Bit:()=>Nr,unpack4Bit:()=>Ln});function Br(r,t){let s=r|0,e=t|0;return s=(s|s<<8)&16711935,s=(s|s<<4)&252645135,s=(s|s<<2)&858993459,s=(s|s<<1)&1431655765,e=(e|e<<8)&16711935,e=(e|e<<4)&252645135,e=(e|e<<2)&858993459,e=(e|e<<1)&1431655765,s|e<<1}function Nr(r){let t=r.length;if(t%2!==0)return r;let s=new Uint8Array(t/2);for(let e=0;e<t;e+=2){let n=(r[e]&240)>>4,i=(r[e+1]&240)>>4;s[e/2]=n<<4|i}return s}function Ln(r,t,s){let e=t*s,n=new Uint8Array(e);for(let i=0;i<r.length;i++){let o=r[i],a=o&240,c=(o&15)<<4;n[i*2]=a,n[i*2+1]=c}return n}function Is(r,t,s,e,n=!1){let i=r.length,o=new Uint16Array(i),a=new Uint16Array(i),c=new Int16Array(i),l=new Uint8Array(i),u;n?u=new Uint32Array(i):u=new Uint32Array(i*2);for(let h=0;h<i;h++)o[h]=Math.round(r[h].x/s*65535),a[h]=Math.round(r[h].y/e*65535),c[h]=Math.round(r[h].angle/Math.PI*32767),l[h]=Math.round(Math.log2(r[h].scale||1)),r[h].descriptors&&r[h].descriptors.length>=2&&(n?u[h]=r[h].hdcSignature||0:(u[h*2]=r[h].descriptors[0],u[h*2+1]=r[h].descriptors[1]));return{x:o,y:a,a:c,s:l,d:u,hdc:n?1:0,t:Ue(t.rootNode)}}function vs(r,t,s,e){let n=r.length,i=new Uint16Array(n),o=new Uint16Array(n),a=new Int16Array(n),c=new Uint8Array(n),l=new Uint32Array(n);for(let u=0;u<n;u++)i[u]=Math.round(r[u].x/s*65535),o[u]=Math.round(r[u].y/e*65535),a[u]=Math.round(r[u].angle/Math.PI*32767),c[u]=Math.round(Math.log2(r[u].scale||1)),r[u].descriptors&&r[u].descriptors.length>=2&&(l[u]=(r[u].descriptors[0]^r[u].descriptors[1])>>>0);return{x:i,y:o,a,s:c,d:l,compact:1,t:Ue(t.rootNode)}}function Ue(r){return r.leaf?[1,r.centerPointIndex||0,r.pointIndexes]:[0,r.centerPointIndex||0,r.children.map(t=>Ue(t))]}function Bn(r){return r[0]===1?{leaf:!0,centerPointIndex:r[1],pointIndexes:r[2]}:{leaf:!1,centerPointIndex:r[1],children:r[2].map(s=>Bn(s))}}function Kt(r){let t=Es(new Uint8Array(r)),s=t.v||0;(s<5||s>Re)&&console.warn(`Potential incompatible .taar version: ${s}. Standard is ${Re}.`);let e=t.dataList;for(let n=0;n<e.length;n++){let i=e[n];for(let o of i.trackingData){let a=(h,f)=>h instanceof Uint8Array&&f!==Uint8Array?new f(h.buffer.slice(h.byteOffset,h.byteOffset+h.byteLength)):h;o.px=a(o.px,Float32Array),o.py=a(o.py,Float32Array);let c=o.data||o.d,l=o.width||o.w,u=o.height||o.h;if(c&&c.length===l*u/2){let h=Ln(c,l,u);o.data&&(o.data=h),o.d&&(o.d=h)}o.mesh&&(o.mesh.t=a(o.mesh.t,Uint16Array),o.mesh.e=a(o.mesh.e,Uint16Array),o.mesh.rl=a(o.mesh.rl,Float32Array))}for(let o of i.matchingData)for(let a of[o.max,o.min]){if(!a)continue;let c=a.x,l=a.y;c instanceof Uint8Array&&(c=new Uint16Array(c.buffer.slice(c.byteOffset,c.byteOffset+c.byteLength))),l instanceof Uint8Array&&(l=new Uint16Array(l.buffer.slice(l.byteOffset,l.byteOffset+l.byteLength)));let u=c.length,h=new Float32Array(u),f=new Float32Array(u);for(let m=0;m<u;m++)h[m]=c[m]/65535*o.w,f[m]=l[m]/65535*o.h;if(a.x=h,a.y=f,a.a instanceof Uint8Array){let m=new Int16Array(a.a.buffer.slice(a.a.byteOffset,a.a.byteOffset+a.a.byteLength)),d=new Float32Array(u);for(let y=0;y<u;y++)d[y]=m[y]/32767*Math.PI;a.a=d}if(a.s instanceof Uint8Array){let m=a.s,d=new Float32Array(u);for(let y=0;y<u;y++)d[y]=Math.pow(2,m[y]);a.s=d}a.d instanceof Uint8Array&&(a.hdc===1?a.d=new Uint32Array(a.d.buffer.slice(a.d.byteOffset,a.d.byteOffset+a.d.byteLength)):a.d=new Uint32Array(a.d.buffer.slice(a.d.byteOffset,a.d.byteOffset+a.d.byteLength)))}}return{version:s,dataList:e}}function Ts(r){return xs({v:Re,dataList:r})}var Re,ks,Ut=W(()=>{"use strict";Pn();Re=11,ks=322420463});var Nn,jr,zr,Jt,jn,qr,xt,Zt=W(()=>{"use strict";ms();fs();xn();Ut();Nn=4,jr=15,zr=12,Jt=36,jn=7,qr=!0,xt=class{constructor(t,s,e={}){this.width=t,this.height=s,this.useGPU=e.useGPU!==void 0?e.useGPU:qr,this.useLSH=e.useLSH!==void 0?e.useLSH:!0,this.useHDC=e.useHDC!==void 0?e.useHDC:!0,this.maxFeaturesPerBucket=e.maxFeaturesPerBucket!==void 0?e.maxFeaturesPerBucket:zr;let n=0,i=t,o=s;for(;i>=Nn&&o>=Nn&&(i=Math.floor(i/2),o=Math.floor(o/2),n++,n!==10););this.numOctaves=e.maxOctaves!==void 0?Math.min(n,e.maxOctaves):n}detect(t,s={}){let e=s.octavesToProcess||Array.from({length:this.numOctaves},(u,h)=>h),n;if(t instanceof Float32Array)n=t;else{n=new Float32Array(t.length);for(let u=0;u<t.length;u++)n[u]=t[u]}let i=this._buildGaussianPyramid(n,this.width,this.height,e),o=this._buildDogPyramid(i,e),a=this._findExtremas(o,i),c=this._applyPrune(a);return this._computeOrientations(c,i),this._computeFreakDescriptors(c,i),{featurePoints:c.map(u=>{let h=Math.pow(2,u.octave);return{maxima:u.score>0,x:u.x*h+h*.5-.5,y:u.y*h+h*.5-.5,scale:h,angle:u.angle||0,score:u.absScore,descriptors:this.useLSH&&u.lsh?u.lsh:u.descriptors||[],imageData:n}}),pyramid:i}}_buildGaussianPyramid(t,s,e,n=null){if(this.useGPU)try{let l=Me.buildPyramid(t,s,e,this.numOctaves),u=[];for(let h=0;h<l.length&&h<this.numOctaves;h++){if(n&&!n.includes(h)){u.push(null);continue}let f=l[h],m=this._applyGaussianFilter(f.data,f.width,f.height);u.push([{data:f.data,width:f.width,height:f.height},{data:m.data,width:f.width,height:f.height}])}return u}catch(l){console.warn("GPU pyramid failed, falling back to CPU:",l.message)}(!this._pyramidBuffers||this._pyramidBuffers.width!==s||this._pyramidBuffers.height!==e)&&(this._pyramidBuffers={width:s,height:e,temp:new Float32Array(s*e)});let i=[],o=t,a=s,c=e;for(let l=0;l<this.numOctaves;l++){let u=!n||n.includes(l);if(u){let h=this._applyGaussianFilter(o,a,c),f=this._applyGaussianFilter(h.data,a,c);i.push([{data:h.data,width:a,height:c},{data:f.data,width:a,height:c}])}else i.push(null);if(l<this.numOctaves-1)if(!n||n.some(f=>f>l)){let f=u?i[l][0].data:o,m=this._downsample(f,a,c);o=m.data,a=m.width,c=m.height}else break}return i}_applyGaussianFilter(t,s,e){let n=new Float32Array(s*e),i=this._pyramidBuffers?.temp||new Float32Array(s*e),o=.0625,a=.25,c=.375,l=s-1;for(let u=0;u<e;u++){let h=u*s,f=o+a+c+a+o;i[h]=(t[h]*(o+a+c)+t[h+1]*a+t[h+2]*o)*(1/(o+a+c)),i[h+1]=(t[h]*a+t[h+1]*c+t[h+2]*a+t[h+3]*o)*(1/(a+c+a+o));for(let y=2;y<s-2;y++){let p=h+y;i[p]=t[p-2]*o+t[p-1]*a+t[p]*c+t[p+1]*a+t[p+2]*o}let m=h+s-2,d=h+s-1;i[m]=(t[m-2]*o+t[m-1]*a+t[m]*c+t[d]*a)*(1/(o+a+c+a)),i[d]=(t[d-2]*o+t[d-1]*a+t[d]*(c+a+o))*(1/(o+a+c))}for(let u=0;u<s;u++){n[u]=(i[u]*(o+a+c)+i[u+s]*a+i[u+s*2]*o)*(1/(o+a+c)),n[u+s]=(i[u]*a+i[u+s]*c+i[u+s*2]*a+i[u+s*3]*o)*(1/(a+c+a+o));for(let m=2;m<e-2;m++){let d=m*s+u;n[d]=i[d-s*2]*o+i[d-s]*a+i[d]*c+i[d+s]*a+i[d+s*2]*o}let h=(e-2)*s+u,f=(e-1)*s+u;n[h]=(i[h-s*2]*o+i[h-s]*a+i[h]*c+i[f]*a)*(1/(o+a+c+a)),n[f]=(i[f-s*2]*o+i[f-s]*a+i[f]*(c+a+o))*(1/(o+a+c))}return{data:n,width:s,height:e}}_downsample(t,s,e){let n=s>>1,i=e>>1,o=new Float32Array(n*i);for(let a=0;a<i;a++){let c=a*2*s,l=c+s,u=a*n;for(let h=0;h<n;h++){let f=h*2;o[u+h]=(t[c+f]+t[c+f+1]+t[l+f]+t[l+f+1])*.25}}return{data:o,width:n,height:i}}_buildDogPyramid(t,s=null){let e=[];for(let n=0;n<t.length;n++){if(!t[n]){e.push(null);continue}let i=t[n][0],o=t[n][1],a=i.width,c=i.height,l=new Float32Array(a*c);for(let u=0;u<l.length;u++)l[u]=o.data[u]-i.data[u];e.push({data:l,width:a,height:c})}return e}_findExtremas(t,s){let e=[];for(let n=0;n<t.length;n++){let i=t[n];if(!i)continue;let o=n>0?t[n-1]:null,a=n<t.length-1?t[n+1]:null,c=i.width,l=i.height;for(let u=1;u<l-1;u++)for(let h=1;h<c-1;h++){let f=i.data[u*c+h];if(Math.abs(f)<.003)continue;let m=!0,d=!0;for(let y=-1;y<=1&&(m||d);y++)for(let p=-1;p<=1&&(m||d);p++){if(p===0&&y===0)continue;let g=i.data[(u+y)*c+(h+p)];g>=f&&(m=!1),g<=f&&(d=!1)}if((m||d)&&o){let y=h<<1,p=u<<1,g=o.width;for(let x=-1;x<=1&&(m||d);x++)for(let M=-1;M<=1&&(m||d);M++){let S=Math.max(0,Math.min(g-1,y+M)),I=Math.max(0,Math.min(o.height-1,p+x)),E=o.data[I*g+S];E>=f&&(m=!1),E<=f&&(d=!1)}}if((m||d)&&a){let y=h>>1,p=u>>1,g=a.width;for(let x=-1;x<=1&&(m||d);x++)for(let M=-1;M<=1&&(m||d);M++){let S=Math.max(0,Math.min(g-1,y+M)),I=Math.max(0,Math.min(a.height-1,p+x)),E=a.data[I*g+S];E>=f&&(m=!1),E<=f&&(d=!1)}}(m||d)&&e.push({score:m?Math.abs(f):-Math.abs(f),octave:n,x:h,y:u,absScore:Math.abs(f)})}}return e}_applyPrune(t){let s=jr,e=this.maxFeaturesPerBucket,n=[];for(let o=0;o<s*s;o++)n.push([]);for(let o of t){let a=Math.min(s-1,Math.floor(o.x/(this.width/Math.pow(2,o.octave))*s)),l=Math.min(s-1,Math.floor(o.y/(this.height/Math.pow(2,o.octave))*s))*s+a;l>=0&&l<n.length&&n[l].push(o)}let i=[];for(let o of n){o.sort((a,c)=>c.absScore-a.absScore);for(let a=0;a<Math.min(e,o.length);a++)i.push(o[a])}return i}_computeOrientations(t,s){for(let e of t){if(e.octave<0||e.octave>=s.length){e.angle=0;continue}let n=s[e.octave][1],i=n.width,o=n.height,a=n.data,c=Math.floor(e.x),l=Math.floor(e.y),u=new Float32Array(Jt),h=4;for(let m=-h;m<=h;m++)for(let d=-h;d<=h;d++){let y=l+m,p=c+d;if(y<=0||y>=o-1||p<=0||p>=i-1)continue;let g=a[(y+1)*i+p]-a[(y-1)*i+p],x=a[y*i+p+1]-a[y*i+p-1],M=Math.sqrt(x*x+g*g),S=Math.atan2(g,x)+Math.PI,I=Math.floor(S/(2*Math.PI)*Jt)%Jt,E=Math.exp(-(d*d+m*m)/(2*h*h));u[I]+=M*E}let f=0;for(let m=1;m<Jt;m++)u[m]>u[f]&&(f=m);e.angle=(f+.5)*2*Math.PI/Jt-Math.PI}}_computeFreakDescriptors(t,s){for(let e of t){if(e.octave<0||e.octave>=s.length){e.descriptors=new Uint8Array(8);continue}let n=s[e.octave][1],i=n.width,o=n.height,a=n.data,c=Math.cos(e.angle||0)*jn,l=Math.sin(e.angle||0)*jn,u=new Float32Array(yt.length);for(let h=0;h<yt.length;h++){let[,f,m]=yt[h],d=e.x+f*c-m*l,y=e.y+f*l+m*c,p=Math.max(0,Math.min(i-2,Math.floor(d))),g=Math.max(0,Math.min(o-2,Math.floor(y))),x=p+1,M=g+1,S=d-p,I=y-g;u[h]=a[g*i+p]*(1-S)*(1-I)+a[g*i+x]*S*(1-I)+a[M*i+p]*(1-S)*I+a[M*i+x]*S*I}this.useLSH?(e.lsh=pn(u),e.descriptors=yn(e.lsh)):e.descriptors=wn(u)}}}});function Ft(r){return r=r>>>0,r-=r>>>1&1431655765,r=(r&858993459)+(r>>>2&858993459),(r+(r>>>4)&252645135)*16843009>>>24}var zn,_s,De,Cs=W(()=>{"use strict";zn=new Uint8Array(256);for(let r=0;r<256;r++){let t=0,s=r;for(;s>0;)s&=s-1,t++;zn[r]=t}_s=(r,t,s,e)=>{let n=(r[t]^s[e])>>>0,i=(r[t+1]^s[e+1])>>>0;n-=n>>>1&1431655765,n=(n&858993459)+(n>>>2&858993459);let o=(n+(n>>>4)&252645135)*16843009>>>24;i-=i>>>1&1431655765,i=(i&858993459)+(i>>>2&858993459);let a=(i+(i>>>4)&252645135)*16843009>>>24;return o+a},De=r=>{let{v1:t,v2:s,v1Offset:e=0,v2Offset:n=0}=r,i=s.length-n;if(i===2)return _s(t,e,s,n);if(i===84){let o=0;for(let a=0;a<84;a++)o+=zn[t[e+a]^s[n+a]];return o}return i===4?Ft(t[e]^s[n])+Ft(t[e+1]^s[n+1])+Ft(t[e+2]^s[n+2])+Ft(t[e+3]^s[n+3]):Ft(t[e]^s[n])+Ft(t[e+1]^s[n+1])}});var Oe,As=W(()=>{"use strict";Oe=()=>({seed:1234,arrayShuffle(t){let{arr:s,sampleSize:e}=t;for(let n=0;n<e;n++){this.seed=(214013*this.seed+2531011)%-2147483648;let i=this.seed>>16&32767;i=i%s.length;let o=s[n];s[n]=s[i],s[i]=o}},nextInt(t){this.seed=(214013*this.seed+2531011)%-2147483648;let s=this.seed>>16&32767;return s=s%t,s}})});function Et(r){return r=r-(r>>1&1431655765),r=(r&858993459)+(r>>2&858993459),(r+(r>>4)&252645135)*16843009>>24}var Vr,Wr,Qt,Hr,Rs,qn,Us=W(()=>{"use strict";Cs();As();Vr=32,Wr=12,Qt=8;Hr=r=>{let{descriptors:t,pointIndexes:s,randomizer:e,useHDC:n}=r,i=s.length,o=new Int32Array(i);for(let u=0;u<i;u++)o[u]=u;let a=Number.MAX_SAFE_INTEGER,c=null,l=new Int32Array(Qt);for(let u=0;u<Wr;u++){e.arrayShuffle({arr:o,sampleSize:Qt});for(let m=0;m<Qt;m++)l[m]=s[o[m]];let h=0,f=new Int32Array(i);for(let m=0;m<i;m++){let d=s[m],y=255,p=-1;for(let g=0;g<Qt;g++){let x=l[g],M;n?M=Et(t[d]^t[x]):M=_s(t,d*2,t,x*2),M<y&&(p=o[g],y=M)}f[m]=p,h+=y}h<a&&(a=h,c=f)}return c},Rs=({points:r})=>{let t=r.length;if(t===0)return{rootNode:{leaf:!0,pointIndexes:[],centerPointIndex:null}};let s=r[0]&&r[0].hdcSignature!==void 0,e=new Uint32Array(s?t:t*2);for(let a=0;a<t;a++)if(s)e[a]=r[a].hdcSignature;else{let c=r[a].descriptors;e[a*2]=c[0],e[a*2+1]=c[1]}let n=new Int32Array(t);for(let a=0;a<t;a++)n[a]=a;let i=Oe();return{rootNode:qn({descriptors:e,pointIndexes:n,centerPointIndex:null,randomizer:i,useHDC:s})}},qn=r=>{let{descriptors:t,pointIndexes:s,centerPointIndex:e,randomizer:n,useHDC:i}=r,o=s.length,a=!1;(o<=Qt||o<=Vr)&&(a=!0);let c=new Map;if(!a){let u=Hr({descriptors:t,pointIndexes:s,randomizer:n,useHDC:i});for(let h=0;h<u.length;h++){let f=s[u[h]],m=c.get(f);m===void 0&&(m=[],c.set(f,m)),m.push(s[h])}c.size===1&&(a=!0)}let l={centerPointIndex:e};if(a)return l.leaf=!0,l.pointIndexes=new Int32Array(s),l;l.leaf=!1,l.children=[];for(let[u,h]of c)l.children.push(qn({descriptors:t,pointIndexes:new Int32Array(h),centerPointIndex:u,randomizer:n,useHDC:i}));return l}});var Le,Fs,vt,Ds=W(()=>{"use strict";Le=(r,t)=>[[r[0][0]*t[0][0]+r[0][2]*t[2][0],r[0][0]*t[0][1]+r[0][2]*t[2][1],r[0][0]*t[0][2]+r[0][2]*t[2][2],r[0][0]*t[0][3]+r[0][2]*t[2][3]],[r[1][1]*t[1][0]+r[1][2]*t[2][0],r[1][1]*t[1][1]+r[1][2]*t[2][1],r[1][1]*t[1][2]+r[1][2]*t[2][2],r[1][1]*t[1][3]+r[1][2]*t[2][3]],[t[2][0],t[2][1],t[2][2],t[2][3]]],Fs=(r,t,s,e)=>{let n=r[0][0]*t+r[0][1]*s+r[0][3],i=r[1][0]*t+r[1][1]*s+r[1][3],o=r[2][0]*t+r[2][1]*s+r[2][3];return{x:n,y:i,z:o}},vt=(r,t,s,e)=>{let{x:n,y:i,z:o}=Fs(r,t,s,e);return{x:n/o,y:i/o}}});function Hn({mesh:r,trackedPoints:t,currentVertices:s,iterations:e=5}){let{e:n,rl:i}=r,o=s.length/2,a=new Float32Array(s),c=.8,l=.5;for(let u=0;u<e;u++){for(let h=0;h<i.length;h++){let f=n[h*2],m=n[h*2+1],d=i[h],y=a[f*2],p=a[f*2+1],g=a[m*2],x=a[m*2+1],M=g-y,S=x-p,I=Math.sqrt(M*M+S*S);if(I<1e-4)continue;let E=(I-d)/I,k=M*.5*E*c,T=S*.5*E*c;a[f*2]+=k,a[f*2+1]+=T,a[m*2]-=k,a[m*2+1]-=T}for(let h of t){let f=h.meshIndex;if(f===void 0)continue;let m=h.x,d=h.y;a[f*2]+=(m-a[f*2])*l,a[f*2+1]+=(d-a[f*2+1])*l}}return a}var Xn=W(()=>{"use strict"});var Gn,Yr,$r,Yn,Dt,Os=W(()=>{"use strict";Ds();Xn();At();Gn=Y.TRACKER_TEMPLATE_SIZE,Yr=Y.TRACKER_SEARCH_SIZE,$r=1,Yn=Y.TRACKER_SIMILARITY_THRESHOLD,Dt=class{constructor(t,s,e,n,i,o=!1){this.markerDimensions=t,this.trackingDataList=s,this.projectionTransform=e,this.inputWidth=n,this.inputHeight=i,this.debugMode=o,this.trackingKeyframeList=[],this.prebuiltData=[];for(let l=0;l<s.length;l++){let u=s[l];this.trackingKeyframeList[l]=u,this.prebuiltData[l]=u.map(h=>({px:new Float32Array(h.px),py:new Float32Array(h.py),data:new Uint8Array(h.d),width:h.w,height:h.h,scale:h.s,mesh:h.mesh,projectedImage:new Float32Array(h.w*h.h)}))}this.meshVerticesState=[];let c=Gn*2+1;this.templateBuffer=new Float32Array(c*c)}dummyRun(t){let s=[[1,0,0,0],[0,1,0,0],[0,0,1,0]];for(let e=0;e<this.trackingKeyframeList.length;e++)this.track(t,s,e)}track(t,s,e){let n={},i=Le(this.projectionTransform,s),[o,a]=this.markerDimensions[e],c=vt(i,0,0),l=vt(i,o,0),u=Math.sqrt((l.x-c.x)**2+(l.y-c.y)**2);this.lastOctaveIndex||(this.lastOctaveIndex=[]);let h=this.lastOctaveIndex[e]!==void 0?this.lastOctaveIndex[e]:0,f=Math.abs(this.prebuiltData[e][h].width-u),m=.8;for(let b=0;b<this.prebuiltData[e].length;b++){let _=Math.abs(this.prebuiltData[e][b].width-u);_<f*m&&(f=_,h=b)}this.lastOctaveIndex[e]=h;let d=this.prebuiltData[e][h];this._computeProjection(i,t,d);let y=d.projectedImage,{matchingPoints:p,sim:g}=this._computeMatching(d,y),x=this.trackingKeyframeList[e][h],M=[],S=[],I=[],{px:E,py:k,s:T}=x,C=[];for(let b=0;b<p.length;b++){let _=g[b];if(_>Yn&&b<E.length){I.push(b);let v=vt(i,p[b][0],p[b][1]);S.push(v),M.push({x:E[b]/T,y:k[b]/T,z:0}),C.push(_)}}let w=null;if(d.mesh&&I.length>=4){this.meshVerticesState[e]||(this.meshVerticesState[e]=[]);let b=this.meshVerticesState[e][h];if(!b){b=new Float32Array(E.length*2);for(let A=0;A<E.length;A++)b[A*2]=E[A],b[A*2+1]=k[A]}let _=[];for(let A=0;A<I.length;A++){let R=I[A];_.push({meshIndex:R,x:p[R][0]*T,y:p[R][1]*T})}let v=Hn({mesh:d.mesh,trackedPoints:_,currentVertices:b,iterations:5});this.meshVerticesState[e][h]=v;let D=new Float32Array(v.length);for(let A=0;A<v.length;A+=2){let R=vt(i,v[A]/T,v[A+1]/T);D[A]=R.x,D[A+1]=R.y}w={vertices:D,triangles:d.mesh.t}}if(S.length>=8){let b=1/0,_=1/0,v=-1/0,D=-1/0;for(let R of S)R.x<b&&(b=R.x),R.y<_&&(_=R.y),R.x>v&&(v=R.x),R.y>D&&(D=R.y);if(Math.sqrt((v-b)**2+(D-_)**2)<u*.15)return{worldCoords:[],screenCoords:[],reliabilities:[],debugExtra:n}}return this.debugMode&&(n={octaveIndex:h,projectedImage:y,matchingPoints:p,goodTrack:I,trackedPoints:S}),{worldCoords:M,screenCoords:S,reliabilities:C,indices:I,octaveIndex:h,deformedMesh:w,debugExtra:n}}_computeMatching(t,s){let{px:e,py:n,scale:i,data:o,width:a,height:c}=t,l=e.length,u=Gn,h=u*2+1,m=1/(h*h),d=Yr,y=$r,p=[],g=new Float32Array(l),x=this.templateBuffer;for(let M=0;M<l;M++){let S=e[M]+.5|0,I=n[M]+.5|0,E=-1,k=e[M]/i,T=n[M]/i,C=0,w=0,b=0;for(let D=-u;D<=u;D++){let A=(I+D)*a;for(let R=-u;R<=u;R++){let P=o[A+S+R];x[b++]=P,C+=P,w+=P*P}}let _=Math.sqrt(Math.max(0,w-C*C*m));if(_<1e-4){g[M]=-1,p.push([k,T]);continue}let v=4;for(let D=-d;D<=d;D+=v){let A=I+D;if(!(A<u||A>=c-u))for(let R=-d;R<=d;R+=v){let P=S+R;if(P<u||P>=a-u)continue;let N=0,j=0,O=0;for(let L=-u;L<=u;L++){let V=(A+L)*a,G=(L+u)*h;for(let q=-u;q<=u;q++){let H=s[V+(P+q)],J=x[G+(q+u)];N+=H,j+=H*H,O+=H*J}}let U=Math.sqrt(Math.max(0,j-N*N*m));if(U<1e-4)continue;let B=(O-N*C*m)/(U*_);B>E&&(E=B,k=P/i,T=A/i)}}if(E>Yn){let D=k*i|0,A=T*i|0,R=v;for(let P=-R;P<=R;P++){let N=A+P;if(!(N<u||N>=c-u))for(let j=-R;j<=R;j++){let O=D+j;if(O<u||O>=a-u)continue;let U=0,B=0,L=0;for(let q=-u;q<=u;q++){let H=(N+q)*a,J=(q+u)*h;for(let Z=-u;Z<=u;Z++){let Q=s[H+(O+Z)],et=x[J+(Z+u)];U+=Q,B+=Q*Q,L+=Q*et}}let V=Math.sqrt(Math.max(0,B-U*U*m));if(V<1e-4)continue;let G=(L-U*C*m)/(V*_);G>E&&(E=G,k=O/i,T=N/i)}}}g[M]=E,p.push([k,T])}return{matchingPoints:p,sim:g}}_computeProjection(t,s,e){let{width:n,height:i,scale:o,projectedImage:a}=e,c=1/o,l=this.inputWidth,u=this.inputHeight,h=t[0][0],f=t[0][1],m=t[0][3],d=t[1][0],y=t[1][1],p=t[1][3],g=t[2][0],x=t[2][1],M=t[2][3];for(let S=0;S<i;S++){let I=S*c,E=S*n;for(let k=0;k<n;k++){let T=k*c,w=1/(T*g+I*x+M),b=(T*h+I*f+m)*w,_=(T*d+I*y+p)*w,v=b|0,D=_|0,A=v+1,R=D+1;if(v>=0&&A<l&&D>=0&&R<u){let P=b-v,N=_-D,j=1-P,O=1-N,U=D*l,B=R*l,L=s[U+v],V=s[U+A],G=s[B+v],q=s[B+A];a[E+k]=L*j*O+V*P*O+G*j*N+q*P*N}else a[E+k]=0}}}}});function Kr(r,t){return r<t?-1:r>t?1:0}var te,$n=W(()=>{te=class{constructor(t=[],s=Kr){if(this.data=t,this.length=this.data.length,this.compare=s,this.length>0)for(let e=(this.length>>1)-1;e>=0;e--)this._down(e)}push(t){this.data.push(t),this.length++,this._up(this.length-1)}pop(){if(this.length===0)return;let t=this.data[0],s=this.data.pop();return this.length--,this.length>0&&(this.data[0]=s,this._down(0)),t}peek(){return this.data[0]}_up(t){let{data:s,compare:e}=this,n=s[t];for(;t>0;){let i=t-1>>1,o=s[i];if(e(n,o)>=0)break;s[t]=o,t=i}s[t]=n}_down(t){let{data:s,compare:e}=this,n=this.length>>1,i=s[t];for(;t<n;){let o=(t<<1)+1,a=s[o],c=o+1;if(c<this.length&&e(s[c],a)<0&&(o=c,a=s[c]),e(a,i)>=0)break;s[t]=a,t=o}s[t]=i}}});var Ps,Jr,Kn=W(()=>{"use strict";Ps=r=>{let{keywidth:t,keyheight:s,querywidth:e,queryheight:n,matches:i}=r,o=e*1.2,a=-o,c=n*1.2,l=-c,u=12,h=12,f=-2,m=1,y=1/Math.log(10),p=Math.max(t,s),g=Math.floor(t/2),x=Math.floor(s/2),M=[];for(let U=0;U<i.length;U++){let B=i[U].querypoint.scale,L=i[U].keypoint.scale;L==0&&console.log("ERROR divide zero");let V=B/L;M.push(V*p)}M.sort((U,B)=>U-B);let S=M[Math.floor(M.length/2)-(M.length%2==0?1:0)-1],I=Math.max(20,.25*S),E=Math.max(5,Math.min(40,Math.ceil((o-a)/I))),k=Math.max(5,Math.min(40,Math.ceil((c-l)/I))),T=E*k,C=T*u,w=[],b=[],_={};for(let U=0;U<i.length;U++){let B=i[U].querypoint,L=i[U].keypoint,{x:V,y:G,scale:q,angle:H}=Jr({querypoint:B,keypoint:L,keycenterX:g,keycenterY:x,scaleOneOverLogK:y});if(V<a||V>=o||G<l||G>=c||H<=-Math.PI||H>Math.PI||q<f||q>=m){w[U]=!1;continue}let J=E*(V-a)/(o-a),Z=k*(G-l)/(c-l),Q=u*(H+Math.PI)/(2*Math.PI),et=h*(q-f)/(m-f);b[U]={binX:J,binY:Z,binAngle:Q,binScale:et};let ot=Math.floor(J-.5),nt=Math.floor(Z-.5),st=Math.floor(et-.5),ht=(Math.floor(Q-.5)+u)%u;if(ot<0||ot+1>=E||nt<0||nt+1>=k||st<0||st+1>=h){w[U]=!1;continue}for(let pt=0;pt<2;pt++){let wt=ot+pt;for(let qt=0;qt<2;qt++){let xe=nt+qt;for(let Ct=0;Ct<2;Ct++){let cn=(ht+Ct)%u;for(let mt=0;mt<2;mt++){let $i=st+mt,as=wt+xe*E+cn*T+$i*C;_[as]===void 0&&(_[as]=0),_[as]+=1}}}}w[U]=!0}let v=0,D=-1;if(Object.keys(_).forEach(U=>{_[U]>v&&(v=_[U],D=U)}),v<3)return[];let A=Math.floor(D%C%T%E),R=Math.floor((D-A)%C%T/E),P=Math.floor((D-A-R*E)%C/T),N=Math.floor((D-A-R*E-P*T)/C),j=[],O=2;for(let U=0;U<i.length;U++){if(!w[U])continue;let B=b[U];if(Math.abs(B.binX-(A+.5))>=O||Math.abs(B.binY-(R+.5))>=O||Math.abs(B.binScale-(N+.5))>=O)continue;let q=Math.abs(B.binAngle-(P+.5));Math.min(q,u-q)>=O||j.push(i[U])}return j},Jr=({querypoint:r,keypoint:t,keycenterX:s,keycenterY:e,scaleOneOverLogK:n})=>{let i=r.angle-t.angle;i<=-Math.PI?i+=2*Math.PI:i>Math.PI&&(i-=2*Math.PI);let o=r.scale/t.scale,a=o*Math.cos(i),c=o*Math.sin(i),l=[a,-c,c,a],u=[l[0]*t.x+l[1]*t.y,l[2]*t.x+l[3]*t.y],h=r.x-u[0],f=r.y-u[1];return{x:l[0]*s+l[1]*e+h,y:l[2]*s+l[3]*e+f,angle:i,scale:Math.log(o)*n}}});var ct,Jn,Zn,Zr,Qn,Xe,ti,ei,ee,He,Ls=W(()=>{"use strict";ct=(r,t,s)=>(t[0]-r[0])*(s[1]-r[1])-(t[1]-r[1])*(s[0]-r[0]),Jn=(r,t,s,e,n,i,o,a)=>!(ct(r,t,s)>0!=ct(n,i,o)>0||ct(t,s,e)>0!=ct(i,o,a)>0||ct(s,e,r)>0!=ct(o,a,n)>0||ct(e,r,t)>0!=ct(a,n,i)>0),Zn=(r,t,s,e,n,i)=>ct(r,t,s)>0==ct(e,n,i)>0,Zr=r=>{let t=r[4]*r[8]-r[5]*r[7],s=r[3]*r[8]-r[5]*r[6],e=r[3]*r[7]-r[4]*r[6];return r[0]*t-r[1]*s+r[2]*e},Qn=(r,t)=>{let s=Zr(r);if(Math.abs(s)<=t)return null;let e=1/s;return[(r[4]*r[8]-r[5]*r[7])*e,(r[2]*r[7]-r[1]*r[8])*e,(r[1]*r[5]-r[2]*r[4])*e,(r[5]*r[6]-r[3]*r[8])*e,(r[0]*r[8]-r[2]*r[6])*e,(r[2]*r[3]-r[0]*r[5])*e,(r[3]*r[7]-r[4]*r[6])*e,(r[1]*r[6]-r[0]*r[7])*e,(r[0]*r[4]-r[1]*r[3])*e]},Xe=(r,t)=>{let s=t[6]*r[0]+t[7]*r[1]+t[8],e=[];return e[0]=(t[0]*r[0]+t[1]*r[1]+t[2])/s,e[1]=(t[3]*r[0]+t[4]*r[1]+t[5])/s,e},ti=(r,t,s,e)=>{let n=ee(t,r),i=ee(s,r),o=ee(e,r),a=ee(t,s),c=ee(e,s),l=He(n,i),u=He(i,o),h=He(n,o),f=He(a,c);return Math.min(Math.min(Math.min(l,u),h),f)},ei=(r,t,s,e)=>{let n=ct(r,t,s)<=0;return!(ct(t,s,e)<=0!==n||ct(s,e,r)<=0!==n||ct(e,r,t)<=0!==n)},ee=(r,t)=>[r[0]-t[0],r[1]-t[1]],He=(r,t)=>{let s=r[0]*t[1]-r[1]*t[0];return Math.abs(s)*.5}});var se=Vt(Ge=>{"use strict";Object.defineProperty(Ge,"__esModule",{value:!0});Ge.isAnyArray=void 0;var Qr=Object.prototype.toString;function to(r){let t=Qr.call(r);return t.endsWith("Array]")&&!t.includes("Big")}Ge.isAnyArray=to});var ni=Vt((ll,si)=>{"use strict";var eo=se();function so(r,t={}){if(!eo.isAnyArray(r))throw new TypeError("input must be an array");if(r.length===0)throw new TypeError("input must not be empty");let{fromIndex:s=0,toIndex:e=r.length}=t;if(s<0||s>=r.length||!Number.isInteger(s))throw new Error("fromIndex must be a positive integer smaller than length");if(e<=s||e>r.length||!Number.isInteger(e))throw new Error("toIndex must be an integer greater than fromIndex and at most equal to length");let n=r[s];for(let i=s+1;i<e;i++)r[i]>n&&(n=r[i]);return n}si.exports=so});var ri=Vt((hl,ii)=>{"use strict";var no=se();function io(r,t={}){if(!no.isAnyArray(r))throw new TypeError("input must be an array");if(r.length===0)throw new TypeError("input must not be empty");let{fromIndex:s=0,toIndex:e=r.length}=t;if(s<0||s>=r.length||!Number.isInteger(s))throw new Error("fromIndex must be a positive integer smaller than length");if(e<=s||e>r.length||!Number.isInteger(e))throw new Error("toIndex must be an integer greater than fromIndex and at most equal to length");let n=r[s];for(let i=s+1;i<e;i++)r[i]<n&&(n=r[i]);return n}ii.exports=io});var li=Vt((ul,ci)=>{"use strict";var oi=se(),ro=ni(),oo=ri();function ai(r){return r&&typeof r=="object"&&"default"in r?r:{default:r}}var ao=ai(ro),co=ai(oo);function lo(r,t={}){if(oi.isAnyArray(r)){if(r.length===0)throw new TypeError("input must not be empty")}else throw new TypeError("input must be an array");let s;if(t.output!==void 0){if(!oi.isAnyArray(t.output))throw new TypeError("output option must be an array if specified");s=t.output}else s=new Array(r.length);let e=co.default(r),n=ao.default(r);if(e===n)throw new RangeError("minimum and maximum input values are equal. Cannot rescale a constant array");let{min:i=t.autoMinMax?e:0,max:o=t.autoMinMax?n:1}=t;if(i>=o)throw new RangeError("min option must be smaller than max option");let a=(o-i)/(n-e);for(let c=0;c<r.length;c++)s[c]=(r[c]-e)*a+i;return s}ci.exports=lo});var pi=Vt(X=>{"use strict";Object.defineProperty(X,"__esModule",{value:!0});var lt=se(),hi=li(),Ye=" ".repeat(2),di=" ".repeat(4);function ho(){return mi(this)}function mi(r,t={}){let{maxRows:s=15,maxColumns:e=10,maxNumSize:n=8,padMinus:i="auto"}=t;return`${r.constructor.name} {
${Ye}[
${di}${uo(r,s,e,n,i)}
${Ye}]
${Ye}rows: ${r.rows}
${Ye}columns: ${r.columns}
}`}function uo(r,t,s,e,n){let{rows:i,columns:o}=r,a=Math.min(i,t),c=Math.min(o,s),l=[];if(n==="auto"){n=!1;t:for(let u=0;u<a;u++)for(let h=0;h<c;h++)if(r.get(u,h)<0){n=!0;break t}}for(let u=0;u<a;u++){let h=[];for(let f=0;f<c;f++)h.push(fo(r.get(u,f),e,n));l.push(`${h.join(" ")}`)}return c!==o&&(l[l.length-1]+=` ... ${o-s} more columns`),a!==i&&l.push(`... ${i-t} more rows`),l.join(`
${di}`)}function fo(r,t,s){return(r>=0&&s?` ${ui(r,t-1)}`:ui(r,t)).padEnd(t)}function ui(r,t){let s=r.toString();if(s.length<=t)return s;let e=r.toFixed(t);if(e.length>t&&(e=r.toFixed(Math.max(0,t-(e.length-t)))),e.length<=t&&!e.startsWith("0.000")&&!e.startsWith("-0.000"))return e;let n=r.toExponential(t);return n.length>t&&(n=r.toExponential(Math.max(0,t-(n.length-t)))),n.slice(0)}function mo(r,t){r.prototype.add=function(e){return typeof e=="number"?this.addS(e):this.addM(e)},r.prototype.addS=function(e){for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)+e);return this},r.prototype.addM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)+e.get(n,i));return this},r.add=function(e,n){return new t(e).add(n)},r.prototype.sub=function(e){return typeof e=="number"?this.subS(e):this.subM(e)},r.prototype.subS=function(e){for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)-e);return this},r.prototype.subM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)-e.get(n,i));return this},r.sub=function(e,n){return new t(e).sub(n)},r.prototype.subtract=r.prototype.sub,r.prototype.subtractS=r.prototype.subS,r.prototype.subtractM=r.prototype.subM,r.subtract=r.sub,r.prototype.mul=function(e){return typeof e=="number"?this.mulS(e):this.mulM(e)},r.prototype.mulS=function(e){for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)*e);return this},r.prototype.mulM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)*e.get(n,i));return this},r.mul=function(e,n){return new t(e).mul(n)},r.prototype.multiply=r.prototype.mul,r.prototype.multiplyS=r.prototype.mulS,r.prototype.multiplyM=r.prototype.mulM,r.multiply=r.mul,r.prototype.div=function(e){return typeof e=="number"?this.divS(e):this.divM(e)},r.prototype.divS=function(e){for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)/e);return this},r.prototype.divM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)/e.get(n,i));return this},r.div=function(e,n){return new t(e).div(n)},r.prototype.divide=r.prototype.div,r.prototype.divideS=r.prototype.divS,r.prototype.divideM=r.prototype.divM,r.divide=r.div,r.prototype.mod=function(e){return typeof e=="number"?this.modS(e):this.modM(e)},r.prototype.modS=function(e){for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)%e);return this},r.prototype.modM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)%e.get(n,i));return this},r.mod=function(e,n){return new t(e).mod(n)},r.prototype.modulus=r.prototype.mod,r.prototype.modulusS=r.prototype.modS,r.prototype.modulusM=r.prototype.modM,r.modulus=r.mod,r.prototype.and=function(e){return typeof e=="number"?this.andS(e):this.andM(e)},r.prototype.andS=function(e){for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)&e);return this},r.prototype.andM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)&e.get(n,i));return this},r.and=function(e,n){return new t(e).and(n)},r.prototype.or=function(e){return typeof e=="number"?this.orS(e):this.orM(e)},r.prototype.orS=function(e){for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)|e);return this},r.prototype.orM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)|e.get(n,i));return this},r.or=function(e,n){return new t(e).or(n)},r.prototype.xor=function(e){return typeof e=="number"?this.xorS(e):this.xorM(e)},r.prototype.xorS=function(e){for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)^e);return this},r.prototype.xorM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)^e.get(n,i));return this},r.xor=function(e,n){return new t(e).xor(n)},r.prototype.leftShift=function(e){return typeof e=="number"?this.leftShiftS(e):this.leftShiftM(e)},r.prototype.leftShiftS=function(e){for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)<<e);return this},r.prototype.leftShiftM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)<<e.get(n,i));return this},r.leftShift=function(e,n){return new t(e).leftShift(n)},r.prototype.signPropagatingRightShift=function(e){return typeof e=="number"?this.signPropagatingRightShiftS(e):this.signPropagatingRightShiftM(e)},r.prototype.signPropagatingRightShiftS=function(e){for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)>>e);return this},r.prototype.signPropagatingRightShiftM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)>>e.get(n,i));return this},r.signPropagatingRightShift=function(e,n){return new t(e).signPropagatingRightShift(n)},r.prototype.rightShift=function(e){return typeof e=="number"?this.rightShiftS(e):this.rightShiftM(e)},r.prototype.rightShiftS=function(e){for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)>>>e);return this},r.prototype.rightShiftM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)>>>e.get(n,i));return this},r.rightShift=function(e,n){return new t(e).rightShift(n)},r.prototype.zeroFillRightShift=r.prototype.rightShift,r.prototype.zeroFillRightShiftS=r.prototype.rightShiftS,r.prototype.zeroFillRightShiftM=r.prototype.rightShiftM,r.zeroFillRightShift=r.rightShift,r.prototype.not=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,~this.get(e,n));return this},r.not=function(e){return new t(e).not()},r.prototype.abs=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.abs(this.get(e,n)));return this},r.abs=function(e){return new t(e).abs()},r.prototype.acos=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.acos(this.get(e,n)));return this},r.acos=function(e){return new t(e).acos()},r.prototype.acosh=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.acosh(this.get(e,n)));return this},r.acosh=function(e){return new t(e).acosh()},r.prototype.asin=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.asin(this.get(e,n)));return this},r.asin=function(e){return new t(e).asin()},r.prototype.asinh=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.asinh(this.get(e,n)));return this},r.asinh=function(e){return new t(e).asinh()},r.prototype.atan=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.atan(this.get(e,n)));return this},r.atan=function(e){return new t(e).atan()},r.prototype.atanh=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.atanh(this.get(e,n)));return this},r.atanh=function(e){return new t(e).atanh()},r.prototype.cbrt=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.cbrt(this.get(e,n)));return this},r.cbrt=function(e){return new t(e).cbrt()},r.prototype.ceil=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.ceil(this.get(e,n)));return this},r.ceil=function(e){return new t(e).ceil()},r.prototype.clz32=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.clz32(this.get(e,n)));return this},r.clz32=function(e){return new t(e).clz32()},r.prototype.cos=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.cos(this.get(e,n)));return this},r.cos=function(e){return new t(e).cos()},r.prototype.cosh=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.cosh(this.get(e,n)));return this},r.cosh=function(e){return new t(e).cosh()},r.prototype.exp=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.exp(this.get(e,n)));return this},r.exp=function(e){return new t(e).exp()},r.prototype.expm1=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.expm1(this.get(e,n)));return this},r.expm1=function(e){return new t(e).expm1()},r.prototype.floor=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.floor(this.get(e,n)));return this},r.floor=function(e){return new t(e).floor()},r.prototype.fround=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.fround(this.get(e,n)));return this},r.fround=function(e){return new t(e).fround()},r.prototype.log=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.log(this.get(e,n)));return this},r.log=function(e){return new t(e).log()},r.prototype.log1p=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.log1p(this.get(e,n)));return this},r.log1p=function(e){return new t(e).log1p()},r.prototype.log10=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.log10(this.get(e,n)));return this},r.log10=function(e){return new t(e).log10()},r.prototype.log2=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.log2(this.get(e,n)));return this},r.log2=function(e){return new t(e).log2()},r.prototype.round=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.round(this.get(e,n)));return this},r.round=function(e){return new t(e).round()},r.prototype.sign=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.sign(this.get(e,n)));return this},r.sign=function(e){return new t(e).sign()},r.prototype.sin=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.sin(this.get(e,n)));return this},r.sin=function(e){return new t(e).sin()},r.prototype.sinh=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.sinh(this.get(e,n)));return this},r.sinh=function(e){return new t(e).sinh()},r.prototype.sqrt=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.sqrt(this.get(e,n)));return this},r.sqrt=function(e){return new t(e).sqrt()},r.prototype.tan=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.tan(this.get(e,n)));return this},r.tan=function(e){return new t(e).tan()},r.prototype.tanh=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.tanh(this.get(e,n)));return this},r.tanh=function(e){return new t(e).tanh()},r.prototype.trunc=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.trunc(this.get(e,n)));return this},r.trunc=function(e){return new t(e).trunc()},r.pow=function(e,n){return new t(e).pow(n)},r.prototype.pow=function(e){return typeof e=="number"?this.powS(e):this.powM(e)},r.prototype.powS=function(e){for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)**e);return this},r.prototype.powM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)**e.get(n,i));return this}}function ut(r,t,s){let e=s?r.rows:r.rows-1;if(t<0||t>e)throw new RangeError("Row index out of range")}function ft(r,t,s){let e=s?r.columns:r.columns-1;if(t<0||t>e)throw new RangeError("Column index out of range")}function Pt(r,t){if(t.to1DArray&&(t=t.to1DArray()),t.length!==r.columns)throw new RangeError("vector size must be the same as the number of columns");return t}function Lt(r,t){if(t.to1DArray&&(t=t.to1DArray()),t.length!==r.rows)throw new RangeError("vector size must be the same as the number of rows");return t}function Gs(r,t){if(!lt.isAnyArray(t))throw new TypeError("row indices must be an array");for(let s=0;s<t.length;s++)if(t[s]<0||t[s]>=r.rows)throw new RangeError("row indices are out of range")}function Ys(r,t){if(!lt.isAnyArray(t))throw new TypeError("column indices must be an array");for(let s=0;s<t.length;s++)if(t[s]<0||t[s]>=r.columns)throw new RangeError("column indices are out of range")}function Bs(r,t,s,e,n){if(arguments.length!==5)throw new RangeError("expected 4 arguments");if($e("startRow",t),$e("endRow",s),$e("startColumn",e),$e("endColumn",n),t>s||e>n||t<0||t>=r.rows||s<0||s>=r.rows||e<0||e>=r.columns||n<0||n>=r.columns)throw new RangeError("Submatrix indices are out of range")}function ns(r,t=0){let s=[];for(let e=0;e<r;e++)s.push(t);return s}function $e(r,t){if(typeof t!="number")throw new TypeError(`${r} must be a number`)}function Ot(r){if(r.isEmpty())throw new Error("Empty matrix has no elements to index")}function go(r){let t=ns(r.rows);for(let s=0;s<r.rows;++s)for(let e=0;e<r.columns;++e)t[s]+=r.get(s,e);return t}function po(r){let t=ns(r.columns);for(let s=0;s<r.rows;++s)for(let e=0;e<r.columns;++e)t[e]+=r.get(s,e);return t}function wo(r){let t=0;for(let s=0;s<r.rows;s++)for(let e=0;e<r.columns;e++)t+=r.get(s,e);return t}function yo(r){let t=ns(r.rows,1);for(let s=0;s<r.rows;++s)for(let e=0;e<r.columns;++e)t[s]*=r.get(s,e);return t}function xo(r){let t=ns(r.columns,1);for(let s=0;s<r.rows;++s)for(let e=0;e<r.columns;++e)t[e]*=r.get(s,e);return t}function Mo(r){let t=1;for(let s=0;s<r.rows;s++)for(let e=0;e<r.columns;e++)t*=r.get(s,e);return t}function bo(r,t,s){let e=r.rows,n=r.columns,i=[];for(let o=0;o<e;o++){let a=0,c=0,l=0;for(let u=0;u<n;u++)l=r.get(o,u)-s[o],a+=l,c+=l*l;t?i.push((c-a*a/n)/(n-1)):i.push((c-a*a/n)/n)}return i}function So(r,t,s){let e=r.rows,n=r.columns,i=[];for(let o=0;o<n;o++){let a=0,c=0,l=0;for(let u=0;u<e;u++)l=r.get(u,o)-s[o],a+=l,c+=l*l;t?i.push((c-a*a/e)/(e-1)):i.push((c-a*a/e)/e)}return i}function Eo(r,t,s){let e=r.rows,n=r.columns,i=e*n,o=0,a=0,c=0;for(let l=0;l<e;l++)for(let u=0;u<n;u++)c=r.get(l,u)-s,o+=c,a+=c*c;return t?(a-o*o/i)/(i-1):(a-o*o/i)/i}function ko(r,t){for(let s=0;s<r.rows;s++)for(let e=0;e<r.columns;e++)r.set(s,e,r.get(s,e)-t[s])}function Io(r,t){for(let s=0;s<r.rows;s++)for(let e=0;e<r.columns;e++)r.set(s,e,r.get(s,e)-t[e])}function vo(r,t){for(let s=0;s<r.rows;s++)for(let e=0;e<r.columns;e++)r.set(s,e,r.get(s,e)-t)}function To(r){let t=[];for(let s=0;s<r.rows;s++){let e=0;for(let n=0;n<r.columns;n++)e+=r.get(s,n)**2/(r.columns-1);t.push(Math.sqrt(e))}return t}function _o(r,t){for(let s=0;s<r.rows;s++)for(let e=0;e<r.columns;e++)r.set(s,e,r.get(s,e)/t[s])}function Co(r){let t=[];for(let s=0;s<r.columns;s++){let e=0;for(let n=0;n<r.rows;n++)e+=r.get(n,s)**2/(r.rows-1);t.push(Math.sqrt(e))}return t}function Ao(r,t){for(let s=0;s<r.rows;s++)for(let e=0;e<r.columns;e++)r.set(s,e,r.get(s,e)/t[e])}function Ro(r){let t=r.size-1,s=0;for(let e=0;e<r.columns;e++)for(let n=0;n<r.rows;n++)s+=r.get(n,e)**2/t;return Math.sqrt(s)}function Uo(r,t){for(let s=0;s<r.rows;s++)for(let e=0;e<r.columns;e++)r.set(s,e,r.get(s,e)/t)}var K=class r{static from1DArray(t,s,e){if(t*s!==e.length)throw new RangeError("data length does not match given dimensions");let i=new F(t,s);for(let o=0;o<t;o++)for(let a=0;a<s;a++)i.set(o,a,e[o*s+a]);return i}static rowVector(t){let s=new F(1,t.length);for(let e=0;e<t.length;e++)s.set(0,e,t[e]);return s}static columnVector(t){let s=new F(t.length,1);for(let e=0;e<t.length;e++)s.set(e,0,t[e]);return s}static zeros(t,s){return new F(t,s)}static ones(t,s){return new F(t,s).fill(1)}static rand(t,s,e={}){if(typeof e!="object")throw new TypeError("options must be an object");let{random:n=Math.random}=e,i=new F(t,s);for(let o=0;o<t;o++)for(let a=0;a<s;a++)i.set(o,a,n());return i}static randInt(t,s,e={}){if(typeof e!="object")throw new TypeError("options must be an object");let{min:n=0,max:i=1e3,random:o=Math.random}=e;if(!Number.isInteger(n))throw new TypeError("min must be an integer");if(!Number.isInteger(i))throw new TypeError("max must be an integer");if(n>=i)throw new RangeError("min must be smaller than max");let a=i-n,c=new F(t,s);for(let l=0;l<t;l++)for(let u=0;u<s;u++){let h=n+Math.round(o()*a);c.set(l,u,h)}return c}static eye(t,s,e){s===void 0&&(s=t),e===void 0&&(e=1);let n=Math.min(t,s),i=this.zeros(t,s);for(let o=0;o<n;o++)i.set(o,o,e);return i}static diag(t,s,e){let n=t.length;s===void 0&&(s=n),e===void 0&&(e=s);let i=Math.min(n,s,e),o=this.zeros(s,e);for(let a=0;a<i;a++)o.set(a,a,t[a]);return o}static min(t,s){t=this.checkMatrix(t),s=this.checkMatrix(s);let e=t.rows,n=t.columns,i=new F(e,n);for(let o=0;o<e;o++)for(let a=0;a<n;a++)i.set(o,a,Math.min(t.get(o,a),s.get(o,a)));return i}static max(t,s){t=this.checkMatrix(t),s=this.checkMatrix(s);let e=t.rows,n=t.columns,i=new this(e,n);for(let o=0;o<e;o++)for(let a=0;a<n;a++)i.set(o,a,Math.max(t.get(o,a),s.get(o,a)));return i}static checkMatrix(t){return r.isMatrix(t)?t:new F(t)}static isMatrix(t){return t!=null&&t.klass==="Matrix"}get size(){return this.rows*this.columns}apply(t){if(typeof t!="function")throw new TypeError("callback must be a function");for(let s=0;s<this.rows;s++)for(let e=0;e<this.columns;e++)t.call(this,s,e);return this}to1DArray(){let t=[];for(let s=0;s<this.rows;s++)for(let e=0;e<this.columns;e++)t.push(this.get(s,e));return t}to2DArray(){let t=[];for(let s=0;s<this.rows;s++){t.push([]);for(let e=0;e<this.columns;e++)t[s].push(this.get(s,e))}return t}toJSON(){return this.to2DArray()}isRowVector(){return this.rows===1}isColumnVector(){return this.columns===1}isVector(){return this.rows===1||this.columns===1}isSquare(){return this.rows===this.columns}isEmpty(){return this.rows===0||this.columns===0}isSymmetric(){if(this.isSquare()){for(let t=0;t<this.rows;t++)for(let s=0;s<=t;s++)if(this.get(t,s)!==this.get(s,t))return!1;return!0}return!1}isDistance(){if(!this.isSymmetric())return!1;for(let t=0;t<this.rows;t++)if(this.get(t,t)!==0)return!1;return!0}isEchelonForm(){let t=0,s=0,e=-1,n=!0,i=!1;for(;t<this.rows&&n;){for(s=0,i=!1;s<this.columns&&i===!1;)this.get(t,s)===0?s++:this.get(t,s)===1&&s>e?(i=!0,e=s):(n=!1,i=!0);t++}return n}isReducedEchelonForm(){let t=0,s=0,e=-1,n=!0,i=!1;for(;t<this.rows&&n;){for(s=0,i=!1;s<this.columns&&i===!1;)this.get(t,s)===0?s++:this.get(t,s)===1&&s>e?(i=!0,e=s):(n=!1,i=!0);for(let o=s+1;o<this.rows;o++)this.get(t,o)!==0&&(n=!1);t++}return n}echelonForm(){let t=this.clone(),s=0,e=0;for(;s<t.rows&&e<t.columns;){let n=s;for(let i=s;i<t.rows;i++)t.get(i,e)>t.get(n,e)&&(n=i);if(t.get(n,e)===0)e++;else{t.swapRows(s,n);let i=t.get(s,e);for(let o=e;o<t.columns;o++)t.set(s,o,t.get(s,o)/i);for(let o=s+1;o<t.rows;o++){let a=t.get(o,e)/t.get(s,e);t.set(o,e,0);for(let c=e+1;c<t.columns;c++)t.set(o,c,t.get(o,c)-t.get(s,c)*a)}s++,e++}}return t}reducedEchelonForm(){let t=this.echelonForm(),s=t.columns,e=t.rows,n=e-1;for(;n>=0;)if(t.maxRow(n)===0)n--;else{let i=0,o=!1;for(;i<e&&o===!1;)t.get(n,i)===1?o=!0:i++;for(let a=0;a<n;a++){let c=t.get(a,i);for(let l=i;l<s;l++){let u=t.get(a,l)-c*t.get(n,l);t.set(a,l,u)}}n--}return t}set(){throw new Error("set method is unimplemented")}get(){throw new Error("get method is unimplemented")}repeat(t={}){if(typeof t!="object")throw new TypeError("options must be an object");let{rows:s=1,columns:e=1}=t;if(!Number.isInteger(s)||s<=0)throw new TypeError("rows must be a positive integer");if(!Number.isInteger(e)||e<=0)throw new TypeError("columns must be a positive integer");let n=new F(this.rows*s,this.columns*e);for(let i=0;i<s;i++)for(let o=0;o<e;o++)n.setSubMatrix(this,this.rows*i,this.columns*o);return n}fill(t){for(let s=0;s<this.rows;s++)for(let e=0;e<this.columns;e++)this.set(s,e,t);return this}neg(){return this.mulS(-1)}getRow(t){ut(this,t);let s=[];for(let e=0;e<this.columns;e++)s.push(this.get(t,e));return s}getRowVector(t){return F.rowVector(this.getRow(t))}setRow(t,s){ut(this,t),s=Pt(this,s);for(let e=0;e<this.columns;e++)this.set(t,e,s[e]);return this}swapRows(t,s){ut(this,t),ut(this,s);for(let e=0;e<this.columns;e++){let n=this.get(t,e);this.set(t,e,this.get(s,e)),this.set(s,e,n)}return this}getColumn(t){ft(this,t);let s=[];for(let e=0;e<this.rows;e++)s.push(this.get(e,t));return s}getColumnVector(t){return F.columnVector(this.getColumn(t))}setColumn(t,s){ft(this,t),s=Lt(this,s);for(let e=0;e<this.rows;e++)this.set(e,t,s[e]);return this}swapColumns(t,s){ft(this,t),ft(this,s);for(let e=0;e<this.rows;e++){let n=this.get(e,t);this.set(e,t,this.get(e,s)),this.set(e,s,n)}return this}addRowVector(t){t=Pt(this,t);for(let s=0;s<this.rows;s++)for(let e=0;e<this.columns;e++)this.set(s,e,this.get(s,e)+t[e]);return this}subRowVector(t){t=Pt(this,t);for(let s=0;s<this.rows;s++)for(let e=0;e<this.columns;e++)this.set(s,e,this.get(s,e)-t[e]);return this}mulRowVector(t){t=Pt(this,t);for(let s=0;s<this.rows;s++)for(let e=0;e<this.columns;e++)this.set(s,e,this.get(s,e)*t[e]);return this}divRowVector(t){t=Pt(this,t);for(let s=0;s<this.rows;s++)for(let e=0;e<this.columns;e++)this.set(s,e,this.get(s,e)/t[e]);return this}addColumnVector(t){t=Lt(this,t);for(let s=0;s<this.rows;s++)for(let e=0;e<this.columns;e++)this.set(s,e,this.get(s,e)+t[s]);return this}subColumnVector(t){t=Lt(this,t);for(let s=0;s<this.rows;s++)for(let e=0;e<this.columns;e++)this.set(s,e,this.get(s,e)-t[s]);return this}mulColumnVector(t){t=Lt(this,t);for(let s=0;s<this.rows;s++)for(let e=0;e<this.columns;e++)this.set(s,e,this.get(s,e)*t[s]);return this}divColumnVector(t){t=Lt(this,t);for(let s=0;s<this.rows;s++)for(let e=0;e<this.columns;e++)this.set(s,e,this.get(s,e)/t[s]);return this}mulRow(t,s){ut(this,t);for(let e=0;e<this.columns;e++)this.set(t,e,this.get(t,e)*s);return this}mulColumn(t,s){ft(this,t);for(let e=0;e<this.rows;e++)this.set(e,t,this.get(e,t)*s);return this}max(t){if(this.isEmpty())return NaN;switch(t){case"row":{let s=new Array(this.rows).fill(Number.NEGATIVE_INFINITY);for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.get(e,n)>s[e]&&(s[e]=this.get(e,n));return s}case"column":{let s=new Array(this.columns).fill(Number.NEGATIVE_INFINITY);for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.get(e,n)>s[n]&&(s[n]=this.get(e,n));return s}case void 0:{let s=this.get(0,0);for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.get(e,n)>s&&(s=this.get(e,n));return s}default:throw new Error(`invalid option: ${t}`)}}maxIndex(){Ot(this);let t=this.get(0,0),s=[0,0];for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.get(e,n)>t&&(t=this.get(e,n),s[0]=e,s[1]=n);return s}min(t){if(this.isEmpty())return NaN;switch(t){case"row":{let s=new Array(this.rows).fill(Number.POSITIVE_INFINITY);for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.get(e,n)<s[e]&&(s[e]=this.get(e,n));return s}case"column":{let s=new Array(this.columns).fill(Number.POSITIVE_INFINITY);for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.get(e,n)<s[n]&&(s[n]=this.get(e,n));return s}case void 0:{let s=this.get(0,0);for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.get(e,n)<s&&(s=this.get(e,n));return s}default:throw new Error(`invalid option: ${t}`)}}minIndex(){Ot(this);let t=this.get(0,0),s=[0,0];for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.get(e,n)<t&&(t=this.get(e,n),s[0]=e,s[1]=n);return s}maxRow(t){if(ut(this,t),this.isEmpty())return NaN;let s=this.get(t,0);for(let e=1;e<this.columns;e++)this.get(t,e)>s&&(s=this.get(t,e));return s}maxRowIndex(t){ut(this,t),Ot(this);let s=this.get(t,0),e=[t,0];for(let n=1;n<this.columns;n++)this.get(t,n)>s&&(s=this.get(t,n),e[1]=n);return e}minRow(t){if(ut(this,t),this.isEmpty())return NaN;let s=this.get(t,0);for(let e=1;e<this.columns;e++)this.get(t,e)<s&&(s=this.get(t,e));return s}minRowIndex(t){ut(this,t),Ot(this);let s=this.get(t,0),e=[t,0];for(let n=1;n<this.columns;n++)this.get(t,n)<s&&(s=this.get(t,n),e[1]=n);return e}maxColumn(t){if(ft(this,t),this.isEmpty())return NaN;let s=this.get(0,t);for(let e=1;e<this.rows;e++)this.get(e,t)>s&&(s=this.get(e,t));return s}maxColumnIndex(t){ft(this,t),Ot(this);let s=this.get(0,t),e=[0,t];for(let n=1;n<this.rows;n++)this.get(n,t)>s&&(s=this.get(n,t),e[0]=n);return e}minColumn(t){if(ft(this,t),this.isEmpty())return NaN;let s=this.get(0,t);for(let e=1;e<this.rows;e++)this.get(e,t)<s&&(s=this.get(e,t));return s}minColumnIndex(t){ft(this,t),Ot(this);let s=this.get(0,t),e=[0,t];for(let n=1;n<this.rows;n++)this.get(n,t)<s&&(s=this.get(n,t),e[0]=n);return e}diag(){let t=Math.min(this.rows,this.columns),s=[];for(let e=0;e<t;e++)s.push(this.get(e,e));return s}norm(t="frobenius"){switch(t){case"max":return this.max();case"frobenius":return Math.sqrt(this.dot(this));default:throw new RangeError(`unknown norm type: ${t}`)}}cumulativeSum(){let t=0;for(let s=0;s<this.rows;s++)for(let e=0;e<this.columns;e++)t+=this.get(s,e),this.set(s,e,t);return this}dot(t){r.isMatrix(t)&&(t=t.to1DArray());let s=this.to1DArray();if(s.length!==t.length)throw new RangeError("vectors do not have the same size");let e=0;for(let n=0;n<s.length;n++)e+=s[n]*t[n];return e}mmul(t){t=F.checkMatrix(t);let s=this.rows,e=this.columns,n=t.columns,i=new F(s,n),o=new Float64Array(e);for(let a=0;a<n;a++){for(let c=0;c<e;c++)o[c]=t.get(c,a);for(let c=0;c<s;c++){let l=0;for(let u=0;u<e;u++)l+=this.get(c,u)*o[u];i.set(c,a,l)}}return i}mpow(t){if(!this.isSquare())throw new RangeError("Matrix must be square");if(!Number.isInteger(t)||t<0)throw new RangeError("Exponent must be a non-negative integer");let s=F.eye(this.rows),e=this;for(let n=t;n>=1;n/=2)(n&1)!==0&&(s=s.mmul(e)),e=e.mmul(e);return s}strassen2x2(t){t=F.checkMatrix(t);let s=new F(2,2),e=this.get(0,0),n=t.get(0,0),i=this.get(0,1),o=t.get(0,1),a=this.get(1,0),c=t.get(1,0),l=this.get(1,1),u=t.get(1,1),h=(e+l)*(n+u),f=(a+l)*n,m=e*(o-u),d=l*(c-n),y=(e+i)*u,p=(a-e)*(n+o),g=(i-l)*(c+u),x=h+d-y+g,M=m+y,S=f+d,I=h-f+m+p;return s.set(0,0,x),s.set(0,1,M),s.set(1,0,S),s.set(1,1,I),s}strassen3x3(t){t=F.checkMatrix(t);let s=new F(3,3),e=this.get(0,0),n=this.get(0,1),i=this.get(0,2),o=this.get(1,0),a=this.get(1,1),c=this.get(1,2),l=this.get(2,0),u=this.get(2,1),h=this.get(2,2),f=t.get(0,0),m=t.get(0,1),d=t.get(0,2),y=t.get(1,0),p=t.get(1,1),g=t.get(1,2),x=t.get(2,0),M=t.get(2,1),S=t.get(2,2),I=(e+n+i-o-a-u-h)*p,E=(e-o)*(-m+p),k=a*(-f+m+y-p-g-x+S),T=(-e+o+a)*(f-m+p),C=(o+a)*(-f+m),w=e*f,b=(-e+l+u)*(f-d+g),_=(-e+l)*(d-g),v=(l+u)*(-f+d),D=(e+n+i-a-c-l-u)*g,A=u*(-f+d+y-p-g-x+M),R=(-i+u+h)*(p+x-M),P=(i-h)*(p-M),N=i*x,j=(u+h)*(-x+M),O=(-i+a+c)*(g+x-S),U=(i-c)*(g-S),B=(a+c)*(-x+S),L=n*y,V=c*M,G=o*d,q=l*m,H=h*S,J=w+N+L,Z=I+T+C+w+R+N+j,Q=w+b+v+D+N+O+B,et=E+k+T+w+N+O+U,ot=E+T+C+w+V,nt=N+O+U+B+G,st=w+b+_+A+R+P+N,ht=R+P+N+j+q,pt=w+b+_+v+H;return s.set(0,0,J),s.set(0,1,Z),s.set(0,2,Q),s.set(1,0,et),s.set(1,1,ot),s.set(1,2,nt),s.set(2,0,st),s.set(2,1,ht),s.set(2,2,pt),s}mmulStrassen(t){t=F.checkMatrix(t);let s=this.clone(),e=s.rows,n=s.columns,i=t.rows,o=t.columns;n!==i&&console.warn(`Multiplying ${e} x ${n} and ${i} x ${o} matrix: dimensions do not match.`);function a(h,f,m){let d=h.rows,y=h.columns;if(d===f&&y===m)return h;{let p=r.zeros(f,m);return p=p.setSubMatrix(h,0,0),p}}let c=Math.max(e,i),l=Math.max(n,o);s=a(s,c,l),t=a(t,c,l);function u(h,f,m,d){if(m<=512||d<=512)return h.mmul(f);m%2===1&&d%2===1?(h=a(h,m+1,d+1),f=a(f,m+1,d+1)):m%2===1?(h=a(h,m+1,d),f=a(f,m+1,d)):d%2===1&&(h=a(h,m,d+1),f=a(f,m,d+1));let y=parseInt(h.rows/2,10),p=parseInt(h.columns/2,10),g=h.subMatrix(0,y-1,0,p-1),x=f.subMatrix(0,y-1,0,p-1),M=h.subMatrix(0,y-1,p,h.columns-1),S=f.subMatrix(0,y-1,p,f.columns-1),I=h.subMatrix(y,h.rows-1,0,p-1),E=f.subMatrix(y,f.rows-1,0,p-1),k=h.subMatrix(y,h.rows-1,p,h.columns-1),T=f.subMatrix(y,f.rows-1,p,f.columns-1),C=u(r.add(g,k),r.add(x,T),y,p),w=u(r.add(I,k),x,y,p),b=u(g,r.sub(S,T),y,p),_=u(k,r.sub(E,x),y,p),v=u(r.add(g,M),T,y,p),D=u(r.sub(I,g),r.add(x,S),y,p),A=u(r.sub(M,k),r.add(E,T),y,p),R=r.add(C,_);R.sub(v),R.add(A);let P=r.add(b,v),N=r.add(w,_),j=r.sub(C,w);j.add(b),j.add(D);let O=r.zeros(2*R.rows,2*R.columns);return O=O.setSubMatrix(R,0,0),O=O.setSubMatrix(P,R.rows,0),O=O.setSubMatrix(N,0,R.columns),O=O.setSubMatrix(j,R.rows,R.columns),O.subMatrix(0,m-1,0,d-1)}return u(s,t,c,l)}scaleRows(t={}){if(typeof t!="object")throw new TypeError("options must be an object");let{min:s=0,max:e=1}=t;if(!Number.isFinite(s))throw new TypeError("min must be a number");if(!Number.isFinite(e))throw new TypeError("max must be a number");if(s>=e)throw new RangeError("min must be smaller than max");let n=new F(this.rows,this.columns);for(let i=0;i<this.rows;i++){let o=this.getRow(i);o.length>0&&hi(o,{min:s,max:e,output:o}),n.setRow(i,o)}return n}scaleColumns(t={}){if(typeof t!="object")throw new TypeError("options must be an object");let{min:s=0,max:e=1}=t;if(!Number.isFinite(s))throw new TypeError("min must be a number");if(!Number.isFinite(e))throw new TypeError("max must be a number");if(s>=e)throw new RangeError("min must be smaller than max");let n=new F(this.rows,this.columns);for(let i=0;i<this.columns;i++){let o=this.getColumn(i);o.length&&hi(o,{min:s,max:e,output:o}),n.setColumn(i,o)}return n}flipRows(){let t=Math.ceil(this.columns/2);for(let s=0;s<this.rows;s++)for(let e=0;e<t;e++){let n=this.get(s,e),i=this.get(s,this.columns-1-e);this.set(s,e,i),this.set(s,this.columns-1-e,n)}return this}flipColumns(){let t=Math.ceil(this.rows/2);for(let s=0;s<this.columns;s++)for(let e=0;e<t;e++){let n=this.get(e,s),i=this.get(this.rows-1-e,s);this.set(e,s,i),this.set(this.rows-1-e,s,n)}return this}kroneckerProduct(t){t=F.checkMatrix(t);let s=this.rows,e=this.columns,n=t.rows,i=t.columns,o=new F(s*n,e*i);for(let a=0;a<s;a++)for(let c=0;c<e;c++)for(let l=0;l<n;l++)for(let u=0;u<i;u++)o.set(n*a+l,i*c+u,this.get(a,c)*t.get(l,u));return o}kroneckerSum(t){if(t=F.checkMatrix(t),!this.isSquare()||!t.isSquare())throw new Error("Kronecker Sum needs two Square Matrices");let s=this.rows,e=t.rows,n=this.kroneckerProduct(F.eye(e,e)),i=F.eye(s,s).kroneckerProduct(t);return n.add(i)}transpose(){let t=new F(this.columns,this.rows);for(let s=0;s<this.rows;s++)for(let e=0;e<this.columns;e++)t.set(e,s,this.get(s,e));return t}sortRows(t=fi){for(let s=0;s<this.rows;s++)this.setRow(s,this.getRow(s).sort(t));return this}sortColumns(t=fi){for(let s=0;s<this.columns;s++)this.setColumn(s,this.getColumn(s).sort(t));return this}subMatrix(t,s,e,n){Bs(this,t,s,e,n);let i=new F(s-t+1,n-e+1);for(let o=t;o<=s;o++)for(let a=e;a<=n;a++)i.set(o-t,a-e,this.get(o,a));return i}subMatrixRow(t,s,e){if(s===void 0&&(s=0),e===void 0&&(e=this.columns-1),s>e||s<0||s>=this.columns||e<0||e>=this.columns)throw new RangeError("Argument out of range");let n=new F(t.length,e-s+1);for(let i=0;i<t.length;i++)for(let o=s;o<=e;o++){if(t[i]<0||t[i]>=this.rows)throw new RangeError(`Row index out of range: ${t[i]}`);n.set(i,o-s,this.get(t[i],o))}return n}subMatrixColumn(t,s,e){if(s===void 0&&(s=0),e===void 0&&(e=this.rows-1),s>e||s<0||s>=this.rows||e<0||e>=this.rows)throw new RangeError("Argument out of range");let n=new F(e-s+1,t.length);for(let i=0;i<t.length;i++)for(let o=s;o<=e;o++){if(t[i]<0||t[i]>=this.columns)throw new RangeError(`Column index out of range: ${t[i]}`);n.set(o-s,i,this.get(o,t[i]))}return n}setSubMatrix(t,s,e){if(t=F.checkMatrix(t),t.isEmpty())return this;let n=s+t.rows-1,i=e+t.columns-1;Bs(this,s,n,e,i);for(let o=0;o<t.rows;o++)for(let a=0;a<t.columns;a++)this.set(s+o,e+a,t.get(o,a));return this}selection(t,s){Gs(this,t),Ys(this,s);let e=new F(t.length,s.length);for(let n=0;n<t.length;n++){let i=t[n];for(let o=0;o<s.length;o++){let a=s[o];e.set(n,o,this.get(i,a))}}return e}trace(){let t=Math.min(this.rows,this.columns),s=0;for(let e=0;e<t;e++)s+=this.get(e,e);return s}clone(){return this.constructor.copy(this,new F(this.rows,this.columns))}static copy(t,s){for(let[e,n,i]of t.entries())s.set(e,n,i);return s}sum(t){switch(t){case"row":return go(this);case"column":return po(this);case void 0:return wo(this);default:throw new Error(`invalid option: ${t}`)}}product(t){switch(t){case"row":return yo(this);case"column":return xo(this);case void 0:return Mo(this);default:throw new Error(`invalid option: ${t}`)}}mean(t){let s=this.sum(t);switch(t){case"row":{for(let e=0;e<this.rows;e++)s[e]/=this.columns;return s}case"column":{for(let e=0;e<this.columns;e++)s[e]/=this.rows;return s}case void 0:return s/this.size;default:throw new Error(`invalid option: ${t}`)}}variance(t,s={}){if(typeof t=="object"&&(s=t,t=void 0),typeof s!="object")throw new TypeError("options must be an object");let{unbiased:e=!0,mean:n=this.mean(t)}=s;if(typeof e!="boolean")throw new TypeError("unbiased must be a boolean");switch(t){case"row":{if(!lt.isAnyArray(n))throw new TypeError("mean must be an array");return bo(this,e,n)}case"column":{if(!lt.isAnyArray(n))throw new TypeError("mean must be an array");return So(this,e,n)}case void 0:{if(typeof n!="number")throw new TypeError("mean must be a number");return Eo(this,e,n)}default:throw new Error(`invalid option: ${t}`)}}standardDeviation(t,s){typeof t=="object"&&(s=t,t=void 0);let e=this.variance(t,s);if(t===void 0)return Math.sqrt(e);for(let n=0;n<e.length;n++)e[n]=Math.sqrt(e[n]);return e}center(t,s={}){if(typeof t=="object"&&(s=t,t=void 0),typeof s!="object")throw new TypeError("options must be an object");let{center:e=this.mean(t)}=s;switch(t){case"row":{if(!lt.isAnyArray(e))throw new TypeError("center must be an array");return ko(this,e),this}case"column":{if(!lt.isAnyArray(e))throw new TypeError("center must be an array");return Io(this,e),this}case void 0:{if(typeof e!="number")throw new TypeError("center must be a number");return vo(this,e),this}default:throw new Error(`invalid option: ${t}`)}}scale(t,s={}){if(typeof t=="object"&&(s=t,t=void 0),typeof s!="object")throw new TypeError("options must be an object");let e=s.scale;switch(t){case"row":{if(e===void 0)e=To(this);else if(!lt.isAnyArray(e))throw new TypeError("scale must be an array");return _o(this,e),this}case"column":{if(e===void 0)e=Co(this);else if(!lt.isAnyArray(e))throw new TypeError("scale must be an array");return Ao(this,e),this}case void 0:{if(e===void 0)e=Ro(this);else if(typeof e!="number")throw new TypeError("scale must be a number");return Uo(this,e),this}default:throw new Error(`invalid option: ${t}`)}}toString(t){return mi(this,t)}[Symbol.iterator](){return this.entries()}*entries(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)yield[t,s,this.get(t,s)]}*values(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)yield this.get(t,s)}};K.prototype.klass="Matrix";typeof Symbol<"u"&&(K.prototype[Symbol.for("nodejs.util.inspect.custom")]=ho);function fi(r,t){return r-t}function Fo(r){return r.every(t=>typeof t=="number")}K.random=K.rand;K.randomInt=K.randInt;K.diagonal=K.diag;K.prototype.diagonal=K.prototype.diag;K.identity=K.eye;K.prototype.negate=K.prototype.neg;K.prototype.tensorProduct=K.prototype.kroneckerProduct;var F=class r extends K{data;#t(t,s){if(this.data=[],Number.isInteger(s)&&s>=0)for(let e=0;e<t;e++)this.data.push(new Float64Array(s));else throw new TypeError("nColumns must be a positive integer");this.rows=t,this.columns=s}constructor(t,s){if(super(),r.isMatrix(t))this.#t(t.rows,t.columns),r.copy(t,this);else if(Number.isInteger(t)&&t>=0)this.#t(t,s);else if(lt.isAnyArray(t)){let e=t;if(t=e.length,s=t?e[0].length:0,typeof s!="number")throw new TypeError("Data must be a 2D array with at least one element");this.data=[];for(let n=0;n<t;n++){if(e[n].length!==s)throw new RangeError("Inconsistent array dimensions");if(!Fo(e[n]))throw new TypeError("Input data contains non-numeric values");this.data.push(Float64Array.from(e[n]))}this.rows=t,this.columns=s}else throw new TypeError("First argument must be a positive number or an array")}set(t,s,e){return this.data[t][s]=e,this}get(t,s){return this.data[t][s]}removeRow(t){return ut(this,t),this.data.splice(t,1),this.rows-=1,this}addRow(t,s){return s===void 0&&(s=t,t=this.rows),ut(this,t,!0),s=Float64Array.from(Pt(this,s)),this.data.splice(t,0,s),this.rows+=1,this}removeColumn(t){ft(this,t);for(let s=0;s<this.rows;s++){let e=new Float64Array(this.columns-1);for(let n=0;n<t;n++)e[n]=this.data[s][n];for(let n=t+1;n<this.columns;n++)e[n-1]=this.data[s][n];this.data[s]=e}return this.columns-=1,this}addColumn(t,s){typeof s>"u"&&(s=t,t=this.columns),ft(this,t,!0),s=Lt(this,s);for(let e=0;e<this.rows;e++){let n=new Float64Array(this.columns+1),i=0;for(;i<t;i++)n[i]=this.data[e][i];for(n[i++]=s[e];i<this.columns+1;i++)n[i]=this.data[e][i-1];this.data[e]=n}return this.columns+=1,this}};mo(K,F);var Tt=class r extends K{#t;get size(){return this.#t.size}get rows(){return this.#t.rows}get columns(){return this.#t.columns}get diagonalSize(){return this.rows}static isSymmetricMatrix(t){return F.isMatrix(t)&&t.klassType==="SymmetricMatrix"}static zeros(t){return new this(t)}static ones(t){return new this(t).fill(1)}constructor(t){if(super(),F.isMatrix(t)){if(!t.isSymmetric())throw new TypeError("not symmetric data");this.#t=F.copy(t,new F(t.rows,t.rows))}else if(Number.isInteger(t)&&t>=0)this.#t=new F(t,t);else if(this.#t=new F(t),!this.isSymmetric())throw new TypeError("not symmetric data")}clone(){let t=new r(this.diagonalSize);for(let[s,e,n]of this.upperRightEntries())t.set(s,e,n);return t}toMatrix(){return new F(this)}get(t,s){return this.#t.get(t,s)}set(t,s,e){return this.#t.set(t,s,e),this.#t.set(s,t,e),this}removeCross(t){return this.#t.removeRow(t),this.#t.removeColumn(t),this}addCross(t,s){s===void 0&&(s=t,t=this.diagonalSize);let e=s.slice();return e.splice(t,1),this.#t.addRow(t,e),this.#t.addColumn(t,s),this}applyMask(t){if(t.length!==this.diagonalSize)throw new RangeError("Mask size do not match with matrix size");let s=[];for(let[e,n]of t.entries())n||s.push(e);s.reverse();for(let e of s)this.removeCross(e);return this}toCompact(){let{diagonalSize:t}=this,s=new Array(t*(t+1)/2);for(let e=0,n=0,i=0;i<s.length;i++)s[i]=this.get(n,e),++e>=t&&(e=++n);return s}static fromCompact(t){let s=t.length,e=(Math.sqrt(8*s+1)-1)/2;if(!Number.isInteger(e))throw new TypeError(`This array is not a compact representation of a Symmetric Matrix, ${JSON.stringify(t)}`);let n=new r(e);for(let i=0,o=0,a=0;a<s;a++)n.set(i,o,t[a]),++i>=e&&(i=++o);return n}*upperRightEntries(){for(let t=0,s=0;t<this.diagonalSize;void 0){let e=this.get(t,s);yield[t,s,e],++s>=this.diagonalSize&&(s=++t)}}*upperRightValues(){for(let t=0,s=0;t<this.diagonalSize;void 0)yield this.get(t,s),++s>=this.diagonalSize&&(s=++t)}};Tt.prototype.klassType="SymmetricMatrix";var Ze=class r extends Tt{static isDistanceMatrix(t){return Tt.isSymmetricMatrix(t)&&t.klassSubType==="DistanceMatrix"}constructor(t){if(super(t),!this.isDistance())throw new TypeError("Provided arguments do no produce a distance matrix")}set(t,s,e){return t===s&&(e=0),super.set(t,s,e)}addCross(t,s){return s===void 0&&(s=t,t=this.diagonalSize),s=s.slice(),s[t]=0,super.addCross(t,s)}toSymmetricMatrix(){return new Tt(this)}clone(){let t=new r(this.diagonalSize);for(let[s,e,n]of this.upperRightEntries())s!==e&&t.set(s,e,n);return t}toCompact(){let{diagonalSize:t}=this,s=(t-1)*t/2,e=new Array(s);for(let n=1,i=0,o=0;o<e.length;o++)e[o]=this.get(i,n),++n>=t&&(n=++i+1);return e}static fromCompact(t){let s=t.length;if(s===0)return new this(0);let e=(Math.sqrt(8*s+1)+1)/2;if(!Number.isInteger(e))throw new TypeError(`This array is not a compact representation of a DistanceMatrix, ${JSON.stringify(t)}`);let n=new this(e);for(let i=1,o=0,a=0;a<s;a++)n.set(i,o,t[a]),++i>=e&&(i=++o+1);return n}};Ze.prototype.klassSubType="DistanceMatrix";var gt=class extends K{constructor(t,s,e){super(),this.matrix=t,this.rows=s,this.columns=e}},Ns=class extends gt{constructor(t,s){ft(t,s),super(t,t.rows,1),this.column=s}set(t,s,e){return this.matrix.set(t,this.column,e),this}get(t){return this.matrix.get(t,this.column)}},js=class extends gt{constructor(t,s){Ys(t,s),super(t,t.rows,s.length),this.columnIndices=s}set(t,s,e){return this.matrix.set(t,this.columnIndices[s],e),this}get(t,s){return this.matrix.get(t,this.columnIndices[s])}},zs=class extends gt{constructor(t){super(t,t.rows,t.columns)}set(t,s,e){return this.matrix.set(t,this.columns-s-1,e),this}get(t,s){return this.matrix.get(t,this.columns-s-1)}},qs=class extends gt{constructor(t){super(t,t.rows,t.columns)}set(t,s,e){return this.matrix.set(this.rows-t-1,s,e),this}get(t,s){return this.matrix.get(this.rows-t-1,s)}},Vs=class extends gt{constructor(t,s){ut(t,s),super(t,1,t.columns),this.row=s}set(t,s,e){return this.matrix.set(this.row,s,e),this}get(t,s){return this.matrix.get(this.row,s)}},Ws=class extends gt{constructor(t,s){Gs(t,s),super(t,s.length,t.columns),this.rowIndices=s}set(t,s,e){return this.matrix.set(this.rowIndices[t],s,e),this}get(t,s){return this.matrix.get(this.rowIndices[t],s)}},Bt=class extends gt{constructor(t,s,e){Gs(t,s),Ys(t,e),super(t,s.length,e.length),this.rowIndices=s,this.columnIndices=e}set(t,s,e){return this.matrix.set(this.rowIndices[t],this.columnIndices[s],e),this}get(t,s){return this.matrix.get(this.rowIndices[t],this.columnIndices[s])}},Hs=class extends gt{constructor(t,s,e,n,i){Bs(t,s,e,n,i),super(t,e-s+1,i-n+1),this.startRow=s,this.startColumn=n}set(t,s,e){return this.matrix.set(this.startRow+t,this.startColumn+s,e),this}get(t,s){return this.matrix.get(this.startRow+t,this.startColumn+s)}},Xs=class extends gt{constructor(t){super(t,t.columns,t.rows)}set(t,s,e){return this.matrix.set(s,t,e),this}get(t,s){return this.matrix.get(s,t)}},Qe=class extends K{constructor(t,s={}){let{rows:e=1}=s;if(t.length%e!==0)throw new Error("the data length is not divisible by the number of rows");super(),this.rows=e,this.columns=t.length/e,this.data=t}set(t,s,e){let n=this._calculateIndex(t,s);return this.data[n]=e,this}get(t,s){let e=this._calculateIndex(t,s);return this.data[e]}_calculateIndex(t,s){return t*this.columns+s}},it=class extends K{constructor(t){super(),this.data=t,this.rows=t.length,this.columns=t[0].length}set(t,s,e){return this.data[t][s]=e,this}get(t,s){return this.data[t][s]}};function Do(r,t){if(lt.isAnyArray(r))return r[0]&&lt.isAnyArray(r[0])?new it(r):new Qe(r,t);throw new Error("the argument is not an array")}var Nt=class{constructor(t){t=it.checkMatrix(t);let s=t.clone(),e=s.rows,n=s.columns,i=new Float64Array(e),o=1,a,c,l,u,h,f,m,d,y;for(a=0;a<e;a++)i[a]=a;for(d=new Float64Array(e),c=0;c<n;c++){for(a=0;a<e;a++)d[a]=s.get(a,c);for(a=0;a<e;a++){for(y=Math.min(a,c),h=0,l=0;l<y;l++)h+=s.get(a,l)*d[l];d[a]-=h,s.set(a,c,d[a])}for(u=c,a=c+1;a<e;a++)Math.abs(d[a])>Math.abs(d[u])&&(u=a);if(u!==c){for(l=0;l<n;l++)f=s.get(u,l),s.set(u,l,s.get(c,l)),s.set(c,l,f);m=i[u],i[u]=i[c],i[c]=m,o=-o}if(c<e&&s.get(c,c)!==0)for(a=c+1;a<e;a++)s.set(a,c,s.get(a,c)/s.get(c,c))}this.LU=s,this.pivotVector=i,this.pivotSign=o}isSingular(){let t=this.LU,s=t.columns;for(let e=0;e<s;e++)if(t.get(e,e)===0)return!0;return!1}solve(t){t=F.checkMatrix(t);let s=this.LU;if(s.rows!==t.rows)throw new Error("Invalid matrix dimensions");if(this.isSingular())throw new Error("LU matrix is singular");let n=t.columns,i=t.subMatrixRow(this.pivotVector,0,n-1),o=s.columns,a,c,l;for(l=0;l<o;l++)for(a=l+1;a<o;a++)for(c=0;c<n;c++)i.set(a,c,i.get(a,c)-i.get(l,c)*s.get(a,l));for(l=o-1;l>=0;l--){for(c=0;c<n;c++)i.set(l,c,i.get(l,c)/s.get(l,l));for(a=0;a<l;a++)for(c=0;c<n;c++)i.set(a,c,i.get(a,c)-i.get(l,c)*s.get(a,l))}return i}get determinant(){let t=this.LU;if(!t.isSquare())throw new Error("Matrix must be square");let s=this.pivotSign,e=t.columns;for(let n=0;n<e;n++)s*=t.get(n,n);return s}get lowerTriangularMatrix(){let t=this.LU,s=t.rows,e=t.columns,n=new F(s,e);for(let i=0;i<s;i++)for(let o=0;o<e;o++)i>o?n.set(i,o,t.get(i,o)):i===o?n.set(i,o,1):n.set(i,o,0);return n}get upperTriangularMatrix(){let t=this.LU,s=t.rows,e=t.columns,n=new F(s,e);for(let i=0;i<s;i++)for(let o=0;o<e;o++)i<=o?n.set(i,o,t.get(i,o)):n.set(i,o,0);return n}get pivotPermutationVector(){return Array.from(this.pivotVector)}};function Mt(r,t){let s=0;return Math.abs(r)>Math.abs(t)?(s=t/r,Math.abs(r)*Math.sqrt(1+s*s)):t!==0?(s=r/t,Math.abs(t)*Math.sqrt(1+s*s)):0}var ne=class{constructor(t){t=it.checkMatrix(t);let s=t.clone(),e=t.rows,n=t.columns,i=new Float64Array(n),o,a,c,l;for(c=0;c<n;c++){let u=0;for(o=c;o<e;o++)u=Mt(u,s.get(o,c));if(u!==0){for(s.get(c,c)<0&&(u=-u),o=c;o<e;o++)s.set(o,c,s.get(o,c)/u);for(s.set(c,c,s.get(c,c)+1),a=c+1;a<n;a++){for(l=0,o=c;o<e;o++)l+=s.get(o,c)*s.get(o,a);for(l=-l/s.get(c,c),o=c;o<e;o++)s.set(o,a,s.get(o,a)+l*s.get(o,c))}}i[c]=-u}this.QR=s,this.Rdiag=i}solve(t){t=F.checkMatrix(t);let s=this.QR,e=s.rows;if(t.rows!==e)throw new Error("Matrix row dimensions must agree");if(!this.isFullRank())throw new Error("Matrix is rank deficient");let n=t.columns,i=t.clone(),o=s.columns,a,c,l,u;for(l=0;l<o;l++)for(c=0;c<n;c++){for(u=0,a=l;a<e;a++)u+=s.get(a,l)*i.get(a,c);for(u=-u/s.get(l,l),a=l;a<e;a++)i.set(a,c,i.get(a,c)+u*s.get(a,l))}for(l=o-1;l>=0;l--){for(c=0;c<n;c++)i.set(l,c,i.get(l,c)/this.Rdiag[l]);for(a=0;a<l;a++)for(c=0;c<n;c++)i.set(a,c,i.get(a,c)-i.get(l,c)*s.get(a,l))}return i.subMatrix(0,o-1,0,n-1)}isFullRank(){let t=this.QR.columns;for(let s=0;s<t;s++)if(this.Rdiag[s]===0)return!1;return!0}get upperTriangularMatrix(){let t=this.QR,s=t.columns,e=new F(s,s),n,i;for(n=0;n<s;n++)for(i=0;i<s;i++)n<i?e.set(n,i,t.get(n,i)):n===i?e.set(n,i,this.Rdiag[n]):e.set(n,i,0);return e}get orthogonalMatrix(){let t=this.QR,s=t.rows,e=t.columns,n=new F(s,e),i,o,a,c;for(a=e-1;a>=0;a--){for(i=0;i<s;i++)n.set(i,a,0);for(n.set(a,a,1),o=a;o<e;o++)if(t.get(a,a)!==0){for(c=0,i=a;i<s;i++)c+=t.get(i,a)*n.get(i,o);for(c=-c/t.get(a,a),i=a;i<s;i++)n.set(i,o,n.get(i,o)+c*t.get(i,a))}}return n}},kt=class{constructor(t,s={}){if(t=it.checkMatrix(t),t.isEmpty())throw new Error("Matrix must be non-empty");let e=t.rows,n=t.columns,{computeLeftSingularVectors:i=!0,computeRightSingularVectors:o=!0,autoTranspose:a=!1}=s,c=!!i,l=!!o,u=!1,h;if(e<n)if(!a)h=t.clone(),console.warn("Computing SVD on a matrix with more columns than rows. Consider enabling autoTranspose");else{h=t.transpose(),e=h.rows,n=h.columns,u=!0;let w=c;c=l,l=w}else h=t.clone();let f=Math.min(e,n),m=Math.min(e+1,n),d=new Float64Array(m),y=new F(e,f),p=new F(n,n),g=new Float64Array(n),x=new Float64Array(e),M=new Float64Array(m);for(let w=0;w<m;w++)M[w]=w;let S=Math.min(e-1,n),I=Math.max(0,Math.min(n-2,e)),E=Math.max(S,I);for(let w=0;w<E;w++){if(w<S){d[w]=0;for(let b=w;b<e;b++)d[w]=Mt(d[w],h.get(b,w));if(d[w]!==0){h.get(w,w)<0&&(d[w]=-d[w]);for(let b=w;b<e;b++)h.set(b,w,h.get(b,w)/d[w]);h.set(w,w,h.get(w,w)+1)}d[w]=-d[w]}for(let b=w+1;b<n;b++){if(w<S&&d[w]!==0){let _=0;for(let v=w;v<e;v++)_+=h.get(v,w)*h.get(v,b);_=-_/h.get(w,w);for(let v=w;v<e;v++)h.set(v,b,h.get(v,b)+_*h.get(v,w))}g[b]=h.get(w,b)}if(c&&w<S)for(let b=w;b<e;b++)y.set(b,w,h.get(b,w));if(w<I){g[w]=0;for(let b=w+1;b<n;b++)g[w]=Mt(g[w],g[b]);if(g[w]!==0){g[w+1]<0&&(g[w]=0-g[w]);for(let b=w+1;b<n;b++)g[b]/=g[w];g[w+1]+=1}if(g[w]=-g[w],w+1<e&&g[w]!==0){for(let b=w+1;b<e;b++)x[b]=0;for(let b=w+1;b<e;b++)for(let _=w+1;_<n;_++)x[b]+=g[_]*h.get(b,_);for(let b=w+1;b<n;b++){let _=-g[b]/g[w+1];for(let v=w+1;v<e;v++)h.set(v,b,h.get(v,b)+_*x[v])}}if(l)for(let b=w+1;b<n;b++)p.set(b,w,g[b])}}let k=Math.min(n,e+1);if(S<n&&(d[S]=h.get(S,S)),e<k&&(d[k-1]=0),I+1<k&&(g[I]=h.get(I,k-1)),g[k-1]=0,c){for(let w=S;w<f;w++){for(let b=0;b<e;b++)y.set(b,w,0);y.set(w,w,1)}for(let w=S-1;w>=0;w--)if(d[w]!==0){for(let b=w+1;b<f;b++){let _=0;for(let v=w;v<e;v++)_+=y.get(v,w)*y.get(v,b);_=-_/y.get(w,w);for(let v=w;v<e;v++)y.set(v,b,y.get(v,b)+_*y.get(v,w))}for(let b=w;b<e;b++)y.set(b,w,-y.get(b,w));y.set(w,w,1+y.get(w,w));for(let b=0;b<w-1;b++)y.set(b,w,0)}else{for(let b=0;b<e;b++)y.set(b,w,0);y.set(w,w,1)}}if(l)for(let w=n-1;w>=0;w--){if(w<I&&g[w]!==0)for(let b=w+1;b<n;b++){let _=0;for(let v=w+1;v<n;v++)_+=p.get(v,w)*p.get(v,b);_=-_/p.get(w+1,w);for(let v=w+1;v<n;v++)p.set(v,b,p.get(v,b)+_*p.get(v,w))}for(let b=0;b<n;b++)p.set(b,w,0);p.set(w,w,1)}let T=k-1,C=Number.EPSILON;for(;k>0;){let w,b;for(w=k-2;w>=-1&&w!==-1;w--){let _=Number.MIN_VALUE+C*Math.abs(d[w]+Math.abs(d[w+1]));if(Math.abs(g[w])<=_||Number.isNaN(g[w])){g[w]=0;break}}if(w===k-2)b=4;else{let _;for(_=k-1;_>=w&&_!==w;_--){let v=(_!==k?Math.abs(g[_]):0)+(_!==w+1?Math.abs(g[_-1]):0);if(Math.abs(d[_])<=C*v){d[_]=0;break}}_===w?b=3:_===k-1?b=1:(b=2,w=_)}switch(w++,b){case 1:{let _=g[k-2];g[k-2]=0;for(let v=k-2;v>=w;v--){let D=Mt(d[v],_),A=d[v]/D,R=_/D;if(d[v]=D,v!==w&&(_=-R*g[v-1],g[v-1]=A*g[v-1]),l)for(let P=0;P<n;P++)D=A*p.get(P,v)+R*p.get(P,k-1),p.set(P,k-1,-R*p.get(P,v)+A*p.get(P,k-1)),p.set(P,v,D)}break}case 2:{let _=g[w-1];g[w-1]=0;for(let v=w;v<k;v++){let D=Mt(d[v],_),A=d[v]/D,R=_/D;if(d[v]=D,_=-R*g[v],g[v]=A*g[v],c)for(let P=0;P<e;P++)D=A*y.get(P,v)+R*y.get(P,w-1),y.set(P,w-1,-R*y.get(P,v)+A*y.get(P,w-1)),y.set(P,v,D)}break}case 3:{let _=Math.max(Math.abs(d[k-1]),Math.abs(d[k-2]),Math.abs(g[k-2]),Math.abs(d[w]),Math.abs(g[w])),v=d[k-1]/_,D=d[k-2]/_,A=g[k-2]/_,R=d[w]/_,P=g[w]/_,N=((D+v)*(D-v)+A*A)/2,j=v*A*(v*A),O=0;(N!==0||j!==0)&&(N<0?O=0-Math.sqrt(N*N+j):O=Math.sqrt(N*N+j),O=j/(N+O));let U=(R+v)*(R-v)+O,B=R*P;for(let L=w;L<k-1;L++){let V=Mt(U,B);V===0&&(V=Number.MIN_VALUE);let G=U/V,q=B/V;if(L!==w&&(g[L-1]=V),U=G*d[L]+q*g[L],g[L]=G*g[L]-q*d[L],B=q*d[L+1],d[L+1]=G*d[L+1],l)for(let H=0;H<n;H++)V=G*p.get(H,L)+q*p.get(H,L+1),p.set(H,L+1,-q*p.get(H,L)+G*p.get(H,L+1)),p.set(H,L,V);if(V=Mt(U,B),V===0&&(V=Number.MIN_VALUE),G=U/V,q=B/V,d[L]=V,U=G*g[L]+q*d[L+1],d[L+1]=-q*g[L]+G*d[L+1],B=q*g[L+1],g[L+1]=G*g[L+1],c&&L<e-1)for(let H=0;H<e;H++)V=G*y.get(H,L)+q*y.get(H,L+1),y.set(H,L+1,-q*y.get(H,L)+G*y.get(H,L+1)),y.set(H,L,V)}g[k-2]=U;break}case 4:{if(d[w]<=0&&(d[w]=d[w]<0?-d[w]:0,l))for(let _=0;_<=T;_++)p.set(_,w,-p.get(_,w));for(;w<T&&!(d[w]>=d[w+1]);){let _=d[w];if(d[w]=d[w+1],d[w+1]=_,l&&w<n-1)for(let v=0;v<n;v++)_=p.get(v,w+1),p.set(v,w+1,p.get(v,w)),p.set(v,w,_);if(c&&w<e-1)for(let v=0;v<e;v++)_=y.get(v,w+1),y.set(v,w+1,y.get(v,w)),y.set(v,w,_);w++}k--;break}}}if(u){let w=p;p=y,y=w}this.m=e,this.n=n,this.s=d,this.U=y,this.V=p}solve(t){let s=t,e=this.threshold,n=this.s.length,i=F.zeros(n,n);for(let f=0;f<n;f++)Math.abs(this.s[f])<=e?i.set(f,f,0):i.set(f,f,1/this.s[f]);let o=this.U,a=this.rightSingularVectors,c=a.mmul(i),l=a.rows,u=o.rows,h=F.zeros(l,u);for(let f=0;f<l;f++)for(let m=0;m<u;m++){let d=0;for(let y=0;y<n;y++)d+=c.get(f,y)*o.get(m,y);h.set(f,m,d)}return h.mmul(s)}solveForDiagonal(t){return this.solve(F.diag(t))}inverse(){let t=this.V,s=this.threshold,e=t.rows,n=t.columns,i=new F(e,this.s.length);for(let u=0;u<e;u++)for(let h=0;h<n;h++)Math.abs(this.s[h])>s&&i.set(u,h,t.get(u,h)/this.s[h]);let o=this.U,a=o.rows,c=o.columns,l=new F(e,a);for(let u=0;u<e;u++)for(let h=0;h<a;h++){let f=0;for(let m=0;m<c;m++)f+=i.get(u,m)*o.get(h,m);l.set(u,h,f)}return l}get condition(){return this.s[0]/this.s[Math.min(this.m,this.n)-1]}get norm2(){return this.s[0]}get rank(){let t=Math.max(this.m,this.n)*this.s[0]*Number.EPSILON,s=0,e=this.s;for(let n=0,i=e.length;n<i;n++)e[n]>t&&s++;return s}get diagonal(){return Array.from(this.s)}get threshold(){return Number.EPSILON/2*Math.max(this.m,this.n)*this.s[0]}get leftSingularVectors(){return this.U}get rightSingularVectors(){return this.V}get diagonalMatrix(){return F.diag(this.s)}};function Oo(r,t=!1){return r=it.checkMatrix(r),t?new kt(r).inverse():gi(r,F.eye(r.rows))}function gi(r,t,s=!1){return r=it.checkMatrix(r),t=it.checkMatrix(t),s?new kt(r).solve(t):r.isSquare()?new Nt(r).solve(t):new ne(r).solve(t)}function Je(r){if(r=F.checkMatrix(r),r.isSquare()){if(r.columns===0)return 1;let t,s,e,n;if(r.columns===2)return t=r.get(0,0),s=r.get(0,1),e=r.get(1,0),n=r.get(1,1),t*n-s*e;if(r.columns===3){let i,o,a;return i=new Bt(r,[1,2],[1,2]),o=new Bt(r,[1,2],[0,2]),a=new Bt(r,[1,2],[0,1]),t=r.get(0,0),s=r.get(0,1),e=r.get(0,2),t*Je(i)-s*Je(o)+e*Je(a)}else return new Nt(r).determinant}else throw Error("determinant can only be calculated for a square matrix")}function Po(r,t){let s=[];for(let e=0;e<r;e++)e!==t&&s.push(e);return s}function Lo(r,t,s,e=1e-9,n=1e-9){if(r>n)return new Array(t.rows+1).fill(0);{let i=t.addRow(s,[0]);for(let o=0;o<i.rows;o++)Math.abs(i.get(o,0))<e&&i.set(o,0,0);return i.to1DArray()}}function Bo(r,t={}){let{thresholdValue:s=1e-9,thresholdError:e=1e-9}=t;r=F.checkMatrix(r);let n=r.rows,i=new F(n,n);for(let o=0;o<n;o++){let a=F.columnVector(r.getRow(o)),c=r.subMatrixRow(Po(n,o)).transpose(),u=new kt(c).solve(a),h=F.sub(a,c.mmul(u)).abs().max();i.setRow(o,Lo(h,u,o,s,e))}return i}function No(r,t=Number.EPSILON){if(r=F.checkMatrix(r),r.isEmpty())return r.transpose();let s=new kt(r,{autoTranspose:!0}),e=s.leftSingularVectors,n=s.rightSingularVectors,i=s.diagonal;for(let o=0;o<i.length;o++)Math.abs(i[o])>t?i[o]=1/i[o]:i[o]=0;return n.mmul(F.diag(i).mmul(e.transpose()))}function jo(r,t=r,s={}){r=new F(r);let e=!1;if(typeof t=="object"&&!F.isMatrix(t)&&!lt.isAnyArray(t)?(s=t,t=r,e=!0):t=new F(t),r.rows!==t.rows)throw new TypeError("Both matrices must have the same number of rows");let{center:n=!0}=s;n&&(r=r.center("column"),e||(t=t.center("column")));let i=r.transpose().mmul(t);for(let o=0;o<i.rows;o++)for(let a=0;a<i.columns;a++)i.set(o,a,i.get(o,a)*(1/(r.rows-1)));return i}function zo(r,t=r,s={}){r=new F(r);let e=!1;if(typeof t=="object"&&!F.isMatrix(t)&&!lt.isAnyArray(t)?(s=t,t=r,e=!0):t=new F(t),r.rows!==t.rows)throw new TypeError("Both matrices must have the same number of rows");let{center:n=!0,scale:i=!0}=s;n&&(r.center("column"),e||t.center("column")),i&&(r.scale("column"),e||t.scale("column"));let o=r.standardDeviation("column",{unbiased:!0}),a=e?o:t.standardDeviation("column",{unbiased:!0}),c=r.transpose().mmul(t);for(let l=0;l<c.rows;l++)for(let u=0;u<c.columns;u++)c.set(l,u,c.get(l,u)*(1/(o[l]*a[u]))*(1/(r.rows-1)));return c}var ts=class{constructor(t,s={}){let{assumeSymmetric:e=!1}=s;if(t=it.checkMatrix(t),!t.isSquare())throw new Error("Matrix is not a square matrix");if(t.isEmpty())throw new Error("Matrix must be non-empty");let n=t.columns,i=new F(n,n),o=new Float64Array(n),a=new Float64Array(n),c=t,l,u,h=!1;if(e?h=!0:h=t.isSymmetric(),h){for(l=0;l<n;l++)for(u=0;u<n;u++)i.set(l,u,c.get(l,u));qo(n,a,o,i),Vo(n,a,o,i)}else{let f=new F(n,n),m=new Float64Array(n);for(u=0;u<n;u++)for(l=0;l<n;l++)f.set(l,u,c.get(l,u));Wo(n,f,m,i),Ho(n,a,o,i,f)}this.n=n,this.e=a,this.d=o,this.V=i}get realEigenvalues(){return Array.from(this.d)}get imaginaryEigenvalues(){return Array.from(this.e)}get eigenvectorMatrix(){return this.V}get diagonalMatrix(){let t=this.n,s=this.e,e=this.d,n=new F(t,t),i,o;for(i=0;i<t;i++){for(o=0;o<t;o++)n.set(i,o,0);n.set(i,i,e[i]),s[i]>0?n.set(i,i+1,s[i]):s[i]<0&&n.set(i,i-1,s[i])}return n}};function qo(r,t,s,e){let n,i,o,a,c,l,u,h;for(c=0;c<r;c++)s[c]=e.get(r-1,c);for(a=r-1;a>0;a--){for(h=0,o=0,l=0;l<a;l++)h=h+Math.abs(s[l]);if(h===0)for(t[a]=s[a-1],c=0;c<a;c++)s[c]=e.get(a-1,c),e.set(a,c,0),e.set(c,a,0);else{for(l=0;l<a;l++)s[l]/=h,o+=s[l]*s[l];for(n=s[a-1],i=Math.sqrt(o),n>0&&(i=-i),t[a]=h*i,o=o-n*i,s[a-1]=n-i,c=0;c<a;c++)t[c]=0;for(c=0;c<a;c++){for(n=s[c],e.set(c,a,n),i=t[c]+e.get(c,c)*n,l=c+1;l<=a-1;l++)i+=e.get(l,c)*s[l],t[l]+=e.get(l,c)*n;t[c]=i}for(n=0,c=0;c<a;c++)t[c]/=o,n+=t[c]*s[c];for(u=n/(o+o),c=0;c<a;c++)t[c]-=u*s[c];for(c=0;c<a;c++){for(n=s[c],i=t[c],l=c;l<=a-1;l++)e.set(l,c,e.get(l,c)-(n*t[l]+i*s[l]));s[c]=e.get(a-1,c),e.set(a,c,0)}}s[a]=o}for(a=0;a<r-1;a++){if(e.set(r-1,a,e.get(a,a)),e.set(a,a,1),o=s[a+1],o!==0){for(l=0;l<=a;l++)s[l]=e.get(l,a+1)/o;for(c=0;c<=a;c++){for(i=0,l=0;l<=a;l++)i+=e.get(l,a+1)*e.get(l,c);for(l=0;l<=a;l++)e.set(l,c,e.get(l,c)-i*s[l])}}for(l=0;l<=a;l++)e.set(l,a+1,0)}for(c=0;c<r;c++)s[c]=e.get(r-1,c),e.set(r-1,c,0);e.set(r-1,r-1,1),t[0]=0}function Vo(r,t,s,e){let n,i,o,a,c,l,u,h,f,m,d,y,p,g,x,M;for(o=1;o<r;o++)t[o-1]=t[o];t[r-1]=0;let S=0,I=0,E=Number.EPSILON;for(l=0;l<r;l++){for(I=Math.max(I,Math.abs(s[l])+Math.abs(t[l])),u=l;u<r&&!(Math.abs(t[u])<=E*I);)u++;if(u>l)do{for(n=s[l],h=(s[l+1]-n)/(2*t[l]),f=Mt(h,1),h<0&&(f=-f),s[l]=t[l]/(h+f),s[l+1]=t[l]*(h+f),m=s[l+1],i=n-s[l],o=l+2;o<r;o++)s[o]-=i;for(S=S+i,h=s[u],d=1,y=d,p=d,g=t[l+1],x=0,M=0,o=u-1;o>=l;o--)for(p=y,y=d,M=x,n=d*t[o],i=d*h,f=Mt(h,t[o]),t[o+1]=x*f,x=t[o]/f,d=h/f,h=d*s[o]-x*n,s[o+1]=i+x*(d*n+x*s[o]),c=0;c<r;c++)i=e.get(c,o+1),e.set(c,o+1,x*e.get(c,o)+d*i),e.set(c,o,d*e.get(c,o)-x*i);h=-x*M*p*g*t[l]/m,t[l]=x*h,s[l]=d*h}while(Math.abs(t[l])>E*I);s[l]=s[l]+S,t[l]=0}for(o=0;o<r-1;o++){for(c=o,h=s[o],a=o+1;a<r;a++)s[a]<h&&(c=a,h=s[a]);if(c!==o)for(s[c]=s[o],s[o]=h,a=0;a<r;a++)h=e.get(a,o),e.set(a,o,e.get(a,c)),e.set(a,c,h)}}function Wo(r,t,s,e){let n=0,i=r-1,o,a,c,l,u,h,f;for(h=n+1;h<=i-1;h++){for(f=0,l=h;l<=i;l++)f=f+Math.abs(t.get(l,h-1));if(f!==0){for(c=0,l=i;l>=h;l--)s[l]=t.get(l,h-1)/f,c+=s[l]*s[l];for(a=Math.sqrt(c),s[h]>0&&(a=-a),c=c-s[h]*a,s[h]=s[h]-a,u=h;u<r;u++){for(o=0,l=i;l>=h;l--)o+=s[l]*t.get(l,u);for(o=o/c,l=h;l<=i;l++)t.set(l,u,t.get(l,u)-o*s[l])}for(l=0;l<=i;l++){for(o=0,u=i;u>=h;u--)o+=s[u]*t.get(l,u);for(o=o/c,u=h;u<=i;u++)t.set(l,u,t.get(l,u)-o*s[u])}s[h]=f*s[h],t.set(h,h-1,f*a)}}for(l=0;l<r;l++)for(u=0;u<r;u++)e.set(l,u,l===u?1:0);for(h=i-1;h>=n+1;h--)if(t.get(h,h-1)!==0){for(l=h+1;l<=i;l++)s[l]=t.get(l,h-1);for(u=h;u<=i;u++){for(a=0,l=h;l<=i;l++)a+=s[l]*e.get(l,u);for(a=a/s[h]/t.get(h,h-1),l=h;l<=i;l++)e.set(l,u,e.get(l,u)+a*s[l])}}}function Ho(r,t,s,e,n){let i=r-1,o=0,a=r-1,c=Number.EPSILON,l=0,u=0,h=0,f=0,m=0,d=0,y=0,p=0,g,x,M,S,I,E,k,T,C,w,b,_,v,D,A;for(g=0;g<r;g++)for((g<o||g>a)&&(s[g]=n.get(g,g),t[g]=0),x=Math.max(g-1,0);x<r;x++)u=u+Math.abs(n.get(g,x));for(;i>=o;){for(S=i;S>o&&(d=Math.abs(n.get(S-1,S-1))+Math.abs(n.get(S,S)),d===0&&(d=u),!(Math.abs(n.get(S,S-1))<c*d));)S--;if(S===i)n.set(i,i,n.get(i,i)+l),s[i]=n.get(i,i),t[i]=0,i--,p=0;else if(S===i-1){if(k=n.get(i,i-1)*n.get(i-1,i),h=(n.get(i-1,i-1)-n.get(i,i))/2,f=h*h+k,y=Math.sqrt(Math.abs(f)),n.set(i,i,n.get(i,i)+l),n.set(i-1,i-1,n.get(i-1,i-1)+l),T=n.get(i,i),f>=0){for(y=h>=0?h+y:h-y,s[i-1]=T+y,s[i]=s[i-1],y!==0&&(s[i]=T-k/y),t[i-1]=0,t[i]=0,T=n.get(i,i-1),d=Math.abs(T)+Math.abs(y),h=T/d,f=y/d,m=Math.sqrt(h*h+f*f),h=h/m,f=f/m,x=i-1;x<r;x++)y=n.get(i-1,x),n.set(i-1,x,f*y+h*n.get(i,x)),n.set(i,x,f*n.get(i,x)-h*y);for(g=0;g<=i;g++)y=n.get(g,i-1),n.set(g,i-1,f*y+h*n.get(g,i)),n.set(g,i,f*n.get(g,i)-h*y);for(g=o;g<=a;g++)y=e.get(g,i-1),e.set(g,i-1,f*y+h*e.get(g,i)),e.set(g,i,f*e.get(g,i)-h*y)}else s[i-1]=T+h,s[i]=T+h,t[i-1]=y,t[i]=-y;i=i-2,p=0}else{if(T=n.get(i,i),C=0,k=0,S<i&&(C=n.get(i-1,i-1),k=n.get(i,i-1)*n.get(i-1,i)),p===10){for(l+=T,g=o;g<=i;g++)n.set(g,g,n.get(g,g)-T);d=Math.abs(n.get(i,i-1))+Math.abs(n.get(i-1,i-2)),T=C=.75*d,k=-.4375*d*d}if(p===30&&(d=(C-T)/2,d=d*d+k,d>0)){for(d=Math.sqrt(d),C<T&&(d=-d),d=T-k/((C-T)/2+d),g=o;g<=i;g++)n.set(g,g,n.get(g,g)-d);l+=d,T=C=k=.964}for(p=p+1,I=i-2;I>=S&&(y=n.get(I,I),m=T-y,d=C-y,h=(m*d-k)/n.get(I+1,I)+n.get(I,I+1),f=n.get(I+1,I+1)-y-m-d,m=n.get(I+2,I+1),d=Math.abs(h)+Math.abs(f)+Math.abs(m),h=h/d,f=f/d,m=m/d,!(I===S||Math.abs(n.get(I,I-1))*(Math.abs(f)+Math.abs(m))<c*(Math.abs(h)*(Math.abs(n.get(I-1,I-1))+Math.abs(y)+Math.abs(n.get(I+1,I+1))))));)I--;for(g=I+2;g<=i;g++)n.set(g,g-2,0),g>I+2&&n.set(g,g-3,0);for(M=I;M<=i-1&&(D=M!==i-1,M!==I&&(h=n.get(M,M-1),f=n.get(M+1,M-1),m=D?n.get(M+2,M-1):0,T=Math.abs(h)+Math.abs(f)+Math.abs(m),T!==0&&(h=h/T,f=f/T,m=m/T)),T!==0);M++)if(d=Math.sqrt(h*h+f*f+m*m),h<0&&(d=-d),d!==0){for(M!==I?n.set(M,M-1,-d*T):S!==I&&n.set(M,M-1,-n.get(M,M-1)),h=h+d,T=h/d,C=f/d,y=m/d,f=f/h,m=m/h,x=M;x<r;x++)h=n.get(M,x)+f*n.get(M+1,x),D&&(h=h+m*n.get(M+2,x),n.set(M+2,x,n.get(M+2,x)-h*y)),n.set(M,x,n.get(M,x)-h*T),n.set(M+1,x,n.get(M+1,x)-h*C);for(g=0;g<=Math.min(i,M+3);g++)h=T*n.get(g,M)+C*n.get(g,M+1),D&&(h=h+y*n.get(g,M+2),n.set(g,M+2,n.get(g,M+2)-h*m)),n.set(g,M,n.get(g,M)-h),n.set(g,M+1,n.get(g,M+1)-h*f);for(g=o;g<=a;g++)h=T*e.get(g,M)+C*e.get(g,M+1),D&&(h=h+y*e.get(g,M+2),e.set(g,M+2,e.get(g,M+2)-h*m)),e.set(g,M,e.get(g,M)-h),e.set(g,M+1,e.get(g,M+1)-h*f)}}}if(u!==0){for(i=r-1;i>=0;i--)if(h=s[i],f=t[i],f===0)for(S=i,n.set(i,i,1),g=i-1;g>=0;g--){for(k=n.get(g,g)-h,m=0,x=S;x<=i;x++)m=m+n.get(g,x)*n.get(x,i);if(t[g]<0)y=k,d=m;else if(S=g,t[g]===0?n.set(g,i,k!==0?-m/k:-m/(c*u)):(T=n.get(g,g+1),C=n.get(g+1,g),f=(s[g]-h)*(s[g]-h)+t[g]*t[g],E=(T*d-y*m)/f,n.set(g,i,E),n.set(g+1,i,Math.abs(T)>Math.abs(y)?(-m-k*E)/T:(-d-C*E)/y)),E=Math.abs(n.get(g,i)),c*E*E>1)for(x=g;x<=i;x++)n.set(x,i,n.get(x,i)/E)}else if(f<0)for(S=i-1,Math.abs(n.get(i,i-1))>Math.abs(n.get(i-1,i))?(n.set(i-1,i-1,f/n.get(i,i-1)),n.set(i-1,i,-(n.get(i,i)-h)/n.get(i,i-1))):(A=Ke(0,-n.get(i-1,i),n.get(i-1,i-1)-h,f),n.set(i-1,i-1,A[0]),n.set(i-1,i,A[1])),n.set(i,i-1,0),n.set(i,i,1),g=i-2;g>=0;g--){for(w=0,b=0,x=S;x<=i;x++)w=w+n.get(g,x)*n.get(x,i-1),b=b+n.get(g,x)*n.get(x,i);if(k=n.get(g,g)-h,t[g]<0)y=k,m=w,d=b;else if(S=g,t[g]===0?(A=Ke(-w,-b,k,f),n.set(g,i-1,A[0]),n.set(g,i,A[1])):(T=n.get(g,g+1),C=n.get(g+1,g),_=(s[g]-h)*(s[g]-h)+t[g]*t[g]-f*f,v=(s[g]-h)*2*f,_===0&&v===0&&(_=c*u*(Math.abs(k)+Math.abs(f)+Math.abs(T)+Math.abs(C)+Math.abs(y))),A=Ke(T*m-y*w+f*b,T*d-y*b-f*w,_,v),n.set(g,i-1,A[0]),n.set(g,i,A[1]),Math.abs(T)>Math.abs(y)+Math.abs(f)?(n.set(g+1,i-1,(-w-k*n.get(g,i-1)+f*n.get(g,i))/T),n.set(g+1,i,(-b-k*n.get(g,i)-f*n.get(g,i-1))/T)):(A=Ke(-m-C*n.get(g,i-1),-d-C*n.get(g,i),y,f),n.set(g+1,i-1,A[0]),n.set(g+1,i,A[1]))),E=Math.max(Math.abs(n.get(g,i-1)),Math.abs(n.get(g,i))),c*E*E>1)for(x=g;x<=i;x++)n.set(x,i-1,n.get(x,i-1)/E),n.set(x,i,n.get(x,i)/E)}for(g=0;g<r;g++)if(g<o||g>a)for(x=g;x<r;x++)e.set(g,x,n.get(g,x));for(x=r-1;x>=o;x--)for(g=o;g<=a;g++){for(y=0,M=o;M<=Math.min(x,a);M++)y=y+e.get(g,M)*n.get(M,x);e.set(g,x,y)}}}function Ke(r,t,s,e){let n,i;return Math.abs(s)>Math.abs(e)?(n=e/s,i=s+n*e,[(r+n*t)/i,(t-n*r)/i]):(n=s/e,i=e+n*s,[(n*r+t)/i,(n*t-r)/i])}var es=class{constructor(t){if(t=it.checkMatrix(t),!t.isSymmetric())throw new Error("Matrix is not symmetric");let s=t,e=s.rows,n=new F(e,e),i=!0,o,a,c;for(a=0;a<e;a++){let l=0;for(c=0;c<a;c++){let u=0;for(o=0;o<c;o++)u+=n.get(c,o)*n.get(a,o);u=(s.get(a,c)-u)/n.get(c,c),n.set(a,c,u),l=l+u*u}for(l=s.get(a,a)-l,i&&=l>0,n.set(a,a,Math.sqrt(Math.max(l,0))),c=a+1;c<e;c++)n.set(a,c,0)}this.L=n,this.positiveDefinite=i}isPositiveDefinite(){return this.positiveDefinite}solve(t){t=it.checkMatrix(t);let s=this.L,e=s.rows;if(t.rows!==e)throw new Error("Matrix dimensions do not match");if(this.isPositiveDefinite()===!1)throw new Error("Matrix is not positive definite");let n=t.columns,i=t.clone(),o,a,c;for(c=0;c<e;c++)for(a=0;a<n;a++){for(o=0;o<c;o++)i.set(c,a,i.get(c,a)-i.get(o,a)*s.get(c,o));i.set(c,a,i.get(c,a)/s.get(c,c))}for(c=e-1;c>=0;c--)for(a=0;a<n;a++){for(o=c+1;o<e;o++)i.set(c,a,i.get(c,a)-i.get(o,a)*s.get(o,c));i.set(c,a,i.get(c,a)/s.get(c,c))}return i}get lowerTriangularMatrix(){return this.L}},ss=class{constructor(t,s={}){t=it.checkMatrix(t);let{Y:e}=s,{scaleScores:n=!1,maxIterations:i=1e3,terminationCriteria:o=1e-10}=s,a;if(e){if(lt.isAnyArray(e)&&typeof e[0]=="number"?e=F.columnVector(e):e=it.checkMatrix(e),e.rows!==t.rows)throw new Error("Y should have the same number of rows as X");a=e.getColumnVector(0)}else a=t.getColumnVector(0);let c=1,l,u,h,f;for(let m=0;m<i&&c>o;m++)h=t.transpose().mmul(a).div(a.transpose().mmul(a).get(0,0)),h=h.div(h.norm()),l=t.mmul(h).div(h.transpose().mmul(h).get(0,0)),m>0&&(c=l.clone().sub(f).pow(2).sum()),f=l.clone(),e?(u=e.transpose().mmul(l).div(l.transpose().mmul(l).get(0,0)),u=u.div(u.norm()),a=e.mmul(u).div(u.transpose().mmul(u).get(0,0))):a=l;if(e){let m=t.transpose().mmul(l).div(l.transpose().mmul(l).get(0,0));m=m.div(m.norm());let d=t.clone().sub(l.clone().mmul(m.transpose())),y=a.transpose().mmul(l).div(l.transpose().mmul(l).get(0,0)),p=e.clone().sub(l.clone().mulS(y.get(0,0)).mmul(u.transpose()));this.t=l,this.p=m.transpose(),this.w=h.transpose(),this.q=u,this.u=a,this.s=l.transpose().mmul(l),this.xResidual=d,this.yResidual=p,this.betas=y}else this.w=h.transpose(),this.s=l.transpose().mmul(l).sqrt(),n?this.t=l.clone().div(this.s.get(0,0)):this.t=l,this.xResidual=t.sub(l.mmul(h.transpose()))}};X.AbstractMatrix=K;X.CHO=es;X.CholeskyDecomposition=es;X.DistanceMatrix=Ze;X.EVD=ts;X.EigenvalueDecomposition=ts;X.LU=Nt;X.LuDecomposition=Nt;X.Matrix=F;X.MatrixColumnSelectionView=js;X.MatrixColumnView=Ns;X.MatrixFlipColumnView=zs;X.MatrixFlipRowView=qs;X.MatrixRowSelectionView=Ws;X.MatrixRowView=Vs;X.MatrixSelectionView=Bt;X.MatrixSubView=Hs;X.MatrixTransposeView=Xs;X.NIPALS=ss;X.Nipals=ss;X.QR=ne;X.QrDecomposition=ne;X.SVD=kt;X.SingularValueDecomposition=kt;X.SymmetricMatrix=Tt;X.WrapperMatrix1D=Qe;X.WrapperMatrix2D=it;X.correlation=zo;X.covariance=jo;X.default=F;X.determinant=Je;X.inverse=Oo;X.linearDependencies=Bo;X.pseudoInverse=No;X.solve=gi;X.wrap=Do});var z,dt,ie,dl,is,re=W(()=>{z=sr(pi(),1),dt=z.Matrix,ie=z.SingularValueDecomposition,dl=z.default.Matrix?z.default.Matrix:z.Matrix,is=z.inverse});var yi,wi,Xo,xi=W(()=>{"use strict";re();yi=(r,t)=>{let{normPoints:s,param:e}=wi(r),{normPoints:n,param:i}=wi(t),o=n.length,a=[],c=[];for(let l=0;l<o;l++){let u=[s[l][0],s[l][1],1,0,0,0,-(s[l][0]*n[l][0]),-(s[l][1]*n[l][0])],h=[0,0,0,s[l][0],s[l][1],1,-(s[l][0]*n[l][1]),-(s[l][1]*n[l][1])];a.push(u),a.push(h),c.push([n[l][0]]),c.push([n[l][1]])}try{let l=new dt(a),u=new dt(c),h=l.transpose(),f=h.mmul(l),m=h.mmul(u),y=is(f).mmul(m).to1DArray();return Xo(y,e,i)}catch{return null}},wi=r=>{let t=0,s=0;for(let c=0;c<r.length;c++)t+=r[c][0],s+=r[c][1];let e=t/r.length,n=s/r.length,i=0;for(let c=0;c<r.length;c++){let l=r[c][0]-e,u=r[c][1]-n;i+=Math.sqrt(l*l+u*u)}let o=Math.sqrt(2)*r.length/i,a=[];for(let c=0;c<r.length;c++)a.push([(r[c][0]-e)*o,(r[c][1]-n)*o]);return{normPoints:a,param:{meanX:e,meanY:n,s:o}}},Xo=(r,t,s)=>{let e=s.s*s.meanX,n=s.s*s.meanY,i=[r[0]+e*r[6],r[1]+e*r[7],(r[0]+e*r[6])*-t.meanX+(r[1]+e*r[7])*-t.meanY+(r[2]+e)/t.s,r[3]+n*r[6],r[4]+n*r[7],(r[3]+n*r[6])*-t.meanX+(r[4]+n*r[7])*-t.meanY+(r[5]+n)/t.s,s.s*r[6],s.s*r[7],s.s*r[6]*-t.meanX+s.s*r[7]*-t.meanY+s.s/t.s];for(let o=0;o<9;o++)i[o]=i[o]/i[8];return i}});var Go,Yo,$o,Ko,$s,Jo,Zo,Qo,ta,Mi=W(()=>{"use strict";As();Ls();xi();Go=.01,Yo=10,$o=100,Ko=50,$s=r=>{let{srcPoints:t,dstPoints:s,keyframe:e,quickMode:n}=r,i=[[0,0],[e.width,0],[e.width,e.height],[0,e.height]],o=4;if(t.length<o)return null;let a=Go,c=1/(a*a),l=Math.min(Yo,t.length),u=Oe(),h=[];for(let M=0;M<t.length;M++)h[M]=M;u.arrayShuffle({arr:h,sampleSize:h.length});let f=n?Ko:$o,m=f*2,d=0,y=[];for(;d<m&&y.length<f;){if(d+=1,u.arrayShuffle({arr:h,sampleSize:o}),!Jn(t[h[0]],t[h[1]],t[h[2]],t[h[3]],s[h[0]],s[h[1]],s[h[2]],s[h[3]]))continue;let M=yi([t[h[0]],t[h[1]],t[h[2]],t[h[3]]],[s[h[0]],s[h[1]],s[h[2]],s[h[3]]]);M!==null&&ta({H:M,testPoints:i})&&y.push(M)}if(y.length===0)return null;let p=[];for(let M=0;M<y.length;M++)p.push({H:y[M],cost:0});let g=l;for(let M=0;M<t.length&&p.length>2;M+=g){g=Math.min(l,t.length-M);let S=M+g;for(let I=0;I<p.length;I++)for(let E=M;E<S;E++){let k=Qo({H:p[I].H,srcPoint:t[E],dstPoint:s[E],oneOverScale2:c});p[I].cost+=k}p.sort((I,E)=>I.cost-E.cost),p.splice(-Math.floor((p.length+1)/2))}let x=null;for(let M=0;M<p.length;M++){let S=Zo({inH:p[M].H});if(Jo({H:S,testPoints:i,keyframe:e})){x=S;break}}return x},Jo=({H:r,testPoints:t,keyframe:s})=>{let e=[];for(let i=0;i<t.length;i++)e.push(Xe(t[i],r));return!(ti(e[0],e[1],e[2],e[3])<s.width*s.height*1e-4||!ei(e[0],e[1],e[2],e[3]))},Zo=({inH:r})=>{let t=1/r[8],s=[];for(let e=0;e<8;e++)s[e]=r[e]*t;return s[8]=1,s},Qo=({H:r,srcPoint:t,dstPoint:s,oneOverScale2:e})=>{let n=Xe(t,r),i=[n[0]-s[0],n[1]-s[1]];return Math.log(1+(i[0]*i[0]+i[1]*i[1])*e)},ta=({H:r,testPoints:t})=>{let s=[];for(let e=0;e<t.length;e++)s[e]=Xe(t[e],r);for(let e=0;e<t.length;e++){let n=e,i=(e+1)%t.length,o=(e+2)%t.length;if(!Zn(t[n],t[i],t[o],s[n],s[i],s[o]))return!1}return!0}});function bi({imageData:r,width:t,height:s,targetData:e,initialH:n,iterations:i=3}){let o=[...n],a=[],c=.05;for(let l=0;l<=1;l+=c)a.push({x:l*e.w,y:0}),a.push({x:l*e.w,y:e.h}),a.push({x:0,y:l*e.h}),a.push({x:e.w,y:l*e.h});for(let l=0;l<i;l++){let u=[];for(let f of a){let m=o[6]*f.x+o[7]*f.y+o[8],d=(o[0]*f.x+o[1]*f.y+o[2])/m,y=(o[3]*f.x+o[4]*f.y+o[5])/m;if(d<2||d>=t-2||y<2||y>=s-2)continue;let p=10,g=d,x=y,M=-1;for(let S=-p;S<=p;S+=2)for(let I=-p;I<=p;I+=2){let E=Math.floor(d+I),k=Math.floor(y+S),T=k*t+E,C=r[T+1]-r[T-1],w=r[T+t]-r[T-t],b=C*C+w*w;b>M&&(M=b,g=E,x=k)}M>500&&u.push({src:f,dst:{x:g,y:x},weight:Math.min(1,M/15e3)})}if(u.length<10)break;let h=ea(u);if(h)for(let f=0;f<9;f++)o[f]=o[f]*.5+h[f]*.5}return o}function ea(r){let t=r.length,s=new dt(t*2,9);for(let e=0;e<t;e++){let{src:n,dst:i,weight:o}=r[e],a=n.x,c=n.y,l=i.x,u=i.y;s.set(e*2,0,0),s.set(e*2,1,0),s.set(e*2,2,0),s.set(e*2,3,-a*o),s.set(e*2,4,-c*o),s.set(e*2,5,-o),s.set(e*2,6,u*a*o),s.set(e*2,7,u*c*o),s.set(e*2,8,u*o),s.set(e*2+1,0,a*o),s.set(e*2+1,1,c*o),s.set(e*2+1,2,o),s.set(e*2+1,3,0),s.set(e*2+1,4,0),s.set(e*2+1,5,0),s.set(e*2+1,6,-l*a*o),s.set(e*2+1,7,-l*c*o),s.set(e*2+1,8,-l*o)}try{let i=new ie(s).rightSingularVectors.getColumn(8),o=1/i[8];return i.map(a=>a*o)}catch{return null}}var Si=W(()=>{"use strict";re()});var Ei,Ks,sa,na,ia,ki,vi,Js,Ii,Ti=W(()=>{"use strict";$n();Cs();Kn();Mi();Ls();Si();Us();At();Ei=Y.INLIER_THRESHOLD,Ks=Y.MIN_NUM_INLIERS,sa=Y.CLUSTER_MAX_POP,na=Y.HAMMING_THRESHOLD,ia=Y.HDC_RATIO_THRESHOLD,ki=Y.MAX_MATCH_QUERY_POINTS,vi=({keyframe:r,querypoints:t,querywidth:s,queryheight:e,debugMode:n,expectedScale:i})=>{let o={},a=t.length>ki?[...t].sort((O,U)=>(U.score||U.response||0)-(O.score||O.response||0)).slice(0,ki):t,c=[],l=a.length,u=r.max,h=r.min,f=r.hdc===!0||u&&u.hdc===1,m=u&&u.compact===1||h&&h.compact===1,d=f||m?1:2,y=f?ia:na;for(let O=0;O<l;O++){let U=a[O],B=U.maxima?u:h;if(!B||B.x.length===0)continue;let L=B.t,V=[],G=new te([],(ot,nt)=>ot.d-nt.d);Js({node:L,descriptors:B.d,querypoint:U,queue:G,keypointIndexes:V,numPop:0,isHDC:f,descSize:d,isCompact:m});let q=-1,H=Number.MAX_SAFE_INTEGER,J=Number.MAX_SAFE_INTEGER,Z=U.descriptors,Q=B.d,et=m&&Z&&Z.length>=2?(Z[0]^Z[1])>>>0:0;for(let ot=0;ot<V.length;ot++){let nt=V[ot];if(i!==void 0&&B.s){let ht=B.s[nt],pt=(U.scale||1)/i;if(ht<pt*.4||ht>pt*2.5)continue}let st;f?st=Et(Q[nt]^U.hdcSignature):m?st=Et(Q[nt]^et):st=De({v1:Q,v1Offset:nt*d,v2:Z}),st<H?(J=H,H=st,q=nt):st<J&&(J=st)}q!==-1&&(J===Number.MAX_SAFE_INTEGER||H/J<y)&&c.push({querypoint:U,keypoint:{x:B.x[q],y:B.y[q],angle:B.a[q],scale:B.s?B.s[q]:r.s},d:H})}if(c.length<Ks)return{debugExtra:o};let p=c;n&&(o.constellationMatches=p);let g=Ps({keywidth:r.w||r.width,keyheight:r.h||r.height,querywidth:s,queryheight:e,matches:p});if(n&&(o.houghMatches=g),g.length<Ks)return{debugExtra:o};let x=$s({srcPoints:g.map(O=>[O.keypoint.x,O.keypoint.y]),dstPoints:g.map(O=>[O.querypoint.x,O.querypoint.y]),keyframe:{width:r.w||r.width,height:r.h||r.height}});if(x===null)return{debugExtra:o};let M=Ii({H:x,matches:g,threshold:Ei});if(n&&(o.inlierMatches=M),M.length<Ks)return{debugExtra:o};n&&Math.random()<.02&&console.log(`MATCH: Homography success with ${M.length} inliers`);let S=Qn(x,1e-5),I=100,E=[],k=S[0],T=S[1],C=S[2],w=S[3],b=S[4],_=S[5],v=S[6],D=S[7],A=S[8];for(let O=0;O<l;O++){let U=a[O],B=U.x,L=U.y,G=1/(B*v+L*D+A),q=(B*k+L*T+C)*G,H=(B*w+L*b+_)*G,J=-1,Z=Number.MAX_SAFE_INTEGER,Q=Number.MAX_SAFE_INTEGER,et=U.maxima?u:h;if(!et)continue;let ot=et.x,nt=et.y,st=et.d,ht=U.descriptors,pt=m&&ht&&ht.length>=2?(ht[0]^ht[1])>>>0:0;for(let wt=0,qt=ot.length;wt<qt;wt++){let xe=ot[wt]-q,Ct=nt[wt]-H;if(xe*xe+Ct*Ct>I)continue;let mt;f?mt=Et(st[wt]^U.hdcSignature):m?mt=Et(st[wt]^pt):mt=De({v1:st,v1Offset:wt*d,v2:ht}),mt<Z?(Q=Z,Z=mt,J=wt):mt<Q&&(Q=mt)}J!==-1&&(Q===Number.MAX_SAFE_INTEGER||Z/Q<y)&&E.push({querypoint:U,keypoint:{x:et.x[J],y:et.y[J],angle:et.a[J],scale:et.s?et.s[J]:r.s}})}n&&(o.matches2=E);let R=Ps({keywidth:r.w||r.width,keyheight:r.h||r.height,querywidth:s,queryheight:e,matches:E});n&&(o.houghMatches2=R);let P=$s({srcPoints:R.map(O=>[O.keypoint.x,O.keypoint.y]),dstPoints:R.map(O=>[O.querypoint.x,O.querypoint.y]),keyframe:{width:r.w||r.width,height:r.h||r.height}});if(P===null)return{debugExtra:o};let N=Ii({H:P,matches:R,threshold:Ei});return n&&(o.inlierMatches2=N),{H:bi({imageData:t[0].imageData,width:s,height:e,targetData:{w:r.w||r.width,h:r.h||r.height},initialH:P,iterations:3})||P,matches:N,debugExtra:o}},Js=({node:r,descriptors:t,querypoint:s,queue:e,keypointIndexes:n,numPop:i,isHDC:o,descSize:a,isCompact:c})=>{let l=r[0]===1,u=r[2];if(l){for(let p=0;p<u.length;p++)n.push(u[p]);return}let h=s.descriptors,f=c&&h&&h.length>=2?(h[0]^h[1])>>>0:0,m=Number.MAX_SAFE_INTEGER,d=u.length,y=new Int32Array(d);for(let p=0;p<d;p++){let x=u[p][1],M;o?M=Et(t[x]^s.hdcSignature):c?M=Et(t[x]^f):M=De({v1:t,v1Offset:x*a,v2:h}),y[p]=M,M<m&&(m=M)}for(let p=0;p<d;p++){let g=y[p];g<=m?Js({node:u[p],descriptors:t,querypoint:s,queue:e,keypointIndexes:n,numPop:i+1,isHDC:o,descSize:a,isCompact:c}):e.push({node:u[p],d:g})}if(i<sa&&e.length>0){let{node:p}=e.pop();Js({node:p,descriptors:t,querypoint:s,queue:e,keypointIndexes:n,numPop:i+1,isHDC:o,descSize:a,isCompact:c})}},Ii=r=>{let{H:t,matches:s,threshold:e}=r,n=e*e,i=t[0],o=t[1],a=t[2],c=t[3],l=t[4],u=t[5],h=t[6],f=t[7],m=t[8],d=[];for(let y=0;y<s.length;y++){let p=s[y],g=p.querypoint,x=p.keypoint,S=1/(x.x*h+x.y*f+m),I=(x.x*i+x.y*o+a)*S,E=(x.x*c+x.y*l+u)*S,k=I-g.x,T=E-g.y;k*k+T*T<=n&&d.push(p)}return d}});var _i={};ls(_i,{Matcher:()=>oe});var oe,Zs=W(()=>{"use strict";Ti();oe=class{constructor(t,s,e=!1){this.queryWidth=t,this.queryHeight=s,this.debugMode=e}matchDetection(t,s,e){let n={frames:[]},i=null;if(!t||!Array.isArray(t))return{targetIndex:-1,keyframeIndex:-1,debugExtra:n};for(let u=0;u<t.length;u++){let{H:h,matches:f,debugExtra:m}=vi({keyframe:t[u],querypoints:s,querywidth:this.queryWidth,queryheight:this.queryHeight,debugMode:this.debugMode,expectedScale:e});m&&(m.keyframeIndex=u,n.frames.push(m)),h&&(i===null||i.matches.length<f.length)&&(i={keyframeIndex:u,H:h,matches:f})}if(i===null)return{targetIndex:-1,keyframeIndex:-1,debugExtra:n};let o=[],a=[],c=t[i.keyframeIndex],l=c.s||c.scale||1;for(let u=0;u<i.matches.length;u++){let h=i.matches[u].querypoint,f=i.matches[u].keypoint,m=f.scale||l;o.push({x:h.x,y:h.y}),a.push({x:(f.x+.5)/l,y:(f.y+.5)/l,z:0})}return{screenCoords:o,worldCoords:a,targetIndex:-1,keyframeIndex:i.keyframeIndex,H:i.H,debugExtra:n}}}});function Ci({screenCoords:r,worldCoords:t,projectionTransform:s}){let e=new dt(s),n=r.length,i=ra(s),o=new dt(n*2,9);for(let E=0;E<n;E++){let k=r[E],T=t[E],C=i[0]*k.x+i[1]*k.y+i[2],w=i[3]*k.x+i[4]*k.y+i[5],b=i[6]*k.x+i[7]*k.y+i[8],_=C/b,v=w/b,D=T.x,A=T.y;o.set(E*2,0,D),o.set(E*2,1,A),o.set(E*2,2,1),o.set(E*2,3,0),o.set(E*2,4,0),o.set(E*2,5,0),o.set(E*2,6,-_*D),o.set(E*2,7,-_*A),o.set(E*2,8,-_),o.set(E*2+1,0,0),o.set(E*2+1,1,0),o.set(E*2+1,2,0),o.set(E*2+1,3,D),o.set(E*2+1,4,A),o.set(E*2+1,5,1),o.set(E*2+1,6,-v*D),o.set(E*2+1,7,-v*A),o.set(E*2+1,8,-v)}let l=new ie(o).rightSingularVectors.getColumn(8);if(l[8]<0)for(let E=0;E<9;E++)l[E]=-l[E];let u=[l[0],l[3],l[6]],h=[l[1],l[4],l[7]],f=[l[2],l[5],l[8]],m=Math.sqrt(u[0]**2+u[1]**2+u[2]**2),d=Math.sqrt(h[0]**2+h[1]**2+h[2]**2),y=(m+d)/2,p=new dt([[u[0]/m,h[0]/d,0],[u[1]/m,h[1]/d,0],[u[2]/m,h[2]/d,0]]);p.set(0,2,p.get(1,0)*p.get(2,1)-p.get(2,0)*p.get(1,1)),p.set(1,2,p.get(2,0)*p.get(0,1)-p.get(0,0)*p.get(2,1)),p.set(2,2,p.get(0,0)*p.get(1,1)-p.get(1,0)*p.get(0,1));let g=new ie(p),x=g.leftSingularVectors,M=g.rightSingularVectors,S=x.mmul(M.transpose());if((E=>E.get(0,0)*(E.get(1,1)*E.get(2,2)-E.get(1,2)*E.get(2,1))-E.get(0,1)*(E.get(1,0)*E.get(2,2)-E.get(1,2)*E.get(2,0))+E.get(0,2)*(E.get(1,0)*E.get(2,1)-E.get(1,1)*E.get(2,0)))(S)<0){let E=x.clone();for(let k=0;k<3;k++)E.set(k,2,-E.get(k,2));S=E.mmul(M.transpose())}return[[S.get(0,0),S.get(0,1),S.get(0,2),f[0]/y],[S.get(1,0),S.get(1,1),S.get(1,2),f[1]/y],[S.get(2,0),S.get(2,1),S.get(2,2),f[2]/y]]}function ra(r){let t=r[0][0],s=r[0][1],e=r[0][2],n=r[1][0],i=r[1][1],o=r[1][2],a=r[2][0],c=r[2][1],l=r[2][2],h=1/(t*(i*l-c*o)-s*(n*l-o*a)+e*(n*c-i*a));return[(i*l-o*c)*h,(e*c-s*l)*h,(s*o-e*i)*h,(o*a-n*l)*h,(t*l-e*a)*h,(n*e-t*o)*h,(n*c-i*a)*h,(a*s-c*t)*h,(t*i-n*s)*h]}var Ai=W(()=>{"use strict";re()});var Ri,Ui=W(()=>{"use strict";Ai();Ri=({screenCoords:r,worldCoords:t,projectionTransform:s})=>Ci({screenCoords:r,worldCoords:t,projectionTransform:s})});var oa,aa,Fi,ca,la,rt,_t,tt,Di,ha,ua,fa,da,Oi=W(()=>{"use strict";re();Ds();oa=5,aa=4,Fi=10,ca=.1,la=.99,rt=[[],[],[]],_t=[[],[]],tt=[[],[],[]],Di=({initialModelViewTransform:r,projectionTransform:t,worldCoords:s,screenCoords:e,stabilities:n})=>{let i=0,o=0;for(let f=0;f<s.length;f++)i+=s[f].x,o+=s[f].y;i/=s.length,o/=s.length;let a=[];for(let f=0;f<s.length;f++)a.push({x:s[f].x-i,y:s[f].y-o,z:s[f].z});let c=[[],[],[]];for(let f=0;f<3;f++)for(let m=0;m<3;m++)c[f][m]=r[f][m];c[0][3]=r[0][0]*i+r[0][1]*o+r[0][3],c[1][3]=r[1][0]*i+r[1][1]*o+r[1][3],c[2][3]=r[2][0]*i+r[2][1]*o+r[2][3];let l=[1,.8,.6,.4,0],u=c,h=null;for(let f=0;f<l.length;f++){let m=ha({initialModelViewTransform:u,projectionTransform:t,worldCoords:a,screenCoords:e,stabilities:n,inlierProb:l[f]});if(u=m.modelViewTransform,m.err<oa){h=u;break}}return h===null?null:(h[0][3]=h[0][3]-h[0][0]*i-h[0][1]*o,h[1][3]=h[1][3]-h[1][0]*i-h[1][1]*o,h[2][3]=h[2][3]-h[2][0]*i-h[2][1]*o,h)},ha=({initialModelViewTransform:r,projectionTransform:t,worldCoords:s,screenCoords:e,stabilities:n,inlierProb:i})=>{let o=i<1,a=r,c=0,l=0,u=new Array(s.length),h=new Array(s.length),f=new Array(s.length),m=new Array(s.length);for(let d=0;d<=Fi;d++){let y=Le(t,a);for(let S=0;S<s.length;S++){let I=vt(y,s[S].x,s[S].y,s[S].z),E=e[S].x-I.x,k=e[S].y-I.y;f[S]=E,m[S]=k,u[S]=E*E+k*k}let p;if(l=0,o){let S=Math.max(3,Math.floor(s.length*i)-1);for(let I=0;I<s.length;I++)h[I]=u[I];h.sort((I,E)=>I-E),p=Math.max(h[S]*aa,16);for(let I=0;I<s.length;I++)h[I]>p?l+=p/6:l+=p/6*(1-(1-h[I]/p)*(1-h[I]/p)*(1-h[I]/p))}else for(let S=0;S<s.length;S++)l+=u[S];if(l/=s.length,l<ca||d>0&&l/c>la||d===Fi)break;c=l;let g=[],x=[];for(let S=0;S<s.length;S++){if(o&&u[S]>p)continue;let I=da({modelViewProjectionTransform:y,modelViewTransform:a,projectionTransform:t,worldCoord:s[S]});if(o){let E=(1-u[S]/p)*(1-u[S]/p),k=n?n[S]:1,T=k*Math.log10(9*k+1),C=E*T;for(let w=0;w<2;w++)for(let b=0;b<6;b++)I[w][b]*=C;g.push([f[S]*C]),g.push([m[S]*C])}else{let E=n?n[S]:1,k=E*Math.log10(9*E+1);for(let T=0;T<2;T++)for(let C=0;C<6;C++)I[T][C]*=k;g.push([f[S]*k]),g.push([m[S]*k])}for(let E=0;E<I.length;E++)x.push(I[E])}let M=fa({dU:g,J_U_S:x});if(M===null)break;a=ua({modelViewTransform:a,dS:M})}return{modelViewTransform:a,err:l}},ua=({modelViewTransform:r,dS:t})=>{let s=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],e,n,i;s<1e-6?(e=1,n=0,i=0,s=0):(s=Math.sqrt(s),e=t[0]/s,n=t[1]/s,i=t[2]/s);let o=Math.cos(s),a=Math.sin(s),c=1-o;rt[0][0]=e*e*c+o,rt[0][1]=e*n*c-i*a,rt[0][2]=e*i*c+n*a,rt[0][3]=t[3],rt[1][0]=n*e*c+i*a,rt[1][1]=n*n*c+o,rt[1][2]=n*i*c-e*a,rt[1][3]=t[4],rt[2][0]=i*e*c-n*a,rt[2][1]=i*n*c+e*a,rt[2][2]=i*i*c+o,rt[2][3]=t[5];let l=[[],[],[]];for(let u=0;u<3;u++){for(let h=0;h<4;h++)l[u][h]=r[u][0]*rt[0][h]+r[u][1]*rt[1][h]+r[u][2]*rt[2][h];l[u][3]+=r[u][3]}return l},fa=({dU:r,J_U_S:t})=>{let s=new dt(t),e=new dt(r),n=s.transpose(),i=n.mmul(s),o=n.mmul(e),a;try{a=is(i)}catch{return null}return a.mmul(o).to1DArray()},da=({modelViewProjectionTransform:r,modelViewTransform:t,projectionTransform:s,worldCoord:e})=>{let n=t,{x:i,y:o,z:a}=e,c=Fs(r,i,o,a),l=c.z*c.z;_t[0][0]=s[0][0]*c.z/l,_t[0][1]=s[0][1]*c.z/l,_t[0][2]=(s[0][2]*c.z-s[2][2]*c.x)/l,_t[1][0]=s[1][0]*c.z/l,_t[1][1]=s[1][1]*c.z/l,_t[1][2]=(s[1][2]*c.z-s[2][2]*c.y)/l,tt[0][0]=n[0][2]*o,tt[0][1]=-n[0][2]*i,tt[0][2]=n[0][1]*i-n[0][0]*o,tt[0][3]=n[0][0],tt[0][4]=n[0][1],tt[0][5]=n[0][2],tt[1][0]=n[1][2]*o,tt[1][1]=-n[1][2]*i,tt[1][2]=n[1][1]*i-n[1][0]*o,tt[1][3]=n[1][0],tt[1][4]=n[1][1],tt[1][5]=n[1][2],tt[2][0]=n[2][2]*o,tt[2][1]=-n[2][2]*i,tt[2][2]=n[2][1]*i-n[2][0]*o,tt[2][3]=n[2][0],tt[2][4]=n[2][1],tt[2][5]=n[2][2];let u=[[],[]];for(let h=0;h<2;h++)for(let f=0;f<6;f++){u[h][f]=0;for(let m=0;m<3;m++)u[h][f]+=_t[h][m]*tt[m][f]}return u}});var Qs={};ls(Qs,{Estimator:()=>ae});var ae,rs=W(()=>{"use strict";Ui();Oi();ae=class{constructor(t){this.projectionTransform=t}estimate({screenCoords:t,worldCoords:s}){return Ri({screenCoords:t,worldCoords:s,projectionTransform:this.projectionTransform})}refineEstimate({initialModelViewTransform:t,worldCoords:s,screenCoords:e}){return Di({initialModelViewTransform:t,worldCoords:s,screenCoords:e,projectionTransform:this.projectionTransform})}}});var ma={};var Pi,tn,Li,en,Bi,Ni,ji=W(()=>{"use strict";Zs();rs();Os();Zt();Pi=null,tn=!1,Li=null,en=null,Bi=null,Ni=null;onmessage=r=>{let{data:t}=r;switch(t.type){case"setup":Pi=t.matchingDataList,tn=t.debugMode,Li=new oe(t.inputWidth,t.inputHeight,tn),en=new ae(t.projectionTransform),t.trackingDataList&&t.markerDimensions&&(Bi=new Dt(t.markerDimensions,t.trackingDataList,t.projectionTransform,t.inputWidth,t.inputHeight,tn)),Ni=new xt(t.inputWidth,t.inputHeight,{useLSH:!0,maxFeaturesPerBucket:24});break;case"match":let s=t.targetIndexes,e=-1,n=null,i=null,o=null,a=null,c=t.featurePoints;t.inputData&&(c=Ni.detect(t.inputData,{octavesToProcess:t.octavesToProcess}).featurePoints);for(let x=0;x<s.length;x++){let M=s[x],{keyframeIndex:S,screenCoords:I,worldCoords:E,debugExtra:k}=Li.matchDetection(Pi[M],c,t.expectedScale);if(a=k,S!==-1){let T=en.estimate({screenCoords:I,worldCoords:E});T&&(e=M,n=T,i=I,o=E);break}}postMessage({type:"matchDone",targetIndex:e,modelViewTransform:n,screenCoords:i,worldCoords:o,featurePoints:c,debugExtra:a});break;case"track":let{inputData:l,lastModelViewTransform:u,targetIndex:h}=t,f=Bi.track(l,u,h);postMessage({type:"trackDone",targetIndex:h,...f});break;case"trackUpdate":let{modelViewTransform:m,worldCoords:d,screenCoords:y,stabilities:p}=t,g=en.refineEstimate({initialModelViewTransform:m,worldCoords:d,screenCoords:y,stabilities:p});postMessage({type:"trackUpdateDone",modelViewTransform:g});break;case"dispose":close();break;default:throw new Error(`Invalid message type '${t.type}'`)}}});var nr=({image:r})=>{let{data:t,width:s,height:e}=r,n=s>>>1,i=e>>>1,o=new Uint8Array(n*i);for(let a=0;a<i;a++){let c=a*2*s,l=c+s,u=a*n;for(let h=0;h<n;h++){let f=h*2,m=t[c+f]+t[c+f+1]+t[l+f]+t[l+f+1]>>2;o[u+h]=m&255}}return{data:o,width:n,height:i}},hs=({image:r,ratio:t})=>{if(t===1)return{data:new Uint8Array(r.data),width:r.width,height:r.height};if(t<=.5)return hs({image:nr({image:r}),ratio:t*2});let s=Math.round(r.width*t)|0,e=Math.round(r.height*t)|0,n=new Uint8Array(s*e),i=r.data,o=r.width|0,a=r.height|0,c=o-1|0,l=a-1|0,u=0;for(let h=0;h<e;h++){let f=h/t,m=f|0,d=(m<l?m+1:l)|0,y=f-m,p=1-y,g=m*o|0,x=d*o|0;for(let M=0;M<s;M++){let S=M/t,I=S|0,E=(I<c?I+1:c)|0,k=S-I,T=1-k,C=i[g+I]*T+i[g+E]*k,w=i[x+I]*T+i[x+E]*k,b=C*p+w*y;n[u++]=b|0}}return{data:n,width:s,height:e}};At();var Ua=Y.MIN_IMAGE_PIXEL_SIZE;var ln=r=>{let t=Math.min(r.width,r.height),s=[],e=[];s.push(Y.TRACKING_DOWNSCALE_LEVEL_1/t),s.push(Y.TRACKING_DOWNSCALE_LEVEL_2/t);for(let n=0;n<s.length;n++)e.push(Object.assign(hs({image:r,ratio:s[n]}),{scale:s[n]}));return e};var Wt=class{constructor(t,s,e){this.width=s,this.height=e,this.cumsum=new Int32Array(s*e),this.cumsum[0]=t[0];for(let n=1;n<s;n++)this.cumsum[n]=this.cumsum[n-1]+t[n];for(let n=1;n<e;n++)this.cumsum[n*s]=this.cumsum[(n-1)*s]+t[n*s];for(let n=1;n<e;n++)for(let i=1;i<s;i++){let o=n*s+i;this.cumsum[o]=t[o]+this.cumsum[(n-1)*s+i]+this.cumsum[n*s+i-1]-this.cumsum[(n-1)*s+i-1]}}query(t,s,e,n){let{width:i}=this,o=this.cumsum[n*i+e];return s>0&&(o-=this.cumsum[(s-1)*i+e]),t>0&&(o-=this.cumsum[n*i+t-1]),t>0&&s>0&&(o+=this.cumsum[(s-1)*i+t-1]),o}};fs();var bt=10,St=2,$=6,lr=4;var ds=.9,hr=.2;var hn=8,ur=!0;var fn=r=>{let{data:t,width:s,height:e}=r,n,i;if(ur){let k=Me.edgeDetection(t,s,e);n=k.dValue,i=k.isCandidate}else{n=new Float32Array(t.length),i=new Uint8Array(t.length);for(let k=1;k<e-1;k++){let T=k*s,C=(k-1)*s,w=(k+1)*s;for(let b=1;b<s-1;b++){let _=T+b,v=(t[C+b+1]-t[C+b-1]+t[T+b+1]-t[T+b-1]+t[w+b+1]-t[w+b-1])/768,D=(t[w+b-1]-t[C+b-1]+t[w+b]-t[C+b]+t[w+b+1]-t[C+b+1])/768;n[_]=Math.sqrt((v*v+D*D)/2)}}for(let k=1;k<e-1;k++){let T=k*s;for(let C=1;C<s-1;C++){let w=T+C,b=n[w];b>0&&b>=n[w-1]&&b>=n[w+1]&&b>=n[w-s]&&b>=n[w+s]&&(i[w]=1)}}}let o=new Uint32Array(1e3),a=0;for(let k=1;k<e-1;k++){let T=k*s;for(let C=1;C<s-1;C++){let w=T+C;if(i[w]){let b=n[w],_=Math.floor(b*1e3);_>999&&(_=999),o[_]++,a++}}}let c=.1*s*e,l=999,u=0;for(;l>=0&&(u+=o[l],!(u>c));)l--;let h=l/1e3,f=new Float32Array(t.length);for(let k=0;k<t.length;k++)f[k]=t[k]*t[k];let m=new Wt(t,s,e),d=new Wt(f,s,e),y=[];for(let k=0;k<t.length;k++)i[k]&&n[k]>=h&&y.push({pos:k,dval:n[k],x:k%s,y:Math.floor(k/s)});y.sort((k,T)=>T.dval-k.dval);let p=($*2+1)*3,g=Math.floor(s/hn)*Math.floor(e/hn)+Math.floor(s/p)*Math.floor(e/p),x=[],M=new Uint8Array(s*e),S=2*$+1,I=S*S,E=Math.floor(Math.min(s,e)/12);for(let k=0;k<y.length;k++){let{x:T,y:C,pos:w}=y[k];if(M[w]||T<$+bt||T>=s-$-bt||C<$+bt||C>=e-$-bt)continue;let b=fr({image:r,cx:T,cy:C,sdThresh:lr,imageDataCumsum:m,imageDataSqrCumsum:d});if(b===null)continue;let _=m.query(T-$,C-$,T+$,C+$)/I,v=new Uint8Array(S*S),D=0,A=(C-$)*s+(T-$);for(let P=0;P<S;P++){let N=A+P*s;for(let j=0;j<S;j++)v[D++]=t[N+j]}let R=-1;for(let P=-bt;P<=bt;P++){for(let N=-bt;N<=bt;N++){if(N*N+P*P<=St*St)continue;let j=un({image:r,cx:T+N,cy:C+P,vlen:b,templateData:v,templateAvg:_,templateWidth:S,imageDataCumsum:m,imageDataSqrCumsum:d,width:s,height:e});if(j!==null&&j>R&&(R=j,R>ds))break}if(R>ds)break}if(R<ds){let P=1,N=-1,j=!1;for(let O=-St;O<=St;O++){for(let U=-St;U<=St;U++){if(U*U+O*O>St*St||U===0&&O===0)continue;let B=un({image:r,vlen:b,cx:T+U,cy:C+O,templateData:v,templateAvg:_,templateWidth:S,imageDataCumsum:m,imageDataSqrCumsum:d,width:s,height:e});if(B!==null&&(B<P&&(P=B),B>N&&(N=B),P<hr||N>.99)){j=!0;break}}if(j)break}if(!j){x.push({x:T,y:C});for(let O=-E;O<=E;O++){let U=C+O;if(U<0||U>=e)continue;let B=U*s;for(let L=-E;L<=E;L++){let V=T+L;V<0||V>=s||(M[B+V]=1)}}}}if(x.length>=g)break}return x},fr=({image:r,cx:t,cy:s,sdThresh:e,imageDataCumsum:n,imageDataSqrCumsum:i})=>{if(t-$<0||t+$>=r.width||s-$<0||s+$>=r.height)return null;let o=2*$+1,a=o*o,c=n.query(t-$,s-$,t+$,s+$);c/=a;let l=i.query(t-$,s-$,t+$,s+$);return l-=2*c*n.query(t-$,s-$,t+$,s+$),l+=a*c*c,l/a<e*e?null:(l=Math.sqrt(l),l)},un=r=>{let{cx:t,cy:s,vlen:e,templateData:n,templateAvg:i,templateWidth:o,imageDataCumsum:a,imageDataSqrCumsum:c,width:l,height:u}=r,h=r.image.data,f=(o-1)/2;if(t-f<0||t+f>=l||s-f<0||s+f>=u)return null;let m=o*o,d=a.query(t-f,s-f,t+f,s+f),p=c.query(t-f,s-f,t+f,s+f)-d*d/m;if(p<=0)return null;p=Math.sqrt(p);let g=0,x=(s-f)*l+(t-f);for(let E=0;E<o;E++){let k=x+E*l,T=E*o;for(let C=0;C<o;C++)g+=h[k+C]*n[T+C]}let M=o*o,S=o*o;return g*=S/M,1*(g-i*d)/(e*p)};var dn=(r,t)=>{let s=[];for(let e=0;e<r.length;e++){let n=r[e],i=fn(n),o={data:n.data,scale:n.scale,width:n.width,height:n.height,points:i};s.push(o),t(e)}return s};Zt();Us();Ut();function Vn(r){if(r.length<3)return[];let t=1/0,s=1/0,e=-1/0,n=-1/0;for(let d of r)d.x<t&&(t=d.x),d.x>e&&(e=d.x),d.y<s&&(s=d.y),d.y>n&&(n=d.y);let i=e-t,o=n-s,a=Math.max(i,o),c=(t+e)/2,l=(s+n)/2,u={x:c-20*a,y:l-a},h={x:c,y:l+20*a},f={x:c+20*a,y:l-a},m=[{p1:u,p2:h,p3:f,indices:[-1,-2,-3]}];for(let d=0;d<r.length;d++){let y=r[d],p=[];for(let x of m)Xr(y,x)&&p.push(x);let g=[];for(let x of p){let M=[{a:x.p1,b:x.p2,i1:x.indices[0],i2:x.indices[1]},{a:x.p2,b:x.p3,i1:x.indices[1],i2:x.indices[2]},{a:x.p3,b:x.p1,i1:x.indices[2],i2:x.indices[0]}];for(let S of M){let I=!1;for(let E of p)if(x!==E&&Gr(S,E)){I=!0;break}I||g.push(S)}}m=m.filter(x=>!p.includes(x));for(let x of g)m.push({p1:x.a,p2:x.b,p3:y,indices:[x.i1,x.i2,d]})}return m.filter(d=>d.indices[0]>=0&&d.indices[1]>=0&&d.indices[2]>=0).map(d=>d.indices)}function Xr(r,t){let s=t.p1.x,e=t.p1.y,n=t.p2.x,i=t.p2.y,o=t.p3.x,a=t.p3.y,c=2*(s*(i-a)+n*(a-e)+o*(e-i)),l=((s*s+e*e)*(i-a)+(n*n+i*i)*(a-e)+(o*o+a*a)*(e-i))/c,u=((s*s+e*e)*(o-n)+(n*n+i*i)*(s-o)+(o*o+a*a)*(n-s))/c,h=(s-l)*(s-l)+(e-u)*(e-u);return(r.x-l)*(r.x-l)+(r.y-u)*(r.y-u)<=h}function Gr(r,t){let s=[[t.indices[0],t.indices[1]],[t.indices[1],t.indices[2]],[t.indices[2],t.indices[0]]];for(let e of s)if(r.i1===e[0]&&r.i2===e[1]||r.i1===e[1]&&r.i2===e[0])return!0;return!1}function Wn(r){let t=new Set,s=[];for(let e of r){let n=[[e[0],e[1]],[e[1],e[2]],[e[2],e[0]]];for(let i of n){let o=Math.min(i[0],i[1]),a=Math.max(i[0],i[1]),c=`${o}-${a}`;t.has(c)||(t.add(c),s.push([o,a]))}}return s}At();var Vc=typeof process<"u"&&process.versions!=null&&process.versions.node!=null,Pe=class{data=null;constructor(){console.log("\u26A1 OfflineCompiler: Main thread mode (no workers)")}async compileImageTargets(t,s){console.time("\u23F1\uFE0F Compilaci\xF3n total");let e=[];for(let i=0;i<t.length;i++){let o=t[i];if(!o||!o.width||!o.height||!o.data)throw new Error(`Imagen inv\xE1lida en posici\xF3n ${i}. Debe tener propiedades width, height y data.`);let a=new Uint8Array(o.width*o.height);if(o.data.length===o.width*o.height)a.set(o.data);else if(o.data.length===o.width*o.height*4)for(let c=0;c<a.length;c++){let l=c*4;a[c]=Math.floor((o.data[l]+o.data[l+1]+o.data[l+2])/3)}else throw new Error(`Formato de datos de imagen no soportado en posici\xF3n ${i}`);e.push({data:a,width:o.width,height:o.height})}let n=await this._compileTarget(e,s);return this.data=e.map((i,o)=>({targetImage:i,matchingData:n[o].matchingData,trackingData:n[o].trackingData})),console.timeEnd("\u23F1\uFE0F Compilaci\xF3n total"),this.data}async _compileTarget(t,s){let e=await this._compileMatch(t,i=>s(i*.5)),n=await this._compileTrack(t,i=>s(50+i*.5));return t.map((i,o)=>({matchingData:e[o],trackingData:n[o]}))}async _compileMatch(t,s){let e=100/t.length,n=0,i=[];for(let o=0;o<t.length;o++){let a=t[o],c=new xt(a.width,a.height,{useLSH:Y.USE_LSH,maxFeaturesPerBucket:Y.MAX_FEATURES_PER_BUCKET}),{featurePoints:l}=c.detect(a.data),u=[0,1,2,3,4,5],h=[],f=300;for(let x of u){let M=Math.pow(2,x),S=l.filter(I=>Math.abs(I.scale-M)<.1).sort((I,E)=>(E.score||0)-(I.score||0)).slice(0,f);h.push(...S)}let m=h.filter(x=>x.maxima),d=h.filter(x=>!x.maxima),y=Rs({points:m}),p=Rs({points:d}),g={maximaPoints:m,minimaPoints:d,maximaPointsCluster:y,minimaPointsCluster:p,width:a.width,height:a.height,scale:1};i.push([g]),n+=e,s(n)}return i}async _compileTrack(t,s){let e=100/t.length,n=0,i=[];for(let o=0;o<t.length;o++){let a=t[o],c=ln(a),l=e/c.length,u=dn(c,()=>{n+=l,s(n)});i.push(u)}return i}async compileTrack({progressCallback:t,targetImages:s,basePercent:e=0}){return this._compileTrack(s,n=>{t(e+n*(100-e)/100)})}async compileMatch({progressCallback:t,targetImages:s,basePercent:e=0}){return this._compileMatch(s,n=>{t(e+n*(50-e)/100)})}exportData(){if(!this.data)throw new Error("No hay datos compilados para exportar");let t=this.data.map(s=>({targetImage:{width:s.targetImage.width,height:s.targetImage.height},trackingData:s.trackingData.map(e=>{let n=e.points.length,i=new Float32Array(n),o=new Float32Array(n);for(let u=0;u<n;u++)i[u]=e.points[u].x,o[u]=e.points[u].y;let a=Vn(e.points),c=Wn(a),l=new Float32Array(c.length);for(let u=0;u<c.length;u++){let h=e.points[c[u][0]],f=e.points[c[u][1]];l[u]=Math.sqrt((h.x-f.x)**2+(h.y-f.y)**2)}return{w:e.width,h:e.height,s:e.scale,px:i,py:o,d:e.data,mesh:{t:new Uint16Array(a.flat()),e:new Uint16Array(c.flat()),rl:l}}}),matchingData:s.matchingData.map(e=>{let i=Y.USE_COMPACT_DESCRIPTORS?vs:Is;return{w:e.width,h:e.height,s:e.scale,hdc:!1,max:i(e.maximaPoints,e.maximaPointsCluster,e.width,e.height),min:i(e.minimaPoints,e.minimaPointsCluster,e.width,e.height)}})}));return Ts(t)}importData(t){let s=Kt(t);return this.data=s.dataList,s}async destroy(){}};Os();var Be=class{constructor(t,s){if(this.width=t,this.height=s,this.grayscaleBuffer=new Uint8Array(t*s),typeof document<"u"){let e=document.createElement("canvas");e.width=t,e.height=s,this.context=e.getContext("2d",{willReadFrequently:!0,alpha:!1})}}loadInput(t){if(t instanceof Uint8Array&&t.length===this.width*this.height)return t;if(typeof ImageData<"u"&&t instanceof ImageData)return this._convertToGrayscale(t.data,t.width,t.height),this.grayscaleBuffer;if(this.context){this.context.clearRect(0,0,this.width,this.height);let s=t.width===this.height&&t.height===this.width,e=s?t.height:t.width,n=s?t.width:t.height,i=e/n,o=this.width/this.height,a=0,c=0,l=e,u=n;i>o?(l=n*o,a=(e-l)/2):i<o&&(u=e/o,c=(n-u)/2),s?(this.context.save(),this.context.translate(this.width/2,this.height/2),this.context.rotate(Math.PI/2),this.context.drawImage(t,a,c,l,u,-this.height/2,-this.width/2,this.height,this.width),this.context.restore()):this.context.drawImage(t,a,c,l,u,0,0,this.width,this.height);let h=this.context.getImageData(0,0,this.width,this.height);return this._convertToGrayscale(h.data,this.width,this.height),this.grayscaleBuffer}if(t.data&&t.data instanceof Uint8Array)return this._convertToGrayscale(t.data,t.width||this.width,t.height||this.height),this.grayscaleBuffer;throw new Error("Input no soportado o entorno sin Canvas")}_convertToGrayscale(t,s,e){let n=this.grayscaleBuffer,i=s*e;for(let o=0;o<i;o++){let a=o<<2;n[o]=t[a]*77+t[a+1]*150+t[a+2]*29>>8}}};var Ne=class{features=[];addFeature(t){this.features.push(t)}getFeature(t){return this.features.find(s=>s.id===t)}init(t){for(let s of this.features)s.enabled&&s.init&&s.init(t)}beforeProcess(t){for(let s of this.features)s.enabled&&s.beforeProcess&&s.beforeProcess(t)}applyWorldMatrixFilters(t,s,e){let n=s;for(let i of this.features)i.enabled&&i.filterWorldMatrix&&(n=i.filterWorldMatrix(t,n,e));return n}shouldShow(t,s){let e=s;for(let n of this.features)n.enabled&&n.shouldShow&&(e=n.shouldShow(t,s));return e}notifyUpdate(t){for(let s of this.features)s.enabled&&s.onUpdate&&s.onUpdate(t)}dispose(){for(let t of this.features)t.dispose&&t.dispose()}};var je=class{constructor(t,s=0){this.y=s,this.s=s,this.alpha=t}setAlpha(t){t<=0||t>1||(this.alpha=t)}filter(t){return this.y=t,this.s=this.alpha*t+(1-this.alpha)*this.s,this.s}filterWithAlpha(t,s){return this.setAlpha(s),this.filter(t)}lastValue(){return this.y}},ze=class{constructor({minCutOff:t=1,beta:s=0,dCutOff:e=1}){this.minCutOff=t,this.beta=s,this.dCutOff=e,this.x=null,this.dx=null,this.lastTime=null}_alpha(t,s){return 1/(1+1/(2*Math.PI*t)/s)}reset(){this.lastTime=null,this.x=null,this.dx=null}filter(t,s){if(this.lastTime===null||this.x===null)return this.lastTime=t,this.x=s.map(i=>new je(this._alpha(this.minCutOff,1),i)),this.dx=s.map(i=>new je(this._alpha(this.dCutOff,1),0)),s;let e=(t-this.lastTime)/1e3;if(e<=0)return s;this.lastTime=t;let n=[];for(let i=0;i<s.length;i++){let o=(s[i]-this.x[i].lastValue())/e,a=this._alpha(this.dCutOff,e),c=this.dx[i].filterWithAlpha(o,a),l=this.minCutOff+this.beta*Math.abs(c),u=this._alpha(l,e);n[i]=this.x[i].filterWithAlpha(s[i],u)}return n}};var qe=class{id="one-euro-filter";name="One Euro Filter";description="Smooths the tracking matrix to reduce jitter using a One Euro Filter.";enabled=!0;filters=[];minCutOff;beta;constructor(t=.5,s=.1){this.minCutOff=t,this.beta=s}init(t){}getFilter(t){return this.filters[t]||(this.filters[t]=new ze({minCutOff:this.minCutOff,beta:this.beta})),this.filters[t]}filterWorldMatrix(t,s,e){if(!this.enabled)return s;let n=this.getFilter(t),i=e?.stability??1,o=this.minCutOff*(.05+Math.pow(i,2)*.95);return n.minCutOff=o,n.beta=this.beta,n.filter(Date.now(),s)}onUpdate(t){t.type==="reset"&&t.targetIndex!==void 0&&this.filters[t.targetIndex]?.reset()}};var Ve=class{id="temporal-filter";name="Temporal Filter";description="Provides warmup tolerance (to avoid false positives) and miss tolerance (to maintain tracking during brief occlusions).";enabled=!0;states=[];warmupTolerance;missTolerance;onToggleShowing;constructor(t=2,s=5,e){this.warmupTolerance=t,this.missTolerance=s,this.onToggleShowing=e}getState(t){return this.states[t]||(this.states[t]={showing:!1,trackCount:0,trackMiss:0}),this.states[t]}shouldShow(t,s){if(!this.enabled)return s;let e=this.getState(t);return e.showing?s?e.trackMiss=0:(e.trackCount=0,e.trackMiss+=1,e.trackMiss>this.missTolerance&&(e.showing=!1,this.onToggleShowing?.(t,!1))):s?(e.trackMiss=0,e.trackCount+=1,e.trackCount>this.warmupTolerance&&(e.showing=!0,this.onToggleShowing?.(t,!0))):e.trackCount=0,e.showing}};var We=class{id="auto-rotation";name="Auto Rotation Matrix";description="Automatically adjusts the world matrix if the input video is rotated (e.g. portrait mode).";enabled=!0;inputWidth=0;inputHeight=0;init(t){this.inputWidth=t.inputWidth,this.inputHeight=t.inputHeight}filterWorldMatrix(t,s){return this.enabled,s}rotate(t){return[-t[1],t[0],t[2],t[3],-t[5],t[4],t[6],t[7],-t[9],t[8],t[10],t[11],-t[13],t[12],t[14],t[15]]}};Zt();Ut();At();var nn,ga=async()=>{if(typeof Worker>"u")return null;try{return(await Promise.resolve().then(()=>(ji(),ma))).default}catch{return null}};nn=await ga();var pa=Y.ONE_EURO_FILTER_CUTOFF,wa=Y.ONE_EURO_FILTER_BETA,ya=Y.WARMUP_TOLERANCE,xa=Y.MISS_TOLERANCE,sn=1e3,zi=0,ce=class{inputWidth;inputHeight;maxTrack=1;inputLoader;markerDimensions=null;onUpdate;debugMode;processingVideo=!1;interestedTargetIndex=-1;trackingStates=[];worker;projectionTransform;projectionMatrix;tracker=null;matchingDataList;workerMatchDone=null;workerTrackDone=null;workerFullTrackDone=null;mainThreadMatcher;mainThreadEstimator;featureManager;fullDetector=null;constructor({inputWidth:t,inputHeight:s,onUpdate:e=null,debugMode:n=!1,maxTrack:i,warmupTolerance:o=null,missTolerance:a=null,filterMinCF:c=null,filterBeta:l=null,worker:u=null}){this.inputWidth=t,this.inputHeight=s,i!==void 0&&(this.maxTrack=i),this.featureManager=new Ne,this.featureManager.addFeature(new qe(c===null?pa:c,l===null?wa:l)),this.featureManager.addFeature(new Ve(o===null?ya:o,a===null?xa:a)),this.featureManager.addFeature(new We),this.inputLoader=new Be(this.inputWidth,this.inputHeight),this.onUpdate=e,this.debugMode=n,this.worker=u,this.worker&&this._setupWorkerListener(),this.fullDetector=new xt(this.inputWidth,this.inputHeight,{useLSH:Y.USE_LSH,maxFeaturesPerBucket:Y.MAX_FEATURES_PER_BUCKET}),this.featureManager.init({inputWidth:this.inputWidth,inputHeight:this.inputHeight,projectionTransform:[],debugMode:this.debugMode});let h=Y.DEFAULT_NEAR,f=Y.DEFAULT_FAR,m=Y.DEFAULT_FOVY*Math.PI/180,d=this.inputHeight/2/Math.tan(m/2);this.projectionTransform=[[d,0,this.inputWidth/2],[0,d,this.inputHeight/2],[0,0,1]],this.featureManager.init({inputWidth:this.inputWidth,inputHeight:this.inputHeight,projectionTransform:this.projectionTransform,debugMode:this.debugMode}),this.projectionMatrix=this._glProjectionMatrix({projectionTransform:this.projectionTransform,width:this.inputWidth,height:this.inputHeight,near:h,far:f})}_setupWorkerListener(){this.worker&&(this.worker.onmessage=t=>{t.data.type==="matchDone"&&this.workerMatchDone!==null&&this.workerMatchDone(t.data),t.data.type==="trackDone"&&this.workerFullTrackDone!==null&&this.workerFullTrackDone(t.data),t.data.type==="trackUpdateDone"&&this.workerTrackDone!==null&&this.workerTrackDone(t.data)})}_ensureWorker(){this.worker||nn&&typeof Worker<"u"&&(this.worker=new nn,this._setupWorkerListener())}async addImageTargets(t){let s=Array.isArray(t)?t:[t],e=await Promise.all(s.map(async n=>(await fetch(n)).arrayBuffer()));return this.addImageTargetsFromBuffers(e)}addImageTargetsFromBuffers(t){let s=[],e=[],n=[];for(let i of t){let a=Kt(i).dataList||[];for(let c of a)e.push(c.matchingData),s.push(c.trackingData),n.push([c.targetImage.width,c.targetImage.height])}return this.tracker=new Dt(n,s,this.projectionTransform,this.inputWidth,this.inputHeight,this.debugMode),this._ensureWorker(),this.worker&&this.worker.postMessage({type:"setup",inputWidth:this.inputWidth,inputHeight:this.inputHeight,projectionTransform:this.projectionTransform,debugMode:this.debugMode,matchingDataList:e,trackingDataList:s,markerDimensions:n}),this.markerDimensions=n,this.matchingDataList=e,this.maxTrack=n.length,{dimensions:n,matchingDataList:e,trackingDataList:s}}addImageTargetsFromBuffer(t){return this.addImageTargetsFromBuffers([t])}dispose(){this.stopProcessVideo(),this.worker&&(this.worker.postMessage({type:"dispose"}),this.worker=null)}dummyRun(t){let s=this.inputLoader.loadInput(t);this.fullDetector?.detect(s),this.tracker.dummyRun(s)}getProjectionMatrix(){return this.projectionMatrix}getRotatedZ90Matrix(t){return[-t[1],t[0],t[2],t[3],-t[5],t[4],t[6],t[7],-t[9],t[8],t[10],t[11],-t[13],t[12],t[14],t[15]]}getWorldMatrix(t,s){return this._glModelViewMatrix(t,s)}async _detectAndMatch(t,s){let e;for(let l of this.trackingStates)if(l.isTracking&&l.currentModelViewTransform){let u=l.currentModelViewTransform;e=Math.sqrt(u[0][0]**2+u[1][0]**2+u[2][0]**2);break}let{targetIndex:n,modelViewTransform:i,screenCoords:o,worldCoords:a,featurePoints:c}=await this._workerMatch(null,s,t,e);return{targetIndex:n,modelViewTransform:i,screenCoords:o,worldCoords:a,featurePoints:c}}async _trackAndUpdate(t,s,e){let{worldCoords:n,screenCoords:i,reliabilities:o,indices:a=[],octaveIndex:c=0,deformedMesh:l}=await this._workerTrack(t,s,e);if(!n||n.length===0)return{modelViewTransform:null,screenCoords:[],reliabilities:[],stabilities:[],deformedMesh:null};let u=this.trackingStates[e];if(u.pointStabilities||(u.pointStabilities=[]),u.lastScreenCoords||(u.lastScreenCoords=[]),!u.pointStabilities[c]){let I=this.tracker.prebuiltData[e][c].px.length;u.pointStabilities[c]=new Float32Array(I).fill(0),u.lastScreenCoords[c]=new Array(I).fill(null)}let h=u.pointStabilities[c],f=u.lastScreenCoords[c];for(let I=0;I<h.length;I++)if(a.includes(I)){let k=a.indexOf(I);h[I]=Math.min(1,h[I]+.4),f[I]=i[k]}else h[I]=Math.max(0,h[I]-.08);let m=[],d=[],y=[],p=[];for(let I=0;I<h.length;I++)if(h[I]>0){let E=a.includes(I);if(m.push({x:f[I].x,y:f[I].y,id:I}),y.push(h[I]),E){let k=a.indexOf(I);d.push(o[k]),p.push(n[k])}else d.push(0)}let g=u.trackCount<15;return p.length<(g?4:5)?{modelViewTransform:null,screenCoords:m,reliabilities:d,stabilities:y}:(u.trackCount++,{modelViewTransform:await this._workerTrackUpdate(s,{worldCoords:p,screenCoords:p.map((I,E)=>{let k=a[E];return f[k]}),stabilities:p.map((I,E)=>{let k=a[E];return h[k]}),deformedMesh:l}),screenCoords:m,reliabilities:d,stabilities:y,deformedMesh:l,octaveIndex:c})}processVideo(t){if(this.processingVideo)return;this.processingVideo=!0;let s=++zi;this.trackingStates=[];for(let n=0;n<(this.markerDimensions?.length||0);n++)this.trackingStates.push({showing:!1,isTracking:!1,currentModelViewTransform:null,trackCount:0,trackMiss:0});(async()=>{for(;!(!this.processingVideo||s!==zi);){let n=this.inputLoader.loadInput(t);if(this.trackingStates.reduce((o,a)=>o+(a.isTracking?1:0),0)<this.maxTrack){let o=[];for(let u=0;u<this.trackingStates.length;u++)this.trackingStates[u].isTracking!==!0&&(this.interestedTargetIndex!==-1&&this.interestedTargetIndex!==u||o.push(u));let{targetIndex:a,modelViewTransform:c,featurePoints:l}=await this._detectAndMatch(n,o);a!==-1&&(this.trackingStates[a].isTracking=!0,this.trackingStates[a].currentModelViewTransform=c),this.onUpdate&&this.onUpdate({type:"featurePoints",featurePoints:l})}for(let o=0;o<this.trackingStates.length;o++){let a=this.trackingStates[o];if(a.isTracking){let l=await this._trackAndUpdate(n,a.currentModelViewTransform,o);l===null||l.modelViewTransform===null?(a.isTracking=!1,a.screenCoords=l?.screenCoords||[],a.reliabilities=l?.reliabilities||[],a.stabilities=l?.stabilities||[]):(a.currentModelViewTransform=l.modelViewTransform,a.screenCoords=l.screenCoords,a.reliabilities=l.reliabilities,a.stabilities=l.stabilities,a.deformedMesh=l.deformedMesh)}let c=a.showing;if(a.showing=this.featureManager.shouldShow(o,a.isTracking),c&&!a.showing&&(a.trackingMatrix=null,this.featureManager.notifyUpdate({type:"reset",targetIndex:o})),a.showing||a.screenCoords&&a.screenCoords.length>0||c&&!a.showing){let l=a.showing?this._glModelViewMatrix(a.currentModelViewTransform,o):null,u=null;if(l){let h=a.stabilities||[],f=h.length>0?h.reduce((y,p)=>y+p,0)/h.length:0,m=this.featureManager.applyWorldMatrixFilters(o,l,{stability:f});if(a.trackingMatrix=m,u=[...m],t.width===this.inputHeight&&t.height===this.inputWidth){let y=this.featureManager.getFeature("auto-rotation");y&&(u=y.rotate(u))}}this.onUpdate&&this.onUpdate({type:"updateMatrix",targetIndex:o,worldMatrix:u,modelViewTransform:a.currentModelViewTransform,screenCoords:a.screenCoords,reliabilities:a.reliabilities,stabilities:a.stabilities,deformedMesh:a.deformedMesh})}}this.onUpdate&&this.onUpdate({type:"processDone"}),typeof requestAnimationFrame<"u"?await new Promise(requestAnimationFrame):await new Promise(o=>setTimeout(o,16))}})()}stopProcessVideo(){this.processingVideo=!1}async detect(t){let s=this.inputLoader.loadInput(t),{featurePoints:e}=this.fullDetector.detect(s);return{featurePoints:e,debugExtra:{}}}async match(t,s){let{targetIndex:e,modelViewTransform:n,screenCoords:i,worldCoords:o,debugExtra:a}=await this._workerMatch(t,[s]);return{targetIndex:e,modelViewTransform:n,screenCoords:i,worldCoords:o,debugExtra:a}}async track(t,s,e){let n=this.inputLoader.loadInput(t);return this.tracker.track(n,s,e)}async trackUpdate(t,s){return s.worldCoords.length<4?null:this._workerTrackUpdate(t,s)}_workerMatch(t,s,e=null,n){return new Promise(i=>{if(!this.worker){let a;!t&&e?a=Promise.resolve(this.fullDetector.detect(e).featurePoints):a=Promise.resolve(t),a.then(c=>{this._matchOnMainThread(c,s,n).then(i)}).catch(()=>i({targetIndex:-1}));return}let o=setTimeout(()=>{this.workerMatchDone=null,i({targetIndex:-1})},sn);this.workerMatchDone=a=>{clearTimeout(o),this.workerMatchDone=null,i({targetIndex:a.targetIndex,modelViewTransform:a.modelViewTransform,screenCoords:a.screenCoords,worldCoords:a.worldCoords,featurePoints:a.featurePoints,debugExtra:a.debugExtra})},e?this.worker.postMessage({type:"match",inputData:e,targetIndexes:s,expectedScale:n}):this.worker.postMessage({type:"match",featurePoints:t,targetIndexes:s,expectedScale:n})})}_workerTrack(t,s,e){return new Promise(n=>{if(!this.worker){n(this.tracker.track(t,s,e));return}let i=setTimeout(()=>{this.workerFullTrackDone=null,n({worldCoords:[],screenCoords:[],reliabilities:[]})},sn);this.workerFullTrackDone=o=>{clearTimeout(i),this.workerFullTrackDone=null,n(o)},this.worker.postMessage({type:"track",inputData:t,lastModelViewTransform:s,targetIndex:e})})}async _matchOnMainThread(t,s,e){if(!this.mainThreadMatcher){let{Matcher:l}=await Promise.resolve().then(()=>(Zs(),_i)),{Estimator:u}=await Promise.resolve().then(()=>(rs(),Qs));this.mainThreadMatcher=new l(this.inputWidth,this.inputHeight,this.debugMode),this.mainThreadEstimator=new u(this.projectionTransform)}let n=-1,i=null,o=null,a=null,c=null;for(let l=0;l<s.length;l++){let u=s[l],{keyframeIndex:h,screenCoords:f,worldCoords:m,debugExtra:d}=this.mainThreadMatcher.matchDetection(this.matchingDataList[u],t,e);if(c=d,h!==-1){let y=this.mainThreadEstimator.estimate({screenCoords:f,worldCoords:m});y&&(n=u,i=y,o=f,a=m);break}}return{targetIndex:n,modelViewTransform:i,screenCoords:o,worldCoords:a,debugExtra:c}}_workerTrackUpdate(t,s){return new Promise(e=>{if(!this.worker){this._trackUpdateOnMainThread(t,s).then(e).catch(()=>e(null));return}let n=setTimeout(()=>{this.workerTrackDone=null,e(null)},sn);this.workerTrackDone=c=>{clearTimeout(n),this.workerTrackDone=null,e(c.modelViewTransform)};let{worldCoords:i,screenCoords:o,stabilities:a}=s;this.worker.postMessage({type:"trackUpdate",modelViewTransform:t,worldCoords:i,screenCoords:o,stabilities:a})})}async _trackUpdateOnMainThread(t,s){if(!this.mainThreadEstimator){let{Estimator:o}=await Promise.resolve().then(()=>(rs(),Qs));this.mainThreadEstimator=new o(this.projectionTransform)}let{worldCoords:e,screenCoords:n,stabilities:i}=s;return this.mainThreadEstimator.refineEstimate({initialModelViewTransform:t,worldCoords:e,screenCoords:n,stabilities:i})}_glModelViewMatrix(t,s){return[t[0][0],-t[1][0],-t[2][0],0,t[0][1],-t[1][1],-t[2][1],0,t[0][2],-t[1][2],-t[2][2],0,t[0][3],-t[1][3],-t[2][3],1]}_glProjectionMatrix({projectionTransform:t,width:s,height:e,near:n,far:i}){let o=[[2*t[0][0]/s,0,-(2*t[0][2]/s-1),0],[0,2*t[1][1]/e,-(2*t[1][2]/e-1),0],[0,0,-(i+n)/(i-n),-2*i*n/(i-n)],[0,0,-1,0]],a=[];for(let c=0;c<4;c++)for(let l=0;l<4;l++)a.push(o[l][c]);return a}};var le=class{constructor(t,s,e){this.width=t,this.height=s,this.config=e,this.minDim=Math.min(t,s),this.foveaRadius=Math.floor(this.minDim*e.FOVEA_RADIUS_RATIO),this.parafoveaRadius=Math.floor(this.minDim*e.PARAFOVEA_RADIUS_RATIO),this._initBuffers()}_initBuffers(){let t=this.foveaRadius*2;this.foveaBuffer=new Uint8Array(t*t);let s=this.parafoveaRadius*2,e=Math.ceil(s*this.config.PARAFOVEA_RESOLUTION);this.parafoveaBuffer=new Uint8Array(e*e);let n=Math.ceil(this.width*this.config.PERIPHERY_RESOLUTION),i=Math.ceil(this.height*this.config.PERIPHERY_RESOLUTION);this.peripheryBuffer=new Uint8Array(n*i),this.peripheryDims={width:n,height:i},this._buildCircularMask()}_buildCircularMask(){let t=this.foveaRadius,s=t*2;this.circularMask=new Uint8Array(s*s);for(let e=0;e<s;e++)for(let n=0;n<s;n++){let i=n-t,o=e-t,a=Math.sqrt(i*i+o*o);this.circularMask[e*s+n]=a<=t?1:0}}extract(t,s,e,n=0){return s=Math.max(this.foveaRadius,Math.min(this.width-this.foveaRadius-1,s)),e=Math.max(this.foveaRadius,Math.min(this.height-this.foveaRadius-1,e)),n===0?this._extractFovea(t,s,e):n===1?this._extractParafovea(t,s,e):this._extractPeriphery(t)}_extractFovea(t,s,e){let n=this.foveaRadius,i=n*2,o=this.foveaBuffer,a=0,c=0;for(let l=-n;l<n;l++){let h=(e+l)*this.width;for(let f=-n;f<n;f++){let m=(l+n)*i+(f+n);if(this.circularMask[m]){let d=s+f;o[a]=t[h+d],c++}else o[a]=0;a++}}return{x:s,y:e,radius:n,resolution:this.config.FOVEA_RESOLUTION,data:o,width:i,height:i,pixelCount:c,type:"fovea",toOriginalCoord:(l,u)=>({x:s-n+l,y:e-n+u}),toLocalCoord:(l,u)=>({x:l-(s-n),y:u-(e-n)})}}_extractParafovea(t,s,e){let n=this.parafoveaRadius,i=this.config.PARAFOVEA_RESOLUTION,a=Math.ceil(n*i)*2,c=this.parafoveaBuffer,l=Math.round(1/i),u=0,h=0;for(let f=0;f<a;f++){let m=e-n+Math.floor(f/i);if(m<0||m>=this.height)continue;let d=m*this.width;for(let y=0;y<a;y++){let p=s-n+Math.floor(y/i);if(p<0||p>=this.width){c[u++]=0;continue}c[u++]=t[d+p],h++}}return{x:s,y:e,radius:n,resolution:i,data:c,width:a,height:a,pixelCount:h,type:"parafovea",toOriginalCoord:(f,m)=>({x:s-n+f/i,y:e-n+m/i}),toLocalCoord:(f,m)=>({x:(f-(s-n))*i,y:(m-(e-n))*i})}}_extractPeriphery(t){let s=this.config.PERIPHERY_RESOLUTION,e=this.peripheryDims.width,n=this.peripheryDims.height,i=this.peripheryBuffer,o=Math.round(1/s),a=0;for(let c=0;c<this.height;c+=o){let l=c*this.width;for(let u=0;u<this.width;u+=o)a<i.length&&(i[a++]=t[l+u])}return{x:this.width/2,y:this.height/2,radius:Math.max(this.width,this.height)/2,resolution:s,data:i,width:e,height:n,pixelCount:e*n,type:"periphery",toOriginalCoord:(c,l)=>({x:c/s,y:l/s}),toLocalCoord:(c,l)=>({x:c*s,y:l*s})}}extractMultiResolution(t,s,e){return{fovea:this._extractFovea(t,s,e),parafovea:this._extractParafovea(t,s,e),periphery:this._extractPeriphery(t),center:{x:s,y:e},totalPixels:this._computeTotalPixels(),originalPixels:this.width*this.height}}_computeTotalPixels(){let t=Math.PI*this.foveaRadius**2,s=Math.PI*this.parafoveaRadius**2*this.config.PARAFOVEA_RESOLUTION**2,e=this.peripheryDims.width*this.peripheryDims.height;return Math.ceil(t+s+e)}configure(t){this.config={...this.config,...t},this.foveaRadius=Math.floor(this.minDim*t.FOVEA_RADIUS_RATIO),this.parafoveaRadius=Math.floor(this.minDim*t.PARAFOVEA_RADIUS_RATIO),this._initBuffers()}};var he=class{constructor(t,s,e){this.width=t,this.height=s,this.config=e,this.recentTargets=[],this.inhibitionRadius=Math.min(t,s)*.1,this.velocityHistory=[],this.lastCenter={x:t/2,y:s/2},this.gridCells=this._buildCoverageGrid(3,3),this.lastVisitedCell=4,this.lastSaccadeTime=0,this.saccadeCount=0}_buildCoverageGrid(t,s){let e=[],n=this.width/s,i=this.height/t;for(let o=0;o<t;o++)for(let a=0;a<s;a++)e.push({x:n*(a+.5),y:i*(o+.5),index:o*s+a,lastVisit:0});return e}computeTargets(t,s,e=null){let n=[],i=this.config.MAX_SACCADES_PER_FRAME;if(e&&e.isTracking){let o=this._predictTrackingCenter(e);o&&n.push({x:o.x,y:o.y,priority:0,reason:"tracking_prediction",saliency:1})}if(t&&t.peaks)for(let o of t.peaks){if(n.length>=i)break;this._isInhibited(o.x,o.y,n)||o.value>this.config.SALIENCY_THRESHOLD&&n.push({x:o.x,y:o.y,priority:n.length,reason:"saliency_peak",saliency:o.value})}if(!e?.isTracking&&n.length<i){let o=this._getNextGridCell();o&&!this._isInhibited(o.x,o.y,n)&&n.push({x:o.x,y:o.y,priority:n.length,reason:"grid_search",saliency:.5})}return n.length===0&&n.push({x:s.x,y:s.y,priority:0,reason:"maintain_position",saliency:.3}),this._updateHistory(n),n}_predictTrackingCenter(t){if(!t.worldMatrix)return null;let s=t.worldMatrix,e=s[12]||this.width/2,n=s[13]||this.height/2;if(this.velocityHistory.length>=2){let i=this._computeAverageVelocity("x"),o=this._computeAverageVelocity("y");return{x:Math.max(0,Math.min(this.width-1,e+i)),y:Math.max(0,Math.min(this.height-1,n+o))}}return{x:e,y:n}}_computeAverageVelocity(t){if(this.velocityHistory.length<2)return 0;let s=0;for(let e=1;e<this.velocityHistory.length;e++)s+=this.velocityHistory[e][t]-this.velocityHistory[e-1][t];return s/(this.velocityHistory.length-1)}_isInhibited(t,s,e){let n=this.inhibitionRadius**2;for(let i of e){let o=t-i.x,a=s-i.y;if(o*o+a*a<n)return!0}for(let i of this.recentTargets){let o=t-i.x,a=s-i.y;if(o*o+a*a<n)return!0}return!1}_getNextGridCell(){let t=this.gridCells[0],s=1/0;for(let e of this.gridCells)e.lastVisit<s&&(s=e.lastVisit,t=e);return t.lastVisit=Date.now(),t}_updateHistory(t){this.recentTargets.push(...t);let s=this.config.MOTION_HISTORY_FRAMES*this.config.MAX_SACCADES_PER_FRAME;for(;this.recentTargets.length>s;)this.recentTargets.shift();if(t.length>0){for(this.velocityHistory.push({x:t[0].x,y:t[0].y});this.velocityHistory.length>this.config.MOTION_HISTORY_FRAMES;)this.velocityHistory.shift();this.lastCenter={x:t[0].x,y:t[0].y}}this.saccadeCount+=t.length,this.lastSaccadeTime=Date.now()}getPredictedLocation(){if(this.velocityHistory.length>=2){let t=this._computeAverageVelocity("x"),s=this._computeAverageVelocity("y");return{x:Math.max(0,Math.min(this.width-1,this.lastCenter.x+t)),y:Math.max(0,Math.min(this.height-1,this.lastCenter.y+s))}}return this.lastCenter}reset(){this.recentTargets=[],this.velocityHistory=[],this.lastCenter={x:this.width/2,y:this.height/2},this.saccadeCount=0;for(let t of this.gridCells)t.lastVisit=0}configure(t){this.config={...this.config,...t},this.inhibitionRadius=Math.min(this.width,this.height)*.1}};var ue=class{constructor(t,s,e){this.width=t,this.height=s,this.config=e,this.frameHistory=[],this.stateHistory=[],this.motionModel={vx:0,vy:0,vtheta:0,vscale:0,confidence:0},this.blockSize=8,this.blocksX=Math.ceil(t/this.blockSize),this.blocksY=Math.ceil(s/this.blockSize),this.blockMeans=new Float32Array(this.blocksX*this.blocksY),this.prevBlockMeans=new Float32Array(this.blocksX*this.blocksY),this.consecutiveSkips=0,this.maxConsecutiveSkips=10}predict(t,s){if(this.frameHistory.length<2)return{canSkip:!1,confidence:0,reason:"insufficient_history"};if(this.consecutiveSkips>=this.maxConsecutiveSkips)return{canSkip:!1,confidence:0,reason:"forced_refresh"};let e=this.getChangeLevel(t),n=s?.isTracking?this.config.CHANGE_THRESHOLD:this.config.CHANGE_THRESHOLD*.5,i=e<n,o=i?Math.min(1,(n-e)/n):0,a=null;return i&&s&&(a=this._predictState(s)),i&&this.consecutiveSkips++,{canSkip:i,confidence:o,changeLevel:e,predictedState:a,reason:i?"low_change":"significant_change"}}getChangeLevel(t){if(this.frameHistory.length===0)return 1;this._computeBlockMeans(t,this.blockMeans);let s=0,e=0,n=this.blocksX*this.blocksY;for(let a=0;a<n;a++){let c=Math.abs(this.blockMeans[a]-this.prevBlockMeans[a])/255;s+=c,e=Math.max(e,c)}let o=s/n*.7+e*.3;return Math.min(1,o)}_computeBlockMeans(t,s){let e=this.blockSize,n=this.width;for(let i=0;i<this.blocksY;i++){let o=i*e,a=Math.min(o+e,this.height);for(let c=0;c<this.blocksX;c++){let l=c*e,u=Math.min(l+e,this.width),h=0,f=0;for(let m=o;m<a;m++){let d=m*n;for(let y=l;y<u;y++)h+=t[d+y],f++}s[i*this.blocksX+c]=h/f}}}_predictState(t){if(!t.worldMatrix)return null;let s=t.worldMatrix,e=new Float32Array(16);for(let i=0;i<16;i++)e[i]=s[i];e[12]+=this.motionModel.vx,e[13]+=this.motionModel.vy;let n=1+this.motionModel.vscale;return e[0]*=n,e[5]*=n,e[10]*=n,{worldMatrix:e,isTracking:!0,isPredicted:!0,predictionConfidence:this.motionModel.confidence}}storeFrame(t,s){for(let e=0;e<this.blockMeans.length;e++)this.prevBlockMeans[e]=this.blockMeans[e];if(this._computeBlockMeans(t,this.blockMeans),s?.worldMatrix)for(this.stateHistory.push({timestamp:Date.now(),matrix:new Float32Array(s.worldMatrix)}),this._updateMotionModel();this.stateHistory.length>this.config.MOTION_HISTORY_FRAMES;)this.stateHistory.shift();for(this.consecutiveSkips=0,this.frameHistory.push(Date.now());this.frameHistory.length>this.config.MOTION_HISTORY_FRAMES;)this.frameHistory.shift()}_updateMotionModel(){let t=this.stateHistory;if(t.length<2){this.motionModel.confidence=0;return}let s=t.length,e=t[s-1].matrix,n=t[s-2].matrix,i=(t[s-1].timestamp-t[s-2].timestamp)/1e3;if(i>0){this.motionModel.vx=(e[12]-n[12])/i*.016,this.motionModel.vy=(e[13]-n[13])/i*.016;let o=(Math.abs(n[0])+Math.abs(n[5]))/2,a=(Math.abs(e[0])+Math.abs(e[5]))/2;if(this.motionModel.vscale=(a-o)/o/i*.016,t.length>=3){let c=t[s-3].matrix,l=(n[12]-c[12])/i*.016,u=(n[13]-c[13])/i*.016,h=Math.abs(this.motionModel.vx-l),f=Math.abs(this.motionModel.vy-u),m=Math.sqrt(h*h+f*f);this.motionModel.confidence=Math.max(0,1-m/10)}else this.motionModel.confidence=.5}}isStaticScene(){return this.stateHistory.length<3?!1:Math.sqrt(this.motionModel.vx**2+this.motionModel.vy**2)<.5&&Math.abs(this.motionModel.vscale)<.01}reset(){this.frameHistory=[],this.stateHistory=[],this.consecutiveSkips=0,this.motionModel={vx:0,vy:0,vtheta:0,vscale:0,confidence:0},this.blockMeans.fill(0),this.prevBlockMeans.fill(0)}configure(t){this.config={...this.config,...t}}};var fe=class{constructor(t,s){this.width=t,this.height=s,this.scale=8,this.scaledW=Math.ceil(t/this.scale),this.scaledH=Math.ceil(s/this.scale),this.intensityMap=new Float32Array(this.scaledW*this.scaledH),this.contrastMap=new Float32Array(this.scaledW*this.scaledH),this.edgeMap=new Float32Array(this.scaledW*this.scaledH),this.saliencyBuffer=new Float32Array(this.scaledW*this.scaledH),this.maxPeaks=5,this.suppressionRadius=Math.max(this.scaledW,this.scaledH)*.15}compute(t){this._downsample(t),this._computeContrast(),this._computeEdges(),this._combineSaliency();let s=this._findPeaks();return{map:this.saliencyBuffer,width:this.scaledW,height:this.scaledH,peaks:s,maxSaliency:s.length>0?s[0].value:0}}_downsample(t){let s=this.scale,e=this.width;for(let n=0;n<this.scaledH;n++){let i=n*s,o=Math.min(i+s,this.height);for(let a=0;a<this.scaledW;a++){let c=a*s,l=Math.min(c+s,this.width),u=0,h=0;for(let f=i;f<o;f++){let m=f*e;for(let d=c;d<l;d++)u+=t[m+d],h++}this.intensityMap[n*this.scaledW+a]=u/h/255}}}_computeContrast(){let t=this.scaledW,s=this.scaledH,e=this.intensityMap,n=this.contrastMap;for(let i=1;i<s-1;i++)for(let o=1;o<t-1;o++){let a=i*t+o,c=e[a],l=0;l+=e[(i-1)*t+(o-1)],l+=e[(i-1)*t+o],l+=e[(i-1)*t+(o+1)],l+=e[i*t+(o-1)],l+=e[i*t+(o+1)],l+=e[(i+1)*t+(o-1)],l+=e[(i+1)*t+o],l+=e[(i+1)*t+(o+1)],l/=8,n[a]=Math.abs(c-l)}for(let i=0;i<s;i++)n[i*t]=0,n[i*t+t-1]=0;for(let i=0;i<t;i++)n[i]=0,n[(s-1)*t+i]=0}_computeEdges(){let t=this.scaledW,s=this.scaledH,e=this.intensityMap,n=this.edgeMap;for(let i=1;i<s-1;i++)for(let o=1;o<t-1;o++){let a=-e[(i-1)*t+(o-1)]+e[(i-1)*t+(o+1)]+-2*e[i*t+(o-1)]+2*e[i*t+(o+1)]+-e[(i+1)*t+(o-1)]+e[(i+1)*t+(o+1)],c=-e[(i-1)*t+(o-1)]-2*e[(i-1)*t+o]-e[(i-1)*t+(o+1)]+e[(i+1)*t+(o-1)]+2*e[(i+1)*t+o]+e[(i+1)*t+(o+1)];n[i*t+o]=Math.sqrt(a*a+c*c)/4}for(let i=0;i<s;i++)n[i*t]=0,n[i*t+t-1]=0;for(let i=0;i<t;i++)n[i]=0,n[(s-1)*t+i]=0}_combineSaliency(){let t=this.saliencyBuffer.length,s=this.contrastMap,e=this.edgeMap,n=this.saliencyBuffer;for(let o=0;o<t;o++)n[o]=s[o]*.6+e[o]*.4;let i=0;for(let o=0;o<t;o++)i=Math.max(i,n[o]);if(i>0)for(let o=0;o<t;o++)n[o]/=i}_findPeaks(){let t=this.scaledW,s=this.scaledH,e=this.saliencyBuffer,n=[],i=this.suppressionRadius,o=i*i,a=[];for(let c=1;c<s-1;c++)for(let l=1;l<t-1;l++){let u=c*t+l,h=e[u];h>e[(c-1)*t+(l-1)]&&h>e[(c-1)*t+l]&&h>e[(c-1)*t+(l+1)]&&h>e[c*t+(l-1)]&&h>e[c*t+(l+1)]&&h>e[(c+1)*t+(l-1)]&&h>e[(c+1)*t+l]&&h>e[(c+1)*t+(l+1)]&&a.push({x:l,y:c,value:h})}a.sort((c,l)=>l.value-c.value);for(let c of a){if(n.length>=this.maxPeaks)break;let l=!1;for(let u of n){let h=c.x-u.x,f=c.y-u.y;if(h*h+f*f<o){l=!0;break}}l||n.push({x:(c.x+.5)*this.scale,y:(c.y+.5)*this.scale,value:c.value})}return n}getSaliencyAt(t,s){let e=Math.floor(t/this.scale),n=Math.floor(s/this.scale);return e<0||e>=this.scaledW||n<0||n>=this.scaledH?0:this.saliencyBuffer[n*this.scaledW+e]}};var de=class{constructor(t,s={}){this.numOctaves=t,this.options={interleaveInterval:10,hysteresis:1,...s},this.frameCount=0,this.lastActiveOctave=-1,this.interleaveOctave=0}getOctavesToProcess(t=null){if(this.frameCount++,!t||!t.isTracking||t.activeOctave===void 0)return this.lastActiveOctave=-1,Array.from({length:this.numOctaves},(i,o)=>o);let s=t.activeOctave;this.lastActiveOctave=s;let e=new Set;for(let i=-this.options.hysteresis;i<=this.options.hysteresis;i++){let o=s+i;o>=0&&o<this.numOctaves&&e.add(o)}this.frameCount%this.options.interleaveInterval===0&&(this.interleaveOctave=(this.interleaveOctave+1)%this.numOctaves,e.has(this.interleaveOctave)&&(this.interleaveOctave=(this.interleaveOctave+1)%this.numOctaves),e.add(this.interleaveOctave),this.options.debug&&console.log(`[ScaleOrchestrator] Interleave check on octave ${this.interleaveOctave}`));let n=Array.from(e).sort((i,o)=>i-o);return this.options.debug&&console.log(`[ScaleOrchestrator] Active: ${s}, Processing: [${n.join(", ")}]`),n}reset(){this.frameCount=0,this.lastActiveOctave=-1}};var qi={FOVEA_RADIUS_RATIO:.15,PARAFOVEA_RADIUS_RATIO:.3,FOVEA_RESOLUTION:1,PARAFOVEA_RESOLUTION:.5,PERIPHERY_RESOLUTION:.25,MAX_SACCADES_PER_FRAME:3,SACCADE_COOLDOWN_MS:50,SALIENCY_THRESHOLD:.3,CHANGE_THRESHOLD:.05,PREDICTION_CONFIDENCE:.8,MOTION_HISTORY_FRAMES:3,ENABLE_SKIP_FRAMES:!0,MIN_PROCESSING_INTERVAL_MS:8,NUM_OCTAVES:5},jt=class{constructor(t,s,e={}){this.width=t,this.height=s,this.config={...qi,...e},this.fovealAttention=new le(t,s,this.config),this.saccadicController=new he(t,s,this.config),this.predictiveCoding=new ue(t,s,this.config),this.saliencyMap=new fe(t,s),this.scaleOrchestrator=new de(this.config.NUM_OCTAVES,{debug:e.debugMode}),this.currentFoveaCenter={x:t/2,y:s/2},this.frameCount=0,this.lastProcessTime=0,this.skipCount=0,this.metrics={totalFrames:0,skippedFrames:0,avgPixelsProcessed:0,avgLatency:0,saccadeCount:0},this._initBuffers()}_initBuffers(){let t=this.width*this.height,s=Math.ceil(t*this.config.FOVEA_RADIUS_RATIO**2*Math.PI);this.outputBuffer={fovea:new Uint8Array(s),parafovea:new Uint8Array(Math.ceil(s*4)),periphery:new Uint8Array(Math.ceil(t*.25))},this.changeBuffer=new Float32Array(Math.ceil(t/64))}process(t,s=null){let e=performance.now();this.frameCount++,this.metrics.totalFrames++;let n=this.predictiveCoding.predict(t,s);if(n.canSkip&&this.config.ENABLE_SKIP_FRAMES)return this.metrics.skippedFrames++,this.skipCount++,{skipped:!0,prediction:n.predictedState,confidence:n.confidence,pixelsProcessed:0,latency:performance.now()-e};this.skipCount=0;let i=this.saliencyMap.compute(t),o=this.saccadicController.computeTargets(i,this.currentFoveaCenter,s),a=[],c=0;for(let h of o){let f=this.fovealAttention.extract(t,h.x,h.y,h.priority);a.push(f),c+=f.pixelCount,this.metrics.saccadeCount++}if(o.length>0){let h=o[0];this.currentFoveaCenter={x:h.x,y:h.y}}let l=this.scaleOrchestrator.getOctavesToProcess(s);this.predictiveCoding.storeFrame(t,s);let u=performance.now()-e;return this._updateMetrics(c,u),{skipped:!1,attentionRegions:a,foveaCenter:this.currentFoveaCenter,saliencyPeaks:i.peaks,octavesToProcess:l,pixelsProcessed:c,pixelsSaved:this.width*this.height-c,savingsPercent:((1-c/(this.width*this.height))*100).toFixed(1),latency:u}}getPrimaryRegion(t){return t.skipped||!t.attentionRegions?.length?null:t.attentionRegions[0]}suggestProcessing(t){let s=this.predictiveCoding.getChangeLevel(t);return{shouldProcessFull:s>.3,shouldProcessPartial:s>.05,canSkip:s<.02,changeLevel:s,recommendedSaccades:Math.ceil(s*this.config.MAX_SACCADES_PER_FRAME)}}_updateMetrics(t,s){this.metrics.avgPixelsProcessed=this.metrics.avgPixelsProcessed*(1-.1)+t*.1,this.metrics.avgLatency=this.metrics.avgLatency*(1-.1)+s*.1}getMetrics(){return{...this.metrics,skipRate:(this.metrics.skippedFrames/this.metrics.totalFrames*100).toFixed(1)+"%",avgSavings:((1-this.metrics.avgPixelsProcessed/(this.width*this.height))*100).toFixed(1)+"%",currentFovea:this.currentFoveaCenter}}reset(){this.currentFoveaCenter={x:this.width/2,y:this.height/2},this.frameCount=0,this.skipCount=0,this.predictiveCoding.reset(),this.saccadicController.reset()}configure(t){this.config={...this.config,...t},this.fovealAttention.configure(this.config),this.saccadicController.configure(this.config),this.predictiveCoding.configure(this.config)}};var me=class extends ce{bioEngine=null;bioEnabled=!0;bioMetricsInterval=null;lastBioResult=null;constructor(t){super(t);let s=t.bioInspired||{};if(this.bioEnabled=s.enabled!==!1,this.bioEnabled){let e={};s.foveaRadiusRatio!==void 0&&(e.FOVEA_RADIUS_RATIO=s.foveaRadiusRatio),s.maxSaccades!==void 0&&(e.MAX_SACCADES_PER_FRAME=s.maxSaccades),s.aggressiveSkipping!==void 0&&(e.ENABLE_SKIP_FRAMES=s.aggressiveSkipping,s.aggressiveSkipping&&(e.CHANGE_THRESHOLD=.03)),this.bioEngine=new jt(t.inputWidth,t.inputHeight,e)}}processVideo(t){if(!this.bioEnabled||!this.bioEngine)return super.processVideo(t);if(this.processingVideo)return;this.processingVideo=!0,this.trackingStates=[];for(let e=0;e<(this.markerDimensions?.length||0);e++)this.trackingStates.push({showing:!1,isTracking:!1,currentModelViewTransform:null,trackCount:0,trackMiss:0});(async()=>{for(;this.processingVideo;){let e=this.inputLoader.loadInput(t),n=this.trackingStates.filter(a=>a.isTracking),i=n.length===1?{isTracking:!0,activeOctave:n[0].lastOctaveIndex,worldMatrix:n[0].currentModelViewTransform?this._flattenMatrix(n[0].currentModelViewTransform):null}:null,o=this.bioEngine.process(e,i||void 0);this.lastBioResult=o,o.skipped&&n.length>0?this._handleSkippedFrame(n,o):await this._processWithAttention(t,e,o),typeof requestAnimationFrame<"u"?await new Promise(requestAnimationFrame):await new Promise(a=>setTimeout(a,16))}})()}_handleSkippedFrame(t,s){let e=s.prediction&&s.prediction.worldMatrix;for(let n of t){e&&t.length===1&&(n.currentModelViewTransform=this._unflattenMatrix(s.prediction.worldMatrix));let i=this.trackingStates.indexOf(n);if(i!==-1){let o=n.currentModelViewTransform?this._glModelViewMatrix(n.currentModelViewTransform,i):null;this.onUpdate?.({type:"updateMatrix",targetIndex:i,worldMatrix:o?this.featureManager.applyWorldMatrixFilters(i,o,{stability:.9}):null,skipped:!0,bioMetrics:this.bioEngine?.getMetrics()})}}this.onUpdate?.({type:"processDone"})}async _processWithAttention(t,s,e){if(this.trackingStates.reduce((i,o)=>i+(o.isTracking?1:0),0)<this.maxTrack){let i=this.trackingStates.map((o,a)=>({state:o,index:a})).filter(({state:o,index:a})=>!o.isTracking&&(this.interestedTargetIndex===-1||this.interestedTargetIndex===a)).map(({index:o})=>o);if(i.length>0){let{targetIndex:o,modelViewTransform:a,featurePoints:c}=await this._detectAndMatch(s,i,e.octavesToProcess||null);o!==-1&&(this.trackingStates[o].isTracking=!0,this.trackingStates[o].currentModelViewTransform=a,e.attentionRegions?.[0]&&this.bioEngine?.reset()),this.onUpdate?.({type:"featurePoints",featurePoints:c})}}for(let i=0;i<this.trackingStates.length;i++){let o=this.trackingStates[i];if(o.isTracking){let c=await this._trackAndUpdate(s,o.currentModelViewTransform,i);!c||!c.modelViewTransform?(o.isTracking=!1,o.screenCoords=c?.screenCoords||[],o.reliabilities=c?.reliabilities||[],o.stabilities=c?.stabilities||[]):(o.currentModelViewTransform=c.modelViewTransform,o.screenCoords=c.screenCoords,o.reliabilities=c.reliabilities,o.stabilities=c.stabilities,o.deformedMesh=c.deformedMesh)}let a=o.showing;if(o.showing=this.featureManager.shouldShow(i,o.isTracking),a&&!o.showing&&(o.trackingMatrix=null,this.featureManager.notifyUpdate({type:"reset",targetIndex:i})),o.showing||o.screenCoords?.length>0||a&&!o.showing){let c=o.showing?this._glModelViewMatrix(o.currentModelViewTransform,i):null,l=null;if(c){let u=o.stabilities||[],h=u.length>0?u.reduce((m,d)=>m+d,0)/u.length:0;if(l=this.featureManager.applyWorldMatrixFilters(i,c,{stability:h}),o.trackingMatrix=l,t.width===this.inputHeight&&t.height===this.inputWidth){let m=this.featureManager.getFeature("auto-rotation");m&&(l=m.rotate(l))}}this.onUpdate?.({type:"updateMatrix",targetIndex:i,worldMatrix:l,modelViewTransform:o.currentModelViewTransform,screenCoords:o.screenCoords,reliabilities:o.reliabilities,stabilities:o.stabilities,deformedMesh:o.deformedMesh,bioMetrics:this.bioEngine?.getMetrics(),foveaCenter:e.foveaCenter,pixelsSaved:e.pixelsSaved})}}this.onUpdate?.({type:"processDone"})}async _detectAndMatch(t,s,e=null){let n;for(let u of this.trackingStates)if(u.isTracking&&u.currentModelViewTransform){let h=u.currentModelViewTransform;n=Math.sqrt(h[0][0]**2+h[1][0]**2+h[2][0]**2);break}let{targetIndex:i,modelViewTransform:o,screenCoords:a,worldCoords:c,featurePoints:l}=await this._workerMatch(null,s,t,n,e);return{targetIndex:i,modelViewTransform:o,screenCoords:a,worldCoords:c,featurePoints:l}}_workerMatch(t,s,e=null,n,i=null){return new Promise(o=>{if(!this.worker){let c;!t&&e?c=Promise.resolve(this.fullDetector.detect(e,{octavesToProcess:i}).featurePoints):c=Promise.resolve(t),c.then(l=>{this._matchOnMainThread(l,s,n).then(o)}).catch(()=>o({targetIndex:-1}));return}let a=setTimeout(()=>{this.workerMatchDone=null,o({targetIndex:-1})},1e3);this.workerMatchDone=c=>{clearTimeout(a),this.workerMatchDone=null,o(c)},e?this.worker.postMessage({type:"match",inputData:e,targetIndexes:s,octavesToProcess:i,expectedScale:n}):this.worker.postMessage({type:"match",featurePoints:t,targetIndexes:s,expectedScale:n})})}async _trackAndUpdate(t,s,e){let n=await super._trackAndUpdate(t,s,e);return n&&n.octaveIndex!==void 0&&(this.trackingStates[e].lastOctaveIndex=n.octaveIndex),n}_flattenMatrix(t){let s=new Float32Array(16);for(let e=0;e<3;e++)for(let n=0;n<4;n++)s[e*4+n]=t[e][n];return s[12]=0,s[13]=0,s[14]=0,s[15]=1,s}_unflattenMatrix(t){return[[t[0],t[1],t[2],t[3]],[t[4],t[5],t[6],t[7]],[t[8],t[9],t[10],t[11]]]}getBioMetrics(){return this.bioEngine?.getMetrics()||null}getLastBioResult(){return this.lastBioResult}setBioEnabled(t){this.bioEnabled=t,t&&!this.bioEngine&&(this.bioEngine=new jt(this.inputWidth,this.inputHeight))}configureBio(t){this.bioEngine?.configure(t)}dispose(){super.dispose(),this.bioEngine=null,this.bioMetricsInterval&&clearInterval(this.bioMetricsInterval)}};function ge(r,t,s,e,n,i,o,a,c=!1){let l=e[0][0]*r+e[0][1]*t+e[0][2]*s+e[0][3],u=e[1][0]*r+e[1][1]*t+e[1][2]*s+e[1][3],h=e[2][0]*r+e[2][1]*t+e[2][2]*s+e[2][3],f=n[0][0]*l/h+n[0][2],m=n[1][1]*u/h+n[1][2],d=c?o:i,y=c?i:o,p=Math.max(a.width/d,a.height/y),g=d*p,x=y*p,M=(a.width-g)/2,S=(a.height-x)/2,I,E;return c?(I=M+g/2-(m-n[1][2])*p,E=S+x/2+(f-n[0][2])*p):(I=M+g/2+(f-n[0][2])*p,E=S+x/2+(m-n[1][2])*p),{sx:I,sy:E}}async function Ma(r){return new Promise((t,s)=>{let e=new Image;e.crossOrigin="anonymous",e.onload=()=>t(e),e.onerror=()=>s(new Error(`Failed to load image: ${r}`)),e.src=r})}async function ba(r){let t;if(typeof r=="string")t=await Ma(r);else if(r instanceof HTMLImageElement)t=r,t.complete||await new Promise((i,o)=>{t.onload=i,t.onerror=o});else return{imageData:r,width:r.width,height:r.height};let s=document.createElement("canvas");s.width=t.width,s.height=t.height;let e=s.getContext("2d");return e.drawImage(t,0,0),{imageData:e.getImageData(0,0,t.width,t.height),width:t.width,height:t.height}}function Sa(r,t,s,e,n,i){let o=s.sx,a=s.sy,c=e.sx,l=e.sy,u=n.sx,h=n.sy,f=i.sx,m=i.sy,d=c-f,y=u-f,p=o-c+f-u,g=l-m,x=h-m,M=a-l+m-h,S=d*x-y*g,I=(p*x-y*M)/S,E=(d*M-p*g)/S,k=c-o+I*c,T=u-o+E*u,C=o,w=l-a+I*l,b=h-a+E*h,_=a;return[k/r,w/r,0,I/r,T/t,b/t,0,E/t,0,0,1,0,C,_,0,1]}async function Vi(r){let{targetSrc:t,container:s,overlay:e,callbacks:n={},cameraConfig:i={facingMode:"environment",width:{ideal:1280},height:{ideal:960}},viewportWidth:o=1280,viewportHeight:a=960,debugMode:c=!1,bioInspiredEnabled:l=!0,scale:u=1}=r,h=!1,f=!1,m=null,d=null,y=[0,0],p=document.createElement("canvas");p.width=o,p.height=a,p.style.width="100%",p.style.height="100%",p.style.objectFit="cover",p.style.position="absolute",p.style.top="0",p.style.left="0",p.style.zIndex="0";let g=p.getContext("2d");e&&(e.style.position="absolute",e.style.transformOrigin="0 0",e.style.display="none",e.style.pointerEvents="none");let x;if(t instanceof ArrayBuffer)x=t;else if(typeof t=="string"&&t.toLowerCase().split("?")[0].endsWith(".taar")){c&&console.log(`[TapTapp AR] Fetching pre-compiled target: ${t}`);let C=await fetch(t);if(!C.ok)throw new Error(`Failed to fetch .taar file: ${C.statusText}`);x=await C.arrayBuffer()}else{c&&console.log("[TapTapp AR] Compiling image target...");let{imageData:C,width:w,height:b}=await ba(t);y=[w,b];let _=new Pe;await _.compileImageTargets([{width:w,height:b,data:C.data}],D=>n.onCompileProgress?.(D));let v=_.exportData();x=v.buffer.slice(v.byteOffset,v.byteOffset+v.byteLength)}let M=new me({inputWidth:o,inputHeight:a,debugMode:c,bioInspired:{enabled:l,aggressiveSkipping:!1},onUpdate:C=>I(C)}),S=await M.addImageTargetsFromBuffer(x);S.dimensions&&S.dimensions[0]&&(y=S.dimensions[0]);function I(C){if(C.type==="processDone"||C.type!=="updateMatrix")return;let{targetIndex:w,worldMatrix:b,modelViewTransform:_,screenCoords:v=[],reliabilities:D=[],stabilities:A=[]}=C,R=b!==null,P=D.length>0?D.reduce((O,U)=>O+U,0)/D.length:0,N=A.length>0?A.reduce((O,U)=>O+U,0)/A.length:0,j={isTracking:R,worldMatrix:b,modelViewTransform:_,screenCoords:v,reliabilities:D,stabilities:A,avgReliability:P,avgStability:N,controller:M,targetIndex:w,targetDimensions:y};R&&!f?n.onFound?.(j):!R&&f&&n.onLost?.(j),(R||f)&&n.onUpdate?.(j),e&&_&&b?E(_):e&&!R&&(e.style.display="none"),f=R}function E(C){if(!e)return;let[w,b]=y,_=M.projectionTransform,v=s.getBoundingClientRect(),D=ge(0,0,0,C,_,o,a,v,!1),A=ge(w,0,0,C,_,o,a,v,!1),R=ge(0,b,0,C,_,o,a,v,!1),P=ge(w,b,0,C,_,o,a,v,!1),N=Sa(w,b,D,A,R,P);e.style.width=`${w}px`,e.style.height=`${b}px`;let j=N.join(",");u!==1?e.style.transform=`matrix3d(${j}) scale(${u})`:e.style.transform=`matrix3d(${j})`,e.style.display="block"}function k(C){C instanceof HTMLVideoElement,g.drawImage(C,0,0,o,a)}return{async startCamera(){if(!h)try{try{m=await navigator.mediaDevices.getUserMedia({video:i,audio:!1})}catch(w){console.warn("[TapTapp AR] Failed to open environment camera, falling back to default:",w),m=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1})}d=document.createElement("video"),d.srcObject=m,d.playsInline=!0,d.muted=!0,await d.play(),s.style.position="relative",s.firstChild?s.insertBefore(p,s.firstChild):s.appendChild(p),h=!0;let C=()=>{!h||!d||(k(d),requestAnimationFrame(C))};C(),M.processVideo(p)}catch(C){throw console.error("[TapTapp AR] Camera access failed:",C),C}},startVideo(C){if(h)return;s.style.position="relative",s.appendChild(p),h=!0;let w=()=>{h&&(k(C),requestAnimationFrame(w))};w(),M.processVideo(p)},stop(){h=!1,M.stopProcessVideo(),m&&(m.getTracks().forEach(C=>C.stop()),m=null),d&&(d.srcObject=null,d=null),p.parentNode&&p.parentNode.removeChild(p),e&&(e.style.display="none")},get isActive(){return h},get isTracking(){return f},get controller(){return M},get targetDimensions(){return y},getProjectionMatrix(){return M.getProjectionMatrix()}}}async function Ea(r){let t=await Vi(r);return await t.startCamera(),t}Zt();var rn=class{state;constructor(t){this.state=t}next(){return this.state=this.state*1664525+1013904223>>>0,this.state/4294967295}};function Wi(r,t){let s=new rn(r),e=[];for(let n=0;n<t;n++){let i=new Uint32Array(32);for(let o=0;o<32;o++)i[o]=s.next()*4294967295>>>0;e.push(i)}return e}function Hi(r,t){let s=new Uint32Array(32);for(let e=0;e<1024;e++){let n=e>>>5,i=e&31,o=0,a=t[e%t.length];for(let c=0;c<2;c++)o+=ka(r[c]&a[c]);o>16&&(s[n]|=1<<i)}return s}function Xi(r){let t=2166136261;for(let s=0;s<r.length;s++)t^=r[s],t=Math.imul(t,16777619);return t>>>0}function ka(r){return r=r-(r>>1&1431655765),r=(r&858993459)+(r>>2&858993459),(r+(r>>4)&252645135)*16843009>>24}function Gi(r){let t=new Uint32Array(32),s=r.length/2,e=new Uint16Array(1024);for(let n of r)for(let i=0;i<1024;i++)n[i>>>5]&1<<(i&31)&&e[i]++;for(let n=0;n<1024;n++)e[n]>s&&(t[n>>>5]|=1<<(n&31));return t}Ut();var an={micro:{outputBits:32,maxFeatures:100,pyramidOctaves:3},compact:{outputBits:128,maxFeatures:200,pyramidOctaves:4},standard:{outputBits:256,maxFeatures:300,pyramidOctaves:5},full:{outputBits:1024,maxFeatures:500,pyramidOctaves:6}},on=null;function Ia(){return on||(on=Wi(ks,1024)),on}var zt=class{constructor(t="standard"){this.config=an[t]||an.standard,this.basis=Ia(),this.mode=t}embed(t,s,e){let n=performance.now(),i=new xt(s,e,{useGPU:!0,useLSH:!0,maxFeaturesPerBucket:Math.ceil(this.config.maxFeatures/100),maxOctaves:this.config.pyramidOctaves}),{featurePoints:o}=i.detect(t),a=o.sort((f,m)=>(m.score||0)-(f.score||0)).slice(0,this.config.maxFeatures);if(a.length===0)return new we(new Uint32Array(this.config.outputBits/32),{featureCount:0,mode:this.mode,timeMs:performance.now()-n});let c=[];for(let f of a){if(!f.descriptors||f.descriptors.length<2)continue;let m=f.descriptors instanceof Uint32Array?f.descriptors:new Uint32Array([f.descriptors[0]|f.descriptors[1]<<8|f.descriptors[2]<<16|f.descriptors[3]<<24,f.descriptors[4]|f.descriptors[5]<<8|f.descriptors[6]<<16|f.descriptors[7]<<24]),d=Hi(m,this.basis),y=Math.floor(f.x/s*3),p=Math.floor(f.y/e*3),x=(Math.min(8,Math.max(0,p*3+y))+1)*2654435769;for(let M=0;M<d.length;M++){let S=x+M*2246822507|0;S=Math.imul(S^S>>>16,36094177),S=Math.imul(S^S>>>13,3266489909),S=(S^S>>>16)>>>0,d[M]^=S}c.push(d)}let l=c.length>0?Gi(c):new Uint32Array(32),u=this._compressToSize(l,this.config.outputBits),h=performance.now()-n;return new we(u,{featureCount:a.length,mode:this.mode,timeMs:h,width:s,height:e})}compare(t,s){let e=t.vector||t,n=s.vector||s;if(e.length!==n.length)throw new Error("Embeddings must have same dimension");let i=0,o=e.length*32;for(let l=0;l<e.length;l++)i+=va(e[l]^n[l]);let a=i/(o/2);return Math.max(0,1-a)}search(t,s,e=10){let n=[];for(let i=0;i<s.length;i++){let o=this.compare(t,s[i]);n.push({index:i,similarity:o})}return n.sort((i,o)=>o.similarity-i.similarity),n.slice(0,e)}cluster(t,s=.7){let e=t.length,n=new Array(e).fill(-1),i=0;for(let o=0;o<e;o++)if(n[o]===-1){n[o]=i;for(let a=o+1;a<e;a++){if(n[a]!==-1)continue;this.compare(t[o],t[a])>=s&&(n[a]=i)}i++}return n}_compressToSize(t,s){let e=s/32;if(e>=32)return new Uint32Array(t.buffer,0,e);let n=new Uint32Array(e);if(s===32)n[0]=Xi(t);else{let i=Math.ceil(32/e);for(let o=0;o<e;o++){let a=0;for(let c=0;c<i;c++){let l=o*i+c;l<32&&(a^=t[l])}n[o]=(a<<o%32|a>>>32-o%32)>>>0}}return n}_weightedBundle(t,s){let e=new Uint32Array(32),n=s.reduce((a,c)=>a+c,0),i=s.map(a=>a/n),o=new Float32Array(1024);for(let a=0;a<t.length;a++){let c=t[a],l=i[a];for(let u=0;u<1024;u++)c[u>>>5]&1<<(u&31)&&(o[u]+=l)}for(let a=0;a<1024;a++)o[a]>.5&&(e[a>>>5]|=1<<(a&31));return e}},we=class r{constructor(t,s={}){this.vector=t,this.metadata=s}toBytes(){return new Uint8Array(this.vector.buffer)}static fromBytes(t){let s=new Uint32Array(t.buffer);return new r(s)}toBase64(){let t=this.toBytes(),s="";for(let e=0;e<t.length;e++)s+=String.fromCharCode(t[e]);return btoa(s)}static fromBase64(t){let s=atob(t),e=new Uint8Array(s.length);for(let n=0;n<s.length;n++)e[n]=s.charCodeAt(n);return r.fromBytes(e)}toHex(){return Array.from(this.vector).map(t=>t.toString(16).padStart(8,"0")).join("")}toFloatArray(){let t=this.bits,s=new Float32Array(t);for(let e=0;e<t;e++){let n=e>>>5,i=e&31;s[e]=this.vector[n]&1<<i?1:0}return s}get bits(){return this.vector.length*32}get bytes(){return this.vector.length*4}};function va(r){return r=r-(r>>1&1431655765),r=(r&858993459)+(r>>2&858993459),(r+(r>>4)&252645135)*16843009>>24}var ye=class{constructor(t="compact"){this.embedder=new zt(t)}async compute(t){let s=null,e=0,n=0;if(typeof t=="string")if(typeof document<"u")t=await this._loadImageBrowser(t);else throw new Error("URL loading in Node requires a fetch/loading utility. Please provide a Buffer or Uint8Array.");if(typeof document<"u"&&(t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||t instanceof ImageBitmap)){let i=document.createElement("canvas");e=t.width||t.videoWidth,n=t.height||t.videoHeight,i.width=e,i.height=n;let o=i.getContext("2d");o.drawImage(t,0,0);let a=o.getImageData(0,0,e,n).data;s=this._rgbaToGrayscale(a,e,n)}if(!s&&(t instanceof Uint8Array||typeof Buffer<"u"&&Buffer.isBuffer(t)))if(t.data&&t.width&&t.height)s=t.data,e=t.width,n=t.height;else throw new Error("Raw data source must be an object { data, width, height }");if(!s)throw new Error("Unsupported image source type");return this.embedder.embed(s,e,n)}async compare(t,s){let e=await this.compute(t),n=await this.compute(s);return this.embedder.compare(e,n)}_rgbaToGrayscale(t,s,e){let n=new Float32Array(s*e);for(let i=0;i<s*e;i++){let o=i*4;n[i]=(t[o]*.299+t[o+1]*.587+t[o+2]*.114)/255}return n}_loadImageBrowser(t){return new Promise((s,e)=>{let n=new Image;n.crossOrigin="anonymous",n.onload=()=>s(n),n.onerror=e,n.src=t})}},Yi=new ye("compact");Ut();export{me as BioInspiredController,ce as Controller,zt as ImageEmbedder,ye as ImageSearchBridge,Pe as OfflineCompiler,Vi as createTracker,Fe as protocol,Ea as startTracking,Yi as visualSearch};
