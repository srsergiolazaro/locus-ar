var is=Object.defineProperty;var q=(a,t)=>()=>(a&&(t=a(a=0)),t);var fe=(a,t)=>{for(var e in t)is(a,e,{get:t[e],enumerable:!0})};var N,pt=q(()=>{"use strict";N={VIEWPORT_WIDTH:640,VIEWPORT_HEIGHT:480,DEFAULT_FOVY:60,DEFAULT_NEAR:1,DEFAULT_FAR:1e4,MAX_FEATURES_PER_BUCKET:24,USE_LSH:!0,HAMMING_THRESHOLD:.85,HDC_RATIO_THRESHOLD:.85,INLIER_THRESHOLD:15,MIN_NUM_INLIERS:6,MAX_MATCH_QUERY_POINTS:800,CLUSTER_MAX_POP:25,TRACKER_TEMPLATE_SIZE:6,TRACKER_SEARCH_SIZE:12,TRACKER_SIMILARITY_THRESHOLD:.65,MIN_IMAGE_PIXEL_SIZE:32,SCALE_STEP_EXPONENT:1,TRACKING_DOWNSCALE_LEVEL_1:256,TRACKING_DOWNSCALE_LEVEL_2:128,WARMUP_TOLERANCE:2,MISS_TOLERANCE:1,ONE_EURO_FILTER_CUTOFF:.5,ONE_EURO_FILTER_BETA:.1,USE_COMPACT_DESCRIPTORS:!0,COMPACT_HAMMING_THRESHOLD:8}});var rs,as,cs,ls,hs,me,qt,pe=q(()=>{"use strict";rs=()=>null,as=(a,t,e)=>{let n=new Float32Array(t*e);for(let s=1;s<e-1;s++){let o=s*t,i=(s-1)*t,r=(s+1)*t;for(let c=1;c<t-1;c++){let h=o+c,l=(a[i+c+1]-a[i+c-1]+a[o+c+1]-a[o+c-1]+a[r+c+1]-a[r+c-1])/768,u=(a[r+c-1]-a[i+c-1]+a[r+c]-a[i+c]+a[r+c+1]-a[i+c+1])/768;n[h]=Math.sqrt((l*l+u*u)/2)}}return n},cs=(a,t,e)=>{let n=new Uint8Array(t*e);for(let s=1;s<e-1;s++){let o=s*t;for(let i=1;i<t-1;i++){let r=o+i,c=a[r];c>0&&c>=a[r-1]&&c>=a[r+1]&&c>=a[r-t]&&c>=a[r+t]&&(n[r]=1)}}return n},ls=(a,t,e)=>{let n=new Float32Array(t*e),s=new Float32Array(t*e),o=1/16,i=4/16,r=6/16,c=t-1,h=e-1;for(let l=0;l<e;l++){let u=l*t;for(let f=0;f<t;f++){let d=f<2?0:f-2,p=f<1?0:f-1,x=f>c-1?c:f+1,m=f>c-2?c:f+2;s[u+f]=a[u+d]*o+a[u+p]*i+a[u+f]*r+a[u+x]*i+a[u+m]*o}}for(let l=0;l<e;l++){let u=(l<2?0:l-2)*t,f=(l<1?0:l-1)*t,d=l*t,p=(l>h-1?h:l+1)*t,x=(l>h-2?h:l+2)*t;for(let m=0;m<t;m++)n[d+m]=s[u+m]*o+s[f+m]*i+s[d+m]*r+s[p+m]*i+s[x+m]*o}return n},hs=(a,t,e)=>{let n=Math.floor(t/2),s=Math.floor(e/2),o=new Float32Array(n*s);for(let i=0;i<s;i++){let r=i*2;for(let c=0;c<n;c++){let h=c*2,l=r*t+h;o[i*n+c]=(a[l]+a[l+1]+a[l+t]+a[l+t+1])/4}}return{data:o,width:n,height:s}},me=class{constructor(){this.gpu=null,this.kernelCache=new Map,this.initialized=!1}init(){this.initialized||(this.gpu=rs(),this.initialized=!0)}computeGradients(t,e,n){return this.init(),as(t,e,n)}findLocalMaxima(t,e,n){return this.init(),cs(t,e,n)}edgeDetection(t,e,n){let s=this.computeGradients(t,e,n),o=this.findLocalMaxima(s,e,n);return{dValue:s,isCandidate:o}}gaussianBlur(t,e,n){return this.init(),ls(t,e,n)}downsample(t,e,n){return this.init(),hs(t,e,n)}buildPyramid(t,e,n,s=5){this.init();let o=[],i=t instanceof Float32Array?t:Float32Array.from(t),r=e,c=n;for(let h=0;h<s;h++){let l=this.gaussianBlur(i,r,c);if(o.push({data:l,width:r,height:c,scale:Math.pow(2,h)}),r>8&&c>8){let u=this.downsample(l,r,c);i=u.data,r=u.width,c=u.height}else break}return o}isGPUAvailable(){return this.init(),this.gpu!==null}destroy(){this.kernelCache.clear(),this.gpu&&this.gpu.destroy&&this.gpu.destroy(),this.gpu=null,this.initialized=!1}},qt=new me});var zt,rt,ye=q(()=>{"use strict";zt=[{sigma:.55,points:[[-1,0],[-.5,-.866025],[.5,-.866025],[1,-0],[.5,.866025],[-.5,.866025]]},{sigma:.475,points:[[0,.930969],[-.806243,.465485],[-.806243,-.465485],[-0,-.930969],[.806243,-.465485],[.806243,.465485]]},{sigma:.4,points:[[.847306,-0],[.423653,.733789],[-.423653,.733789],[-.847306,0],[-.423653,-.733789],[.423653,-.733789]]},{sigma:.325,points:[[-0,-.741094],[.641806,-.370547],[.641806,.370547],[0,.741094],[-.641806,.370547],[-.641806,-.370547]]},{sigma:.25,points:[[-.595502,0],[-.297751,-.51572],[.297751,-.51572],[.595502,-0],[.297751,.51572],[-.297751,.51572]]},{sigma:.175,points:[[0,.362783],[-.314179,.181391],[-.314179,-.181391],[-0,-.362783],[.314179,-.181391],[.314179,.181391]]},{sigma:.1,points:[[0,0]]}],rt=[];for(let a=0;a<zt.length;a++){let t=zt[a].sigma;for(let e=0;e<zt[a].points.length;e++){let n=zt[a].points[e];rt.push([t,n[0],n[1]])}}});function Qe(a){let t=new Uint32Array(2);for(let e=0;e<64;e++){let n=Gt[e*2],s=Gt[e*2+1];if(a[n]<a[s]){let o=e>>5,i=e&31;t[o]|=1<<i}}return t}function tn(a){let t=new Uint8Array(84),e=0,n=0;for(let s=0;s<rt.length;s++)for(let o=s+1;o<rt.length;o++)a[s]<a[o]&&(t[n]|=1<<7-e),e++,e===8&&(n++,e=0);return t}function en(a){let t=new Uint8Array(8),e=new DataView(t.buffer);return e.setUint32(0,a[0],!0),e.setUint32(4,a[1],!0),t}var Gt,Je,Ze,vt,nn=q(()=>{"use strict";ye();Gt=new Int32Array(128),Je=new Int32Array(64);for(let a=0;a<64;a++)Je[a]=Math.floor(a*(672/64));Ze=0,vt=0;for(let a=0;a<rt.length;a++)for(let t=a+1;t<rt.length;t++)vt<64&&Ze===Je[vt]&&(Gt[vt*2]=a,Gt[vt*2+1]=t,vt++),Ze++});var Kt={};fe(Kt,{CURRENT_VERSION:()=>Xt,HDC_SEED:()=>xe,columnarize:()=>Me,columnarizeCompact:()=>be,compactTree:()=>Yt,decodeTaar:()=>It,encodeTaar:()=>we,expandTree:()=>on,getMorton:()=>ps,pack4Bit:()=>gs,unpack4Bit:()=>sn});import*as jt from"@msgpack/msgpack";function ps(a,t){let e=a|0,n=t|0;return e=(e|e<<8)&16711935,e=(e|e<<4)&252645135,e=(e|e<<2)&858993459,e=(e|e<<1)&1431655765,n=(n|n<<8)&16711935,n=(n|n<<4)&252645135,n=(n|n<<2)&858993459,n=(n|n<<1)&1431655765,e|n<<1}function gs(a){let t=a.length;if(t%2!==0)return a;let e=new Uint8Array(t/2);for(let n=0;n<t;n+=2){let s=(a[n]&240)>>4,o=(a[n+1]&240)>>4;e[n/2]=s<<4|o}return e}function sn(a,t,e){let n=t*e,s=new Uint8Array(n);for(let o=0;o<a.length;o++){let i=a[o],r=i&240,c=(i&15)<<4;s[o*2]=r,s[o*2+1]=c}return s}function Me(a,t,e,n,s=!1){let o=a.length,i=new Uint16Array(o),r=new Uint16Array(o),c=new Int16Array(o),h=new Uint8Array(o),l;s?l=new Uint32Array(o):l=new Uint32Array(o*2);for(let u=0;u<o;u++)i[u]=Math.round(a[u].x/e*65535),r[u]=Math.round(a[u].y/n*65535),c[u]=Math.round(a[u].angle/Math.PI*32767),h[u]=Math.round(Math.log2(a[u].scale||1)),a[u].descriptors&&a[u].descriptors.length>=2&&(s?l[u]=a[u].hdcSignature||0:(l[u*2]=a[u].descriptors[0],l[u*2+1]=a[u].descriptors[1]));return{x:i,y:r,a:c,s:h,d:l,hdc:s?1:0,t:Yt(t.rootNode)}}function be(a,t,e,n){let s=a.length,o=new Uint16Array(s),i=new Uint16Array(s),r=new Int16Array(s),c=new Uint8Array(s),h=new Uint32Array(s);for(let l=0;l<s;l++)o[l]=Math.round(a[l].x/e*65535),i[l]=Math.round(a[l].y/n*65535),r[l]=Math.round(a[l].angle/Math.PI*32767),c[l]=Math.round(Math.log2(a[l].scale||1)),a[l].descriptors&&a[l].descriptors.length>=2&&(h[l]=(a[l].descriptors[0]^a[l].descriptors[1])>>>0);return{x:o,y:i,a:r,s:c,d:h,compact:1,t:Yt(t.rootNode)}}function Yt(a){return a.leaf?[1,a.centerPointIndex||0,a.pointIndexes]:[0,a.centerPointIndex||0,a.children.map(t=>Yt(t))]}function on(a){return a[0]===1?{leaf:!0,centerPointIndex:a[1],pointIndexes:a[2]}:{leaf:!1,centerPointIndex:a[1],children:a[2].map(e=>on(e))}}function It(a){let t=jt.decode(new Uint8Array(a)),e=t.v||0;(e<5||e>Xt)&&console.warn(`Potential incompatible .taar version: ${e}. Standard is ${Xt}.`);let n=t.dataList;for(let s=0;s<n.length;s++){let o=n[s];for(let i of o.trackingData){let r=(u,f)=>u instanceof Uint8Array&&f!==Uint8Array?new f(u.buffer.slice(u.byteOffset,u.byteOffset+u.byteLength)):u;i.px=r(i.px,Float32Array),i.py=r(i.py,Float32Array);let c=i.data||i.d,h=i.width||i.w,l=i.height||i.h;if(c&&c.length===h*l/2){let u=sn(c,h,l);i.data&&(i.data=u),i.d&&(i.d=u)}i.mesh&&(i.mesh.t=r(i.mesh.t,Uint16Array),i.mesh.e=r(i.mesh.e,Uint16Array),i.mesh.rl=r(i.mesh.rl,Float32Array))}for(let i of o.matchingData)for(let r of[i.max,i.min]){if(!r)continue;let c=r.x,h=r.y;c instanceof Uint8Array&&(c=new Uint16Array(c.buffer.slice(c.byteOffset,c.byteOffset+c.byteLength))),h instanceof Uint8Array&&(h=new Uint16Array(h.buffer.slice(h.byteOffset,h.byteOffset+h.byteLength)));let l=c.length,u=new Float32Array(l),f=new Float32Array(l);for(let d=0;d<l;d++)u[d]=c[d]/65535*i.w,f[d]=h[d]/65535*i.h;if(r.x=u,r.y=f,r.a instanceof Uint8Array){let d=new Int16Array(r.a.buffer.slice(r.a.byteOffset,r.a.byteOffset+r.a.byteLength)),p=new Float32Array(l);for(let x=0;x<l;x++)p[x]=d[x]/32767*Math.PI;r.a=p}if(r.s instanceof Uint8Array){let d=r.s,p=new Float32Array(l);for(let x=0;x<l;x++)p[x]=Math.pow(2,d[x]);r.s=p}r.d instanceof Uint8Array&&(r.hdc===1?r.d=new Uint32Array(r.d.buffer.slice(r.d.byteOffset,r.d.byteOffset+r.d.byteLength)):r.d=new Uint32Array(r.d.buffer.slice(r.d.byteOffset,r.d.byteOffset+r.d.byteLength)))}}return{version:e,dataList:n}}function we(a){return jt.encode({v:Xt,dataList:a})}var Xt,xe,gt=q(()=>{"use strict";Xt=11,xe=322420463});var rn,ys,xs,kt,an,Ms,at,Et=q(()=>{"use strict";ye();pe();nn();gt();rn=4,ys=15,xs=12,kt=36,an=7,Ms=!0,at=class{constructor(t,e,n={}){this.width=t,this.height=e,this.useGPU=n.useGPU!==void 0?n.useGPU:Ms,this.useLSH=n.useLSH!==void 0?n.useLSH:!0,this.useHDC=n.useHDC!==void 0?n.useHDC:!0,this.maxFeaturesPerBucket=n.maxFeaturesPerBucket!==void 0?n.maxFeaturesPerBucket:xs;let s=0,o=t,i=e;for(;o>=rn&&i>=rn&&(o=Math.floor(o/2),i=Math.floor(i/2),s++,s!==10););this.numOctaves=n.maxOctaves!==void 0?Math.min(s,n.maxOctaves):s}detect(t,e={}){let n=e.octavesToProcess||Array.from({length:this.numOctaves},(l,u)=>u),s;if(t instanceof Float32Array)s=t;else{s=new Float32Array(t.length);for(let l=0;l<t.length;l++)s[l]=t[l]}let o=this._buildGaussianPyramid(s,this.width,this.height,n),i=this._buildDogPyramid(o,n),r=this._findExtremas(i,o),c=this._applyPrune(r);return this._computeOrientations(c,o),this._computeFreakDescriptors(c,o),{featurePoints:c.map(l=>{let u=Math.pow(2,l.octave);return{maxima:l.score>0,x:l.x*u+u*.5-.5,y:l.y*u+u*.5-.5,scale:u,angle:l.angle||0,score:l.absScore,descriptors:this.useLSH&&l.lsh?l.lsh:l.descriptors||[],imageData:s}}),pyramid:o}}_buildGaussianPyramid(t,e,n,s=null){if(this.useGPU)try{let h=qt.buildPyramid(t,e,n,this.numOctaves),l=[];for(let u=0;u<h.length&&u<this.numOctaves;u++){if(s&&!s.includes(u)){l.push(null);continue}let f=h[u],d=this._applyGaussianFilter(f.data,f.width,f.height);l.push([{data:f.data,width:f.width,height:f.height},{data:d.data,width:f.width,height:f.height}])}return l}catch(h){console.warn("GPU pyramid failed, falling back to CPU:",h.message)}(!this._pyramidBuffers||this._pyramidBuffers.width!==e||this._pyramidBuffers.height!==n)&&(this._pyramidBuffers={width:e,height:n,temp:new Float32Array(e*n)});let o=[],i=t,r=e,c=n;for(let h=0;h<this.numOctaves;h++){let l=!s||s.includes(h);if(l){let u=this._applyGaussianFilter(i,r,c),f=this._applyGaussianFilter(u.data,r,c);o.push([{data:u.data,width:r,height:c},{data:f.data,width:r,height:c}])}else o.push(null);if(h<this.numOctaves-1)if(!s||s.some(f=>f>h)){let f=l?o[h][0].data:i,d=this._downsample(f,r,c);i=d.data,r=d.width,c=d.height}else break}return o}_applyGaussianFilter(t,e,n){let s=new Float32Array(e*n),o=this._pyramidBuffers?.temp||new Float32Array(e*n),i=.0625,r=.25,c=.375,h=e-1;for(let l=0;l<n;l++){let u=l*e,f=i+r+c+r+i;o[u]=(t[u]*(i+r+c)+t[u+1]*r+t[u+2]*i)*(1/(i+r+c)),o[u+1]=(t[u]*r+t[u+1]*c+t[u+2]*r+t[u+3]*i)*(1/(r+c+r+i));for(let x=2;x<e-2;x++){let m=u+x;o[m]=t[m-2]*i+t[m-1]*r+t[m]*c+t[m+1]*r+t[m+2]*i}let d=u+e-2,p=u+e-1;o[d]=(t[d-2]*i+t[d-1]*r+t[d]*c+t[p]*r)*(1/(i+r+c+r)),o[p]=(t[p-2]*i+t[p-1]*r+t[p]*(c+r+i))*(1/(i+r+c))}for(let l=0;l<e;l++){s[l]=(o[l]*(i+r+c)+o[l+e]*r+o[l+e*2]*i)*(1/(i+r+c)),s[l+e]=(o[l]*r+o[l+e]*c+o[l+e*2]*r+o[l+e*3]*i)*(1/(r+c+r+i));for(let d=2;d<n-2;d++){let p=d*e+l;s[p]=o[p-e*2]*i+o[p-e]*r+o[p]*c+o[p+e]*r+o[p+e*2]*i}let u=(n-2)*e+l,f=(n-1)*e+l;s[u]=(o[u-e*2]*i+o[u-e]*r+o[u]*c+o[f]*r)*(1/(i+r+c+r)),s[f]=(o[f-e*2]*i+o[f-e]*r+o[f]*(c+r+i))*(1/(i+r+c))}return{data:s,width:e,height:n}}_downsample(t,e,n){let s=e>>1,o=n>>1,i=new Float32Array(s*o);for(let r=0;r<o;r++){let c=r*2*e,h=c+e,l=r*s;for(let u=0;u<s;u++){let f=u*2;i[l+u]=(t[c+f]+t[c+f+1]+t[h+f]+t[h+f+1])*.25}}return{data:i,width:s,height:o}}_buildDogPyramid(t,e=null){let n=[];for(let s=0;s<t.length;s++){if(!t[s]){n.push(null);continue}let o=t[s][0],i=t[s][1],r=o.width,c=o.height,h=new Float32Array(r*c);for(let l=0;l<h.length;l++)h[l]=i.data[l]-o.data[l];n.push({data:h,width:r,height:c})}return n}_findExtremas(t,e){let n=[];for(let s=0;s<t.length;s++){let o=t[s];if(!o)continue;let i=s>0?t[s-1]:null,r=s<t.length-1?t[s+1]:null,c=o.width,h=o.height;for(let l=1;l<h-1;l++)for(let u=1;u<c-1;u++){let f=o.data[l*c+u];if(Math.abs(f)<.003)continue;let d=!0,p=!0;for(let x=-1;x<=1&&(d||p);x++)for(let m=-1;m<=1&&(d||p);m++){if(m===0&&x===0)continue;let I=o.data[(l+x)*c+(u+m)];I>=f&&(d=!1),I<=f&&(p=!1)}if((d||p)&&i){let x=u<<1,m=l<<1,I=i.width;for(let w=-1;w<=1&&(d||p);w++)for(let M=-1;M<=1&&(d||p);M++){let y=Math.max(0,Math.min(I-1,x+M)),b=Math.max(0,Math.min(i.height-1,m+w)),g=i.data[b*I+y];g>=f&&(d=!1),g<=f&&(p=!1)}}if((d||p)&&r){let x=u>>1,m=l>>1,I=r.width;for(let w=-1;w<=1&&(d||p);w++)for(let M=-1;M<=1&&(d||p);M++){let y=Math.max(0,Math.min(I-1,x+M)),b=Math.max(0,Math.min(r.height-1,m+w)),g=r.data[b*I+y];g>=f&&(d=!1),g<=f&&(p=!1)}}(d||p)&&n.push({score:d?Math.abs(f):-Math.abs(f),octave:s,x:u,y:l,absScore:Math.abs(f)})}}return n}_applyPrune(t){let e=ys,n=this.maxFeaturesPerBucket,s=[];for(let i=0;i<e*e;i++)s.push([]);for(let i of t){let r=Math.min(e-1,Math.floor(i.x/(this.width/Math.pow(2,i.octave))*e)),h=Math.min(e-1,Math.floor(i.y/(this.height/Math.pow(2,i.octave))*e))*e+r;h>=0&&h<s.length&&s[h].push(i)}let o=[];for(let i of s){i.sort((r,c)=>c.absScore-r.absScore);for(let r=0;r<Math.min(n,i.length);r++)o.push(i[r])}return o}_computeOrientations(t,e){for(let n of t){if(n.octave<0||n.octave>=e.length){n.angle=0;continue}let s=e[n.octave][1],o=s.width,i=s.height,r=s.data,c=Math.floor(n.x),h=Math.floor(n.y),l=new Float32Array(kt),u=4;for(let d=-u;d<=u;d++)for(let p=-u;p<=u;p++){let x=h+d,m=c+p;if(x<=0||x>=i-1||m<=0||m>=o-1)continue;let I=r[(x+1)*o+m]-r[(x-1)*o+m],w=r[x*o+m+1]-r[x*o+m-1],M=Math.sqrt(w*w+I*I),y=Math.atan2(I,w)+Math.PI,b=Math.floor(y/(2*Math.PI)*kt)%kt,g=Math.exp(-(p*p+d*d)/(2*u*u));l[b]+=M*g}let f=0;for(let d=1;d<kt;d++)l[d]>l[f]&&(f=d);n.angle=(f+.5)*2*Math.PI/kt-Math.PI}}_computeFreakDescriptors(t,e){for(let n of t){if(n.octave<0||n.octave>=e.length){n.descriptors=new Uint8Array(8);continue}let s=e[n.octave][1],o=s.width,i=s.height,r=s.data,c=Math.cos(n.angle||0)*an,h=Math.sin(n.angle||0)*an,l=new Float32Array(rt.length);for(let u=0;u<rt.length;u++){let[,f,d]=rt[u],p=n.x+f*c-d*h,x=n.y+f*h+d*c,m=Math.max(0,Math.min(o-2,Math.floor(p))),I=Math.max(0,Math.min(i-2,Math.floor(x))),w=m+1,M=I+1,y=p-m,b=x-I;l[u]=r[I*o+m]*(1-y)*(1-b)+r[I*o+w]*y*(1-b)+r[M*o+m]*(1-y)*b+r[M*o+w]*y*b}this.useLSH?(n.lsh=Qe(l),n.descriptors=en(n.lsh)):n.descriptors=tn(l)}}}});function yt(a){return a=a>>>0,a-=a>>>1&1431655765,a=(a&858993459)+(a>>>2&858993459),(a+(a>>>4)&252645135)*16843009>>>24}var cn,_e,$t,ve=q(()=>{"use strict";cn=new Uint8Array(256);for(let a=0;a<256;a++){let t=0,e=a;for(;e>0;)e&=e-1,t++;cn[a]=t}_e=(a,t,e,n)=>{let s=(a[t]^e[n])>>>0,o=(a[t+1]^e[n+1])>>>0;s-=s>>>1&1431655765,s=(s&858993459)+(s>>>2&858993459);let i=(s+(s>>>4)&252645135)*16843009>>>24;o-=o>>>1&1431655765,o=(o&858993459)+(o>>>2&858993459);let r=(o+(o>>>4)&252645135)*16843009>>>24;return i+r},$t=a=>{let{v1:t,v2:e,v1Offset:n=0,v2Offset:s=0}=a,o=e.length-s;if(o===2)return _e(t,n,e,s);if(o===84){let i=0;for(let r=0;r<84;r++)i+=cn[t[n+r]^e[s+r]];return i}return o===4?yt(t[n]^e[s])+yt(t[n+1]^e[s+1])+yt(t[n+2]^e[s+2])+yt(t[n+3]^e[s+3]):yt(t[n]^e[s])+yt(t[n+1]^e[s+1])}});var Zt,Ie=q(()=>{"use strict";Zt=()=>({seed:1234,arrayShuffle(t){let{arr:e,sampleSize:n}=t;for(let s=0;s<n;s++){this.seed=(214013*this.seed+2531011)%-2147483648;let o=this.seed>>16&32767;o=o%e.length;let i=e[s];e[s]=e[o],e[o]=i}},nextInt(t){this.seed=(214013*this.seed+2531011)%-2147483648;let e=this.seed>>16&32767;return e=e%t,e}})});function ut(a){return a=a-(a>>1&1431655765),a=(a&858993459)+(a>>2&858993459),(a+(a>>4)&252645135)*16843009>>24}var bs,ws,Tt,_s,ke,ln,Ee=q(()=>{"use strict";ve();Ie();bs=32,ws=12,Tt=8;_s=a=>{let{descriptors:t,pointIndexes:e,randomizer:n,useHDC:s}=a,o=e.length,i=new Int32Array(o);for(let l=0;l<o;l++)i[l]=l;let r=Number.MAX_SAFE_INTEGER,c=null,h=new Int32Array(Tt);for(let l=0;l<ws;l++){n.arrayShuffle({arr:i,sampleSize:Tt});for(let d=0;d<Tt;d++)h[d]=e[i[d]];let u=0,f=new Int32Array(o);for(let d=0;d<o;d++){let p=e[d],x=255,m=-1;for(let I=0;I<Tt;I++){let w=h[I],M;s?M=ut(t[p]^t[w]):M=_e(t,p*2,t,w*2),M<x&&(m=i[I],x=M)}f[d]=m,u+=x}u<r&&(r=u,c=f)}return c},ke=({points:a})=>{let t=a.length;if(t===0)return{rootNode:{leaf:!0,pointIndexes:[],centerPointIndex:null}};let e=a[0]&&a[0].hdcSignature!==void 0,n=new Uint32Array(e?t:t*2);for(let r=0;r<t;r++)if(e)n[r]=a[r].hdcSignature;else{let c=a[r].descriptors;n[r*2]=c[0],n[r*2+1]=c[1]}let s=new Int32Array(t);for(let r=0;r<t;r++)s[r]=r;let o=Zt();return{rootNode:ln({descriptors:n,pointIndexes:s,centerPointIndex:null,randomizer:o,useHDC:e})}},ln=a=>{let{descriptors:t,pointIndexes:e,centerPointIndex:n,randomizer:s,useHDC:o}=a,i=e.length,r=!1;(i<=Tt||i<=bs)&&(r=!0);let c=new Map;if(!r){let l=_s({descriptors:t,pointIndexes:e,randomizer:s,useHDC:o});for(let u=0;u<l.length;u++){let f=e[l[u]],d=c.get(f);d===void 0&&(d=[],c.set(f,d)),d.push(e[u])}c.size===1&&(r=!0)}let h={centerPointIndex:n};if(r)return h.leaf=!0,h.pointIndexes=new Int32Array(e),h;h.leaf=!1,h.children=[];for(let[l,u]of c)h.children.push(ln({descriptors:t,pointIndexes:new Int32Array(u),centerPointIndex:l,randomizer:s,useHDC:o}));return h}});var Qt,Te,ft,Se=q(()=>{"use strict";Qt=(a,t)=>[[a[0][0]*t[0][0]+a[0][2]*t[2][0],a[0][0]*t[0][1]+a[0][2]*t[2][1],a[0][0]*t[0][2]+a[0][2]*t[2][2],a[0][0]*t[0][3]+a[0][2]*t[2][3]],[a[1][1]*t[1][0]+a[1][2]*t[2][0],a[1][1]*t[1][1]+a[1][2]*t[2][1],a[1][1]*t[1][2]+a[1][2]*t[2][2],a[1][1]*t[1][3]+a[1][2]*t[2][3]],[t[2][0],t[2][1],t[2][2],t[2][3]]],Te=(a,t,e,n)=>{let s=a[0][0]*t+a[0][1]*e+a[0][3],o=a[1][0]*t+a[1][1]*e+a[1][3],i=a[2][0]*t+a[2][1]*e+a[2][3];return{x:s,y:o,z:i}},ft=(a,t,e,n)=>{let{x:s,y:o,z:i}=Te(a,t,e,n);return{x:s/i,y:o/i}}});function fn({mesh:a,trackedPoints:t,currentVertices:e,iterations:n=5}){let{e:s,rl:o}=a,i=e.length/2,r=new Float32Array(e),c=.8,h=.5;for(let l=0;l<n;l++){for(let u=0;u<o.length;u++){let f=s[u*2],d=s[u*2+1],p=o[u],x=r[f*2],m=r[f*2+1],I=r[d*2],w=r[d*2+1],M=I-x,y=w-m,b=Math.sqrt(M*M+y*y);if(b<1e-4)continue;let g=(b-p)/b,_=M*.5*g*c,E=y*.5*g*c;r[f*2]+=_,r[f*2+1]+=E,r[d*2]-=_,r[d*2+1]-=E}for(let u of t){let f=u.meshIndex;if(f===void 0)continue;let d=u.x,p=u.y;r[f*2]+=(d-r[f*2])*h,r[f*2+1]+=(p-r[f*2+1])*h}}return r}var dn=q(()=>{"use strict"});var mn,ks,Es,pn,xt,Ae=q(()=>{"use strict";Se();dn();pt();mn=N.TRACKER_TEMPLATE_SIZE,ks=N.TRACKER_SEARCH_SIZE,Es=1,pn=N.TRACKER_SIMILARITY_THRESHOLD,xt=class{constructor(t,e,n,s,o,i=!1){this.markerDimensions=t,this.trackingDataList=e,this.projectionTransform=n,this.inputWidth=s,this.inputHeight=o,this.debugMode=i,this.trackingKeyframeList=[],this.prebuiltData=[];for(let h=0;h<e.length;h++){let l=e[h];this.trackingKeyframeList[h]=l,this.prebuiltData[h]=l.map(u=>({px:new Float32Array(u.px),py:new Float32Array(u.py),data:new Uint8Array(u.d),width:u.w,height:u.h,scale:u.s,mesh:u.mesh,projectedImage:new Float32Array(u.w*u.h)}))}this.meshVerticesState=[];let c=mn*2+1;this.templateBuffer=new Float32Array(c*c)}dummyRun(t){let e=[[1,0,0,0],[0,1,0,0],[0,0,1,0]];for(let n=0;n<this.trackingKeyframeList.length;n++)this.track(t,e,n)}track(t,e,n){let s={},o=Qt(this.projectionTransform,e),[i,r]=this.markerDimensions[n],c=ft(o,0,0),h=ft(o,i,0),l=Math.sqrt((h.x-c.x)**2+(h.y-c.y)**2);this.lastOctaveIndex||(this.lastOctaveIndex=[]);let u=this.lastOctaveIndex[n]!==void 0?this.lastOctaveIndex[n]:0,f=Math.abs(this.prebuiltData[n][u].width-l),d=.8;for(let k=0;k<this.prebuiltData[n].length;k++){let A=Math.abs(this.prebuiltData[n][k].width-l);A<f*d&&(f=A,u=k)}this.lastOctaveIndex[n]=u;let p=this.prebuiltData[n][u];this._computeProjection(o,t,p);let x=p.projectedImage,{matchingPoints:m,sim:I}=this._computeMatching(p,x),w=this.trackingKeyframeList[n][u],M=[],y=[],b=[],{px:g,py:_,s:E}=w,v=[];for(let k=0;k<m.length;k++){let A=I[k];if(A>pn&&k<g.length){b.push(k);let R=ft(o,m[k][0],m[k][1]);y.push(R),M.push({x:g[k]/E,y:_[k]/E,z:0}),v.push(A)}}let S=null;if(p.mesh&&b.length>=4){this.meshVerticesState[n]||(this.meshVerticesState[n]=[]);let k=this.meshVerticesState[n][u];if(!k){k=new Float32Array(g.length*2);for(let F=0;F<g.length;F++)k[F*2]=g[F],k[F*2+1]=_[F]}let A=[];for(let F=0;F<b.length;F++){let C=b[F];A.push({meshIndex:C,x:m[C][0]*E,y:m[C][1]*E})}let R=fn({mesh:p.mesh,trackedPoints:A,currentVertices:k,iterations:5});this.meshVerticesState[n][u]=R;let P=new Float32Array(R.length);for(let F=0;F<R.length;F+=2){let C=ft(o,R[F]/E,R[F+1]/E);P[F]=C.x,P[F+1]=C.y}S={vertices:P,triangles:p.mesh.t}}if(y.length>=8){let k=1/0,A=1/0,R=-1/0,P=-1/0;for(let C of y)C.x<k&&(k=C.x),C.y<A&&(A=C.y),C.x>R&&(R=C.x),C.y>P&&(P=C.y);if(Math.sqrt((R-k)**2+(P-A)**2)<l*.15)return{worldCoords:[],screenCoords:[],reliabilities:[],debugExtra:s}}return this.debugMode&&(s={octaveIndex:u,projectedImage:x,matchingPoints:m,goodTrack:b,trackedPoints:y}),{worldCoords:M,screenCoords:y,reliabilities:v,indices:b,octaveIndex:u,deformedMesh:S,debugExtra:s}}_computeMatching(t,e){let{px:n,py:s,scale:o,data:i,width:r,height:c}=t,h=n.length,l=mn,u=l*2+1,d=1/(u*u),p=ks,x=Es,m=[],I=new Float32Array(h),w=this.templateBuffer;for(let M=0;M<h;M++){let y=n[M]+.5|0,b=s[M]+.5|0,g=-1,_=n[M]/o,E=s[M]/o,v=0,S=0,k=0;for(let P=-l;P<=l;P++){let F=(b+P)*r;for(let C=-l;C<=l;C++){let H=i[F+y+C];w[k++]=H,v+=H,S+=H*H}}let A=Math.sqrt(Math.max(0,S-v*v*d));if(A<1e-4){I[M]=-1,m.push([_,E]);continue}let R=4;for(let P=-p;P<=p;P+=R){let F=b+P;if(!(F<l||F>=c-l))for(let C=-p;C<=p;C+=R){let H=y+C;if(H<l||H>=r-l)continue;let U=0,L=0,O=0;for(let V=-l;V<=l;V++){let z=(F+V)*r,$=(V+l)*u;for(let W=-l;W<=l;W++){let G=e[z+(H+W)],X=w[$+(W+l)];U+=G,L+=G*G,O+=G*X}}let T=Math.sqrt(Math.max(0,L-U*U*d));if(T<1e-4)continue;let D=(O-U*v*d)/(T*A);D>g&&(g=D,_=H/o,E=F/o)}}if(g>pn){let P=_*o|0,F=E*o|0,C=R;for(let H=-C;H<=C;H++){let U=F+H;if(!(U<l||U>=c-l))for(let L=-C;L<=C;L++){let O=P+L;if(O<l||O>=r-l)continue;let T=0,D=0,V=0;for(let W=-l;W<=l;W++){let G=(U+W)*r,X=(W+l)*u;for(let Y=-l;Y<=l;Y++){let K=e[G+(O+Y)],Z=w[X+(Y+l)];T+=K,D+=K*K,V+=K*Z}}let z=Math.sqrt(Math.max(0,D-T*T*d));if(z<1e-4)continue;let $=(V-T*v*d)/(z*A);$>g&&(g=$,_=O/o,E=U/o)}}}I[M]=g,m.push([_,E])}return{matchingPoints:m,sim:I}}_computeProjection(t,e,n){let{width:s,height:o,scale:i,projectedImage:r}=n,c=1/i,h=this.inputWidth,l=this.inputHeight,u=t[0][0],f=t[0][1],d=t[0][3],p=t[1][0],x=t[1][1],m=t[1][3],I=t[2][0],w=t[2][1],M=t[2][3];for(let y=0;y<o;y++){let b=y*c,g=y*s;for(let _=0;_<s;_++){let E=_*c,S=1/(E*I+b*w+M),k=(E*u+b*f+d)*S,A=(E*p+b*x+m)*S,R=k|0,P=A|0,F=R+1,C=P+1;if(R>=0&&F<h&&P>=0&&C<l){let H=k-R,U=A-P,L=1-H,O=1-U,T=P*h,D=C*h,V=e[T+R],z=e[T+F],$=e[D+R],W=e[D+F];r[g+_]=V*L*O+z*H*O+$*L*U+W*H*U}else r[g+_]=0}}}}});var Ce,Ts,gn=q(()=>{"use strict";Ce=a=>{let{keywidth:t,keyheight:e,querywidth:n,queryheight:s,matches:o}=a,i=n*1.2,r=-i,c=s*1.2,h=-c,l=12,u=12,f=-2,d=1,x=1/Math.log(10),m=Math.max(t,e),I=Math.floor(t/2),w=Math.floor(e/2),M=[];for(let T=0;T<o.length;T++){let D=o[T].querypoint.scale,V=o[T].keypoint.scale;V==0&&console.log("ERROR divide zero");let z=D/V;M.push(z*m)}M.sort((T,D)=>T-D);let y=M[Math.floor(M.length/2)-(M.length%2==0?1:0)-1],b=Math.max(20,.25*y),g=Math.max(5,Math.min(40,Math.ceil((i-r)/b))),_=Math.max(5,Math.min(40,Math.ceil((c-h)/b))),E=g*_,v=E*l,S=[],k=[],A={};for(let T=0;T<o.length;T++){let D=o[T].querypoint,V=o[T].keypoint,{x:z,y:$,scale:W,angle:G}=Ts({querypoint:D,keypoint:V,keycenterX:I,keycenterY:w,scaleOneOverLogK:x});if(z<r||z>=i||$<h||$>=c||G<=-Math.PI||G>Math.PI||W<f||W>=d){S[T]=!1;continue}let X=g*(z-r)/(i-r),Y=_*($-h)/(c-h),K=l*(G+Math.PI)/(2*Math.PI),Z=u*(W-f)/(d-f);k[T]={binX:X,binY:Y,binAngle:K,binScale:Z};let nt=Math.floor(X-.5),et=Math.floor(Y-.5),J=Math.floor(Z-.5),it=(Math.floor(K-.5)+l)%l;if(nt<0||nt+1>=g||et<0||et+1>=_||J<0||J+1>=u){S[T]=!1;continue}for(let ct=0;ct<2;ct++){let ot=nt+ct;for(let wt=0;wt<2;wt++){let Vt=et+wt;for(let mt=0;mt<2;mt++){let Ge=(it+mt)%l;for(let st=0;st<2;st++){let ss=J+st,ue=ot+Vt*g+Ge*E+ss*v;A[ue]===void 0&&(A[ue]=0),A[ue]+=1}}}}S[T]=!0}let R=0,P=-1;if(Object.keys(A).forEach(T=>{A[T]>R&&(R=A[T],P=T)}),R<3)return[];let F=Math.floor(P%v%E%g),C=Math.floor((P-F)%v%E/g),H=Math.floor((P-F-C*g)%v/E),U=Math.floor((P-F-C*g-H*E)/v),L=[],O=2;for(let T=0;T<o.length;T++){if(!S[T])continue;let D=k[T];if(Math.abs(D.binX-(F+.5))>=O||Math.abs(D.binY-(C+.5))>=O||Math.abs(D.binScale-(U+.5))>=O)continue;let W=Math.abs(D.binAngle-(H+.5));Math.min(W,l-W)>=O||L.push(o[T])}return L},Ts=({querypoint:a,keypoint:t,keycenterX:e,keycenterY:n,scaleOneOverLogK:s})=>{let o=a.angle-t.angle;o<=-Math.PI?o+=2*Math.PI:o>Math.PI&&(o-=2*Math.PI);let i=a.scale/t.scale,r=i*Math.cos(o),c=i*Math.sin(o),h=[r,-c,c,r],l=[h[0]*t.x+h[1]*t.y,h[2]*t.x+h[3]*t.y],u=a.x-l[0],f=a.y-l[1];return{x:h[0]*e+h[1]*n+u,y:h[2]*e+h[3]*n+f,angle:o,scale:Math.log(i)*s}}});var tt,yn,xn,Ss,Mn,ce,bn,wn,St,ae,Oe=q(()=>{"use strict";tt=(a,t,e)=>(t[0]-a[0])*(e[1]-a[1])-(t[1]-a[1])*(e[0]-a[0]),yn=(a,t,e,n,s,o,i,r)=>!(tt(a,t,e)>0!=tt(s,o,i)>0||tt(t,e,n)>0!=tt(o,i,r)>0||tt(e,n,a)>0!=tt(i,r,s)>0||tt(n,a,t)>0!=tt(r,s,o)>0),xn=(a,t,e,n,s,o)=>tt(a,t,e)>0==tt(n,s,o)>0,Ss=a=>{let t=a[4]*a[8]-a[5]*a[7],e=a[3]*a[8]-a[5]*a[6],n=a[3]*a[7]-a[4]*a[6];return a[0]*t-a[1]*e+a[2]*n},Mn=(a,t)=>{let e=Ss(a);if(Math.abs(e)<=t)return null;let n=1/e;return[(a[4]*a[8]-a[5]*a[7])*n,(a[2]*a[7]-a[1]*a[8])*n,(a[1]*a[5]-a[2]*a[4])*n,(a[5]*a[6]-a[3]*a[8])*n,(a[0]*a[8]-a[2]*a[6])*n,(a[2]*a[3]-a[0]*a[5])*n,(a[3]*a[7]-a[4]*a[6])*n,(a[1]*a[6]-a[0]*a[7])*n,(a[0]*a[4]-a[1]*a[3])*n]},ce=(a,t)=>{let e=t[6]*a[0]+t[7]*a[1]+t[8],n=[];return n[0]=(t[0]*a[0]+t[1]*a[1]+t[2])/e,n[1]=(t[3]*a[0]+t[4]*a[1]+t[5])/e,n},bn=(a,t,e,n)=>{let s=St(t,a),o=St(e,a),i=St(n,a),r=St(t,e),c=St(n,e),h=ae(s,o),l=ae(o,i),u=ae(s,i),f=ae(r,c);return Math.min(Math.min(Math.min(h,l),u),f)},wn=(a,t,e,n)=>{let s=tt(a,t,e)<=0;return!(tt(t,e,n)<=0!==s||tt(e,n,a)<=0!==s||tt(n,a,t)<=0!==s)},St=(a,t)=>[a[0]-t[0],a[1]-t[1]],ae=(a,t)=>{let e=a[0]*t[1]-a[1]*t[0];return Math.abs(e)*.5}});import{Matrix as _n,inverse as As}from"ml-matrix";var In,vn,Cs,kn=q(()=>{"use strict";In=(a,t)=>{let{normPoints:e,param:n}=vn(a),{normPoints:s,param:o}=vn(t),i=s.length,r=[],c=[];for(let h=0;h<i;h++){let l=[e[h][0],e[h][1],1,0,0,0,-(e[h][0]*s[h][0]),-(e[h][1]*s[h][0])],u=[0,0,0,e[h][0],e[h][1],1,-(e[h][0]*s[h][1]),-(e[h][1]*s[h][1])];r.push(l),r.push(u),c.push([s[h][0]]),c.push([s[h][1]])}try{let h=new _n(r),l=new _n(c),u=h.transpose(),f=u.mmul(h),d=u.mmul(l),x=As(f).mmul(d).to1DArray();return Cs(x,n,o)}catch{return null}},vn=a=>{let t=0,e=0;for(let c=0;c<a.length;c++)t+=a[c][0],e+=a[c][1];let n=t/a.length,s=e/a.length,o=0;for(let c=0;c<a.length;c++){let h=a[c][0]-n,l=a[c][1]-s;o+=Math.sqrt(h*h+l*l)}let i=Math.sqrt(2)*a.length/o,r=[];for(let c=0;c<a.length;c++)r.push([(a[c][0]-n)*i,(a[c][1]-s)*i]);return{normPoints:r,param:{meanX:n,meanY:s,s:i}}},Cs=(a,t,e)=>{let n=e.s*e.meanX,s=e.s*e.meanY,o=[a[0]+n*a[6],a[1]+n*a[7],(a[0]+n*a[6])*-t.meanX+(a[1]+n*a[7])*-t.meanY+(a[2]+n)/t.s,a[3]+s*a[6],a[4]+s*a[7],(a[3]+s*a[6])*-t.meanX+(a[4]+s*a[7])*-t.meanY+(a[5]+s)/t.s,e.s*a[6],e.s*a[7],e.s*a[6]*-t.meanX+e.s*a[7]*-t.meanY+e.s/t.s];for(let i=0;i<9;i++)o[i]=o[i]/o[8];return o}});var Os,Fs,Rs,Ps,Fe,Ds,Hs,Us,Ls,En=q(()=>{"use strict";Ie();Oe();kn();Os=.01,Fs=10,Rs=100,Ps=50,Fe=a=>{let{srcPoints:t,dstPoints:e,keyframe:n,quickMode:s}=a,o=[[0,0],[n.width,0],[n.width,n.height],[0,n.height]],i=4;if(t.length<i)return null;let r=Os,c=1/(r*r),h=Math.min(Fs,t.length),l=Zt(),u=[];for(let M=0;M<t.length;M++)u[M]=M;l.arrayShuffle({arr:u,sampleSize:u.length});let f=s?Ps:Rs,d=f*2,p=0,x=[];for(;p<d&&x.length<f;){if(p+=1,l.arrayShuffle({arr:u,sampleSize:i}),!yn(t[u[0]],t[u[1]],t[u[2]],t[u[3]],e[u[0]],e[u[1]],e[u[2]],e[u[3]]))continue;let M=In([t[u[0]],t[u[1]],t[u[2]],t[u[3]]],[e[u[0]],e[u[1]],e[u[2]],e[u[3]]]);M!==null&&Ls({H:M,testPoints:o})&&x.push(M)}if(x.length===0)return null;let m=[];for(let M=0;M<x.length;M++)m.push({H:x[M],cost:0});let I=h;for(let M=0;M<t.length&&m.length>2;M+=I){I=Math.min(h,t.length-M);let y=M+I;for(let b=0;b<m.length;b++)for(let g=M;g<y;g++){let _=Us({H:m[b].H,srcPoint:t[g],dstPoint:e[g],oneOverScale2:c});m[b].cost+=_}m.sort((b,g)=>b.cost-g.cost),m.splice(-Math.floor((m.length+1)/2))}let w=null;for(let M=0;M<m.length;M++){let y=Hs({inH:m[M].H});if(Ds({H:y,testPoints:o,keyframe:n})){w=y;break}}return w},Ds=({H:a,testPoints:t,keyframe:e})=>{let n=[];for(let o=0;o<t.length;o++)n.push(ce(t[o],a));return!(bn(n[0],n[1],n[2],n[3])<e.width*e.height*1e-4||!wn(n[0],n[1],n[2],n[3]))},Hs=({inH:a})=>{let t=1/a[8],e=[];for(let n=0;n<8;n++)e[n]=a[n]*t;return e[8]=1,e},Us=({H:a,srcPoint:t,dstPoint:e,oneOverScale2:n})=>{let s=ce(t,a),o=[s[0]-e[0],s[1]-e[1]];return Math.log(1+(o[0]*o[0]+o[1]*o[1])*n)},Ls=({H:a,testPoints:t})=>{let e=[];for(let n=0;n<t.length;n++)e[n]=ce(t[n],a);for(let n=0;n<t.length;n++){let s=n,o=(n+1)%t.length,i=(n+2)%t.length;if(!xn(t[s],t[o],t[i],e[s],e[o],e[i]))return!1}return!0}});import{Matrix as Ns,SingularValueDecomposition as Bs}from"ml-matrix";function Tn({imageData:a,width:t,height:e,targetData:n,initialH:s,iterations:o=3}){let i=[...s],r=[],c=.05;for(let h=0;h<=1;h+=c)r.push({x:h*n.w,y:0}),r.push({x:h*n.w,y:n.h}),r.push({x:0,y:h*n.h}),r.push({x:n.w,y:h*n.h});for(let h=0;h<o;h++){let l=[];for(let f of r){let d=i[6]*f.x+i[7]*f.y+i[8],p=(i[0]*f.x+i[1]*f.y+i[2])/d,x=(i[3]*f.x+i[4]*f.y+i[5])/d;if(p<2||p>=t-2||x<2||x>=e-2)continue;let m=10,I=p,w=x,M=-1;for(let y=-m;y<=m;y+=2)for(let b=-m;b<=m;b+=2){let g=Math.floor(p+b),_=Math.floor(x+y),E=_*t+g,v=a[E+1]-a[E-1],S=a[E+t]-a[E-t],k=v*v+S*S;k>M&&(M=k,I=g,w=_)}M>500&&l.push({src:f,dst:{x:I,y:w},weight:Math.min(1,M/15e3)})}if(l.length<10)break;let u=Ws(l);if(u)for(let f=0;f<9;f++)i[f]=i[f]*.5+u[f]*.5}return i}function Ws(a){let t=a.length,e=new Ns(t*2,9);for(let n=0;n<t;n++){let{src:s,dst:o,weight:i}=a[n],r=s.x,c=s.y,h=o.x,l=o.y;e.set(n*2,0,0),e.set(n*2,1,0),e.set(n*2,2,0),e.set(n*2,3,-r*i),e.set(n*2,4,-c*i),e.set(n*2,5,-i),e.set(n*2,6,l*r*i),e.set(n*2,7,l*c*i),e.set(n*2,8,l*i),e.set(n*2+1,0,r*i),e.set(n*2+1,1,c*i),e.set(n*2+1,2,i),e.set(n*2+1,3,0),e.set(n*2+1,4,0),e.set(n*2+1,5,0),e.set(n*2+1,6,-h*r*i),e.set(n*2+1,7,-h*c*i),e.set(n*2+1,8,-h*i)}try{let o=new Bs(e).rightSingularVectors.getColumn(8),i=1/o[8];return o.map(r=>r*i)}catch{return null}}var Sn=q(()=>{"use strict"});import Vs from"tinyqueue";var An,Re,qs,zs,Gs,Cn,Fn,Pe,On,Rn=q(()=>{"use strict";ve();gn();En();Oe();Sn();Ee();pt();An=N.INLIER_THRESHOLD,Re=N.MIN_NUM_INLIERS,qs=N.CLUSTER_MAX_POP,zs=N.HAMMING_THRESHOLD,Gs=N.HDC_RATIO_THRESHOLD,Cn=N.MAX_MATCH_QUERY_POINTS,Fn=({keyframe:a,querypoints:t,querywidth:e,queryheight:n,debugMode:s,expectedScale:o})=>{let i={},r=t.length>Cn?[...t].sort((O,T)=>(T.score||T.response||0)-(O.score||O.response||0)).slice(0,Cn):t,c=[],h=r.length,l=a.max,u=a.min,f=a.hdc===!0||l&&l.hdc===1,d=l&&l.compact===1||u&&u.compact===1,p=f||d?1:2,x=f?Gs:zs;for(let O=0;O<h;O++){let T=r[O],D=T.maxima?l:u;if(!D||D.x.length===0)continue;let V=D.t,z=[],$=new Vs([],(nt,et)=>nt.d-et.d);Pe({node:V,descriptors:D.d,querypoint:T,queue:$,keypointIndexes:z,numPop:0,isHDC:f,descSize:p,isCompact:d});let W=-1,G=Number.MAX_SAFE_INTEGER,X=Number.MAX_SAFE_INTEGER,Y=T.descriptors,K=D.d,Z=d&&Y&&Y.length>=2?(Y[0]^Y[1])>>>0:0;for(let nt=0;nt<z.length;nt++){let et=z[nt];if(o!==void 0&&D.s){let it=D.s[et],ct=(T.scale||1)/o;if(it<ct*.4||it>ct*2.5)continue}let J;f?J=ut(K[et]^T.hdcSignature):d?J=ut(K[et]^Z):J=$t({v1:K,v1Offset:et*p,v2:Y}),J<G?(X=G,G=J,W=et):J<X&&(X=J)}W!==-1&&(X===Number.MAX_SAFE_INTEGER||G/X<x)&&c.push({querypoint:T,keypoint:{x:D.x[W],y:D.y[W],angle:D.a[W],scale:D.s?D.s[W]:a.s},d:G})}if(c.length<Re)return{debugExtra:i};let m=c;s&&(i.constellationMatches=m);let I=Ce({keywidth:a.w||a.width,keyheight:a.h||a.height,querywidth:e,queryheight:n,matches:m});if(s&&(i.houghMatches=I),I.length<Re)return{debugExtra:i};let w=Fe({srcPoints:I.map(O=>[O.keypoint.x,O.keypoint.y]),dstPoints:I.map(O=>[O.querypoint.x,O.querypoint.y]),keyframe:{width:a.w||a.width,height:a.h||a.height}});if(w===null)return{debugExtra:i};let M=On({H:w,matches:I,threshold:An});if(s&&(i.inlierMatches=M),M.length<Re)return{debugExtra:i};s&&Math.random()<.02&&console.log(`MATCH: Homography success with ${M.length} inliers`);let y=Mn(w,1e-5),b=100,g=[],_=y[0],E=y[1],v=y[2],S=y[3],k=y[4],A=y[5],R=y[6],P=y[7],F=y[8];for(let O=0;O<h;O++){let T=r[O],D=T.x,V=T.y,$=1/(D*R+V*P+F),W=(D*_+V*E+v)*$,G=(D*S+V*k+A)*$,X=-1,Y=Number.MAX_SAFE_INTEGER,K=Number.MAX_SAFE_INTEGER,Z=T.maxima?l:u;if(!Z)continue;let nt=Z.x,et=Z.y,J=Z.d,it=T.descriptors,ct=d&&it&&it.length>=2?(it[0]^it[1])>>>0:0;for(let ot=0,wt=nt.length;ot<wt;ot++){let Vt=nt[ot]-W,mt=et[ot]-G;if(Vt*Vt+mt*mt>b)continue;let st;f?st=ut(J[ot]^T.hdcSignature):d?st=ut(J[ot]^ct):st=$t({v1:J,v1Offset:ot*p,v2:it}),st<Y?(K=Y,Y=st,X=ot):st<K&&(K=st)}X!==-1&&(K===Number.MAX_SAFE_INTEGER||Y/K<x)&&g.push({querypoint:T,keypoint:{x:Z.x[X],y:Z.y[X],angle:Z.a[X],scale:Z.s?Z.s[X]:a.s}})}s&&(i.matches2=g);let C=Ce({keywidth:a.w||a.width,keyheight:a.h||a.height,querywidth:e,queryheight:n,matches:g});s&&(i.houghMatches2=C);let H=Fe({srcPoints:C.map(O=>[O.keypoint.x,O.keypoint.y]),dstPoints:C.map(O=>[O.querypoint.x,O.querypoint.y]),keyframe:{width:a.w||a.width,height:a.h||a.height}});if(H===null)return{debugExtra:i};let U=On({H,matches:C,threshold:An});return s&&(i.inlierMatches2=U),{H:Tn({imageData:t[0].imageData,width:e,height:n,targetData:{w:a.w||a.width,h:a.h||a.height},initialH:H,iterations:3})||H,matches:U,debugExtra:i}},Pe=({node:a,descriptors:t,querypoint:e,queue:n,keypointIndexes:s,numPop:o,isHDC:i,descSize:r,isCompact:c})=>{let h=a[0]===1,l=a[2];if(h){for(let m=0;m<l.length;m++)s.push(l[m]);return}let u=e.descriptors,f=c&&u&&u.length>=2?(u[0]^u[1])>>>0:0,d=Number.MAX_SAFE_INTEGER,p=l.length,x=new Int32Array(p);for(let m=0;m<p;m++){let w=l[m][1],M;i?M=ut(t[w]^e.hdcSignature):c?M=ut(t[w]^f):M=$t({v1:t,v1Offset:w*r,v2:u}),x[m]=M,M<d&&(d=M)}for(let m=0;m<p;m++){let I=x[m];I<=d?Pe({node:l[m],descriptors:t,querypoint:e,queue:n,keypointIndexes:s,numPop:o+1,isHDC:i,descSize:r,isCompact:c}):n.push({node:l[m],d:I})}if(o<qs&&n.length>0){let{node:m}=n.pop();Pe({node:m,descriptors:t,querypoint:e,queue:n,keypointIndexes:s,numPop:o+1,isHDC:i,descSize:r,isCompact:c})}},On=a=>{let{H:t,matches:e,threshold:n}=a,s=n*n,o=t[0],i=t[1],r=t[2],c=t[3],h=t[4],l=t[5],u=t[6],f=t[7],d=t[8],p=[];for(let x=0;x<e.length;x++){let m=e[x],I=m.querypoint,w=m.keypoint,y=1/(w.x*u+w.y*f+d),b=(w.x*o+w.y*i+r)*y,g=(w.x*c+w.y*h+l)*y,_=b-I.x,E=g-I.y;_*_+E*E<=s&&p.push(m)}return p}});var Pn={};fe(Pn,{Matcher:()=>At});var At,De=q(()=>{"use strict";Rn();At=class{constructor(t,e,n=!1){this.queryWidth=t,this.queryHeight=e,this.debugMode=n}matchDetection(t,e,n){let s={frames:[]},o=null;if(!t||!Array.isArray(t))return{targetIndex:-1,keyframeIndex:-1,debugExtra:s};for(let l=0;l<t.length;l++){let{H:u,matches:f,debugExtra:d}=Fn({keyframe:t[l],querypoints:e,querywidth:this.queryWidth,queryheight:this.queryHeight,debugMode:this.debugMode,expectedScale:n});d&&(d.keyframeIndex=l,s.frames.push(d)),u&&(o===null||o.matches.length<f.length)&&(o={keyframeIndex:l,H:u,matches:f})}if(o===null)return{targetIndex:-1,keyframeIndex:-1,debugExtra:s};let i=[],r=[],c=t[o.keyframeIndex],h=c.s||c.scale||1;for(let l=0;l<o.matches.length;l++){let u=o.matches[l].querypoint,f=o.matches[l].keypoint,d=f.scale||h;i.push({x:u.x,y:u.y}),r.push({x:(f.x+.5)/h,y:(f.y+.5)/h,z:0})}return{screenCoords:i,worldCoords:r,targetIndex:-1,keyframeIndex:o.keyframeIndex,H:o.H,debugExtra:s}}}});import{Matrix as He,SingularValueDecomposition as Dn}from"ml-matrix";function Hn({screenCoords:a,worldCoords:t,projectionTransform:e}){let n=new He(e),s=a.length,o=Xs(e),i=new He(s*2,9);for(let g=0;g<s;g++){let _=a[g],E=t[g],v=o[0]*_.x+o[1]*_.y+o[2],S=o[3]*_.x+o[4]*_.y+o[5],k=o[6]*_.x+o[7]*_.y+o[8],A=v/k,R=S/k,P=E.x,F=E.y;i.set(g*2,0,P),i.set(g*2,1,F),i.set(g*2,2,1),i.set(g*2,3,0),i.set(g*2,4,0),i.set(g*2,5,0),i.set(g*2,6,-A*P),i.set(g*2,7,-A*F),i.set(g*2,8,-A),i.set(g*2+1,0,0),i.set(g*2+1,1,0),i.set(g*2+1,2,0),i.set(g*2+1,3,P),i.set(g*2+1,4,F),i.set(g*2+1,5,1),i.set(g*2+1,6,-R*P),i.set(g*2+1,7,-R*F),i.set(g*2+1,8,-R)}let h=new Dn(i).rightSingularVectors.getColumn(8);if(h[8]<0)for(let g=0;g<9;g++)h[g]=-h[g];let l=[h[0],h[3],h[6]],u=[h[1],h[4],h[7]],f=[h[2],h[5],h[8]],d=Math.sqrt(l[0]**2+l[1]**2+l[2]**2),p=Math.sqrt(u[0]**2+u[1]**2+u[2]**2),x=(d+p)/2,m=new He([[l[0]/d,u[0]/p,0],[l[1]/d,u[1]/p,0],[l[2]/d,u[2]/p,0]]);m.set(0,2,m.get(1,0)*m.get(2,1)-m.get(2,0)*m.get(1,1)),m.set(1,2,m.get(2,0)*m.get(0,1)-m.get(0,0)*m.get(2,1)),m.set(2,2,m.get(0,0)*m.get(1,1)-m.get(1,0)*m.get(0,1));let I=new Dn(m),w=I.leftSingularVectors,M=I.rightSingularVectors,y=w.mmul(M.transpose());if((g=>g.get(0,0)*(g.get(1,1)*g.get(2,2)-g.get(1,2)*g.get(2,1))-g.get(0,1)*(g.get(1,0)*g.get(2,2)-g.get(1,2)*g.get(2,0))+g.get(0,2)*(g.get(1,0)*g.get(2,1)-g.get(1,1)*g.get(2,0)))(y)<0){let g=w.clone();for(let _=0;_<3;_++)g.set(_,2,-g.get(_,2));y=g.mmul(M.transpose())}return[[y.get(0,0),y.get(0,1),y.get(0,2),f[0]/x],[y.get(1,0),y.get(1,1),y.get(1,2),f[1]/x],[y.get(2,0),y.get(2,1),y.get(2,2),f[2]/x]]}function Xs(a){let t=a[0][0],e=a[0][1],n=a[0][2],s=a[1][0],o=a[1][1],i=a[1][2],r=a[2][0],c=a[2][1],h=a[2][2],u=1/(t*(o*h-c*i)-e*(s*h-i*r)+n*(s*c-o*r));return[(o*h-i*c)*u,(n*c-e*h)*u,(e*i-n*o)*u,(i*r-s*h)*u,(t*h-n*r)*u,(s*n-t*i)*u,(s*c-o*r)*u,(r*e-c*t)*u,(t*o-s*e)*u]}var Un=q(()=>{"use strict"});var Ln,Nn=q(()=>{"use strict";Un();Ln=({screenCoords:a,worldCoords:t,projectionTransform:e})=>Hn({screenCoords:a,worldCoords:t,projectionTransform:e})});import{Matrix as Bn,inverse as js}from"ml-matrix";var Ys,Ks,Wn,$s,Zs,Q,dt,j,Vn,Js,Qs,ti,ei,qn=q(()=>{"use strict";Se();Ys=5,Ks=4,Wn=10,$s=.1,Zs=.99,Q=[[],[],[]],dt=[[],[]],j=[[],[],[]],Vn=({initialModelViewTransform:a,projectionTransform:t,worldCoords:e,screenCoords:n,stabilities:s})=>{let o=0,i=0;for(let f=0;f<e.length;f++)o+=e[f].x,i+=e[f].y;o/=e.length,i/=e.length;let r=[];for(let f=0;f<e.length;f++)r.push({x:e[f].x-o,y:e[f].y-i,z:e[f].z});let c=[[],[],[]];for(let f=0;f<3;f++)for(let d=0;d<3;d++)c[f][d]=a[f][d];c[0][3]=a[0][0]*o+a[0][1]*i+a[0][3],c[1][3]=a[1][0]*o+a[1][1]*i+a[1][3],c[2][3]=a[2][0]*o+a[2][1]*i+a[2][3];let h=[1,.8,.6,.4,0],l=c,u=null;for(let f=0;f<h.length;f++){let d=Js({initialModelViewTransform:l,projectionTransform:t,worldCoords:r,screenCoords:n,stabilities:s,inlierProb:h[f]});if(l=d.modelViewTransform,d.err<Ys){u=l;break}}return u===null?null:(u[0][3]=u[0][3]-u[0][0]*o-u[0][1]*i,u[1][3]=u[1][3]-u[1][0]*o-u[1][1]*i,u[2][3]=u[2][3]-u[2][0]*o-u[2][1]*i,u)},Js=({initialModelViewTransform:a,projectionTransform:t,worldCoords:e,screenCoords:n,stabilities:s,inlierProb:o})=>{let i=o<1,r=a,c=0,h=0,l=new Array(e.length),u=new Array(e.length),f=new Array(e.length),d=new Array(e.length);for(let p=0;p<=Wn;p++){let x=Qt(t,r);for(let y=0;y<e.length;y++){let b=ft(x,e[y].x,e[y].y,e[y].z),g=n[y].x-b.x,_=n[y].y-b.y;f[y]=g,d[y]=_,l[y]=g*g+_*_}let m;if(h=0,i){let y=Math.max(3,Math.floor(e.length*o)-1);for(let b=0;b<e.length;b++)u[b]=l[b];u.sort((b,g)=>b-g),m=Math.max(u[y]*Ks,16);for(let b=0;b<e.length;b++)u[b]>m?h+=m/6:h+=m/6*(1-(1-u[b]/m)*(1-u[b]/m)*(1-u[b]/m))}else for(let y=0;y<e.length;y++)h+=l[y];if(h/=e.length,h<$s||p>0&&h/c>Zs||p===Wn)break;c=h;let I=[],w=[];for(let y=0;y<e.length;y++){if(i&&l[y]>m)continue;let b=ei({modelViewProjectionTransform:x,modelViewTransform:r,projectionTransform:t,worldCoord:e[y]});if(i){let g=(1-l[y]/m)*(1-l[y]/m),_=s?s[y]:1,E=_*Math.log10(9*_+1),v=g*E;for(let S=0;S<2;S++)for(let k=0;k<6;k++)b[S][k]*=v;I.push([f[y]*v]),I.push([d[y]*v])}else{let g=s?s[y]:1,_=g*Math.log10(9*g+1);for(let E=0;E<2;E++)for(let v=0;v<6;v++)b[E][v]*=_;I.push([f[y]*_]),I.push([d[y]*_])}for(let g=0;g<b.length;g++)w.push(b[g])}let M=ti({dU:I,J_U_S:w});if(M===null)break;r=Qs({modelViewTransform:r,dS:M})}return{modelViewTransform:r,err:h}},Qs=({modelViewTransform:a,dS:t})=>{let e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],n,s,o;e<1e-6?(n=1,s=0,o=0,e=0):(e=Math.sqrt(e),n=t[0]/e,s=t[1]/e,o=t[2]/e);let i=Math.cos(e),r=Math.sin(e),c=1-i;Q[0][0]=n*n*c+i,Q[0][1]=n*s*c-o*r,Q[0][2]=n*o*c+s*r,Q[0][3]=t[3],Q[1][0]=s*n*c+o*r,Q[1][1]=s*s*c+i,Q[1][2]=s*o*c-n*r,Q[1][3]=t[4],Q[2][0]=o*n*c-s*r,Q[2][1]=o*s*c+n*r,Q[2][2]=o*o*c+i,Q[2][3]=t[5];let h=[[],[],[]];for(let l=0;l<3;l++){for(let u=0;u<4;u++)h[l][u]=a[l][0]*Q[0][u]+a[l][1]*Q[1][u]+a[l][2]*Q[2][u];h[l][3]+=a[l][3]}return h},ti=({dU:a,J_U_S:t})=>{let e=new Bn(t),n=new Bn(a),s=e.transpose(),o=s.mmul(e),i=s.mmul(n),r;try{r=js(o)}catch{return null}return r.mmul(i).to1DArray()},ei=({modelViewProjectionTransform:a,modelViewTransform:t,projectionTransform:e,worldCoord:n})=>{let s=t,{x:o,y:i,z:r}=n,c=Te(a,o,i,r),h=c.z*c.z;dt[0][0]=e[0][0]*c.z/h,dt[0][1]=e[0][1]*c.z/h,dt[0][2]=(e[0][2]*c.z-e[2][2]*c.x)/h,dt[1][0]=e[1][0]*c.z/h,dt[1][1]=e[1][1]*c.z/h,dt[1][2]=(e[1][2]*c.z-e[2][2]*c.y)/h,j[0][0]=s[0][2]*i,j[0][1]=-s[0][2]*o,j[0][2]=s[0][1]*o-s[0][0]*i,j[0][3]=s[0][0],j[0][4]=s[0][1],j[0][5]=s[0][2],j[1][0]=s[1][2]*i,j[1][1]=-s[1][2]*o,j[1][2]=s[1][1]*o-s[1][0]*i,j[1][3]=s[1][0],j[1][4]=s[1][1],j[1][5]=s[1][2],j[2][0]=s[2][2]*i,j[2][1]=-s[2][2]*o,j[2][2]=s[2][1]*o-s[2][0]*i,j[2][3]=s[2][0],j[2][4]=s[2][1],j[2][5]=s[2][2];let l=[[],[]];for(let u=0;u<2;u++)for(let f=0;f<6;f++){l[u][f]=0;for(let d=0;d<3;d++)l[u][f]+=dt[u][d]*j[d][f]}return l}});var Ue={};fe(Ue,{Estimator:()=>Ct});var Ct,le=q(()=>{"use strict";Nn();qn();Ct=class{constructor(t){this.projectionTransform=t}estimate({screenCoords:t,worldCoords:e}){return Ln({screenCoords:t,worldCoords:e,projectionTransform:this.projectionTransform})}refineEstimate({initialModelViewTransform:t,worldCoords:e,screenCoords:n}){return Vn({initialModelViewTransform:t,worldCoords:e,screenCoords:n,projectionTransform:this.projectionTransform})}}});var ni={};var zn,Le,Gn,Ne,Xn,jn,Yn=q(()=>{"use strict";De();le();Ae();Et();zn=null,Le=!1,Gn=null,Ne=null,Xn=null,jn=null;onmessage=a=>{let{data:t}=a;switch(t.type){case"setup":zn=t.matchingDataList,Le=t.debugMode,Gn=new At(t.inputWidth,t.inputHeight,Le),Ne=new Ct(t.projectionTransform),t.trackingDataList&&t.markerDimensions&&(Xn=new xt(t.markerDimensions,t.trackingDataList,t.projectionTransform,t.inputWidth,t.inputHeight,Le)),jn=new at(t.inputWidth,t.inputHeight,{useLSH:!0,maxFeaturesPerBucket:24});break;case"match":let e=t.targetIndexes,n=-1,s=null,o=null,i=null,r=null,c=t.featurePoints;t.inputData&&(c=jn.detect(t.inputData,{octavesToProcess:t.octavesToProcess}).featurePoints);for(let w=0;w<e.length;w++){let M=e[w],{keyframeIndex:y,screenCoords:b,worldCoords:g,debugExtra:_}=Gn.matchDetection(zn[M],c,t.expectedScale);if(r=_,y!==-1){let E=Ne.estimate({screenCoords:b,worldCoords:g});E&&(n=M,s=E,o=b,i=g);break}}postMessage({type:"matchDone",targetIndex:n,modelViewTransform:s,screenCoords:o,worldCoords:i,featurePoints:c,debugExtra:r});break;case"track":let{inputData:h,lastModelViewTransform:l,targetIndex:u}=t,f=Xn.track(h,l,u);postMessage({type:"trackDone",targetIndex:u,...f});break;case"trackUpdate":let{modelViewTransform:d,worldCoords:p,screenCoords:x,stabilities:m}=t,I=Ne.refineEstimate({initialModelViewTransform:d,worldCoords:p,screenCoords:x,stabilities:m});postMessage({type:"trackUpdateDone",modelViewTransform:I});break;case"dispose":close();break;default:throw new Error(`Invalid message type '${t.type}'`)}}});var os=({image:a})=>{let{data:t,width:e,height:n}=a,s=e>>>1,o=n>>>1,i=new Uint8Array(s*o);for(let r=0;r<o;r++){let c=r*2*e,h=c+e,l=r*s;for(let u=0;u<s;u++){let f=u*2,d=t[c+f]+t[c+f+1]+t[h+f]+t[h+f+1]>>2;i[l+u]=d&255}}return{data:i,width:s,height:o}},de=({image:a,ratio:t})=>{if(t===1)return{data:new Uint8Array(a.data),width:a.width,height:a.height};if(t<=.5)return de({image:os({image:a}),ratio:t*2});let e=Math.round(a.width*t)|0,n=Math.round(a.height*t)|0,s=new Uint8Array(e*n),o=a.data,i=a.width|0,r=a.height|0,c=i-1|0,h=r-1|0,l=0;for(let u=0;u<n;u++){let f=u/t,d=f|0,p=(d<h?d+1:h)|0,x=f-d,m=1-x,I=d*i|0,w=p*i|0;for(let M=0;M<e;M++){let y=M/t,b=y|0,g=(b<c?b+1:c)|0,_=y-b,E=1-_,v=o[I+b]*E+o[I+g]*_,S=o[w+b]*E+o[w+g]*_,k=v*m+S*x;s[l++]=k|0}}return{data:s,width:e,height:n}};pt();var bi=N.MIN_IMAGE_PIXEL_SIZE;var Xe=a=>{let t=Math.min(a.width,a.height),e=[],n=[];e.push(N.TRACKING_DOWNSCALE_LEVEL_1/t),e.push(N.TRACKING_DOWNSCALE_LEVEL_2/t);for(let s=0;s<e.length;s++)n.push(Object.assign(de({image:a,ratio:e[s]}),{scale:e[s]}));return n};var _t=class{constructor(t,e,n){this.width=e,this.height=n,this.cumsum=new Int32Array(e*n),this.cumsum[0]=t[0];for(let s=1;s<e;s++)this.cumsum[s]=this.cumsum[s-1]+t[s];for(let s=1;s<n;s++)this.cumsum[s*e]=this.cumsum[(s-1)*e]+t[s*e];for(let s=1;s<n;s++)for(let o=1;o<e;o++){let i=s*e+o;this.cumsum[i]=t[i]+this.cumsum[(s-1)*e+o]+this.cumsum[s*e+o-1]-this.cumsum[(s-1)*e+o-1]}}query(t,e,n,s){let{width:o}=this,i=this.cumsum[s*o+n];return e>0&&(i-=this.cumsum[(e-1)*o+n]),t>0&&(i-=this.cumsum[s*o+t-1]),t>0&&e>0&&(i+=this.cumsum[(e-1)*o+t-1]),i}};pe();var lt=10,ht=2,B=6,us=4;var ge=.9,fs=.2;var je=8,ds=!0;var Ke=a=>{let{data:t,width:e,height:n}=a,s,o;if(ds){let _=qt.edgeDetection(t,e,n);s=_.dValue,o=_.isCandidate}else{s=new Float32Array(t.length),o=new Uint8Array(t.length);for(let _=1;_<n-1;_++){let E=_*e,v=(_-1)*e,S=(_+1)*e;for(let k=1;k<e-1;k++){let A=E+k,R=(t[v+k+1]-t[v+k-1]+t[E+k+1]-t[E+k-1]+t[S+k+1]-t[S+k-1])/768,P=(t[S+k-1]-t[v+k-1]+t[S+k]-t[v+k]+t[S+k+1]-t[v+k+1])/768;s[A]=Math.sqrt((R*R+P*P)/2)}}for(let _=1;_<n-1;_++){let E=_*e;for(let v=1;v<e-1;v++){let S=E+v,k=s[S];k>0&&k>=s[S-1]&&k>=s[S+1]&&k>=s[S-e]&&k>=s[S+e]&&(o[S]=1)}}}let i=new Uint32Array(1e3),r=0;for(let _=1;_<n-1;_++){let E=_*e;for(let v=1;v<e-1;v++){let S=E+v;if(o[S]){let k=s[S],A=Math.floor(k*1e3);A>999&&(A=999),i[A]++,r++}}}let c=.1*e*n,h=999,l=0;for(;h>=0&&(l+=i[h],!(l>c));)h--;let u=h/1e3,f=new Float32Array(t.length);for(let _=0;_<t.length;_++)f[_]=t[_]*t[_];let d=new _t(t,e,n),p=new _t(f,e,n),x=[];for(let _=0;_<t.length;_++)o[_]&&s[_]>=u&&x.push({pos:_,dval:s[_],x:_%e,y:Math.floor(_/e)});x.sort((_,E)=>E.dval-_.dval);let m=(B*2+1)*3,I=Math.floor(e/je)*Math.floor(n/je)+Math.floor(e/m)*Math.floor(n/m),w=[],M=new Uint8Array(e*n),y=2*B+1,b=y*y,g=Math.floor(Math.min(e,n)/12);for(let _=0;_<x.length;_++){let{x:E,y:v,pos:S}=x[_];if(M[S]||E<B+lt||E>=e-B-lt||v<B+lt||v>=n-B-lt)continue;let k=ms({image:a,cx:E,cy:v,sdThresh:us,imageDataCumsum:d,imageDataSqrCumsum:p});if(k===null)continue;let A=d.query(E-B,v-B,E+B,v+B)/b,R=new Uint8Array(y*y),P=0,F=(v-B)*e+(E-B);for(let H=0;H<y;H++){let U=F+H*e;for(let L=0;L<y;L++)R[P++]=t[U+L]}let C=-1;for(let H=-lt;H<=lt;H++){for(let U=-lt;U<=lt;U++){if(U*U+H*H<=ht*ht)continue;let L=Ye({image:a,cx:E+U,cy:v+H,vlen:k,templateData:R,templateAvg:A,templateWidth:y,imageDataCumsum:d,imageDataSqrCumsum:p,width:e,height:n});if(L!==null&&L>C&&(C=L,C>ge))break}if(C>ge)break}if(C<ge){let H=1,U=-1,L=!1;for(let O=-ht;O<=ht;O++){for(let T=-ht;T<=ht;T++){if(T*T+O*O>ht*ht||T===0&&O===0)continue;let D=Ye({image:a,vlen:k,cx:E+T,cy:v+O,templateData:R,templateAvg:A,templateWidth:y,imageDataCumsum:d,imageDataSqrCumsum:p,width:e,height:n});if(D!==null&&(D<H&&(H=D),D>U&&(U=D),H<fs||U>.99)){L=!0;break}}if(L)break}if(!L){w.push({x:E,y:v});for(let O=-g;O<=g;O++){let T=v+O;if(T<0||T>=n)continue;let D=T*e;for(let V=-g;V<=g;V++){let z=E+V;z<0||z>=e||(M[D+z]=1)}}}}if(w.length>=I)break}return w},ms=({image:a,cx:t,cy:e,sdThresh:n,imageDataCumsum:s,imageDataSqrCumsum:o})=>{if(t-B<0||t+B>=a.width||e-B<0||e+B>=a.height)return null;let i=2*B+1,r=i*i,c=s.query(t-B,e-B,t+B,e+B);c/=r;let h=o.query(t-B,e-B,t+B,e+B);return h-=2*c*s.query(t-B,e-B,t+B,e+B),h+=r*c*c,h/r<n*n?null:(h=Math.sqrt(h),h)},Ye=a=>{let{cx:t,cy:e,vlen:n,templateData:s,templateAvg:o,templateWidth:i,imageDataCumsum:r,imageDataSqrCumsum:c,width:h,height:l}=a,u=a.image.data,f=(i-1)/2;if(t-f<0||t+f>=h||e-f<0||e+f>=l)return null;let d=i*i,p=r.query(t-f,e-f,t+f,e+f),m=c.query(t-f,e-f,t+f,e+f)-p*p/d;if(m<=0)return null;m=Math.sqrt(m);let I=0,w=(e-f)*h+(t-f);for(let g=0;g<i;g++){let _=w+g*h,E=g*i;for(let v=0;v<i;v++)I+=u[_+v]*s[E+v]}let M=i*i,y=i*i;return I*=y/M,1*(I-o*p)/(n*m)};var $e=(a,t)=>{let e=[];for(let n=0;n<a.length;n++){let s=a[n],o=Ke(s),i={data:s.data,scale:s.scale,width:s.width,height:s.height,points:o};e.push(i),t(n)}return e};Et();Ee();gt();function hn(a){if(a.length<3)return[];let t=1/0,e=1/0,n=-1/0,s=-1/0;for(let p of a)p.x<t&&(t=p.x),p.x>n&&(n=p.x),p.y<e&&(e=p.y),p.y>s&&(s=p.y);let o=n-t,i=s-e,r=Math.max(o,i),c=(t+n)/2,h=(e+s)/2,l={x:c-20*r,y:h-r},u={x:c,y:h+20*r},f={x:c+20*r,y:h-r},d=[{p1:l,p2:u,p3:f,indices:[-1,-2,-3]}];for(let p=0;p<a.length;p++){let x=a[p],m=[];for(let w of d)vs(x,w)&&m.push(w);let I=[];for(let w of m){let M=[{a:w.p1,b:w.p2,i1:w.indices[0],i2:w.indices[1]},{a:w.p2,b:w.p3,i1:w.indices[1],i2:w.indices[2]},{a:w.p3,b:w.p1,i1:w.indices[2],i2:w.indices[0]}];for(let y of M){let b=!1;for(let g of m)if(w!==g&&Is(y,g)){b=!0;break}b||I.push(y)}}d=d.filter(w=>!m.includes(w));for(let w of I)d.push({p1:w.a,p2:w.b,p3:x,indices:[w.i1,w.i2,p]})}return d.filter(p=>p.indices[0]>=0&&p.indices[1]>=0&&p.indices[2]>=0).map(p=>p.indices)}function vs(a,t){let e=t.p1.x,n=t.p1.y,s=t.p2.x,o=t.p2.y,i=t.p3.x,r=t.p3.y,c=2*(e*(o-r)+s*(r-n)+i*(n-o)),h=((e*e+n*n)*(o-r)+(s*s+o*o)*(r-n)+(i*i+r*r)*(n-o))/c,l=((e*e+n*n)*(i-s)+(s*s+o*o)*(e-i)+(i*i+r*r)*(s-e))/c,u=(e-h)*(e-h)+(n-l)*(n-l);return(a.x-h)*(a.x-h)+(a.y-l)*(a.y-l)<=u}function Is(a,t){let e=[[t.indices[0],t.indices[1]],[t.indices[1],t.indices[2]],[t.indices[2],t.indices[0]]];for(let n of e)if(a.i1===n[0]&&a.i2===n[1]||a.i1===n[1]&&a.i2===n[0])return!0;return!1}function un(a){let t=new Set,e=[];for(let n of a){let s=[[n[0],n[1]],[n[1],n[2]],[n[2],n[0]]];for(let o of s){let i=Math.min(o[0],o[1]),r=Math.max(o[0],o[1]),c=`${i}-${r}`;t.has(c)||(t.add(c),e.push([i,r]))}}return e}pt();var Zi=typeof process<"u"&&process.versions!=null&&process.versions.node!=null,Jt=class{data=null;constructor(){console.log("\u26A1 OfflineCompiler: Main thread mode (no workers)")}async compileImageTargets(t,e){console.time("\u23F1\uFE0F Compilaci\xF3n total");let n=[];for(let o=0;o<t.length;o++){let i=t[o];if(!i||!i.width||!i.height||!i.data)throw new Error(`Imagen inv\xE1lida en posici\xF3n ${o}. Debe tener propiedades width, height y data.`);let r=new Uint8Array(i.width*i.height);if(i.data.length===i.width*i.height)r.set(i.data);else if(i.data.length===i.width*i.height*4)for(let c=0;c<r.length;c++){let h=c*4;r[c]=Math.floor((i.data[h]+i.data[h+1]+i.data[h+2])/3)}else throw new Error(`Formato de datos de imagen no soportado en posici\xF3n ${o}`);n.push({data:r,width:i.width,height:i.height})}let s=await this._compileTarget(n,e);return this.data=n.map((o,i)=>({targetImage:o,matchingData:s[i].matchingData,trackingData:s[i].trackingData})),console.timeEnd("\u23F1\uFE0F Compilaci\xF3n total"),this.data}async _compileTarget(t,e){let n=await this._compileMatch(t,o=>e(o*.5)),s=await this._compileTrack(t,o=>e(50+o*.5));return t.map((o,i)=>({matchingData:n[i],trackingData:s[i]}))}async _compileMatch(t,e){let n=100/t.length,s=0,o=[];for(let i=0;i<t.length;i++){let r=t[i],c=new at(r.width,r.height,{useLSH:N.USE_LSH,maxFeaturesPerBucket:N.MAX_FEATURES_PER_BUCKET}),{featurePoints:h}=c.detect(r.data),l=[0,1,2,3,4,5],u=[],f=300;for(let w of l){let M=Math.pow(2,w),y=h.filter(b=>Math.abs(b.scale-M)<.1).sort((b,g)=>(g.score||0)-(b.score||0)).slice(0,f);u.push(...y)}let d=u.filter(w=>w.maxima),p=u.filter(w=>!w.maxima),x=ke({points:d}),m=ke({points:p}),I={maximaPoints:d,minimaPoints:p,maximaPointsCluster:x,minimaPointsCluster:m,width:r.width,height:r.height,scale:1};o.push([I]),s+=n,e(s)}return o}async _compileTrack(t,e){let n=100/t.length,s=0,o=[];for(let i=0;i<t.length;i++){let r=t[i],c=Xe(r),h=n/c.length,l=$e(c,()=>{s+=h,e(s)});o.push(l)}return o}async compileTrack({progressCallback:t,targetImages:e,basePercent:n=0}){return this._compileTrack(e,s=>{t(n+s*(100-n)/100)})}async compileMatch({progressCallback:t,targetImages:e,basePercent:n=0}){return this._compileMatch(e,s=>{t(n+s*(50-n)/100)})}exportData(){if(!this.data)throw new Error("No hay datos compilados para exportar");let t=this.data.map(e=>({targetImage:{width:e.targetImage.width,height:e.targetImage.height},trackingData:e.trackingData.map(n=>{let s=n.points.length,o=new Float32Array(s),i=new Float32Array(s);for(let l=0;l<s;l++)o[l]=n.points[l].x,i[l]=n.points[l].y;let r=hn(n.points),c=un(r),h=new Float32Array(c.length);for(let l=0;l<c.length;l++){let u=n.points[c[l][0]],f=n.points[c[l][1]];h[l]=Math.sqrt((u.x-f.x)**2+(u.y-f.y)**2)}return{w:n.width,h:n.height,s:n.scale,px:o,py:i,d:n.data,mesh:{t:new Uint16Array(r.flat()),e:new Uint16Array(c.flat()),rl:h}}}),matchingData:e.matchingData.map(n=>{let o=N.USE_COMPACT_DESCRIPTORS?be:Me;return{w:n.width,h:n.height,s:n.scale,hdc:!1,max:o(n.maximaPoints,n.maximaPointsCluster,n.width,n.height),min:o(n.minimaPoints,n.minimaPointsCluster,n.width,n.height)}})}));return we(t)}importData(t){let e=It(t);return this.data=e.dataList,e}async destroy(){}};Ae();var te=class{constructor(t,e){if(this.width=t,this.height=e,this.grayscaleBuffer=new Uint8Array(t*e),typeof document<"u"){let n=document.createElement("canvas");n.width=t,n.height=e,this.context=n.getContext("2d",{willReadFrequently:!0,alpha:!1})}}loadInput(t){if(t instanceof Uint8Array&&t.length===this.width*this.height)return t;if(typeof ImageData<"u"&&t instanceof ImageData)return this._convertToGrayscale(t.data,t.width,t.height),this.grayscaleBuffer;if(this.context){this.context.clearRect(0,0,this.width,this.height);let e=t.width===this.height&&t.height===this.width,n=e?t.height:t.width,s=e?t.width:t.height,o=n/s,i=this.width/this.height,r=0,c=0,h=n,l=s;o>i?(h=s*i,r=(n-h)/2):o<i&&(l=n/i,c=(s-l)/2),e?(this.context.save(),this.context.translate(this.width/2,this.height/2),this.context.rotate(Math.PI/2),this.context.drawImage(t,r,c,h,l,-this.height/2,-this.width/2,this.height,this.width),this.context.restore()):this.context.drawImage(t,r,c,h,l,0,0,this.width,this.height);let u=this.context.getImageData(0,0,this.width,this.height);return this._convertToGrayscale(u.data,this.width,this.height),this.grayscaleBuffer}if(t.data&&t.data instanceof Uint8Array)return this._convertToGrayscale(t.data,t.width||this.width,t.height||this.height),this.grayscaleBuffer;throw new Error("Input no soportado o entorno sin Canvas")}_convertToGrayscale(t,e,n){let s=this.grayscaleBuffer,o=e*n;for(let i=0;i<o;i++){let r=i<<2;s[i]=t[r]*77+t[r+1]*150+t[r+2]*29>>8}}};var ee=class{features=[];addFeature(t){this.features.push(t)}getFeature(t){return this.features.find(e=>e.id===t)}init(t){for(let e of this.features)e.enabled&&e.init&&e.init(t)}beforeProcess(t){for(let e of this.features)e.enabled&&e.beforeProcess&&e.beforeProcess(t)}applyWorldMatrixFilters(t,e,n){let s=e;for(let o of this.features)o.enabled&&o.filterWorldMatrix&&(s=o.filterWorldMatrix(t,s,n));return s}shouldShow(t,e){let n=e;for(let s of this.features)s.enabled&&s.shouldShow&&(n=s.shouldShow(t,e));return n}notifyUpdate(t){for(let e of this.features)e.enabled&&e.onUpdate&&e.onUpdate(t)}dispose(){for(let t of this.features)t.dispose&&t.dispose()}};var ne=class{constructor(t,e=0){this.y=e,this.s=e,this.alpha=t}setAlpha(t){t<=0||t>1||(this.alpha=t)}filter(t){return this.y=t,this.s=this.alpha*t+(1-this.alpha)*this.s,this.s}filterWithAlpha(t,e){return this.setAlpha(e),this.filter(t)}lastValue(){return this.y}},se=class{constructor({minCutOff:t=1,beta:e=0,dCutOff:n=1}){this.minCutOff=t,this.beta=e,this.dCutOff=n,this.x=null,this.dx=null,this.lastTime=null}_alpha(t,e){return 1/(1+1/(2*Math.PI*t)/e)}reset(){this.lastTime=null,this.x=null,this.dx=null}filter(t,e){if(this.lastTime===null||this.x===null)return this.lastTime=t,this.x=e.map(o=>new ne(this._alpha(this.minCutOff,1),o)),this.dx=e.map(o=>new ne(this._alpha(this.dCutOff,1),0)),e;let n=(t-this.lastTime)/1e3;if(n<=0)return e;this.lastTime=t;let s=[];for(let o=0;o<e.length;o++){let i=(e[o]-this.x[o].lastValue())/n,r=this._alpha(this.dCutOff,n),c=this.dx[o].filterWithAlpha(i,r),h=this.minCutOff+this.beta*Math.abs(c),l=this._alpha(h,n);s[o]=this.x[o].filterWithAlpha(e[o],l)}return s}};var ie=class{id="one-euro-filter";name="One Euro Filter";description="Smooths the tracking matrix to reduce jitter using a One Euro Filter.";enabled=!0;filters=[];minCutOff;beta;constructor(t=.5,e=.1){this.minCutOff=t,this.beta=e}init(t){}getFilter(t){return this.filters[t]||(this.filters[t]=new se({minCutOff:this.minCutOff,beta:this.beta})),this.filters[t]}filterWorldMatrix(t,e,n){if(!this.enabled)return e;let s=this.getFilter(t),o=n?.stability??1,i=this.minCutOff*(.05+Math.pow(o,2)*.95);return s.minCutOff=i,s.beta=this.beta,s.filter(Date.now(),e)}onUpdate(t){t.type==="reset"&&t.targetIndex!==void 0&&this.filters[t.targetIndex]?.reset()}};var oe=class{id="temporal-filter";name="Temporal Filter";description="Provides warmup tolerance (to avoid false positives) and miss tolerance (to maintain tracking during brief occlusions).";enabled=!0;states=[];warmupTolerance;missTolerance;onToggleShowing;constructor(t=2,e=5,n){this.warmupTolerance=t,this.missTolerance=e,this.onToggleShowing=n}getState(t){return this.states[t]||(this.states[t]={showing:!1,trackCount:0,trackMiss:0}),this.states[t]}shouldShow(t,e){if(!this.enabled)return e;let n=this.getState(t);return n.showing?e?n.trackMiss=0:(n.trackCount=0,n.trackMiss+=1,n.trackMiss>this.missTolerance&&(n.showing=!1,this.onToggleShowing?.(t,!1))):e?(n.trackMiss=0,n.trackCount+=1,n.trackCount>this.warmupTolerance&&(n.showing=!0,this.onToggleShowing?.(t,!0))):n.trackCount=0,n.showing}};var re=class{id="auto-rotation";name="Auto Rotation Matrix";description="Automatically adjusts the world matrix if the input video is rotated (e.g. portrait mode).";enabled=!0;inputWidth=0;inputHeight=0;init(t){this.inputWidth=t.inputWidth,this.inputHeight=t.inputHeight}filterWorldMatrix(t,e){return this.enabled,e}rotate(t){return[-t[1],t[0],t[2],t[3],-t[5],t[4],t[6],t[7],-t[9],t[8],t[10],t[11],-t[13],t[12],t[14],t[15]]}};Et();gt();pt();var We,si=async()=>{if(typeof Worker>"u")return null;try{return(await Promise.resolve().then(()=>(Yn(),ni))).default}catch{return null}};We=await si();var ii=N.ONE_EURO_FILTER_CUTOFF,oi=N.ONE_EURO_FILTER_BETA,ri=N.WARMUP_TOLERANCE,ai=N.MISS_TOLERANCE,Be=1e3,Kn=0,Ot=class{inputWidth;inputHeight;maxTrack=1;inputLoader;markerDimensions=null;onUpdate;debugMode;processingVideo=!1;interestedTargetIndex=-1;trackingStates=[];worker;projectionTransform;projectionMatrix;tracker=null;matchingDataList;workerMatchDone=null;workerTrackDone=null;workerFullTrackDone=null;mainThreadMatcher;mainThreadEstimator;featureManager;fullDetector=null;constructor({inputWidth:t,inputHeight:e,onUpdate:n=null,debugMode:s=!1,maxTrack:o,warmupTolerance:i=null,missTolerance:r=null,filterMinCF:c=null,filterBeta:h=null,worker:l=null}){this.inputWidth=t,this.inputHeight=e,o!==void 0&&(this.maxTrack=o),this.featureManager=new ee,this.featureManager.addFeature(new ie(c===null?ii:c,h===null?oi:h)),this.featureManager.addFeature(new oe(i===null?ri:i,r===null?ai:r)),this.featureManager.addFeature(new re),this.inputLoader=new te(this.inputWidth,this.inputHeight),this.onUpdate=n,this.debugMode=s,this.worker=l,this.worker&&this._setupWorkerListener(),this.fullDetector=new at(this.inputWidth,this.inputHeight,{useLSH:N.USE_LSH,maxFeaturesPerBucket:N.MAX_FEATURES_PER_BUCKET}),this.featureManager.init({inputWidth:this.inputWidth,inputHeight:this.inputHeight,projectionTransform:[],debugMode:this.debugMode});let u=N.DEFAULT_NEAR,f=N.DEFAULT_FAR,d=N.DEFAULT_FOVY*Math.PI/180,p=this.inputHeight/2/Math.tan(d/2);this.projectionTransform=[[p,0,this.inputWidth/2],[0,p,this.inputHeight/2],[0,0,1]],this.featureManager.init({inputWidth:this.inputWidth,inputHeight:this.inputHeight,projectionTransform:this.projectionTransform,debugMode:this.debugMode}),this.projectionMatrix=this._glProjectionMatrix({projectionTransform:this.projectionTransform,width:this.inputWidth,height:this.inputHeight,near:u,far:f})}_setupWorkerListener(){this.worker&&(this.worker.onmessage=t=>{t.data.type==="matchDone"&&this.workerMatchDone!==null&&this.workerMatchDone(t.data),t.data.type==="trackDone"&&this.workerFullTrackDone!==null&&this.workerFullTrackDone(t.data),t.data.type==="trackUpdateDone"&&this.workerTrackDone!==null&&this.workerTrackDone(t.data)})}_ensureWorker(){this.worker||We&&typeof Worker<"u"&&(this.worker=new We,this._setupWorkerListener())}async addImageTargets(t){let e=Array.isArray(t)?t:[t],n=await Promise.all(e.map(async s=>(await fetch(s)).arrayBuffer()));return this.addImageTargetsFromBuffers(n)}addImageTargetsFromBuffers(t){let e=[],n=[],s=[];for(let o of t){let r=It(o).dataList||[];for(let c of r)n.push(c.matchingData),e.push(c.trackingData),s.push([c.targetImage.width,c.targetImage.height])}return this.tracker=new xt(s,e,this.projectionTransform,this.inputWidth,this.inputHeight,this.debugMode),this._ensureWorker(),this.worker&&this.worker.postMessage({type:"setup",inputWidth:this.inputWidth,inputHeight:this.inputHeight,projectionTransform:this.projectionTransform,debugMode:this.debugMode,matchingDataList:n,trackingDataList:e,markerDimensions:s}),this.markerDimensions=s,this.matchingDataList=n,this.maxTrack=s.length,{dimensions:s,matchingDataList:n,trackingDataList:e}}addImageTargetsFromBuffer(t){return this.addImageTargetsFromBuffers([t])}dispose(){this.stopProcessVideo(),this.worker&&(this.worker.postMessage({type:"dispose"}),this.worker=null)}dummyRun(t){let e=this.inputLoader.loadInput(t);this.fullDetector?.detect(e),this.tracker.dummyRun(e)}getProjectionMatrix(){return this.projectionMatrix}getRotatedZ90Matrix(t){return[-t[1],t[0],t[2],t[3],-t[5],t[4],t[6],t[7],-t[9],t[8],t[10],t[11],-t[13],t[12],t[14],t[15]]}getWorldMatrix(t,e){return this._glModelViewMatrix(t,e)}async _detectAndMatch(t,e){let n;for(let h of this.trackingStates)if(h.isTracking&&h.currentModelViewTransform){let l=h.currentModelViewTransform;n=Math.sqrt(l[0][0]**2+l[1][0]**2+l[2][0]**2);break}let{targetIndex:s,modelViewTransform:o,screenCoords:i,worldCoords:r,featurePoints:c}=await this._workerMatch(null,e,t,n);return{targetIndex:s,modelViewTransform:o,screenCoords:i,worldCoords:r,featurePoints:c}}async _trackAndUpdate(t,e,n){let{worldCoords:s,screenCoords:o,reliabilities:i,indices:r=[],octaveIndex:c=0,deformedMesh:h}=await this._workerTrack(t,e,n);if(!s||s.length===0)return{modelViewTransform:null,screenCoords:[],reliabilities:[],stabilities:[],deformedMesh:null};let l=this.trackingStates[n];if(l.pointStabilities||(l.pointStabilities=[]),l.lastScreenCoords||(l.lastScreenCoords=[]),!l.pointStabilities[c]){let b=this.tracker.prebuiltData[n][c].px.length;l.pointStabilities[c]=new Float32Array(b).fill(0),l.lastScreenCoords[c]=new Array(b).fill(null)}let u=l.pointStabilities[c],f=l.lastScreenCoords[c];for(let b=0;b<u.length;b++)if(r.includes(b)){let _=r.indexOf(b);u[b]=Math.min(1,u[b]+.4),f[b]=o[_]}else u[b]=Math.max(0,u[b]-.08);let d=[],p=[],x=[],m=[];for(let b=0;b<u.length;b++)if(u[b]>0){let g=r.includes(b);if(d.push({x:f[b].x,y:f[b].y,id:b}),x.push(u[b]),g){let _=r.indexOf(b);p.push(i[_]),m.push(s[_])}else p.push(0)}let I=l.trackCount<15;return m.length<(I?4:5)?{modelViewTransform:null,screenCoords:d,reliabilities:p,stabilities:x}:(l.trackCount++,{modelViewTransform:await this._workerTrackUpdate(e,{worldCoords:m,screenCoords:m.map((b,g)=>{let _=r[g];return f[_]}),stabilities:m.map((b,g)=>{let _=r[g];return u[_]}),deformedMesh:h}),screenCoords:d,reliabilities:p,stabilities:x,deformedMesh:h,octaveIndex:c})}processVideo(t){if(this.processingVideo)return;this.processingVideo=!0;let e=++Kn;this.trackingStates=[];for(let s=0;s<(this.markerDimensions?.length||0);s++)this.trackingStates.push({showing:!1,isTracking:!1,currentModelViewTransform:null,trackCount:0,trackMiss:0});(async()=>{for(;!(!this.processingVideo||e!==Kn);){let s=this.inputLoader.loadInput(t);if(this.trackingStates.reduce((i,r)=>i+(r.isTracking?1:0),0)<this.maxTrack){let i=[];for(let l=0;l<this.trackingStates.length;l++)this.trackingStates[l].isTracking!==!0&&(this.interestedTargetIndex!==-1&&this.interestedTargetIndex!==l||i.push(l));let{targetIndex:r,modelViewTransform:c,featurePoints:h}=await this._detectAndMatch(s,i);r!==-1&&(this.trackingStates[r].isTracking=!0,this.trackingStates[r].currentModelViewTransform=c),this.onUpdate&&this.onUpdate({type:"featurePoints",featurePoints:h})}for(let i=0;i<this.trackingStates.length;i++){let r=this.trackingStates[i];if(r.isTracking){let h=await this._trackAndUpdate(s,r.currentModelViewTransform,i);h===null||h.modelViewTransform===null?(r.isTracking=!1,r.screenCoords=h?.screenCoords||[],r.reliabilities=h?.reliabilities||[],r.stabilities=h?.stabilities||[]):(r.currentModelViewTransform=h.modelViewTransform,r.screenCoords=h.screenCoords,r.reliabilities=h.reliabilities,r.stabilities=h.stabilities,r.deformedMesh=h.deformedMesh)}let c=r.showing;if(r.showing=this.featureManager.shouldShow(i,r.isTracking),c&&!r.showing&&(r.trackingMatrix=null,this.featureManager.notifyUpdate({type:"reset",targetIndex:i})),r.showing||r.screenCoords&&r.screenCoords.length>0||c&&!r.showing){let h=r.showing?this._glModelViewMatrix(r.currentModelViewTransform,i):null,l=null;if(h){let u=r.stabilities||[],f=u.length>0?u.reduce((x,m)=>x+m,0)/u.length:0,d=this.featureManager.applyWorldMatrixFilters(i,h,{stability:f});if(r.trackingMatrix=d,l=[...d],t.width===this.inputHeight&&t.height===this.inputWidth){let x=this.featureManager.getFeature("auto-rotation");x&&(l=x.rotate(l))}}this.onUpdate&&this.onUpdate({type:"updateMatrix",targetIndex:i,worldMatrix:l,modelViewTransform:r.currentModelViewTransform,screenCoords:r.screenCoords,reliabilities:r.reliabilities,stabilities:r.stabilities,deformedMesh:r.deformedMesh})}}this.onUpdate&&this.onUpdate({type:"processDone"}),typeof requestAnimationFrame<"u"?await new Promise(requestAnimationFrame):await new Promise(i=>setTimeout(i,16))}})()}stopProcessVideo(){this.processingVideo=!1}async detect(t){let e=this.inputLoader.loadInput(t),{featurePoints:n}=this.fullDetector.detect(e);return{featurePoints:n,debugExtra:{}}}async match(t,e){let{targetIndex:n,modelViewTransform:s,screenCoords:o,worldCoords:i,debugExtra:r}=await this._workerMatch(t,[e]);return{targetIndex:n,modelViewTransform:s,screenCoords:o,worldCoords:i,debugExtra:r}}async track(t,e,n){let s=this.inputLoader.loadInput(t);return this.tracker.track(s,e,n)}async trackUpdate(t,e){return e.worldCoords.length<4?null:this._workerTrackUpdate(t,e)}_workerMatch(t,e,n=null,s){return new Promise(o=>{if(!this.worker){let r;!t&&n?r=Promise.resolve(this.fullDetector.detect(n).featurePoints):r=Promise.resolve(t),r.then(c=>{this._matchOnMainThread(c,e,s).then(o)}).catch(()=>o({targetIndex:-1}));return}let i=setTimeout(()=>{this.workerMatchDone=null,o({targetIndex:-1})},Be);this.workerMatchDone=r=>{clearTimeout(i),this.workerMatchDone=null,o({targetIndex:r.targetIndex,modelViewTransform:r.modelViewTransform,screenCoords:r.screenCoords,worldCoords:r.worldCoords,featurePoints:r.featurePoints,debugExtra:r.debugExtra})},n?this.worker.postMessage({type:"match",inputData:n,targetIndexes:e,expectedScale:s}):this.worker.postMessage({type:"match",featurePoints:t,targetIndexes:e,expectedScale:s})})}_workerTrack(t,e,n){return new Promise(s=>{if(!this.worker){s(this.tracker.track(t,e,n));return}let o=setTimeout(()=>{this.workerFullTrackDone=null,s({worldCoords:[],screenCoords:[],reliabilities:[]})},Be);this.workerFullTrackDone=i=>{clearTimeout(o),this.workerFullTrackDone=null,s(i)},this.worker.postMessage({type:"track",inputData:t,lastModelViewTransform:e,targetIndex:n})})}async _matchOnMainThread(t,e,n){if(!this.mainThreadMatcher){let{Matcher:h}=await Promise.resolve().then(()=>(De(),Pn)),{Estimator:l}=await Promise.resolve().then(()=>(le(),Ue));this.mainThreadMatcher=new h(this.inputWidth,this.inputHeight,this.debugMode),this.mainThreadEstimator=new l(this.projectionTransform)}let s=-1,o=null,i=null,r=null,c=null;for(let h=0;h<e.length;h++){let l=e[h],{keyframeIndex:u,screenCoords:f,worldCoords:d,debugExtra:p}=this.mainThreadMatcher.matchDetection(this.matchingDataList[l],t,n);if(c=p,u!==-1){let x=this.mainThreadEstimator.estimate({screenCoords:f,worldCoords:d});x&&(s=l,o=x,i=f,r=d);break}}return{targetIndex:s,modelViewTransform:o,screenCoords:i,worldCoords:r,debugExtra:c}}_workerTrackUpdate(t,e){return new Promise(n=>{if(!this.worker){this._trackUpdateOnMainThread(t,e).then(n).catch(()=>n(null));return}let s=setTimeout(()=>{this.workerTrackDone=null,n(null)},Be);this.workerTrackDone=c=>{clearTimeout(s),this.workerTrackDone=null,n(c.modelViewTransform)};let{worldCoords:o,screenCoords:i,stabilities:r}=e;this.worker.postMessage({type:"trackUpdate",modelViewTransform:t,worldCoords:o,screenCoords:i,stabilities:r})})}async _trackUpdateOnMainThread(t,e){if(!this.mainThreadEstimator){let{Estimator:i}=await Promise.resolve().then(()=>(le(),Ue));this.mainThreadEstimator=new i(this.projectionTransform)}let{worldCoords:n,screenCoords:s,stabilities:o}=e;return this.mainThreadEstimator.refineEstimate({initialModelViewTransform:t,worldCoords:n,screenCoords:s,stabilities:o})}_glModelViewMatrix(t,e){return[t[0][0],-t[1][0],-t[2][0],0,t[0][1],-t[1][1],-t[2][1],0,t[0][2],-t[1][2],-t[2][2],0,t[0][3],-t[1][3],-t[2][3],1]}_glProjectionMatrix({projectionTransform:t,width:e,height:n,near:s,far:o}){let i=[[2*t[0][0]/e,0,-(2*t[0][2]/e-1),0],[0,2*t[1][1]/n,-(2*t[1][2]/n-1),0],[0,0,-(o+s)/(o-s),-2*o*s/(o-s)],[0,0,-1,0]],r=[];for(let c=0;c<4;c++)for(let h=0;h<4;h++)r.push(i[h][c]);return r}};var Ft=class{constructor(t,e,n){this.width=t,this.height=e,this.config=n,this.minDim=Math.min(t,e),this.foveaRadius=Math.floor(this.minDim*n.FOVEA_RADIUS_RATIO),this.parafoveaRadius=Math.floor(this.minDim*n.PARAFOVEA_RADIUS_RATIO),this._initBuffers()}_initBuffers(){let t=this.foveaRadius*2;this.foveaBuffer=new Uint8Array(t*t);let e=this.parafoveaRadius*2,n=Math.ceil(e*this.config.PARAFOVEA_RESOLUTION);this.parafoveaBuffer=new Uint8Array(n*n);let s=Math.ceil(this.width*this.config.PERIPHERY_RESOLUTION),o=Math.ceil(this.height*this.config.PERIPHERY_RESOLUTION);this.peripheryBuffer=new Uint8Array(s*o),this.peripheryDims={width:s,height:o},this._buildCircularMask()}_buildCircularMask(){let t=this.foveaRadius,e=t*2;this.circularMask=new Uint8Array(e*e);for(let n=0;n<e;n++)for(let s=0;s<e;s++){let o=s-t,i=n-t,r=Math.sqrt(o*o+i*i);this.circularMask[n*e+s]=r<=t?1:0}}extract(t,e,n,s=0){return e=Math.max(this.foveaRadius,Math.min(this.width-this.foveaRadius-1,e)),n=Math.max(this.foveaRadius,Math.min(this.height-this.foveaRadius-1,n)),s===0?this._extractFovea(t,e,n):s===1?this._extractParafovea(t,e,n):this._extractPeriphery(t)}_extractFovea(t,e,n){let s=this.foveaRadius,o=s*2,i=this.foveaBuffer,r=0,c=0;for(let h=-s;h<s;h++){let u=(n+h)*this.width;for(let f=-s;f<s;f++){let d=(h+s)*o+(f+s);if(this.circularMask[d]){let p=e+f;i[r]=t[u+p],c++}else i[r]=0;r++}}return{x:e,y:n,radius:s,resolution:this.config.FOVEA_RESOLUTION,data:i,width:o,height:o,pixelCount:c,type:"fovea",toOriginalCoord:(h,l)=>({x:e-s+h,y:n-s+l}),toLocalCoord:(h,l)=>({x:h-(e-s),y:l-(n-s)})}}_extractParafovea(t,e,n){let s=this.parafoveaRadius,o=this.config.PARAFOVEA_RESOLUTION,r=Math.ceil(s*o)*2,c=this.parafoveaBuffer,h=Math.round(1/o),l=0,u=0;for(let f=0;f<r;f++){let d=n-s+Math.floor(f/o);if(d<0||d>=this.height)continue;let p=d*this.width;for(let x=0;x<r;x++){let m=e-s+Math.floor(x/o);if(m<0||m>=this.width){c[l++]=0;continue}c[l++]=t[p+m],u++}}return{x:e,y:n,radius:s,resolution:o,data:c,width:r,height:r,pixelCount:u,type:"parafovea",toOriginalCoord:(f,d)=>({x:e-s+f/o,y:n-s+d/o}),toLocalCoord:(f,d)=>({x:(f-(e-s))*o,y:(d-(n-s))*o})}}_extractPeriphery(t){let e=this.config.PERIPHERY_RESOLUTION,n=this.peripheryDims.width,s=this.peripheryDims.height,o=this.peripheryBuffer,i=Math.round(1/e),r=0;for(let c=0;c<this.height;c+=i){let h=c*this.width;for(let l=0;l<this.width;l+=i)r<o.length&&(o[r++]=t[h+l])}return{x:this.width/2,y:this.height/2,radius:Math.max(this.width,this.height)/2,resolution:e,data:o,width:n,height:s,pixelCount:n*s,type:"periphery",toOriginalCoord:(c,h)=>({x:c/e,y:h/e}),toLocalCoord:(c,h)=>({x:c*e,y:h*e})}}extractMultiResolution(t,e,n){return{fovea:this._extractFovea(t,e,n),parafovea:this._extractParafovea(t,e,n),periphery:this._extractPeriphery(t),center:{x:e,y:n},totalPixels:this._computeTotalPixels(),originalPixels:this.width*this.height}}_computeTotalPixels(){let t=Math.PI*this.foveaRadius**2,e=Math.PI*this.parafoveaRadius**2*this.config.PARAFOVEA_RESOLUTION**2,n=this.peripheryDims.width*this.peripheryDims.height;return Math.ceil(t+e+n)}configure(t){this.config={...this.config,...t},this.foveaRadius=Math.floor(this.minDim*t.FOVEA_RADIUS_RATIO),this.parafoveaRadius=Math.floor(this.minDim*t.PARAFOVEA_RADIUS_RATIO),this._initBuffers()}};var Rt=class{constructor(t,e,n){this.width=t,this.height=e,this.config=n,this.recentTargets=[],this.inhibitionRadius=Math.min(t,e)*.1,this.velocityHistory=[],this.lastCenter={x:t/2,y:e/2},this.gridCells=this._buildCoverageGrid(3,3),this.lastVisitedCell=4,this.lastSaccadeTime=0,this.saccadeCount=0}_buildCoverageGrid(t,e){let n=[],s=this.width/e,o=this.height/t;for(let i=0;i<t;i++)for(let r=0;r<e;r++)n.push({x:s*(r+.5),y:o*(i+.5),index:i*e+r,lastVisit:0});return n}computeTargets(t,e,n=null){let s=[],o=this.config.MAX_SACCADES_PER_FRAME;if(n&&n.isTracking){let i=this._predictTrackingCenter(n);i&&s.push({x:i.x,y:i.y,priority:0,reason:"tracking_prediction",saliency:1})}if(t&&t.peaks)for(let i of t.peaks){if(s.length>=o)break;this._isInhibited(i.x,i.y,s)||i.value>this.config.SALIENCY_THRESHOLD&&s.push({x:i.x,y:i.y,priority:s.length,reason:"saliency_peak",saliency:i.value})}if(!n?.isTracking&&s.length<o){let i=this._getNextGridCell();i&&!this._isInhibited(i.x,i.y,s)&&s.push({x:i.x,y:i.y,priority:s.length,reason:"grid_search",saliency:.5})}return s.length===0&&s.push({x:e.x,y:e.y,priority:0,reason:"maintain_position",saliency:.3}),this._updateHistory(s),s}_predictTrackingCenter(t){if(!t.worldMatrix)return null;let e=t.worldMatrix,n=e[12]||this.width/2,s=e[13]||this.height/2;if(this.velocityHistory.length>=2){let o=this._computeAverageVelocity("x"),i=this._computeAverageVelocity("y");return{x:Math.max(0,Math.min(this.width-1,n+o)),y:Math.max(0,Math.min(this.height-1,s+i))}}return{x:n,y:s}}_computeAverageVelocity(t){if(this.velocityHistory.length<2)return 0;let e=0;for(let n=1;n<this.velocityHistory.length;n++)e+=this.velocityHistory[n][t]-this.velocityHistory[n-1][t];return e/(this.velocityHistory.length-1)}_isInhibited(t,e,n){let s=this.inhibitionRadius**2;for(let o of n){let i=t-o.x,r=e-o.y;if(i*i+r*r<s)return!0}for(let o of this.recentTargets){let i=t-o.x,r=e-o.y;if(i*i+r*r<s)return!0}return!1}_getNextGridCell(){let t=this.gridCells[0],e=1/0;for(let n of this.gridCells)n.lastVisit<e&&(e=n.lastVisit,t=n);return t.lastVisit=Date.now(),t}_updateHistory(t){this.recentTargets.push(...t);let e=this.config.MOTION_HISTORY_FRAMES*this.config.MAX_SACCADES_PER_FRAME;for(;this.recentTargets.length>e;)this.recentTargets.shift();if(t.length>0){for(this.velocityHistory.push({x:t[0].x,y:t[0].y});this.velocityHistory.length>this.config.MOTION_HISTORY_FRAMES;)this.velocityHistory.shift();this.lastCenter={x:t[0].x,y:t[0].y}}this.saccadeCount+=t.length,this.lastSaccadeTime=Date.now()}getPredictedLocation(){if(this.velocityHistory.length>=2){let t=this._computeAverageVelocity("x"),e=this._computeAverageVelocity("y");return{x:Math.max(0,Math.min(this.width-1,this.lastCenter.x+t)),y:Math.max(0,Math.min(this.height-1,this.lastCenter.y+e))}}return this.lastCenter}reset(){this.recentTargets=[],this.velocityHistory=[],this.lastCenter={x:this.width/2,y:this.height/2},this.saccadeCount=0;for(let t of this.gridCells)t.lastVisit=0}configure(t){this.config={...this.config,...t},this.inhibitionRadius=Math.min(this.width,this.height)*.1}};var Pt=class{constructor(t,e,n){this.width=t,this.height=e,this.config=n,this.frameHistory=[],this.stateHistory=[],this.motionModel={vx:0,vy:0,vtheta:0,vscale:0,confidence:0},this.blockSize=8,this.blocksX=Math.ceil(t/this.blockSize),this.blocksY=Math.ceil(e/this.blockSize),this.blockMeans=new Float32Array(this.blocksX*this.blocksY),this.prevBlockMeans=new Float32Array(this.blocksX*this.blocksY),this.consecutiveSkips=0,this.maxConsecutiveSkips=10}predict(t,e){if(this.frameHistory.length<2)return{canSkip:!1,confidence:0,reason:"insufficient_history"};if(this.consecutiveSkips>=this.maxConsecutiveSkips)return{canSkip:!1,confidence:0,reason:"forced_refresh"};let n=this.getChangeLevel(t),s=e?.isTracking?this.config.CHANGE_THRESHOLD:this.config.CHANGE_THRESHOLD*.5,o=n<s,i=o?Math.min(1,(s-n)/s):0,r=null;return o&&e&&(r=this._predictState(e)),o&&this.consecutiveSkips++,{canSkip:o,confidence:i,changeLevel:n,predictedState:r,reason:o?"low_change":"significant_change"}}getChangeLevel(t){if(this.frameHistory.length===0)return 1;this._computeBlockMeans(t,this.blockMeans);let e=0,n=0,s=this.blocksX*this.blocksY;for(let r=0;r<s;r++){let c=Math.abs(this.blockMeans[r]-this.prevBlockMeans[r])/255;e+=c,n=Math.max(n,c)}let i=e/s*.7+n*.3;return Math.min(1,i)}_computeBlockMeans(t,e){let n=this.blockSize,s=this.width;for(let o=0;o<this.blocksY;o++){let i=o*n,r=Math.min(i+n,this.height);for(let c=0;c<this.blocksX;c++){let h=c*n,l=Math.min(h+n,this.width),u=0,f=0;for(let d=i;d<r;d++){let p=d*s;for(let x=h;x<l;x++)u+=t[p+x],f++}e[o*this.blocksX+c]=u/f}}}_predictState(t){if(!t.worldMatrix)return null;let e=t.worldMatrix,n=new Float32Array(16);for(let o=0;o<16;o++)n[o]=e[o];n[12]+=this.motionModel.vx,n[13]+=this.motionModel.vy;let s=1+this.motionModel.vscale;return n[0]*=s,n[5]*=s,n[10]*=s,{worldMatrix:n,isTracking:!0,isPredicted:!0,predictionConfidence:this.motionModel.confidence}}storeFrame(t,e){for(let n=0;n<this.blockMeans.length;n++)this.prevBlockMeans[n]=this.blockMeans[n];if(this._computeBlockMeans(t,this.blockMeans),e?.worldMatrix)for(this.stateHistory.push({timestamp:Date.now(),matrix:new Float32Array(e.worldMatrix)}),this._updateMotionModel();this.stateHistory.length>this.config.MOTION_HISTORY_FRAMES;)this.stateHistory.shift();for(this.consecutiveSkips=0,this.frameHistory.push(Date.now());this.frameHistory.length>this.config.MOTION_HISTORY_FRAMES;)this.frameHistory.shift()}_updateMotionModel(){let t=this.stateHistory;if(t.length<2){this.motionModel.confidence=0;return}let e=t.length,n=t[e-1].matrix,s=t[e-2].matrix,o=(t[e-1].timestamp-t[e-2].timestamp)/1e3;if(o>0){this.motionModel.vx=(n[12]-s[12])/o*.016,this.motionModel.vy=(n[13]-s[13])/o*.016;let i=(Math.abs(s[0])+Math.abs(s[5]))/2,r=(Math.abs(n[0])+Math.abs(n[5]))/2;if(this.motionModel.vscale=(r-i)/i/o*.016,t.length>=3){let c=t[e-3].matrix,h=(s[12]-c[12])/o*.016,l=(s[13]-c[13])/o*.016,u=Math.abs(this.motionModel.vx-h),f=Math.abs(this.motionModel.vy-l),d=Math.sqrt(u*u+f*f);this.motionModel.confidence=Math.max(0,1-d/10)}else this.motionModel.confidence=.5}}isStaticScene(){return this.stateHistory.length<3?!1:Math.sqrt(this.motionModel.vx**2+this.motionModel.vy**2)<.5&&Math.abs(this.motionModel.vscale)<.01}reset(){this.frameHistory=[],this.stateHistory=[],this.consecutiveSkips=0,this.motionModel={vx:0,vy:0,vtheta:0,vscale:0,confidence:0},this.blockMeans.fill(0),this.prevBlockMeans.fill(0)}configure(t){this.config={...this.config,...t}}};var Dt=class{constructor(t,e){this.width=t,this.height=e,this.scale=8,this.scaledW=Math.ceil(t/this.scale),this.scaledH=Math.ceil(e/this.scale),this.intensityMap=new Float32Array(this.scaledW*this.scaledH),this.contrastMap=new Float32Array(this.scaledW*this.scaledH),this.edgeMap=new Float32Array(this.scaledW*this.scaledH),this.saliencyBuffer=new Float32Array(this.scaledW*this.scaledH),this.maxPeaks=5,this.suppressionRadius=Math.max(this.scaledW,this.scaledH)*.15}compute(t){this._downsample(t),this._computeContrast(),this._computeEdges(),this._combineSaliency();let e=this._findPeaks();return{map:this.saliencyBuffer,width:this.scaledW,height:this.scaledH,peaks:e,maxSaliency:e.length>0?e[0].value:0}}_downsample(t){let e=this.scale,n=this.width;for(let s=0;s<this.scaledH;s++){let o=s*e,i=Math.min(o+e,this.height);for(let r=0;r<this.scaledW;r++){let c=r*e,h=Math.min(c+e,this.width),l=0,u=0;for(let f=o;f<i;f++){let d=f*n;for(let p=c;p<h;p++)l+=t[d+p],u++}this.intensityMap[s*this.scaledW+r]=l/u/255}}}_computeContrast(){let t=this.scaledW,e=this.scaledH,n=this.intensityMap,s=this.contrastMap;for(let o=1;o<e-1;o++)for(let i=1;i<t-1;i++){let r=o*t+i,c=n[r],h=0;h+=n[(o-1)*t+(i-1)],h+=n[(o-1)*t+i],h+=n[(o-1)*t+(i+1)],h+=n[o*t+(i-1)],h+=n[o*t+(i+1)],h+=n[(o+1)*t+(i-1)],h+=n[(o+1)*t+i],h+=n[(o+1)*t+(i+1)],h/=8,s[r]=Math.abs(c-h)}for(let o=0;o<e;o++)s[o*t]=0,s[o*t+t-1]=0;for(let o=0;o<t;o++)s[o]=0,s[(e-1)*t+o]=0}_computeEdges(){let t=this.scaledW,e=this.scaledH,n=this.intensityMap,s=this.edgeMap;for(let o=1;o<e-1;o++)for(let i=1;i<t-1;i++){let r=-n[(o-1)*t+(i-1)]+n[(o-1)*t+(i+1)]+-2*n[o*t+(i-1)]+2*n[o*t+(i+1)]+-n[(o+1)*t+(i-1)]+n[(o+1)*t+(i+1)],c=-n[(o-1)*t+(i-1)]-2*n[(o-1)*t+i]-n[(o-1)*t+(i+1)]+n[(o+1)*t+(i-1)]+2*n[(o+1)*t+i]+n[(o+1)*t+(i+1)];s[o*t+i]=Math.sqrt(r*r+c*c)/4}for(let o=0;o<e;o++)s[o*t]=0,s[o*t+t-1]=0;for(let o=0;o<t;o++)s[o]=0,s[(e-1)*t+o]=0}_combineSaliency(){let t=this.saliencyBuffer.length,e=this.contrastMap,n=this.edgeMap,s=this.saliencyBuffer;for(let i=0;i<t;i++)s[i]=e[i]*.6+n[i]*.4;let o=0;for(let i=0;i<t;i++)o=Math.max(o,s[i]);if(o>0)for(let i=0;i<t;i++)s[i]/=o}_findPeaks(){let t=this.scaledW,e=this.scaledH,n=this.saliencyBuffer,s=[],o=this.suppressionRadius,i=o*o,r=[];for(let c=1;c<e-1;c++)for(let h=1;h<t-1;h++){let l=c*t+h,u=n[l];u>n[(c-1)*t+(h-1)]&&u>n[(c-1)*t+h]&&u>n[(c-1)*t+(h+1)]&&u>n[c*t+(h-1)]&&u>n[c*t+(h+1)]&&u>n[(c+1)*t+(h-1)]&&u>n[(c+1)*t+h]&&u>n[(c+1)*t+(h+1)]&&r.push({x:h,y:c,value:u})}r.sort((c,h)=>h.value-c.value);for(let c of r){if(s.length>=this.maxPeaks)break;let h=!1;for(let l of s){let u=c.x-l.x,f=c.y-l.y;if(u*u+f*f<i){h=!0;break}}h||s.push({x:(c.x+.5)*this.scale,y:(c.y+.5)*this.scale,value:c.value})}return s}getSaliencyAt(t,e){let n=Math.floor(t/this.scale),s=Math.floor(e/this.scale);return n<0||n>=this.scaledW||s<0||s>=this.scaledH?0:this.saliencyBuffer[s*this.scaledW+n]}};var Ht=class{constructor(t,e={}){this.numOctaves=t,this.options={interleaveInterval:10,hysteresis:1,...e},this.frameCount=0,this.lastActiveOctave=-1,this.interleaveOctave=0}getOctavesToProcess(t=null){if(this.frameCount++,!t||!t.isTracking||t.activeOctave===void 0)return this.lastActiveOctave=-1,Array.from({length:this.numOctaves},(o,i)=>i);let e=t.activeOctave;this.lastActiveOctave=e;let n=new Set;for(let o=-this.options.hysteresis;o<=this.options.hysteresis;o++){let i=e+o;i>=0&&i<this.numOctaves&&n.add(i)}this.frameCount%this.options.interleaveInterval===0&&(this.interleaveOctave=(this.interleaveOctave+1)%this.numOctaves,n.has(this.interleaveOctave)&&(this.interleaveOctave=(this.interleaveOctave+1)%this.numOctaves),n.add(this.interleaveOctave),this.options.debug&&console.log(`[ScaleOrchestrator] Interleave check on octave ${this.interleaveOctave}`));let s=Array.from(n).sort((o,i)=>o-i);return this.options.debug&&console.log(`[ScaleOrchestrator] Active: ${e}, Processing: [${s.join(", ")}]`),s}reset(){this.frameCount=0,this.lastActiveOctave=-1}};var $n={FOVEA_RADIUS_RATIO:.15,PARAFOVEA_RADIUS_RATIO:.3,FOVEA_RESOLUTION:1,PARAFOVEA_RESOLUTION:.5,PERIPHERY_RESOLUTION:.25,MAX_SACCADES_PER_FRAME:3,SACCADE_COOLDOWN_MS:50,SALIENCY_THRESHOLD:.3,CHANGE_THRESHOLD:.05,PREDICTION_CONFIDENCE:.8,MOTION_HISTORY_FRAMES:3,ENABLE_SKIP_FRAMES:!0,MIN_PROCESSING_INTERVAL_MS:8,NUM_OCTAVES:5},Mt=class{constructor(t,e,n={}){this.width=t,this.height=e,this.config={...$n,...n},this.fovealAttention=new Ft(t,e,this.config),this.saccadicController=new Rt(t,e,this.config),this.predictiveCoding=new Pt(t,e,this.config),this.saliencyMap=new Dt(t,e),this.scaleOrchestrator=new Ht(this.config.NUM_OCTAVES,{debug:n.debugMode}),this.currentFoveaCenter={x:t/2,y:e/2},this.frameCount=0,this.lastProcessTime=0,this.skipCount=0,this.metrics={totalFrames:0,skippedFrames:0,avgPixelsProcessed:0,avgLatency:0,saccadeCount:0},this._initBuffers()}_initBuffers(){let t=this.width*this.height,e=Math.ceil(t*this.config.FOVEA_RADIUS_RATIO**2*Math.PI);this.outputBuffer={fovea:new Uint8Array(e),parafovea:new Uint8Array(Math.ceil(e*4)),periphery:new Uint8Array(Math.ceil(t*.25))},this.changeBuffer=new Float32Array(Math.ceil(t/64))}process(t,e=null){let n=performance.now();this.frameCount++,this.metrics.totalFrames++;let s=this.predictiveCoding.predict(t,e);if(s.canSkip&&this.config.ENABLE_SKIP_FRAMES)return this.metrics.skippedFrames++,this.skipCount++,{skipped:!0,prediction:s.predictedState,confidence:s.confidence,pixelsProcessed:0,latency:performance.now()-n};this.skipCount=0;let o=this.saliencyMap.compute(t),i=this.saccadicController.computeTargets(o,this.currentFoveaCenter,e),r=[],c=0;for(let u of i){let f=this.fovealAttention.extract(t,u.x,u.y,u.priority);r.push(f),c+=f.pixelCount,this.metrics.saccadeCount++}if(i.length>0){let u=i[0];this.currentFoveaCenter={x:u.x,y:u.y}}let h=this.scaleOrchestrator.getOctavesToProcess(e);this.predictiveCoding.storeFrame(t,e);let l=performance.now()-n;return this._updateMetrics(c,l),{skipped:!1,attentionRegions:r,foveaCenter:this.currentFoveaCenter,saliencyPeaks:o.peaks,octavesToProcess:h,pixelsProcessed:c,pixelsSaved:this.width*this.height-c,savingsPercent:((1-c/(this.width*this.height))*100).toFixed(1),latency:l}}getPrimaryRegion(t){return t.skipped||!t.attentionRegions?.length?null:t.attentionRegions[0]}suggestProcessing(t){let e=this.predictiveCoding.getChangeLevel(t);return{shouldProcessFull:e>.3,shouldProcessPartial:e>.05,canSkip:e<.02,changeLevel:e,recommendedSaccades:Math.ceil(e*this.config.MAX_SACCADES_PER_FRAME)}}_updateMetrics(t,e){this.metrics.avgPixelsProcessed=this.metrics.avgPixelsProcessed*(1-.1)+t*.1,this.metrics.avgLatency=this.metrics.avgLatency*(1-.1)+e*.1}getMetrics(){return{...this.metrics,skipRate:(this.metrics.skippedFrames/this.metrics.totalFrames*100).toFixed(1)+"%",avgSavings:((1-this.metrics.avgPixelsProcessed/(this.width*this.height))*100).toFixed(1)+"%",currentFovea:this.currentFoveaCenter}}reset(){this.currentFoveaCenter={x:this.width/2,y:this.height/2},this.frameCount=0,this.skipCount=0,this.predictiveCoding.reset(),this.saccadicController.reset()}configure(t){this.config={...this.config,...t},this.fovealAttention.configure(this.config),this.saccadicController.configure(this.config),this.predictiveCoding.configure(this.config)}};var Ut=class extends Ot{bioEngine=null;bioEnabled=!0;bioMetricsInterval=null;lastBioResult=null;constructor(t){super(t);let e=t.bioInspired||{};if(this.bioEnabled=e.enabled!==!1,this.bioEnabled){let n={};e.foveaRadiusRatio!==void 0&&(n.FOVEA_RADIUS_RATIO=e.foveaRadiusRatio),e.maxSaccades!==void 0&&(n.MAX_SACCADES_PER_FRAME=e.maxSaccades),e.aggressiveSkipping!==void 0&&(n.ENABLE_SKIP_FRAMES=e.aggressiveSkipping,e.aggressiveSkipping&&(n.CHANGE_THRESHOLD=.03)),this.bioEngine=new Mt(t.inputWidth,t.inputHeight,n)}}processVideo(t){if(!this.bioEnabled||!this.bioEngine)return super.processVideo(t);if(this.processingVideo)return;this.processingVideo=!0,this.trackingStates=[];for(let n=0;n<(this.markerDimensions?.length||0);n++)this.trackingStates.push({showing:!1,isTracking:!1,currentModelViewTransform:null,trackCount:0,trackMiss:0});(async()=>{for(;this.processingVideo;){let n=this.inputLoader.loadInput(t),s=this.trackingStates.filter(r=>r.isTracking),o=s.length===1?{isTracking:!0,activeOctave:s[0].lastOctaveIndex,worldMatrix:s[0].currentModelViewTransform?this._flattenMatrix(s[0].currentModelViewTransform):null}:null,i=this.bioEngine.process(n,o||void 0);this.lastBioResult=i,i.skipped&&s.length>0?this._handleSkippedFrame(s,i):await this._processWithAttention(t,n,i),typeof requestAnimationFrame<"u"?await new Promise(requestAnimationFrame):await new Promise(r=>setTimeout(r,16))}})()}_handleSkippedFrame(t,e){let n=e.prediction&&e.prediction.worldMatrix;for(let s of t){n&&t.length===1&&(s.currentModelViewTransform=this._unflattenMatrix(e.prediction.worldMatrix));let o=this.trackingStates.indexOf(s);if(o!==-1){let i=s.currentModelViewTransform?this._glModelViewMatrix(s.currentModelViewTransform,o):null;this.onUpdate?.({type:"updateMatrix",targetIndex:o,worldMatrix:i?this.featureManager.applyWorldMatrixFilters(o,i,{stability:.9}):null,skipped:!0,bioMetrics:this.bioEngine?.getMetrics()})}}this.onUpdate?.({type:"processDone"})}async _processWithAttention(t,e,n){if(this.trackingStates.reduce((o,i)=>o+(i.isTracking?1:0),0)<this.maxTrack){let o=this.trackingStates.map((i,r)=>({state:i,index:r})).filter(({state:i,index:r})=>!i.isTracking&&(this.interestedTargetIndex===-1||this.interestedTargetIndex===r)).map(({index:i})=>i);if(o.length>0){let{targetIndex:i,modelViewTransform:r,featurePoints:c}=await this._detectAndMatch(e,o,n.octavesToProcess||null);i!==-1&&(this.trackingStates[i].isTracking=!0,this.trackingStates[i].currentModelViewTransform=r,n.attentionRegions?.[0]&&this.bioEngine?.reset()),this.onUpdate?.({type:"featurePoints",featurePoints:c})}}for(let o=0;o<this.trackingStates.length;o++){let i=this.trackingStates[o];if(i.isTracking){let c=await this._trackAndUpdate(e,i.currentModelViewTransform,o);!c||!c.modelViewTransform?(i.isTracking=!1,i.screenCoords=c?.screenCoords||[],i.reliabilities=c?.reliabilities||[],i.stabilities=c?.stabilities||[]):(i.currentModelViewTransform=c.modelViewTransform,i.screenCoords=c.screenCoords,i.reliabilities=c.reliabilities,i.stabilities=c.stabilities,i.deformedMesh=c.deformedMesh)}let r=i.showing;if(i.showing=this.featureManager.shouldShow(o,i.isTracking),r&&!i.showing&&(i.trackingMatrix=null,this.featureManager.notifyUpdate({type:"reset",targetIndex:o})),i.showing||i.screenCoords?.length>0||r&&!i.showing){let c=i.showing?this._glModelViewMatrix(i.currentModelViewTransform,o):null,h=null;if(c){let l=i.stabilities||[],u=l.length>0?l.reduce((d,p)=>d+p,0)/l.length:0;if(h=this.featureManager.applyWorldMatrixFilters(o,c,{stability:u}),i.trackingMatrix=h,t.width===this.inputHeight&&t.height===this.inputWidth){let d=this.featureManager.getFeature("auto-rotation");d&&(h=d.rotate(h))}}this.onUpdate?.({type:"updateMatrix",targetIndex:o,worldMatrix:h,modelViewTransform:i.currentModelViewTransform,screenCoords:i.screenCoords,reliabilities:i.reliabilities,stabilities:i.stabilities,deformedMesh:i.deformedMesh,bioMetrics:this.bioEngine?.getMetrics(),foveaCenter:n.foveaCenter,pixelsSaved:n.pixelsSaved})}}this.onUpdate?.({type:"processDone"})}async _detectAndMatch(t,e,n=null){let s;for(let l of this.trackingStates)if(l.isTracking&&l.currentModelViewTransform){let u=l.currentModelViewTransform;s=Math.sqrt(u[0][0]**2+u[1][0]**2+u[2][0]**2);break}let{targetIndex:o,modelViewTransform:i,screenCoords:r,worldCoords:c,featurePoints:h}=await this._workerMatch(null,e,t,s,n);return{targetIndex:o,modelViewTransform:i,screenCoords:r,worldCoords:c,featurePoints:h}}_workerMatch(t,e,n=null,s,o=null){return new Promise(i=>{if(!this.worker){let c;!t&&n?c=Promise.resolve(this.fullDetector.detect(n,{octavesToProcess:o}).featurePoints):c=Promise.resolve(t),c.then(h=>{this._matchOnMainThread(h,e,s).then(i)}).catch(()=>i({targetIndex:-1}));return}let r=setTimeout(()=>{this.workerMatchDone=null,i({targetIndex:-1})},1e3);this.workerMatchDone=c=>{clearTimeout(r),this.workerMatchDone=null,i(c)},n?this.worker.postMessage({type:"match",inputData:n,targetIndexes:e,octavesToProcess:o,expectedScale:s}):this.worker.postMessage({type:"match",featurePoints:t,targetIndexes:e,expectedScale:s})})}async _trackAndUpdate(t,e,n){let s=await super._trackAndUpdate(t,e,n);return s&&s.octaveIndex!==void 0&&(this.trackingStates[n].lastOctaveIndex=s.octaveIndex),s}_flattenMatrix(t){let e=new Float32Array(16);for(let n=0;n<3;n++)for(let s=0;s<4;s++)e[n*4+s]=t[n][s];return e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}_unflattenMatrix(t){return[[t[0],t[1],t[2],t[3]],[t[4],t[5],t[6],t[7]],[t[8],t[9],t[10],t[11]]]}getBioMetrics(){return this.bioEngine?.getMetrics()||null}getLastBioResult(){return this.lastBioResult}setBioEnabled(t){this.bioEnabled=t,t&&!this.bioEngine&&(this.bioEngine=new Mt(this.inputWidth,this.inputHeight))}configureBio(t){this.bioEngine?.configure(t)}dispose(){super.dispose(),this.bioEngine=null,this.bioMetricsInterval&&clearInterval(this.bioMetricsInterval)}};function Lt(a,t,e,n,s,o,i,r,c=!1){let h=n[0][0]*a+n[0][1]*t+n[0][2]*e+n[0][3],l=n[1][0]*a+n[1][1]*t+n[1][2]*e+n[1][3],u=n[2][0]*a+n[2][1]*t+n[2][2]*e+n[2][3],f=s[0][0]*h/u+s[0][2],d=s[1][1]*l/u+s[1][2],p=c?i:o,x=c?o:i,m=Math.max(r.width/p,r.height/x),I=p*m,w=x*m,M=(r.width-I)/2,y=(r.height-w)/2,b,g;return c?(b=M+I/2-(d-s[1][2])*m,g=y+w/2+(f-s[0][2])*m):(b=M+I/2+(f-s[0][2])*m,g=y+w/2+(d-s[1][2])*m),{sx:b,sy:g}}async function ci(a){return new Promise((t,e)=>{let n=new Image;n.crossOrigin="anonymous",n.onload=()=>t(n),n.onerror=()=>e(new Error(`Failed to load image: ${a}`)),n.src=a})}async function li(a){let t;if(typeof a=="string")t=await ci(a);else if(a instanceof HTMLImageElement)t=a,t.complete||await new Promise((o,i)=>{t.onload=o,t.onerror=i});else return{imageData:a,width:a.width,height:a.height};let e=document.createElement("canvas");e.width=t.width,e.height=t.height;let n=e.getContext("2d");return n.drawImage(t,0,0),{imageData:n.getImageData(0,0,t.width,t.height),width:t.width,height:t.height}}function hi(a,t,e,n,s,o){let i=e.sx,r=e.sy,c=n.sx,h=n.sy,l=s.sx,u=s.sy,f=o.sx,d=o.sy,p=c-f,x=l-f,m=i-c+f-l,I=h-d,w=u-d,M=r-h+d-u,y=p*w-x*I,b=(m*w-x*M)/y,g=(p*M-m*I)/y,_=c-i+b*c,E=l-i+g*l,v=i,S=h-r+b*h,k=u-r+g*u,A=r;return[_/a,S/a,0,b/a,E/t,k/t,0,g/t,0,0,1,0,v,A,0,1]}async function Zn(a){let{targetSrc:t,container:e,overlay:n,callbacks:s={},cameraConfig:o={facingMode:"environment",width:{ideal:1280},height:{ideal:960}},viewportWidth:i=1280,viewportHeight:r=960,debugMode:c=!1,bioInspiredEnabled:h=!0,scale:l=1}=a,u=!1,f=!1,d=null,p=null,x=[0,0],m=document.createElement("canvas");m.width=i,m.height=r,m.style.width="100%",m.style.height="100%",m.style.objectFit="cover",m.style.position="absolute",m.style.top="0",m.style.left="0",m.style.zIndex="0";let I=m.getContext("2d");n&&(n.style.position="absolute",n.style.transformOrigin="0 0",n.style.display="none",n.style.pointerEvents="none");let w;if(t instanceof ArrayBuffer)w=t;else if(typeof t=="string"&&t.toLowerCase().split("?")[0].endsWith(".taar")){c&&console.log(`[TapTapp AR] Fetching pre-compiled target: ${t}`);let v=await fetch(t);if(!v.ok)throw new Error(`Failed to fetch .taar file: ${v.statusText}`);w=await v.arrayBuffer()}else{c&&console.log("[TapTapp AR] Compiling image target...");let{imageData:v,width:S,height:k}=await li(t);x=[S,k];let A=new Jt;await A.compileImageTargets([{width:S,height:k,data:v.data}],P=>s.onCompileProgress?.(P));let R=A.exportData();w=R.buffer.slice(R.byteOffset,R.byteOffset+R.byteLength)}let M=new Ut({inputWidth:i,inputHeight:r,debugMode:c,bioInspired:{enabled:h,aggressiveSkipping:!1},onUpdate:v=>b(v)}),y=await M.addImageTargetsFromBuffer(w);y.dimensions&&y.dimensions[0]&&(x=y.dimensions[0]);function b(v){if(v.type==="processDone"||v.type!=="updateMatrix")return;let{targetIndex:S,worldMatrix:k,modelViewTransform:A,screenCoords:R=[],reliabilities:P=[],stabilities:F=[]}=v,C=k!==null,H=P.length>0?P.reduce((O,T)=>O+T,0)/P.length:0,U=F.length>0?F.reduce((O,T)=>O+T,0)/F.length:0,L={isTracking:C,worldMatrix:k,modelViewTransform:A,screenCoords:R,reliabilities:P,stabilities:F,avgReliability:H,avgStability:U,controller:M,targetIndex:S,targetDimensions:x};C&&!f?s.onFound?.(L):!C&&f&&s.onLost?.(L),(C||f)&&s.onUpdate?.(L),n&&A&&k?g(A):n&&!C&&(n.style.display="none"),f=C}function g(v){if(!n)return;let[S,k]=x,A=M.projectionTransform,R=e.getBoundingClientRect(),P=Lt(0,0,0,v,A,i,r,R,!1),F=Lt(S,0,0,v,A,i,r,R,!1),C=Lt(0,k,0,v,A,i,r,R,!1),H=Lt(S,k,0,v,A,i,r,R,!1),U=hi(S,k,P,F,C,H);n.style.width=`${S}px`,n.style.height=`${k}px`;let L=U.join(",");l!==1?n.style.transform=`matrix3d(${L}) scale(${l})`:n.style.transform=`matrix3d(${L})`,n.style.display="block"}function _(v){v instanceof HTMLVideoElement,I.drawImage(v,0,0,i,r)}return{async startCamera(){if(!u)try{try{d=await navigator.mediaDevices.getUserMedia({video:o,audio:!1})}catch(S){console.warn("[TapTapp AR] Failed to open environment camera, falling back to default:",S),d=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1})}p=document.createElement("video"),p.srcObject=d,p.playsInline=!0,p.muted=!0,await p.play(),e.style.position="relative",e.firstChild?e.insertBefore(m,e.firstChild):e.appendChild(m),u=!0;let v=()=>{!u||!p||(_(p),requestAnimationFrame(v))};v(),M.processVideo(m)}catch(v){throw console.error("[TapTapp AR] Camera access failed:",v),v}},startVideo(v){if(u)return;e.style.position="relative",e.appendChild(m),u=!0;let S=()=>{u&&(_(v),requestAnimationFrame(S))};S(),M.processVideo(m)},stop(){u=!1,M.stopProcessVideo(),d&&(d.getTracks().forEach(v=>v.stop()),d=null),p&&(p.srcObject=null,p=null),m.parentNode&&m.parentNode.removeChild(m),n&&(n.style.display="none")},get isActive(){return u},get isTracking(){return f},get controller(){return M},get targetDimensions(){return x},getProjectionMatrix(){return M.getProjectionMatrix()}}}async function ui(a){let t=await Zn(a);return await t.startCamera(),t}Et();var Ve=class{state;constructor(t){this.state=t}next(){return this.state=this.state*1664525+1013904223>>>0,this.state/4294967295}};function Jn(a,t){let e=new Ve(a),n=[];for(let s=0;s<t;s++){let o=new Uint32Array(32);for(let i=0;i<32;i++)o[i]=e.next()*4294967295>>>0;n.push(o)}return n}function Qn(a,t){let e=new Uint32Array(32);for(let n=0;n<1024;n++){let s=n>>>5,o=n&31,i=0,r=t[n%t.length];for(let c=0;c<2;c++)i+=fi(a[c]&r[c]);i>16&&(e[s]|=1<<o)}return e}function ts(a){let t=2166136261;for(let e=0;e<a.length;e++)t^=a[e],t=Math.imul(t,16777619);return t>>>0}function fi(a){return a=a-(a>>1&1431655765),a=(a&858993459)+(a>>2&858993459),(a+(a>>4)&252645135)*16843009>>24}function es(a){let t=new Uint32Array(32),e=a.length/2,n=new Uint16Array(1024);for(let s of a)for(let o=0;o<1024;o++)s[o>>>5]&1<<(o&31)&&n[o]++;for(let s=0;s<1024;s++)n[s]>e&&(t[s>>>5]|=1<<(s&31));return t}gt();var ze={micro:{outputBits:32,maxFeatures:100,pyramidOctaves:3},compact:{outputBits:128,maxFeatures:200,pyramidOctaves:4},standard:{outputBits:256,maxFeatures:300,pyramidOctaves:5},full:{outputBits:1024,maxFeatures:500,pyramidOctaves:6}},qe=null;function di(){return qe||(qe=Jn(xe,1024)),qe}var bt=class{constructor(t="standard"){this.config=ze[t]||ze.standard,this.basis=di(),this.mode=t}embed(t,e,n){let s=performance.now(),o=new at(e,n,{useGPU:!0,useLSH:!0,maxFeaturesPerBucket:Math.ceil(this.config.maxFeatures/100),maxOctaves:this.config.pyramidOctaves}),{featurePoints:i}=o.detect(t),r=i.sort((f,d)=>(d.score||0)-(f.score||0)).slice(0,this.config.maxFeatures);if(r.length===0)return new Bt(new Uint32Array(this.config.outputBits/32),{featureCount:0,mode:this.mode,timeMs:performance.now()-s});let c=[];for(let f of r){if(!f.descriptors||f.descriptors.length<2)continue;let d=f.descriptors instanceof Uint32Array?f.descriptors:new Uint32Array([f.descriptors[0]|f.descriptors[1]<<8|f.descriptors[2]<<16|f.descriptors[3]<<24,f.descriptors[4]|f.descriptors[5]<<8|f.descriptors[6]<<16|f.descriptors[7]<<24]),p=Qn(d,this.basis),x=Math.floor(f.x/e*3),m=Math.floor(f.y/n*3),w=(Math.min(8,Math.max(0,m*3+x))+1)*2654435769;for(let M=0;M<p.length;M++){let y=w+M*2246822507|0;y=Math.imul(y^y>>>16,36094177),y=Math.imul(y^y>>>13,3266489909),y=(y^y>>>16)>>>0,p[M]^=y}c.push(p)}let h=c.length>0?es(c):new Uint32Array(32),l=this._compressToSize(h,this.config.outputBits),u=performance.now()-s;return new Bt(l,{featureCount:r.length,mode:this.mode,timeMs:u,width:e,height:n})}compare(t,e){let n=t.vector||t,s=e.vector||e;if(n.length!==s.length)throw new Error("Embeddings must have same dimension");let o=0,i=n.length*32;for(let h=0;h<n.length;h++)o+=mi(n[h]^s[h]);let r=o/(i/2);return Math.max(0,1-r)}search(t,e,n=10){let s=[];for(let o=0;o<e.length;o++){let i=this.compare(t,e[o]);s.push({index:o,similarity:i})}return s.sort((o,i)=>i.similarity-o.similarity),s.slice(0,n)}cluster(t,e=.7){let n=t.length,s=new Array(n).fill(-1),o=0;for(let i=0;i<n;i++)if(s[i]===-1){s[i]=o;for(let r=i+1;r<n;r++){if(s[r]!==-1)continue;this.compare(t[i],t[r])>=e&&(s[r]=o)}o++}return s}_compressToSize(t,e){let n=e/32;if(n>=32)return new Uint32Array(t.buffer,0,n);let s=new Uint32Array(n);if(e===32)s[0]=ts(t);else{let o=Math.ceil(32/n);for(let i=0;i<n;i++){let r=0;for(let c=0;c<o;c++){let h=i*o+c;h<32&&(r^=t[h])}s[i]=(r<<i%32|r>>>32-i%32)>>>0}}return s}_weightedBundle(t,e){let n=new Uint32Array(32),s=e.reduce((r,c)=>r+c,0),o=e.map(r=>r/s),i=new Float32Array(1024);for(let r=0;r<t.length;r++){let c=t[r],h=o[r];for(let l=0;l<1024;l++)c[l>>>5]&1<<(l&31)&&(i[l]+=h)}for(let r=0;r<1024;r++)i[r]>.5&&(n[r>>>5]|=1<<(r&31));return n}},Bt=class a{constructor(t,e={}){this.vector=t,this.metadata=e}toBytes(){return new Uint8Array(this.vector.buffer)}static fromBytes(t){let e=new Uint32Array(t.buffer);return new a(e)}toBase64(){let t=this.toBytes(),e="";for(let n=0;n<t.length;n++)e+=String.fromCharCode(t[n]);return btoa(e)}static fromBase64(t){let e=atob(t),n=new Uint8Array(e.length);for(let s=0;s<e.length;s++)n[s]=e.charCodeAt(s);return a.fromBytes(n)}toHex(){return Array.from(this.vector).map(t=>t.toString(16).padStart(8,"0")).join("")}toFloatArray(){let t=this.bits,e=new Float32Array(t);for(let n=0;n<t;n++){let s=n>>>5,o=n&31;e[n]=this.vector[s]&1<<o?1:0}return e}get bits(){return this.vector.length*32}get bytes(){return this.vector.length*4}};function mi(a){return a=a-(a>>1&1431655765),a=(a&858993459)+(a>>2&858993459),(a+(a>>4)&252645135)*16843009>>24}var Wt=class{constructor(t="compact"){this.embedder=new bt(t)}async compute(t){let e=null,n=0,s=0;if(typeof t=="string")if(typeof document<"u")t=await this._loadImageBrowser(t);else throw new Error("URL loading in Node requires a fetch/loading utility. Please provide a Buffer or Uint8Array.");if(typeof document<"u"&&(t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||t instanceof ImageBitmap)){let o=document.createElement("canvas");n=t.width||t.videoWidth,s=t.height||t.videoHeight,o.width=n,o.height=s;let i=o.getContext("2d");i.drawImage(t,0,0);let r=i.getImageData(0,0,n,s).data;e=this._rgbaToGrayscale(r,n,s)}if(!e&&(t instanceof Uint8Array||typeof Buffer<"u"&&Buffer.isBuffer(t)))if(t.data&&t.width&&t.height)e=t.data,n=t.width,s=t.height;else throw new Error("Raw data source must be an object { data, width, height }");if(!e)throw new Error("Unsupported image source type");return this.embedder.embed(e,n,s)}async compare(t,e){let n=await this.compute(t),s=await this.compute(e);return this.embedder.compare(n,s)}_rgbaToGrayscale(t,e,n){let s=new Float32Array(e*n);for(let o=0;o<e*n;o++){let i=o*4;s[o]=(t[i]*.299+t[i+1]*.587+t[i+2]*.114)/255}return s}_loadImageBrowser(t){return new Promise((e,n)=>{let s=new Image;s.crossOrigin="anonymous",s.onload=()=>e(s),s.onerror=n,s.src=t})}},ns=new Wt("compact");gt();export{Ut as BioInspiredController,Ot as Controller,bt as ImageEmbedder,Wt as ImageSearchBridge,Jt as OfflineCompiler,Zn as createTracker,Kt as protocol,ui as startTracking,ns as visualSearch};
