var Qi=Object.create;var ds=Object.defineProperty;var to=Object.getOwnPropertyDescriptor;var eo=Object.getOwnPropertyNames;var so=Object.getPrototypeOf,no=Object.prototype.hasOwnProperty;var W=(o,t)=>()=>(o&&(t=o(o=0)),t);var Jt=(o,t)=>()=>(t||o((t={exports:{}}).exports,t),t.exports),hn=(o,t)=>{for(var s in t)ds(o,s,{get:t[s],enumerable:!0})},io=(o,t,s,e)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of eo(t))!no.call(o,n)&&n!==s&&ds(o,n,{get:()=>t[n],enumerable:!(e=to(t,n))||e.enumerable});return o};var oo=(o,t,s)=>(s=o!=null?Qi(so(o)):{},io(t||!o||!o.__esModule?ds(s,"default",{value:o,enumerable:!0}):s,o));var Se,ms,Ft,gs=W(()=>{"use strict";Se=(o,t)=>[[o[0][0]*t[0][0]+o[0][2]*t[2][0],o[0][0]*t[0][1]+o[0][2]*t[2][1],o[0][0]*t[0][2]+o[0][2]*t[2][2],o[0][0]*t[0][3]+o[0][2]*t[2][3]],[o[1][1]*t[1][0]+o[1][2]*t[2][0],o[1][1]*t[1][1]+o[1][2]*t[2][1],o[1][1]*t[1][2]+o[1][2]*t[2][2],o[1][1]*t[1][3]+o[1][2]*t[2][3]],[t[2][0],t[2][1],t[2][2],t[2][3]]],ms=(o,t,s,e)=>{let n=o[0][0]*t+o[0][1]*s+o[0][3],i=o[1][0]*t+o[1][1]*s+o[1][3],r=o[2][0]*t+o[2][1]*s+o[2][3];return{x:n,y:i,z:r}},Ft=(o,t,s,e)=>{let{x:n,y:i,z:r}=ms(o,t,s,e);return{x:n/r,y:i/r}}});function un({mesh:o,trackedPoints:t,currentVertices:s,iterations:e=5}){let{e:n,rl:i}=o,r=s.length/2,a=new Float32Array(s),c=.8,l=.5;for(let u=0;u<e;u++){for(let h=0;h<i.length;h++){let f=n[h*2],m=n[h*2+1],d=i[h],p=a[f*2],w=a[f*2+1],g=a[m*2],x=a[m*2+1],M=g-p,E=x-w,I=Math.sqrt(M*M+E*E);if(I<1e-4)continue;let S=(I-d)/I,k=M*.5*S*c,T=E*.5*S*c;a[f*2]+=k,a[f*2+1]+=T,a[m*2]-=k,a[m*2+1]-=T}for(let h of t){let f=h.meshIndex;if(f===void 0)continue;let m=h.x,d=h.y;a[f*2]+=(m-a[f*2])*l,a[f*2+1]+=(d-a[f*2+1])*l}}return a}var fn=W(()=>{"use strict"});var X,Pt=W(()=>{"use strict";X={VIEWPORT_WIDTH:640,VIEWPORT_HEIGHT:480,DEFAULT_FOVY:60,DEFAULT_NEAR:1,DEFAULT_FAR:1e4,MAX_FEATURES_PER_BUCKET:24,USE_LSH:!0,HAMMING_THRESHOLD:.85,HDC_RATIO_THRESHOLD:.85,INLIER_THRESHOLD:15,MIN_NUM_INLIERS:6,MAX_MATCH_QUERY_POINTS:800,CLUSTER_MAX_POP:25,TRACKER_TEMPLATE_SIZE:6,TRACKER_SEARCH_SIZE:12,TRACKER_SIMILARITY_THRESHOLD:.65,MIN_IMAGE_PIXEL_SIZE:32,SCALE_STEP_EXPONENT:1,TRACKING_DOWNSCALE_LEVEL_1:256,TRACKING_DOWNSCALE_LEVEL_2:128,WARMUP_TOLERANCE:2,MISS_TOLERANCE:1,ONE_EURO_FILTER_CUTOFF:.5,ONE_EURO_FILTER_BETA:.1,USE_COMPACT_DESCRIPTORS:!0,COMPACT_HAMMING_THRESHOLD:8}});var dn,ro,ao,mn,zt,ps=W(()=>{"use strict";gs();fn();Pt();dn=X.TRACKER_TEMPLATE_SIZE,ro=X.TRACKER_SEARCH_SIZE,ao=1,mn=X.TRACKER_SIMILARITY_THRESHOLD,zt=class{constructor(t,s,e,n,i,r=!1){this.markerDimensions=t,this.trackingDataList=s,this.projectionTransform=e,this.inputWidth=n,this.inputHeight=i,this.debugMode=r,this.trackingKeyframeList=[],this.prebuiltData=[];for(let l=0;l<s.length;l++){let u=s[l];this.trackingKeyframeList[l]=u,this.prebuiltData[l]=u.map(h=>({px:new Float32Array(h.px),py:new Float32Array(h.py),data:new Uint8Array(h.d),width:h.w,height:h.h,scale:h.s,mesh:h.mesh,projectedImage:new Float32Array(h.w*h.h)}))}this.meshVerticesState=[];let c=dn*2+1;this.templateBuffer=new Float32Array(c*c)}dummyRun(t){let s=[[1,0,0,0],[0,1,0,0],[0,0,1,0]];for(let e=0;e<this.trackingKeyframeList.length;e++)this.track(t,s,e)}track(t,s,e){let n={},i=Se(this.projectionTransform,s),[r,a]=this.markerDimensions[e],c=Ft(i,0,0),l=Ft(i,r,0),u=Math.sqrt((l.x-c.x)**2+(l.y-c.y)**2);this.lastOctaveIndex||(this.lastOctaveIndex=[]);let h=this.lastOctaveIndex[e]!==void 0?this.lastOctaveIndex[e]:0,f=Math.abs(this.prebuiltData[e][h].width-u),m=.8;for(let b=0;b<this.prebuiltData[e].length;b++){let _=Math.abs(this.prebuiltData[e][b].width-u);_<f*m&&(f=_,h=b)}this.lastOctaveIndex[e]=h;let d=this.prebuiltData[e][h];this._computeProjection(i,t,d);let p=d.projectedImage,{matchingPoints:w,sim:g}=this._computeMatching(d,p),x=this.trackingKeyframeList[e][h],M=[],E=[],I=[],{px:S,py:k,s:T}=x,C=[];for(let b=0;b<w.length;b++){let _=g[b];if(_>mn&&b<S.length){I.push(b);let v=Ft(i,w[b][0],w[b][1]);E.push(v),M.push({x:S[b]/T,y:k[b]/T,z:0}),C.push(_)}}let y=null;if(d.mesh&&I.length>=4){this.meshVerticesState[e]||(this.meshVerticesState[e]=[]);let b=this.meshVerticesState[e][h];if(!b){b=new Float32Array(S.length*2);for(let A=0;A<S.length;A++)b[A*2]=S[A],b[A*2+1]=k[A]}let _=[];for(let A=0;A<I.length;A++){let F=I[A];_.push({meshIndex:F,x:w[F][0]*T,y:w[F][1]*T})}let v=un({mesh:d.mesh,trackedPoints:_,currentVertices:b,iterations:5});this.meshVerticesState[e][h]=v;let D=new Float32Array(v.length);for(let A=0;A<v.length;A+=2){let F=Ft(i,v[A]/T,v[A+1]/T);D[A]=F.x,D[A+1]=F.y}y={vertices:D,triangles:d.mesh.t}}if(E.length>=8){let b=1/0,_=1/0,v=-1/0,D=-1/0;for(let F of E)F.x<b&&(b=F.x),F.y<_&&(_=F.y),F.x>v&&(v=F.x),F.y>D&&(D=F.y);if(Math.sqrt((v-b)**2+(D-_)**2)<u*.15)return{worldCoords:[],screenCoords:[],reliabilities:[],debugExtra:n}}return this.debugMode&&(n={octaveIndex:h,projectedImage:p,matchingPoints:w,goodTrack:I,trackedPoints:E}),{worldCoords:M,screenCoords:E,reliabilities:C,indices:I,octaveIndex:h,deformedMesh:y,debugExtra:n}}_computeMatching(t,s){let{px:e,py:n,scale:i,data:r,width:a,height:c}=t,l=e.length,u=dn,h=u*2+1,m=1/(h*h),d=ro,p=ao,w=[],g=new Float32Array(l),x=this.templateBuffer;for(let M=0;M<l;M++){let E=e[M]+.5|0,I=n[M]+.5|0,S=-1,k=e[M]/i,T=n[M]/i,C=0,y=0,b=0;for(let D=-u;D<=u;D++){let A=(I+D)*a;for(let F=-u;F<=u;F++){let O=r[A+E+F];x[b++]=O,C+=O,y+=O*O}}let _=Math.sqrt(Math.max(0,y-C*C*m));if(_<1e-4){g[M]=-1,w.push([k,T]);continue}let v=4;for(let D=-d;D<=d;D+=v){let A=I+D;if(!(A<u||A>=c-u))for(let F=-d;F<=d;F+=v){let O=E+F;if(O<u||O>=a-u)continue;let B=0,V=0,P=0;for(let L=-u;L<=u;L++){let j=(A+L)*a,Y=(L+u)*h;for(let q=-u;q<=u;q++){let H=s[j+(O+q)],J=x[Y+(q+u)];B+=H,V+=H*H,P+=H*J}}let U=Math.sqrt(Math.max(0,V-B*B*m));if(U<1e-4)continue;let N=(P-B*C*m)/(U*_);N>S&&(S=N,k=O/i,T=A/i)}}if(S>mn){let D=k*i|0,A=T*i|0,F=v;for(let O=-F;O<=F;O++){let B=A+O;if(!(B<u||B>=c-u))for(let V=-F;V<=F;V++){let P=D+V;if(P<u||P>=a-u)continue;let U=0,N=0,L=0;for(let q=-u;q<=u;q++){let H=(B+q)*a,J=(q+u)*h;for(let Z=-u;Z<=u;Z++){let Q=s[H+(P+Z)],et=x[J+(Z+u)];U+=Q,N+=Q*Q,L+=Q*et}}let j=Math.sqrt(Math.max(0,N-U*U*m));if(j<1e-4)continue;let Y=(L-U*C*m)/(j*_);Y>S&&(S=Y,k=P/i,T=B/i)}}}g[M]=S,w.push([k,T])}return{matchingPoints:w,sim:g}}_computeProjection(t,s,e){let{width:n,height:i,scale:r,projectedImage:a}=e,c=1/r,l=this.inputWidth,u=this.inputHeight,h=t[0][0],f=t[0][1],m=t[0][3],d=t[1][0],p=t[1][1],w=t[1][3],g=t[2][0],x=t[2][1],M=t[2][3];for(let E=0;E<i;E++){let I=E*c,S=E*n;for(let k=0;k<n;k++){let T=k*c,y=1/(T*g+I*x+M),b=(T*h+I*f+m)*y,_=(T*d+I*p+w)*y,v=b|0,D=_|0,A=v+1,F=D+1;if(v>=0&&A<l&&D>=0&&F<u){let O=b-v,B=_-D,V=1-O,P=1-B,U=D*l,N=F*l,L=s[U+v],j=s[U+A],Y=s[N+v],q=s[N+A];a[S+k]=L*V*P+j*O*P+Y*V*B+q*O*B}else a[S+k]=0}}}}});var Re,Et,ws=W(()=>{"use strict";Re=[{sigma:.55,points:[[-1,0],[-.5,-.866025],[.5,-.866025],[1,-0],[.5,.866025],[-.5,.866025]]},{sigma:.475,points:[[0,.930969],[-.806243,.465485],[-.806243,-.465485],[-0,-.930969],[.806243,-.465485],[.806243,.465485]]},{sigma:.4,points:[[.847306,-0],[.423653,.733789],[-.423653,.733789],[-.847306,0],[-.423653,-.733789],[.423653,-.733789]]},{sigma:.325,points:[[-0,-.741094],[.641806,-.370547],[.641806,.370547],[0,.741094],[-.641806,.370547],[-.641806,-.370547]]},{sigma:.25,points:[[-.595502,0],[-.297751,-.51572],[.297751,-.51572],[.595502,-0],[.297751,.51572],[-.297751,.51572]]},{sigma:.175,points:[[0,.362783],[-.314179,.181391],[-.314179,-.181391],[-0,-.362783],[.314179,-.181391],[.314179,.181391]]},{sigma:.1,points:[[0,0]]}],Et=[];for(let o=0;o<Re.length;o++){let t=Re[o].sigma;for(let s=0;s<Re[o].points.length;s++){let e=Re[o].points[s];Et.push([t,e[0],e[1]])}}});var co,lo,ho,uo,fo,ys,Ae,xs=W(()=>{"use strict";co=()=>null,lo=(o,t,s)=>{let e=new Float32Array(t*s);for(let n=1;n<s-1;n++){let i=n*t,r=(n-1)*t,a=(n+1)*t;for(let c=1;c<t-1;c++){let l=i+c,u=(o[r+c+1]-o[r+c-1]+o[i+c+1]-o[i+c-1]+o[a+c+1]-o[a+c-1])/768,h=(o[a+c-1]-o[r+c-1]+o[a+c]-o[r+c]+o[a+c+1]-o[r+c+1])/768;e[l]=Math.sqrt((u*u+h*h)/2)}}return e},ho=(o,t,s)=>{let e=new Uint8Array(t*s);for(let n=1;n<s-1;n++){let i=n*t;for(let r=1;r<t-1;r++){let a=i+r,c=o[a];c>0&&c>=o[a-1]&&c>=o[a+1]&&c>=o[a-t]&&c>=o[a+t]&&(e[a]=1)}}return e},uo=(o,t,s)=>{let e=new Float32Array(t*s),n=new Float32Array(t*s),i=1/16,r=4/16,a=6/16,c=t-1,l=s-1;for(let u=0;u<s;u++){let h=u*t;for(let f=0;f<t;f++){let m=f<2?0:f-2,d=f<1?0:f-1,p=f>c-1?c:f+1,w=f>c-2?c:f+2;n[h+f]=o[h+m]*i+o[h+d]*r+o[h+f]*a+o[h+p]*r+o[h+w]*i}}for(let u=0;u<s;u++){let h=(u<2?0:u-2)*t,f=(u<1?0:u-1)*t,m=u*t,d=(u>l-1?l:u+1)*t,p=(u>l-2?l:u+2)*t;for(let w=0;w<t;w++)e[m+w]=n[h+w]*i+n[f+w]*r+n[m+w]*a+n[d+w]*r+n[p+w]*i}return e},fo=(o,t,s)=>{let e=Math.floor(t/2),n=Math.floor(s/2),i=new Float32Array(e*n);for(let r=0;r<n;r++){let a=r*2;for(let c=0;c<e;c++){let l=c*2,u=a*t+l;i[r*e+c]=(o[u]+o[u+1]+o[u+t]+o[u+t+1])/4}}return{data:i,width:e,height:n}},ys=class{constructor(){this.gpu=null,this.kernelCache=new Map,this.initialized=!1}init(){this.initialized||(this.gpu=co(),this.initialized=!0)}computeGradients(t,s,e){return this.init(),lo(t,s,e)}findLocalMaxima(t,s,e){return this.init(),ho(t,s,e)}edgeDetection(t,s,e){let n=this.computeGradients(t,s,e),i=this.findLocalMaxima(n,s,e);return{dValue:n,isCandidate:i}}gaussianBlur(t,s,e){return this.init(),uo(t,s,e)}downsample(t,s,e){return this.init(),fo(t,s,e)}buildPyramid(t,s,e,n=5){this.init();let i=[],r=t instanceof Float32Array?t:Float32Array.from(t),a=s,c=e;for(let l=0;l<n;l++){let u=this.gaussianBlur(r,a,c);if(i.push({data:u,width:a,height:c,scale:Math.pow(2,l)}),a>8&&c>8){let h=this.downsample(u,a,c);r=h.data,a=h.width,c=h.height}else break}return i}isGPUAvailable(){return this.init(),this.gpu!==null}destroy(){this.kernelCache.clear(),this.gpu&&this.gpu.destroy&&this.gpu.destroy(),this.gpu=null,this.initialized=!1}},Ae=new ys});function wn(o){let t=new Uint32Array(2);for(let s=0;s<64;s++){let e=Ue[s*2],n=Ue[s*2+1];if(o[e]<o[n]){let i=s>>5,r=s&31;t[i]|=1<<r}}return t}function yn(o){let t=new Uint8Array(84),s=0,e=0;for(let n=0;n<Et.length;n++)for(let i=n+1;i<Et.length;i++)o[n]<o[i]&&(t[e]|=1<<7-s),s++,s===8&&(e++,s=0);return t}function xn(o){let t=new Uint8Array(8),s=new DataView(t.buffer);return s.setUint32(0,o[0],!0),s.setUint32(4,o[1],!0),t}var Ue,pn,gn,Zt,Mn=W(()=>{"use strict";ws();Ue=new Int32Array(128),pn=new Int32Array(64);for(let o=0;o<64;o++)pn[o]=Math.floor(o*(672/64));gn=0,Zt=0;for(let o=0;o<Et.length;o++)for(let t=o+1;t<Et.length;t++)Zt<64&&gn===pn[Zt]&&(Ue[Zt*2]=o,Ue[Zt*2+1]=t,Zt++),gn++});function bn(o){let t=o.length,s=0,e=0;for(;e<t;){let n=o.charCodeAt(e++);if((n&4294967168)===0){s++;continue}else if((n&4294965248)===0)s+=2;else{if(n>=55296&&n<=56319&&e<t){let i=o.charCodeAt(e);(i&64512)===56320&&(++e,n=((n&1023)<<10)+(i&1023)+65536)}(n&4294901760)===0?s+=3:s+=4}}return s}function mo(o,t,s){let e=o.length,n=s,i=0;for(;i<e;){let r=o.charCodeAt(i++);if((r&4294967168)===0){t[n++]=r;continue}else if((r&4294965248)===0)t[n++]=r>>6&31|192;else{if(r>=55296&&r<=56319&&i<e){let a=o.charCodeAt(i);(a&64512)===56320&&(++i,r=((r&1023)<<10)+(a&1023)+65536)}(r&4294901760)===0?(t[n++]=r>>12&15|224,t[n++]=r>>6&63|128):(t[n++]=r>>18&7|240,t[n++]=r>>12&63|128,t[n++]=r>>6&63|128)}t[n++]=r&63|128}}function wo(o,t,s){go.encodeInto(o,t.subarray(s))}function Sn(o,t,s){o.length>po?wo(o,t,s):mo(o,t,s)}function Ms(o,t,s){let e=t,n=e+s,i=[],r="";for(;e<n;){let a=o[e++];if((a&128)===0)i.push(a);else if((a&224)===192){let c=o[e++]&63;i.push((a&31)<<6|c)}else if((a&240)===224){let c=o[e++]&63,l=o[e++]&63;i.push((a&31)<<12|c<<6|l)}else if((a&248)===240){let c=o[e++]&63,l=o[e++]&63,u=o[e++]&63,h=(a&7)<<18|c<<12|l<<6|u;h>65535&&(h-=65536,i.push(h>>>10&1023|55296),h=56320|h&1023),i.push(h)}else i.push(a);i.length>=yo&&(r+=String.fromCharCode(...i),i.length=0)}return i.length>0&&(r+=String.fromCharCode(...i)),r}function bo(o,t,s){let e=o.subarray(t,t+s);return xo.decode(e)}function En(o,t,s){return s>Mo?bo(o,t,s):Ms(o,t,s)}var go,po,yo,xo,Mo,Fe=W(()=>{go=new TextEncoder,po=50;yo=4096;xo=new TextDecoder,Mo=200});var Dt,kn=W(()=>{Dt=class{type;data;constructor(t,s){this.type=t,this.data=s}}});var lt,bs=W(()=>{lt=class o extends Error{constructor(t){super(t);let s=Object.create(o.prototype);Object.setPrototypeOf(this,s),Object.defineProperty(this,"name",{configurable:!0,enumerable:!1,value:o.name})}}});function In(o,t,s){let e=s/4294967296,n=s;o.setUint32(t,e),o.setUint32(t+4,n)}function Pe(o,t,s){let e=Math.floor(s/4294967296),n=s;o.setUint32(t,e),o.setUint32(t+4,n)}function De(o,t){let s=o.getInt32(t),e=o.getUint32(t+4);return s*4294967296+e}function vn(o,t){let s=o.getUint32(t),e=o.getUint32(t+4);return s*4294967296+e}var Oe=W(()=>{});function Io({sec:o,nsec:t}){if(o>=0&&t>=0&&o<=ko)if(t===0&&o<=Eo){let s=new Uint8Array(4);return new DataView(s.buffer).setUint32(0,o),s}else{let s=o/4294967296,e=o&4294967295,n=new Uint8Array(8),i=new DataView(n.buffer);return i.setUint32(0,t<<2|s&3),i.setUint32(4,e),n}else{let s=new Uint8Array(12),e=new DataView(s.buffer);return e.setUint32(0,t),Pe(e,4,o),s}}function vo(o){let t=o.getTime(),s=Math.floor(t/1e3),e=(t-s*1e3)*1e6,n=Math.floor(e/1e9);return{sec:s+n,nsec:e-n*1e9}}function To(o){if(o instanceof Date){let t=vo(o);return Io(t)}else return null}function _o(o){let t=new DataView(o.buffer,o.byteOffset,o.byteLength);switch(o.byteLength){case 4:return{sec:t.getUint32(0),nsec:0};case 8:{let s=t.getUint32(0),e=t.getUint32(4),n=(s&3)*4294967296+e,i=s>>>2;return{sec:n,nsec:i}}case 12:{let s=De(t,4),e=t.getUint32(0);return{sec:s,nsec:e}}default:throw new lt(`Unrecognized data size for timestamp (expected 4, 8, or 12): ${o.length}`)}}function Co(o){let t=_o(o);return new Date(t.sec*1e3+t.nsec/1e6)}var So,Eo,ko,Tn,_n=W(()=>{bs();Oe();So=-1,Eo=4294967296-1,ko=17179869184-1;Tn={type:So,encode:To,decode:Co}});var qt,Ss=W(()=>{kn();_n();qt=class o{static defaultCodec=new o;__brand;builtInEncoders=[];builtInDecoders=[];encoders=[];decoders=[];constructor(){this.register(Tn)}register({type:t,encode:s,decode:e}){if(t>=0)this.encoders[t]=s,this.decoders[t]=e;else{let n=-1-t;this.builtInEncoders[n]=s,this.builtInDecoders[n]=e}}tryToEncode(t,s){for(let e=0;e<this.builtInEncoders.length;e++){let n=this.builtInEncoders[e];if(n!=null){let i=n(t,s);if(i!=null){let r=-1-e;return new Dt(r,i)}}}for(let e=0;e<this.encoders.length;e++){let n=this.encoders[e];if(n!=null){let i=n(t,s);if(i!=null){let r=e;return new Dt(r,i)}}}return t instanceof Dt?t:null}decode(t,s,e){let n=s<0?this.builtInDecoders[-1-s]:this.decoders[s];return n?n(t,s,e):new Dt(s,t)}}});function Ro(o){return o instanceof ArrayBuffer||typeof SharedArrayBuffer<"u"&&o instanceof SharedArrayBuffer}function Qt(o){return o instanceof Uint8Array?o:ArrayBuffer.isView(o)?new Uint8Array(o.buffer,o.byteOffset,o.byteLength):Ro(o)?new Uint8Array(o):Uint8Array.from(o)}var Es=W(()=>{});var Ao,Uo,Le,Cn=W(()=>{Fe();Ss();Oe();Es();Ao=100,Uo=2048,Le=class o{extensionCodec;context;useBigInt64;maxDepth;initialBufferSize;sortKeys;forceFloat32;ignoreUndefined;forceIntegerToFloat;pos;view;bytes;entered=!1;constructor(t){this.extensionCodec=t?.extensionCodec??qt.defaultCodec,this.context=t?.context,this.useBigInt64=t?.useBigInt64??!1,this.maxDepth=t?.maxDepth??Ao,this.initialBufferSize=t?.initialBufferSize??Uo,this.sortKeys=t?.sortKeys??!1,this.forceFloat32=t?.forceFloat32??!1,this.ignoreUndefined=t?.ignoreUndefined??!1,this.forceIntegerToFloat=t?.forceIntegerToFloat??!1,this.pos=0,this.view=new DataView(new ArrayBuffer(this.initialBufferSize)),this.bytes=new Uint8Array(this.view.buffer)}clone(){return new o({extensionCodec:this.extensionCodec,context:this.context,useBigInt64:this.useBigInt64,maxDepth:this.maxDepth,initialBufferSize:this.initialBufferSize,sortKeys:this.sortKeys,forceFloat32:this.forceFloat32,ignoreUndefined:this.ignoreUndefined,forceIntegerToFloat:this.forceIntegerToFloat})}reinitializeState(){this.pos=0}encodeSharedRef(t){if(this.entered)return this.clone().encodeSharedRef(t);try{return this.entered=!0,this.reinitializeState(),this.doEncode(t,1),this.bytes.subarray(0,this.pos)}finally{this.entered=!1}}encode(t){if(this.entered)return this.clone().encode(t);try{return this.entered=!0,this.reinitializeState(),this.doEncode(t,1),this.bytes.slice(0,this.pos)}finally{this.entered=!1}}doEncode(t,s){if(s>this.maxDepth)throw new Error(`Too deep objects in depth ${s}`);t==null?this.encodeNil():typeof t=="boolean"?this.encodeBoolean(t):typeof t=="number"?this.forceIntegerToFloat?this.encodeNumberAsFloat(t):this.encodeNumber(t):typeof t=="string"?this.encodeString(t):this.useBigInt64&&typeof t=="bigint"?this.encodeBigInt64(t):this.encodeObject(t,s)}ensureBufferSizeToWrite(t){let s=this.pos+t;this.view.byteLength<s&&this.resizeBuffer(s*2)}resizeBuffer(t){let s=new ArrayBuffer(t),e=new Uint8Array(s),n=new DataView(s);e.set(this.bytes),this.view=n,this.bytes=e}encodeNil(){this.writeU8(192)}encodeBoolean(t){t===!1?this.writeU8(194):this.writeU8(195)}encodeNumber(t){!this.forceIntegerToFloat&&Number.isSafeInteger(t)?t>=0?t<128?this.writeU8(t):t<256?(this.writeU8(204),this.writeU8(t)):t<65536?(this.writeU8(205),this.writeU16(t)):t<4294967296?(this.writeU8(206),this.writeU32(t)):this.useBigInt64?this.encodeNumberAsFloat(t):(this.writeU8(207),this.writeU64(t)):t>=-32?this.writeU8(224|t+32):t>=-128?(this.writeU8(208),this.writeI8(t)):t>=-32768?(this.writeU8(209),this.writeI16(t)):t>=-2147483648?(this.writeU8(210),this.writeI32(t)):this.useBigInt64?this.encodeNumberAsFloat(t):(this.writeU8(211),this.writeI64(t)):this.encodeNumberAsFloat(t)}encodeNumberAsFloat(t){this.forceFloat32?(this.writeU8(202),this.writeF32(t)):(this.writeU8(203),this.writeF64(t))}encodeBigInt64(t){t>=BigInt(0)?(this.writeU8(207),this.writeBigUint64(t)):(this.writeU8(211),this.writeBigInt64(t))}writeStringHeader(t){if(t<32)this.writeU8(160+t);else if(t<256)this.writeU8(217),this.writeU8(t);else if(t<65536)this.writeU8(218),this.writeU16(t);else if(t<4294967296)this.writeU8(219),this.writeU32(t);else throw new Error(`Too long string: ${t} bytes in UTF-8`)}encodeString(t){let e=bn(t);this.ensureBufferSizeToWrite(5+e),this.writeStringHeader(e),Sn(t,this.bytes,this.pos),this.pos+=e}encodeObject(t,s){let e=this.extensionCodec.tryToEncode(t,this.context);if(e!=null)this.encodeExtension(e);else if(Array.isArray(t))this.encodeArray(t,s);else if(ArrayBuffer.isView(t))this.encodeBinary(t);else if(typeof t=="object")this.encodeMap(t,s);else throw new Error(`Unrecognized object: ${Object.prototype.toString.apply(t)}`)}encodeBinary(t){let s=t.byteLength;if(s<256)this.writeU8(196),this.writeU8(s);else if(s<65536)this.writeU8(197),this.writeU16(s);else if(s<4294967296)this.writeU8(198),this.writeU32(s);else throw new Error(`Too large binary: ${s}`);let e=Qt(t);this.writeU8a(e)}encodeArray(t,s){let e=t.length;if(e<16)this.writeU8(144+e);else if(e<65536)this.writeU8(220),this.writeU16(e);else if(e<4294967296)this.writeU8(221),this.writeU32(e);else throw new Error(`Too large array: ${e}`);for(let n of t)this.doEncode(n,s+1)}countWithoutUndefined(t,s){let e=0;for(let n of s)t[n]!==void 0&&e++;return e}encodeMap(t,s){let e=Object.keys(t);this.sortKeys&&e.sort();let n=this.ignoreUndefined?this.countWithoutUndefined(t,e):e.length;if(n<16)this.writeU8(128+n);else if(n<65536)this.writeU8(222),this.writeU16(n);else if(n<4294967296)this.writeU8(223),this.writeU32(n);else throw new Error(`Too large map object: ${n}`);for(let i of e){let r=t[i];this.ignoreUndefined&&r===void 0||(this.encodeString(i),this.doEncode(r,s+1))}}encodeExtension(t){if(typeof t.data=="function"){let e=t.data(this.pos+6),n=e.length;if(n>=4294967296)throw new Error(`Too large extension object: ${n}`);this.writeU8(201),this.writeU32(n),this.writeI8(t.type),this.writeU8a(e);return}let s=t.data.length;if(s===1)this.writeU8(212);else if(s===2)this.writeU8(213);else if(s===4)this.writeU8(214);else if(s===8)this.writeU8(215);else if(s===16)this.writeU8(216);else if(s<256)this.writeU8(199),this.writeU8(s);else if(s<65536)this.writeU8(200),this.writeU16(s);else if(s<4294967296)this.writeU8(201),this.writeU32(s);else throw new Error(`Too large extension object: ${s}`);this.writeI8(t.type),this.writeU8a(t.data)}writeU8(t){this.ensureBufferSizeToWrite(1),this.view.setUint8(this.pos,t),this.pos++}writeU8a(t){let s=t.length;this.ensureBufferSizeToWrite(s),this.bytes.set(t,this.pos),this.pos+=s}writeI8(t){this.ensureBufferSizeToWrite(1),this.view.setInt8(this.pos,t),this.pos++}writeU16(t){this.ensureBufferSizeToWrite(2),this.view.setUint16(this.pos,t),this.pos+=2}writeI16(t){this.ensureBufferSizeToWrite(2),this.view.setInt16(this.pos,t),this.pos+=2}writeU32(t){this.ensureBufferSizeToWrite(4),this.view.setUint32(this.pos,t),this.pos+=4}writeI32(t){this.ensureBufferSizeToWrite(4),this.view.setInt32(this.pos,t),this.pos+=4}writeF32(t){this.ensureBufferSizeToWrite(4),this.view.setFloat32(this.pos,t),this.pos+=4}writeF64(t){this.ensureBufferSizeToWrite(8),this.view.setFloat64(this.pos,t),this.pos+=8}writeU64(t){this.ensureBufferSizeToWrite(8),In(this.view,this.pos,t),this.pos+=8}writeI64(t){this.ensureBufferSizeToWrite(8),Pe(this.view,this.pos,t),this.pos+=8}writeBigUint64(t){this.ensureBufferSizeToWrite(8),this.view.setBigUint64(this.pos,t),this.pos+=8}writeBigInt64(t){this.ensureBufferSizeToWrite(8),this.view.setBigInt64(this.pos,t),this.pos+=8}}});function ks(o,t){return new Le(t).encodeSharedRef(o)}var Rn=W(()=>{Cn()});function Ne(o){return`${o<0?"-":""}0x${Math.abs(o).toString(16).padStart(2,"0")}`}var An=W(()=>{});var Fo,Po,Be,Un=W(()=>{Fe();Fo=16,Po=16,Be=class{hit=0;miss=0;caches;maxKeyLength;maxLengthPerKey;constructor(t=Fo,s=Po){this.maxKeyLength=t,this.maxLengthPerKey=s,this.caches=[];for(let e=0;e<this.maxKeyLength;e++)this.caches.push([])}canBeCached(t){return t>0&&t<=this.maxKeyLength}find(t,s,e){let n=this.caches[e-1];t:for(let i of n){let r=i.bytes;for(let a=0;a<e;a++)if(r[a]!==t[s+a])continue t;return i.str}return null}store(t,s){let e=this.caches[t.length-1],n={bytes:t,str:s};e.length>=this.maxLengthPerKey?e[Math.random()*e.length|0]=n:e.push(n)}decode(t,s,e){let n=this.find(t,s,e);if(n!=null)return this.hit++,n;this.miss++;let i=Ms(t,s,e),r=Uint8Array.prototype.slice.call(t,s,s+e);return this.store(r,i),i}}});var Is,se,Pn,Do,vs,ee,Ts,Oo,Fn,Lo,je,Dn=W(()=>{An();Ss();Oe();Fe();Es();Un();bs();Is="array",se="map_key",Pn="map_value",Do=o=>{if(typeof o=="string"||typeof o=="number")return o;throw new lt("The type of key must be string or number but "+typeof o)},vs=class{stack=[];stackHeadPosition=-1;get length(){return this.stackHeadPosition+1}top(){return this.stack[this.stackHeadPosition]}pushArrayState(t){let s=this.getUninitializedStateFromPool();s.type=Is,s.position=0,s.size=t,s.array=new Array(t)}pushMapState(t){let s=this.getUninitializedStateFromPool();s.type=se,s.readCount=0,s.size=t,s.map={}}getUninitializedStateFromPool(){if(this.stackHeadPosition++,this.stackHeadPosition===this.stack.length){let t={type:void 0,size:0,array:void 0,position:0,readCount:0,map:void 0,key:null};this.stack.push(t)}return this.stack[this.stackHeadPosition]}release(t){if(this.stack[this.stackHeadPosition]!==t)throw new Error("Invalid stack state. Released state is not on top of the stack.");if(t.type===Is){let e=t;e.size=0,e.array=void 0,e.position=0,e.type=void 0}if(t.type===se||t.type===Pn){let e=t;e.size=0,e.map=void 0,e.readCount=0,e.type=void 0}this.stackHeadPosition--}reset(){this.stack.length=0,this.stackHeadPosition=-1}},ee=-1,Ts=new DataView(new ArrayBuffer(0)),Oo=new Uint8Array(Ts.buffer);try{Ts.getInt8(0)}catch(o){if(!(o instanceof RangeError))throw new Error("This module is not supported in the current JavaScript engine because DataView does not throw RangeError on out-of-bounds access")}Fn=new RangeError("Insufficient data"),Lo=new Be,je=class o{extensionCodec;context;useBigInt64;rawStrings;maxStrLength;maxBinLength;maxArrayLength;maxMapLength;maxExtLength;keyDecoder;mapKeyConverter;totalPos=0;pos=0;view=Ts;bytes=Oo;headByte=ee;stack=new vs;entered=!1;constructor(t){this.extensionCodec=t?.extensionCodec??qt.defaultCodec,this.context=t?.context,this.useBigInt64=t?.useBigInt64??!1,this.rawStrings=t?.rawStrings??!1,this.maxStrLength=t?.maxStrLength??4294967295,this.maxBinLength=t?.maxBinLength??4294967295,this.maxArrayLength=t?.maxArrayLength??4294967295,this.maxMapLength=t?.maxMapLength??4294967295,this.maxExtLength=t?.maxExtLength??4294967295,this.keyDecoder=t?.keyDecoder!==void 0?t.keyDecoder:Lo,this.mapKeyConverter=t?.mapKeyConverter??Do}clone(){return new o({extensionCodec:this.extensionCodec,context:this.context,useBigInt64:this.useBigInt64,rawStrings:this.rawStrings,maxStrLength:this.maxStrLength,maxBinLength:this.maxBinLength,maxArrayLength:this.maxArrayLength,maxMapLength:this.maxMapLength,maxExtLength:this.maxExtLength,keyDecoder:this.keyDecoder})}reinitializeState(){this.totalPos=0,this.headByte=ee,this.stack.reset()}setBuffer(t){let s=Qt(t);this.bytes=s,this.view=new DataView(s.buffer,s.byteOffset,s.byteLength),this.pos=0}appendBuffer(t){if(this.headByte===ee&&!this.hasRemaining(1))this.setBuffer(t);else{let s=this.bytes.subarray(this.pos),e=Qt(t),n=new Uint8Array(s.length+e.length);n.set(s),n.set(e,s.length),this.setBuffer(n)}}hasRemaining(t){return this.view.byteLength-this.pos>=t}createExtraByteError(t){let{view:s,pos:e}=this;return new RangeError(`Extra ${s.byteLength-e} of ${s.byteLength} byte(s) found at buffer[${t}]`)}decode(t){if(this.entered)return this.clone().decode(t);try{this.entered=!0,this.reinitializeState(),this.setBuffer(t);let s=this.doDecodeSync();if(this.hasRemaining(1))throw this.createExtraByteError(this.pos);return s}finally{this.entered=!1}}*decodeMulti(t){if(this.entered){yield*this.clone().decodeMulti(t);return}try{for(this.entered=!0,this.reinitializeState(),this.setBuffer(t);this.hasRemaining(1);)yield this.doDecodeSync()}finally{this.entered=!1}}async decodeAsync(t){if(this.entered)return this.clone().decodeAsync(t);try{this.entered=!0;let s=!1,e;for await(let a of t){if(s)throw this.entered=!1,this.createExtraByteError(this.totalPos);this.appendBuffer(a);try{e=this.doDecodeSync(),s=!0}catch(c){if(!(c instanceof RangeError))throw c}this.totalPos+=this.pos}if(s){if(this.hasRemaining(1))throw this.createExtraByteError(this.totalPos);return e}let{headByte:n,pos:i,totalPos:r}=this;throw new RangeError(`Insufficient data in parsing ${Ne(n)} at ${r} (${i} in the current buffer)`)}finally{this.entered=!1}}decodeArrayStream(t){return this.decodeMultiAsync(t,!0)}decodeStream(t){return this.decodeMultiAsync(t,!1)}async*decodeMultiAsync(t,s){if(this.entered){yield*this.clone().decodeMultiAsync(t,s);return}try{this.entered=!0;let e=s,n=-1;for await(let i of t){if(s&&n===0)throw this.createExtraByteError(this.totalPos);this.appendBuffer(i),e&&(n=this.readArraySize(),e=!1,this.complete());try{for(;yield this.doDecodeSync(),--n!==0;);}catch(r){if(!(r instanceof RangeError))throw r}this.totalPos+=this.pos}}finally{this.entered=!1}}doDecodeSync(){t:for(;;){let t=this.readHeadByte(),s;if(t>=224)s=t-256;else if(t<192)if(t<128)s=t;else if(t<144){let n=t-128;if(n!==0){this.pushMapState(n),this.complete();continue t}else s={}}else if(t<160){let n=t-144;if(n!==0){this.pushArrayState(n),this.complete();continue t}else s=[]}else{let n=t-160;s=this.decodeString(n,0)}else if(t===192)s=null;else if(t===194)s=!1;else if(t===195)s=!0;else if(t===202)s=this.readF32();else if(t===203)s=this.readF64();else if(t===204)s=this.readU8();else if(t===205)s=this.readU16();else if(t===206)s=this.readU32();else if(t===207)this.useBigInt64?s=this.readU64AsBigInt():s=this.readU64();else if(t===208)s=this.readI8();else if(t===209)s=this.readI16();else if(t===210)s=this.readI32();else if(t===211)this.useBigInt64?s=this.readI64AsBigInt():s=this.readI64();else if(t===217){let n=this.lookU8();s=this.decodeString(n,1)}else if(t===218){let n=this.lookU16();s=this.decodeString(n,2)}else if(t===219){let n=this.lookU32();s=this.decodeString(n,4)}else if(t===220){let n=this.readU16();if(n!==0){this.pushArrayState(n),this.complete();continue t}else s=[]}else if(t===221){let n=this.readU32();if(n!==0){this.pushArrayState(n),this.complete();continue t}else s=[]}else if(t===222){let n=this.readU16();if(n!==0){this.pushMapState(n),this.complete();continue t}else s={}}else if(t===223){let n=this.readU32();if(n!==0){this.pushMapState(n),this.complete();continue t}else s={}}else if(t===196){let n=this.lookU8();s=this.decodeBinary(n,1)}else if(t===197){let n=this.lookU16();s=this.decodeBinary(n,2)}else if(t===198){let n=this.lookU32();s=this.decodeBinary(n,4)}else if(t===212)s=this.decodeExtension(1,0);else if(t===213)s=this.decodeExtension(2,0);else if(t===214)s=this.decodeExtension(4,0);else if(t===215)s=this.decodeExtension(8,0);else if(t===216)s=this.decodeExtension(16,0);else if(t===199){let n=this.lookU8();s=this.decodeExtension(n,1)}else if(t===200){let n=this.lookU16();s=this.decodeExtension(n,2)}else if(t===201){let n=this.lookU32();s=this.decodeExtension(n,4)}else throw new lt(`Unrecognized type byte: ${Ne(t)}`);this.complete();let e=this.stack;for(;e.length>0;){let n=e.top();if(n.type===Is)if(n.array[n.position]=s,n.position++,n.position===n.size)s=n.array,e.release(n);else continue t;else if(n.type===se){if(s==="__proto__")throw new lt("The key __proto__ is not allowed");n.key=this.mapKeyConverter(s),n.type=Pn;continue t}else if(n.map[n.key]=s,n.readCount++,n.readCount===n.size)s=n.map,e.release(n);else{n.key=null,n.type=se;continue t}}return s}}readHeadByte(){return this.headByte===ee&&(this.headByte=this.readU8()),this.headByte}complete(){this.headByte=ee}readArraySize(){let t=this.readHeadByte();switch(t){case 220:return this.readU16();case 221:return this.readU32();default:{if(t<160)return t-144;throw new lt(`Unrecognized array type byte: ${Ne(t)}`)}}}pushMapState(t){if(t>this.maxMapLength)throw new lt(`Max length exceeded: map length (${t}) > maxMapLengthLength (${this.maxMapLength})`);this.stack.pushMapState(t)}pushArrayState(t){if(t>this.maxArrayLength)throw new lt(`Max length exceeded: array length (${t}) > maxArrayLength (${this.maxArrayLength})`);this.stack.pushArrayState(t)}decodeString(t,s){return!this.rawStrings||this.stateIsMapKey()?this.decodeUtf8String(t,s):this.decodeBinary(t,s)}decodeUtf8String(t,s){if(t>this.maxStrLength)throw new lt(`Max length exceeded: UTF-8 byte length (${t}) > maxStrLength (${this.maxStrLength})`);if(this.bytes.byteLength<this.pos+s+t)throw Fn;let e=this.pos+s,n;return this.stateIsMapKey()&&this.keyDecoder?.canBeCached(t)?n=this.keyDecoder.decode(this.bytes,e,t):n=En(this.bytes,e,t),this.pos+=s+t,n}stateIsMapKey(){return this.stack.length>0?this.stack.top().type===se:!1}decodeBinary(t,s){if(t>this.maxBinLength)throw new lt(`Max length exceeded: bin length (${t}) > maxBinLength (${this.maxBinLength})`);if(!this.hasRemaining(t+s))throw Fn;let e=this.pos+s,n=this.bytes.subarray(e,e+t);return this.pos+=s+t,n}decodeExtension(t,s){if(t>this.maxExtLength)throw new lt(`Max length exceeded: ext length (${t}) > maxExtLength (${this.maxExtLength})`);let e=this.view.getInt8(this.pos+s),n=this.decodeBinary(t,s+1);return this.extensionCodec.decode(n,e,this.context)}lookU8(){return this.view.getUint8(this.pos)}lookU16(){return this.view.getUint16(this.pos)}lookU32(){return this.view.getUint32(this.pos)}readU8(){let t=this.view.getUint8(this.pos);return this.pos++,t}readI8(){let t=this.view.getInt8(this.pos);return this.pos++,t}readU16(){let t=this.view.getUint16(this.pos);return this.pos+=2,t}readI16(){let t=this.view.getInt16(this.pos);return this.pos+=2,t}readU32(){let t=this.view.getUint32(this.pos);return this.pos+=4,t}readI32(){let t=this.view.getInt32(this.pos);return this.pos+=4,t}readU64(){let t=vn(this.view,this.pos);return this.pos+=8,t}readI64(){let t=De(this.view,this.pos);return this.pos+=8,t}readU64AsBigInt(){let t=this.view.getBigUint64(this.pos);return this.pos+=8,t}readI64AsBigInt(){let t=this.view.getBigInt64(this.pos);return this.pos+=8,t}readF32(){let t=this.view.getFloat32(this.pos);return this.pos+=4,t}readF64(){let t=this.view.getFloat64(this.pos);return this.pos+=8,t}}});function _s(o,t){return new je(t).decode(o)}var On=W(()=>{Dn()});var Ln=W(()=>{Rn();On()});function Bo(o,t,s){let e=t*s,n=new Uint8Array(e);for(let i=0;i<o.length;i++){let r=o[i],a=r&240,c=(r&15)<<4;n[i*2]=a,n[i*2+1]=c}return n}function Nn(o,t,s,e,n=!1){let i=o.length,r=new Uint16Array(i),a=new Uint16Array(i),c=new Int16Array(i),l=new Uint8Array(i),u;n?u=new Uint32Array(i):u=new Uint32Array(i*2);for(let h=0;h<i;h++)r[h]=Math.round(o[h].x/s*65535),a[h]=Math.round(o[h].y/e*65535),c[h]=Math.round(o[h].angle/Math.PI*32767),l[h]=Math.round(Math.log2(o[h].scale||1)),o[h].descriptors&&o[h].descriptors.length>=2&&(n?u[h]=o[h].hdcSignature||0:(u[h*2]=o[h].descriptors[0],u[h*2+1]=o[h].descriptors[1]));return{x:r,y:a,a:c,s:l,d:u,hdc:n?1:0,t:Rs(t.rootNode)}}function Bn(o,t,s,e){let n=o.length,i=new Uint16Array(n),r=new Uint16Array(n),a=new Int16Array(n),c=new Uint8Array(n),l=new Uint32Array(n);for(let u=0;u<n;u++)i[u]=Math.round(o[u].x/s*65535),r[u]=Math.round(o[u].y/e*65535),a[u]=Math.round(o[u].angle/Math.PI*32767),c[u]=Math.round(Math.log2(o[u].scale||1)),o[u].descriptors&&o[u].descriptors.length>=2&&(l[u]=(o[u].descriptors[0]^o[u].descriptors[1])>>>0);return{x:i,y:r,a,s:c,d:l,compact:1,t:Rs(t.rootNode)}}function Rs(o){return o.leaf?[1,o.centerPointIndex||0,o.pointIndexes]:[0,o.centerPointIndex||0,o.children.map(t=>Rs(t))]}function ze(o){let t=_s(new Uint8Array(o)),s=t.v||0;(s<5||s>Cs)&&console.warn(`Potential incompatible .taar version: ${s}. Standard is ${Cs}.`);let e=t.dataList;for(let n=0;n<e.length;n++){let i=e[n];for(let r of i.trackingData){let a=(h,f)=>h instanceof Uint8Array&&f!==Uint8Array?new f(h.buffer.slice(h.byteOffset,h.byteOffset+h.byteLength)):h;r.px=a(r.px,Float32Array),r.py=a(r.py,Float32Array);let c=r.data||r.d,l=r.width||r.w,u=r.height||r.h;if(c&&c.length===l*u/2){let h=Bo(c,l,u);r.data&&(r.data=h),r.d&&(r.d=h)}r.mesh&&(r.mesh.t=a(r.mesh.t,Uint16Array),r.mesh.e=a(r.mesh.e,Uint16Array),r.mesh.rl=a(r.mesh.rl,Float32Array))}for(let r of i.matchingData)for(let a of[r.max,r.min]){if(!a)continue;let c=a.x,l=a.y;c instanceof Uint8Array&&(c=new Uint16Array(c.buffer.slice(c.byteOffset,c.byteOffset+c.byteLength))),l instanceof Uint8Array&&(l=new Uint16Array(l.buffer.slice(l.byteOffset,l.byteOffset+l.byteLength)));let u=c.length,h=new Float32Array(u),f=new Float32Array(u);for(let m=0;m<u;m++)h[m]=c[m]/65535*r.w,f[m]=l[m]/65535*r.h;if(a.x=h,a.y=f,a.a instanceof Uint8Array){let m=new Int16Array(a.a.buffer.slice(a.a.byteOffset,a.a.byteOffset+a.a.byteLength)),d=new Float32Array(u);for(let p=0;p<u;p++)d[p]=m[p]/32767*Math.PI;a.a=d}if(a.s instanceof Uint8Array){let m=a.s,d=new Float32Array(u);for(let p=0;p<u;p++)d[p]=Math.pow(2,m[p]);a.s=d}a.d instanceof Uint8Array&&(a.hdc===1?a.d=new Uint32Array(a.d.buffer.slice(a.d.byteOffset,a.d.byteOffset+a.d.byteLength)):a.d=new Uint32Array(a.d.buffer.slice(a.d.byteOffset,a.d.byteOffset+a.d.byteLength)))}}return{version:s,dataList:e}}function jn(o){return ks({v:Cs,dataList:o})}var Cs,qe=W(()=>{"use strict";Ln();Cs=11});var qn,jo,zo,ne,Vn,qo,Tt,Ve=W(()=>{"use strict";ws();xs();Mn();qe();qn=4,jo=15,zo=12,ne=36,Vn=7,qo=!0,Tt=class{constructor(t,s,e={}){this.width=t,this.height=s,this.useGPU=e.useGPU!==void 0?e.useGPU:qo,this.useLSH=e.useLSH!==void 0?e.useLSH:!0,this.useHDC=e.useHDC!==void 0?e.useHDC:!0,this.maxFeaturesPerBucket=e.maxFeaturesPerBucket!==void 0?e.maxFeaturesPerBucket:zo;let n=0,i=t,r=s;for(;i>=qn&&r>=qn&&(i=Math.floor(i/2),r=Math.floor(r/2),n++,n!==10););this.numOctaves=e.maxOctaves!==void 0?Math.min(n,e.maxOctaves):n}detect(t,s={}){let e=s.octavesToProcess||Array.from({length:this.numOctaves},(u,h)=>h),n;if(t instanceof Float32Array)n=t;else{n=new Float32Array(t.length);for(let u=0;u<t.length;u++)n[u]=t[u]}let i=this._buildGaussianPyramid(n,this.width,this.height,e),r=this._buildDogPyramid(i,e),a=this._findExtremas(r,i),c=this._applyPrune(a);return this._computeOrientations(c,i),this._computeFreakDescriptors(c,i),{featurePoints:c.map(u=>{let h=Math.pow(2,u.octave);return{maxima:u.score>0,x:u.x*h+h*.5-.5,y:u.y*h+h*.5-.5,scale:h,angle:u.angle||0,score:u.absScore,descriptors:this.useLSH&&u.lsh?u.lsh:u.descriptors||[],imageData:n}}),pyramid:i}}_buildGaussianPyramid(t,s,e,n=null){if(this.useGPU)try{let l=Ae.buildPyramid(t,s,e,this.numOctaves),u=[];for(let h=0;h<l.length&&h<this.numOctaves;h++){if(n&&!n.includes(h)){u.push(null);continue}let f=l[h],m=this._applyGaussianFilter(f.data,f.width,f.height);u.push([{data:f.data,width:f.width,height:f.height},{data:m.data,width:f.width,height:f.height}])}return u}catch(l){console.warn("GPU pyramid failed, falling back to CPU:",l.message)}(!this._pyramidBuffers||this._pyramidBuffers.width!==s||this._pyramidBuffers.height!==e)&&(this._pyramidBuffers={width:s,height:e,temp:new Float32Array(s*e)});let i=[],r=t,a=s,c=e;for(let l=0;l<this.numOctaves;l++){let u=!n||n.includes(l);if(u){let h=this._applyGaussianFilter(r,a,c),f=this._applyGaussianFilter(h.data,a,c);i.push([{data:h.data,width:a,height:c},{data:f.data,width:a,height:c}])}else i.push(null);if(l<this.numOctaves-1)if(!n||n.some(f=>f>l)){let f=u?i[l][0].data:r,m=this._downsample(f,a,c);r=m.data,a=m.width,c=m.height}else break}return i}_applyGaussianFilter(t,s,e){let n=new Float32Array(s*e),i=this._pyramidBuffers?.temp||new Float32Array(s*e),r=.0625,a=.25,c=.375,l=s-1;for(let u=0;u<e;u++){let h=u*s,f=r+a+c+a+r;i[h]=(t[h]*(r+a+c)+t[h+1]*a+t[h+2]*r)*(1/(r+a+c)),i[h+1]=(t[h]*a+t[h+1]*c+t[h+2]*a+t[h+3]*r)*(1/(a+c+a+r));for(let p=2;p<s-2;p++){let w=h+p;i[w]=t[w-2]*r+t[w-1]*a+t[w]*c+t[w+1]*a+t[w+2]*r}let m=h+s-2,d=h+s-1;i[m]=(t[m-2]*r+t[m-1]*a+t[m]*c+t[d]*a)*(1/(r+a+c+a)),i[d]=(t[d-2]*r+t[d-1]*a+t[d]*(c+a+r))*(1/(r+a+c))}for(let u=0;u<s;u++){n[u]=(i[u]*(r+a+c)+i[u+s]*a+i[u+s*2]*r)*(1/(r+a+c)),n[u+s]=(i[u]*a+i[u+s]*c+i[u+s*2]*a+i[u+s*3]*r)*(1/(a+c+a+r));for(let m=2;m<e-2;m++){let d=m*s+u;n[d]=i[d-s*2]*r+i[d-s]*a+i[d]*c+i[d+s]*a+i[d+s*2]*r}let h=(e-2)*s+u,f=(e-1)*s+u;n[h]=(i[h-s*2]*r+i[h-s]*a+i[h]*c+i[f]*a)*(1/(r+a+c+a)),n[f]=(i[f-s*2]*r+i[f-s]*a+i[f]*(c+a+r))*(1/(r+a+c))}return{data:n,width:s,height:e}}_downsample(t,s,e){let n=s>>1,i=e>>1,r=new Float32Array(n*i);for(let a=0;a<i;a++){let c=a*2*s,l=c+s,u=a*n;for(let h=0;h<n;h++){let f=h*2;r[u+h]=(t[c+f]+t[c+f+1]+t[l+f]+t[l+f+1])*.25}}return{data:r,width:n,height:i}}_buildDogPyramid(t,s=null){let e=[];for(let n=0;n<t.length;n++){if(!t[n]){e.push(null);continue}let i=t[n][0],r=t[n][1],a=i.width,c=i.height,l=new Float32Array(a*c);for(let u=0;u<l.length;u++)l[u]=r.data[u]-i.data[u];e.push({data:l,width:a,height:c})}return e}_findExtremas(t,s){let e=[];for(let n=0;n<t.length;n++){let i=t[n];if(!i)continue;let r=n>0?t[n-1]:null,a=n<t.length-1?t[n+1]:null,c=i.width,l=i.height;for(let u=1;u<l-1;u++)for(let h=1;h<c-1;h++){let f=i.data[u*c+h];if(Math.abs(f)<.003)continue;let m=!0,d=!0;for(let p=-1;p<=1&&(m||d);p++)for(let w=-1;w<=1&&(m||d);w++){if(w===0&&p===0)continue;let g=i.data[(u+p)*c+(h+w)];g>=f&&(m=!1),g<=f&&(d=!1)}if((m||d)&&r){let p=h<<1,w=u<<1,g=r.width;for(let x=-1;x<=1&&(m||d);x++)for(let M=-1;M<=1&&(m||d);M++){let E=Math.max(0,Math.min(g-1,p+M)),I=Math.max(0,Math.min(r.height-1,w+x)),S=r.data[I*g+E];S>=f&&(m=!1),S<=f&&(d=!1)}}if((m||d)&&a){let p=h>>1,w=u>>1,g=a.width;for(let x=-1;x<=1&&(m||d);x++)for(let M=-1;M<=1&&(m||d);M++){let E=Math.max(0,Math.min(g-1,p+M)),I=Math.max(0,Math.min(a.height-1,w+x)),S=a.data[I*g+E];S>=f&&(m=!1),S<=f&&(d=!1)}}(m||d)&&e.push({score:m?Math.abs(f):-Math.abs(f),octave:n,x:h,y:u,absScore:Math.abs(f)})}}return e}_applyPrune(t){let s=jo,e=this.maxFeaturesPerBucket,n=[];for(let r=0;r<s*s;r++)n.push([]);for(let r of t){let a=Math.min(s-1,Math.floor(r.x/(this.width/Math.pow(2,r.octave))*s)),l=Math.min(s-1,Math.floor(r.y/(this.height/Math.pow(2,r.octave))*s))*s+a;l>=0&&l<n.length&&n[l].push(r)}let i=[];for(let r of n){r.sort((a,c)=>c.absScore-a.absScore);for(let a=0;a<Math.min(e,r.length);a++)i.push(r[a])}return i}_computeOrientations(t,s){for(let e of t){if(e.octave<0||e.octave>=s.length){e.angle=0;continue}let n=s[e.octave][1],i=n.width,r=n.height,a=n.data,c=Math.floor(e.x),l=Math.floor(e.y),u=new Float32Array(ne),h=4;for(let m=-h;m<=h;m++)for(let d=-h;d<=h;d++){let p=l+m,w=c+d;if(p<=0||p>=r-1||w<=0||w>=i-1)continue;let g=a[(p+1)*i+w]-a[(p-1)*i+w],x=a[p*i+w+1]-a[p*i+w-1],M=Math.sqrt(x*x+g*g),E=Math.atan2(g,x)+Math.PI,I=Math.floor(E/(2*Math.PI)*ne)%ne,S=Math.exp(-(d*d+m*m)/(2*h*h));u[I]+=M*S}let f=0;for(let m=1;m<ne;m++)u[m]>u[f]&&(f=m);e.angle=(f+.5)*2*Math.PI/ne-Math.PI}}_computeFreakDescriptors(t,s){for(let e of t){if(e.octave<0||e.octave>=s.length){e.descriptors=new Uint8Array(8);continue}let n=s[e.octave][1],i=n.width,r=n.height,a=n.data,c=Math.cos(e.angle||0)*Vn,l=Math.sin(e.angle||0)*Vn,u=new Float32Array(Et.length);for(let h=0;h<Et.length;h++){let[,f,m]=Et[h],d=e.x+f*c-m*l,p=e.y+f*l+m*c,w=Math.max(0,Math.min(i-2,Math.floor(d))),g=Math.max(0,Math.min(r-2,Math.floor(p))),x=w+1,M=g+1,E=d-w,I=p-g;u[h]=a[g*i+w]*(1-E)*(1-I)+a[g*i+x]*E*(1-I)+a[M*i+w]*(1-E)*I+a[M*i+x]*E*I}this.useLSH?(e.lsh=wn(u),e.descriptors=xn(e.lsh)):e.descriptors=yn(u)}}}});function Vo(o,t){return o<t?-1:o>t?1:0}var ie,Wn=W(()=>{ie=class{constructor(t=[],s=Vo){if(this.data=t,this.length=this.data.length,this.compare=s,this.length>0)for(let e=(this.length>>1)-1;e>=0;e--)this._down(e)}push(t){this.data.push(t),this.length++,this._up(this.length-1)}pop(){if(this.length===0)return;let t=this.data[0],s=this.data.pop();return this.length--,this.length>0&&(this.data[0]=s,this._down(0)),t}peek(){return this.data[0]}_up(t){let{data:s,compare:e}=this,n=s[t];for(;t>0;){let i=t-1>>1,r=s[i];if(e(n,r)>=0)break;s[t]=r,t=i}s[t]=n}_down(t){let{data:s,compare:e}=this,n=this.length>>1,i=s[t];for(;t<n;){let r=(t<<1)+1,a=s[r],c=r+1;if(c<this.length&&e(s[c],a)<0&&(r=c,a=s[c]),e(a,i)>=0)break;s[t]=a,t=r}s[t]=i}}});function Vt(o){return o=o>>>0,o-=o>>>1&1431655765,o=(o&858993459)+(o>>>2&858993459),(o+(o>>>4)&252645135)*16843009>>>24}var Hn,As,We,Us=W(()=>{"use strict";Hn=new Uint8Array(256);for(let o=0;o<256;o++){let t=0,s=o;for(;s>0;)s&=s-1,t++;Hn[o]=t}As=(o,t,s,e)=>{let n=(o[t]^s[e])>>>0,i=(o[t+1]^s[e+1])>>>0;n-=n>>>1&1431655765,n=(n&858993459)+(n>>>2&858993459);let r=(n+(n>>>4)&252645135)*16843009>>>24;i-=i>>>1&1431655765,i=(i&858993459)+(i>>>2&858993459);let a=(i+(i>>>4)&252645135)*16843009>>>24;return r+a},We=o=>{let{v1:t,v2:s,v1Offset:e=0,v2Offset:n=0}=o,i=s.length-n;if(i===2)return As(t,e,s,n);if(i===84){let r=0;for(let a=0;a<84;a++)r+=Hn[t[e+a]^s[n+a]];return r}return i===4?Vt(t[e]^s[n])+Vt(t[e+1]^s[n+1])+Vt(t[e+2]^s[n+2])+Vt(t[e+3]^s[n+3]):Vt(t[e]^s[n])+Vt(t[e+1]^s[n+1])}});var Fs,Wo,$n=W(()=>{"use strict";Fs=o=>{let{keywidth:t,keyheight:s,querywidth:e,queryheight:n,matches:i}=o,r=e*1.2,a=-r,c=n*1.2,l=-c,u=12,h=12,f=-2,m=1,p=1/Math.log(10),w=Math.max(t,s),g=Math.floor(t/2),x=Math.floor(s/2),M=[];for(let U=0;U<i.length;U++){let N=i[U].querypoint.scale,L=i[U].keypoint.scale;L==0&&console.log("ERROR divide zero");let j=N/L;M.push(j*w)}M.sort((U,N)=>U-N);let E=M[Math.floor(M.length/2)-(M.length%2==0?1:0)-1],I=Math.max(20,.25*E),S=Math.max(5,Math.min(40,Math.ceil((r-a)/I))),k=Math.max(5,Math.min(40,Math.ceil((c-l)/I))),T=S*k,C=T*u,y=[],b=[],_={};for(let U=0;U<i.length;U++){let N=i[U].querypoint,L=i[U].keypoint,{x:j,y:Y,scale:q,angle:H}=Wo({querypoint:N,keypoint:L,keycenterX:g,keycenterY:x,scaleOneOverLogK:p});if(j<a||j>=r||Y<l||Y>=c||H<=-Math.PI||H>Math.PI||q<f||q>=m){y[U]=!1;continue}let J=S*(j-a)/(r-a),Z=k*(Y-l)/(c-l),Q=u*(H+Math.PI)/(2*Math.PI),et=h*(q-f)/(m-f);b[U]={binX:J,binY:Z,binAngle:Q,binScale:et};let ct=Math.floor(J-.5),nt=Math.floor(Z-.5),st=Math.floor(et-.5),ft=(Math.floor(Q-.5)+u)%u;if(ct<0||ct+1>=S||nt<0||nt+1>=k||st<0||st+1>=h){y[U]=!1;continue}for(let bt=0;bt<2;bt++){let St=ct+bt;for(let Kt=0;Kt<2;Kt++){let be=nt+Kt;for(let jt=0;jt<2;jt++){let ln=(ft+jt)%u;for(let pt=0;pt<2;pt++){let Zi=st+pt,fs=St+be*S+ln*T+Zi*C;_[fs]===void 0&&(_[fs]=0),_[fs]+=1}}}}y[U]=!0}let v=0,D=-1;if(Object.keys(_).forEach(U=>{_[U]>v&&(v=_[U],D=U)}),v<3)return[];let A=Math.floor(D%C%T%S),F=Math.floor((D-A)%C%T/S),O=Math.floor((D-A-F*S)%C/T),B=Math.floor((D-A-F*S-O*T)/C),V=[],P=2;for(let U=0;U<i.length;U++){if(!y[U])continue;let N=b[U];if(Math.abs(N.binX-(A+.5))>=P||Math.abs(N.binY-(F+.5))>=P||Math.abs(N.binScale-(B+.5))>=P)continue;let q=Math.abs(N.binAngle-(O+.5));Math.min(q,u-q)>=P||V.push(i[U])}return V},Wo=({querypoint:o,keypoint:t,keycenterX:s,keycenterY:e,scaleOneOverLogK:n})=>{let i=o.angle-t.angle;i<=-Math.PI?i+=2*Math.PI:i>Math.PI&&(i-=2*Math.PI);let r=o.scale/t.scale,a=r*Math.cos(i),c=r*Math.sin(i),l=[a,-c,c,a],u=[l[0]*t.x+l[1]*t.y,l[2]*t.x+l[3]*t.y],h=o.x-u[0],f=o.y-u[1];return{x:l[0]*s+l[1]*e+h,y:l[2]*s+l[3]*e+f,angle:i,scale:Math.log(r)*n}}});var He,Ps=W(()=>{"use strict";He=()=>({seed:1234,arrayShuffle(t){let{arr:s,sampleSize:e}=t;for(let n=0;n<e;n++){this.seed=(214013*this.seed+2531011)%-2147483648;let i=this.seed>>16&32767;i=i%s.length;let r=s[n];s[n]=s[i],s[i]=r}},nextInt(t){this.seed=(214013*this.seed+2531011)%-2147483648;let s=this.seed>>16&32767;return s=s%t,s}})});var ht,Xn,Yn,Ho,Gn,Xe,Kn,Jn,oe,$e,Ds=W(()=>{"use strict";ht=(o,t,s)=>(t[0]-o[0])*(s[1]-o[1])-(t[1]-o[1])*(s[0]-o[0]),Xn=(o,t,s,e,n,i,r,a)=>!(ht(o,t,s)>0!=ht(n,i,r)>0||ht(t,s,e)>0!=ht(i,r,a)>0||ht(s,e,o)>0!=ht(r,a,n)>0||ht(e,o,t)>0!=ht(a,n,i)>0),Yn=(o,t,s,e,n,i)=>ht(o,t,s)>0==ht(e,n,i)>0,Ho=o=>{let t=o[4]*o[8]-o[5]*o[7],s=o[3]*o[8]-o[5]*o[6],e=o[3]*o[7]-o[4]*o[6];return o[0]*t-o[1]*s+o[2]*e},Gn=(o,t)=>{let s=Ho(o);if(Math.abs(s)<=t)return null;let e=1/s;return[(o[4]*o[8]-o[5]*o[7])*e,(o[2]*o[7]-o[1]*o[8])*e,(o[1]*o[5]-o[2]*o[4])*e,(o[5]*o[6]-o[3]*o[8])*e,(o[0]*o[8]-o[2]*o[6])*e,(o[2]*o[3]-o[0]*o[5])*e,(o[3]*o[7]-o[4]*o[6])*e,(o[1]*o[6]-o[0]*o[7])*e,(o[0]*o[4]-o[1]*o[3])*e]},Xe=(o,t)=>{let s=t[6]*o[0]+t[7]*o[1]+t[8],e=[];return e[0]=(t[0]*o[0]+t[1]*o[1]+t[2])/s,e[1]=(t[3]*o[0]+t[4]*o[1]+t[5])/s,e},Kn=(o,t,s,e)=>{let n=oe(t,o),i=oe(s,o),r=oe(e,o),a=oe(t,s),c=oe(e,s),l=$e(n,i),u=$e(i,r),h=$e(n,r),f=$e(a,c);return Math.min(Math.min(Math.min(l,u),h),f)},Jn=(o,t,s,e)=>{let n=ht(o,t,s)<=0;return!(ht(t,s,e)<=0!==n||ht(s,e,o)<=0!==n||ht(e,o,t)<=0!==n)},oe=(o,t)=>[o[0]-t[0],o[1]-t[1]],$e=(o,t)=>{let s=o[0]*t[1]-o[1]*t[0];return Math.abs(s)*.5}});var re=Jt(Ye=>{"use strict";Object.defineProperty(Ye,"__esModule",{value:!0});Ye.isAnyArray=void 0;var $o=Object.prototype.toString;function Xo(o){let t=$o.call(o);return t.endsWith("Array]")&&!t.includes("Big")}Ye.isAnyArray=Xo});var Qn=Jt((Wc,Zn)=>{"use strict";var Yo=re();function Go(o,t={}){if(!Yo.isAnyArray(o))throw new TypeError("input must be an array");if(o.length===0)throw new TypeError("input must not be empty");let{fromIndex:s=0,toIndex:e=o.length}=t;if(s<0||s>=o.length||!Number.isInteger(s))throw new Error("fromIndex must be a positive integer smaller than length");if(e<=s||e>o.length||!Number.isInteger(e))throw new Error("toIndex must be an integer greater than fromIndex and at most equal to length");let n=o[s];for(let i=s+1;i<e;i++)o[i]>n&&(n=o[i]);return n}Zn.exports=Go});var ei=Jt((Hc,ti)=>{"use strict";var Ko=re();function Jo(o,t={}){if(!Ko.isAnyArray(o))throw new TypeError("input must be an array");if(o.length===0)throw new TypeError("input must not be empty");let{fromIndex:s=0,toIndex:e=o.length}=t;if(s<0||s>=o.length||!Number.isInteger(s))throw new Error("fromIndex must be a positive integer smaller than length");if(e<=s||e>o.length||!Number.isInteger(e))throw new Error("toIndex must be an integer greater than fromIndex and at most equal to length");let n=o[s];for(let i=s+1;i<e;i++)o[i]<n&&(n=o[i]);return n}ti.exports=Jo});var oi=Jt(($c,ii)=>{"use strict";var si=re(),Zo=Qn(),Qo=ei();function ni(o){return o&&typeof o=="object"&&"default"in o?o:{default:o}}var tr=ni(Zo),er=ni(Qo);function sr(o,t={}){if(si.isAnyArray(o)){if(o.length===0)throw new TypeError("input must not be empty")}else throw new TypeError("input must be an array");let s;if(t.output!==void 0){if(!si.isAnyArray(t.output))throw new TypeError("output option must be an array if specified");s=t.output}else s=new Array(o.length);let e=er.default(o),n=tr.default(o);if(e===n)throw new RangeError("minimum and maximum input values are equal. Cannot rescale a constant array");let{min:i=t.autoMinMax?e:0,max:r=t.autoMinMax?n:1}=t;if(i>=r)throw new RangeError("min option must be smaller than max option");let a=(r-i)/(n-e);for(let c=0;c<o.length;c++)s[c]=(o[c]-e)*a+i;return s}ii.exports=sr});var fi=Jt($=>{"use strict";Object.defineProperty($,"__esModule",{value:!0});var ut=re(),ri=oi(),Ge=" ".repeat(2),li=" ".repeat(4);function nr(){return hi(this)}function hi(o,t={}){let{maxRows:s=15,maxColumns:e=10,maxNumSize:n=8,padMinus:i="auto"}=t;return`${o.constructor.name} {
${Ge}[
${li}${ir(o,s,e,n,i)}
${Ge}]
${Ge}rows: ${o.rows}
${Ge}columns: ${o.columns}
}`}function ir(o,t,s,e,n){let{rows:i,columns:r}=o,a=Math.min(i,t),c=Math.min(r,s),l=[];if(n==="auto"){n=!1;t:for(let u=0;u<a;u++)for(let h=0;h<c;h++)if(o.get(u,h)<0){n=!0;break t}}for(let u=0;u<a;u++){let h=[];for(let f=0;f<c;f++)h.push(or(o.get(u,f),e,n));l.push(`${h.join(" ")}`)}return c!==r&&(l[l.length-1]+=` ... ${r-s} more columns`),a!==i&&l.push(`... ${i-t} more rows`),l.join(`
${li}`)}function or(o,t,s){return(o>=0&&s?` ${ai(o,t-1)}`:ai(o,t)).padEnd(t)}function ai(o,t){let s=o.toString();if(s.length<=t)return s;let e=o.toFixed(t);if(e.length>t&&(e=o.toFixed(Math.max(0,t-(e.length-t)))),e.length<=t&&!e.startsWith("0.000")&&!e.startsWith("-0.000"))return e;let n=o.toExponential(t);return n.length>t&&(n=o.toExponential(Math.max(0,t-(n.length-t)))),n.slice(0)}function rr(o,t){o.prototype.add=function(e){return typeof e=="number"?this.addS(e):this.addM(e)},o.prototype.addS=function(e){for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)+e);return this},o.prototype.addM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)+e.get(n,i));return this},o.add=function(e,n){return new t(e).add(n)},o.prototype.sub=function(e){return typeof e=="number"?this.subS(e):this.subM(e)},o.prototype.subS=function(e){for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)-e);return this},o.prototype.subM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)-e.get(n,i));return this},o.sub=function(e,n){return new t(e).sub(n)},o.prototype.subtract=o.prototype.sub,o.prototype.subtractS=o.prototype.subS,o.prototype.subtractM=o.prototype.subM,o.subtract=o.sub,o.prototype.mul=function(e){return typeof e=="number"?this.mulS(e):this.mulM(e)},o.prototype.mulS=function(e){for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)*e);return this},o.prototype.mulM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)*e.get(n,i));return this},o.mul=function(e,n){return new t(e).mul(n)},o.prototype.multiply=o.prototype.mul,o.prototype.multiplyS=o.prototype.mulS,o.prototype.multiplyM=o.prototype.mulM,o.multiply=o.mul,o.prototype.div=function(e){return typeof e=="number"?this.divS(e):this.divM(e)},o.prototype.divS=function(e){for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)/e);return this},o.prototype.divM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)/e.get(n,i));return this},o.div=function(e,n){return new t(e).div(n)},o.prototype.divide=o.prototype.div,o.prototype.divideS=o.prototype.divS,o.prototype.divideM=o.prototype.divM,o.divide=o.div,o.prototype.mod=function(e){return typeof e=="number"?this.modS(e):this.modM(e)},o.prototype.modS=function(e){for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)%e);return this},o.prototype.modM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)%e.get(n,i));return this},o.mod=function(e,n){return new t(e).mod(n)},o.prototype.modulus=o.prototype.mod,o.prototype.modulusS=o.prototype.modS,o.prototype.modulusM=o.prototype.modM,o.modulus=o.mod,o.prototype.and=function(e){return typeof e=="number"?this.andS(e):this.andM(e)},o.prototype.andS=function(e){for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)&e);return this},o.prototype.andM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)&e.get(n,i));return this},o.and=function(e,n){return new t(e).and(n)},o.prototype.or=function(e){return typeof e=="number"?this.orS(e):this.orM(e)},o.prototype.orS=function(e){for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)|e);return this},o.prototype.orM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)|e.get(n,i));return this},o.or=function(e,n){return new t(e).or(n)},o.prototype.xor=function(e){return typeof e=="number"?this.xorS(e):this.xorM(e)},o.prototype.xorS=function(e){for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)^e);return this},o.prototype.xorM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)^e.get(n,i));return this},o.xor=function(e,n){return new t(e).xor(n)},o.prototype.leftShift=function(e){return typeof e=="number"?this.leftShiftS(e):this.leftShiftM(e)},o.prototype.leftShiftS=function(e){for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)<<e);return this},o.prototype.leftShiftM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)<<e.get(n,i));return this},o.leftShift=function(e,n){return new t(e).leftShift(n)},o.prototype.signPropagatingRightShift=function(e){return typeof e=="number"?this.signPropagatingRightShiftS(e):this.signPropagatingRightShiftM(e)},o.prototype.signPropagatingRightShiftS=function(e){for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)>>e);return this},o.prototype.signPropagatingRightShiftM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)>>e.get(n,i));return this},o.signPropagatingRightShift=function(e,n){return new t(e).signPropagatingRightShift(n)},o.prototype.rightShift=function(e){return typeof e=="number"?this.rightShiftS(e):this.rightShiftM(e)},o.prototype.rightShiftS=function(e){for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)>>>e);return this},o.prototype.rightShiftM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)>>>e.get(n,i));return this},o.rightShift=function(e,n){return new t(e).rightShift(n)},o.prototype.zeroFillRightShift=o.prototype.rightShift,o.prototype.zeroFillRightShiftS=o.prototype.rightShiftS,o.prototype.zeroFillRightShiftM=o.prototype.rightShiftM,o.zeroFillRightShift=o.rightShift,o.prototype.not=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,~this.get(e,n));return this},o.not=function(e){return new t(e).not()},o.prototype.abs=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.abs(this.get(e,n)));return this},o.abs=function(e){return new t(e).abs()},o.prototype.acos=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.acos(this.get(e,n)));return this},o.acos=function(e){return new t(e).acos()},o.prototype.acosh=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.acosh(this.get(e,n)));return this},o.acosh=function(e){return new t(e).acosh()},o.prototype.asin=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.asin(this.get(e,n)));return this},o.asin=function(e){return new t(e).asin()},o.prototype.asinh=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.asinh(this.get(e,n)));return this},o.asinh=function(e){return new t(e).asinh()},o.prototype.atan=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.atan(this.get(e,n)));return this},o.atan=function(e){return new t(e).atan()},o.prototype.atanh=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.atanh(this.get(e,n)));return this},o.atanh=function(e){return new t(e).atanh()},o.prototype.cbrt=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.cbrt(this.get(e,n)));return this},o.cbrt=function(e){return new t(e).cbrt()},o.prototype.ceil=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.ceil(this.get(e,n)));return this},o.ceil=function(e){return new t(e).ceil()},o.prototype.clz32=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.clz32(this.get(e,n)));return this},o.clz32=function(e){return new t(e).clz32()},o.prototype.cos=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.cos(this.get(e,n)));return this},o.cos=function(e){return new t(e).cos()},o.prototype.cosh=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.cosh(this.get(e,n)));return this},o.cosh=function(e){return new t(e).cosh()},o.prototype.exp=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.exp(this.get(e,n)));return this},o.exp=function(e){return new t(e).exp()},o.prototype.expm1=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.expm1(this.get(e,n)));return this},o.expm1=function(e){return new t(e).expm1()},o.prototype.floor=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.floor(this.get(e,n)));return this},o.floor=function(e){return new t(e).floor()},o.prototype.fround=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.fround(this.get(e,n)));return this},o.fround=function(e){return new t(e).fround()},o.prototype.log=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.log(this.get(e,n)));return this},o.log=function(e){return new t(e).log()},o.prototype.log1p=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.log1p(this.get(e,n)));return this},o.log1p=function(e){return new t(e).log1p()},o.prototype.log10=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.log10(this.get(e,n)));return this},o.log10=function(e){return new t(e).log10()},o.prototype.log2=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.log2(this.get(e,n)));return this},o.log2=function(e){return new t(e).log2()},o.prototype.round=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.round(this.get(e,n)));return this},o.round=function(e){return new t(e).round()},o.prototype.sign=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.sign(this.get(e,n)));return this},o.sign=function(e){return new t(e).sign()},o.prototype.sin=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.sin(this.get(e,n)));return this},o.sin=function(e){return new t(e).sin()},o.prototype.sinh=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.sinh(this.get(e,n)));return this},o.sinh=function(e){return new t(e).sinh()},o.prototype.sqrt=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.sqrt(this.get(e,n)));return this},o.sqrt=function(e){return new t(e).sqrt()},o.prototype.tan=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.tan(this.get(e,n)));return this},o.tan=function(e){return new t(e).tan()},o.prototype.tanh=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.tanh(this.get(e,n)));return this},o.tanh=function(e){return new t(e).tanh()},o.prototype.trunc=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.trunc(this.get(e,n)));return this},o.trunc=function(e){return new t(e).trunc()},o.pow=function(e,n){return new t(e).pow(n)},o.prototype.pow=function(e){return typeof e=="number"?this.powS(e):this.powM(e)},o.prototype.powS=function(e){for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)**e);return this},o.prototype.powM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)**e.get(n,i));return this}}function dt(o,t,s){let e=s?o.rows:o.rows-1;if(t<0||t>e)throw new RangeError("Row index out of range")}function mt(o,t,s){let e=s?o.columns:o.columns-1;if(t<0||t>e)throw new RangeError("Column index out of range")}function Ht(o,t){if(t.to1DArray&&(t=t.to1DArray()),t.length!==o.columns)throw new RangeError("vector size must be the same as the number of columns");return t}function $t(o,t){if(t.to1DArray&&(t=t.to1DArray()),t.length!==o.rows)throw new RangeError("vector size must be the same as the number of rows");return t}function Hs(o,t){if(!ut.isAnyArray(t))throw new TypeError("row indices must be an array");for(let s=0;s<t.length;s++)if(t[s]<0||t[s]>=o.rows)throw new RangeError("row indices are out of range")}function $s(o,t){if(!ut.isAnyArray(t))throw new TypeError("column indices must be an array");for(let s=0;s<t.length;s++)if(t[s]<0||t[s]>=o.columns)throw new RangeError("column indices are out of range")}function Os(o,t,s,e,n){if(arguments.length!==5)throw new RangeError("expected 4 arguments");if(Ke("startRow",t),Ke("endRow",s),Ke("startColumn",e),Ke("endColumn",n),t>s||e>n||t<0||t>=o.rows||s<0||s>=o.rows||e<0||e>=o.columns||n<0||n>=o.columns)throw new RangeError("Submatrix indices are out of range")}function is(o,t=0){let s=[];for(let e=0;e<o;e++)s.push(t);return s}function Ke(o,t){if(typeof t!="number")throw new TypeError(`${o} must be a number`)}function Wt(o){if(o.isEmpty())throw new Error("Empty matrix has no elements to index")}function ar(o){let t=is(o.rows);for(let s=0;s<o.rows;++s)for(let e=0;e<o.columns;++e)t[s]+=o.get(s,e);return t}function cr(o){let t=is(o.columns);for(let s=0;s<o.rows;++s)for(let e=0;e<o.columns;++e)t[e]+=o.get(s,e);return t}function lr(o){let t=0;for(let s=0;s<o.rows;s++)for(let e=0;e<o.columns;e++)t+=o.get(s,e);return t}function hr(o){let t=is(o.rows,1);for(let s=0;s<o.rows;++s)for(let e=0;e<o.columns;++e)t[s]*=o.get(s,e);return t}function ur(o){let t=is(o.columns,1);for(let s=0;s<o.rows;++s)for(let e=0;e<o.columns;++e)t[e]*=o.get(s,e);return t}function fr(o){let t=1;for(let s=0;s<o.rows;s++)for(let e=0;e<o.columns;e++)t*=o.get(s,e);return t}function dr(o,t,s){let e=o.rows,n=o.columns,i=[];for(let r=0;r<e;r++){let a=0,c=0,l=0;for(let u=0;u<n;u++)l=o.get(r,u)-s[r],a+=l,c+=l*l;t?i.push((c-a*a/n)/(n-1)):i.push((c-a*a/n)/n)}return i}function mr(o,t,s){let e=o.rows,n=o.columns,i=[];for(let r=0;r<n;r++){let a=0,c=0,l=0;for(let u=0;u<e;u++)l=o.get(u,r)-s[r],a+=l,c+=l*l;t?i.push((c-a*a/e)/(e-1)):i.push((c-a*a/e)/e)}return i}function gr(o,t,s){let e=o.rows,n=o.columns,i=e*n,r=0,a=0,c=0;for(let l=0;l<e;l++)for(let u=0;u<n;u++)c=o.get(l,u)-s,r+=c,a+=c*c;return t?(a-r*r/i)/(i-1):(a-r*r/i)/i}function pr(o,t){for(let s=0;s<o.rows;s++)for(let e=0;e<o.columns;e++)o.set(s,e,o.get(s,e)-t[s])}function wr(o,t){for(let s=0;s<o.rows;s++)for(let e=0;e<o.columns;e++)o.set(s,e,o.get(s,e)-t[e])}function yr(o,t){for(let s=0;s<o.rows;s++)for(let e=0;e<o.columns;e++)o.set(s,e,o.get(s,e)-t)}function xr(o){let t=[];for(let s=0;s<o.rows;s++){let e=0;for(let n=0;n<o.columns;n++)e+=o.get(s,n)**2/(o.columns-1);t.push(Math.sqrt(e))}return t}function Mr(o,t){for(let s=0;s<o.rows;s++)for(let e=0;e<o.columns;e++)o.set(s,e,o.get(s,e)/t[s])}function br(o){let t=[];for(let s=0;s<o.columns;s++){let e=0;for(let n=0;n<o.rows;n++)e+=o.get(n,s)**2/(o.rows-1);t.push(Math.sqrt(e))}return t}function Sr(o,t){for(let s=0;s<o.rows;s++)for(let e=0;e<o.columns;e++)o.set(s,e,o.get(s,e)/t[e])}function Er(o){let t=o.size-1,s=0;for(let e=0;e<o.columns;e++)for(let n=0;n<o.rows;n++)s+=o.get(n,e)**2/t;return Math.sqrt(s)}function kr(o,t){for(let s=0;s<o.rows;s++)for(let e=0;e<o.columns;e++)o.set(s,e,o.get(s,e)/t)}var K=class o{static from1DArray(t,s,e){if(t*s!==e.length)throw new RangeError("data length does not match given dimensions");let i=new R(t,s);for(let r=0;r<t;r++)for(let a=0;a<s;a++)i.set(r,a,e[r*s+a]);return i}static rowVector(t){let s=new R(1,t.length);for(let e=0;e<t.length;e++)s.set(0,e,t[e]);return s}static columnVector(t){let s=new R(t.length,1);for(let e=0;e<t.length;e++)s.set(e,0,t[e]);return s}static zeros(t,s){return new R(t,s)}static ones(t,s){return new R(t,s).fill(1)}static rand(t,s,e={}){if(typeof e!="object")throw new TypeError("options must be an object");let{random:n=Math.random}=e,i=new R(t,s);for(let r=0;r<t;r++)for(let a=0;a<s;a++)i.set(r,a,n());return i}static randInt(t,s,e={}){if(typeof e!="object")throw new TypeError("options must be an object");let{min:n=0,max:i=1e3,random:r=Math.random}=e;if(!Number.isInteger(n))throw new TypeError("min must be an integer");if(!Number.isInteger(i))throw new TypeError("max must be an integer");if(n>=i)throw new RangeError("min must be smaller than max");let a=i-n,c=new R(t,s);for(let l=0;l<t;l++)for(let u=0;u<s;u++){let h=n+Math.round(r()*a);c.set(l,u,h)}return c}static eye(t,s,e){s===void 0&&(s=t),e===void 0&&(e=1);let n=Math.min(t,s),i=this.zeros(t,s);for(let r=0;r<n;r++)i.set(r,r,e);return i}static diag(t,s,e){let n=t.length;s===void 0&&(s=n),e===void 0&&(e=s);let i=Math.min(n,s,e),r=this.zeros(s,e);for(let a=0;a<i;a++)r.set(a,a,t[a]);return r}static min(t,s){t=this.checkMatrix(t),s=this.checkMatrix(s);let e=t.rows,n=t.columns,i=new R(e,n);for(let r=0;r<e;r++)for(let a=0;a<n;a++)i.set(r,a,Math.min(t.get(r,a),s.get(r,a)));return i}static max(t,s){t=this.checkMatrix(t),s=this.checkMatrix(s);let e=t.rows,n=t.columns,i=new this(e,n);for(let r=0;r<e;r++)for(let a=0;a<n;a++)i.set(r,a,Math.max(t.get(r,a),s.get(r,a)));return i}static checkMatrix(t){return o.isMatrix(t)?t:new R(t)}static isMatrix(t){return t!=null&&t.klass==="Matrix"}get size(){return this.rows*this.columns}apply(t){if(typeof t!="function")throw new TypeError("callback must be a function");for(let s=0;s<this.rows;s++)for(let e=0;e<this.columns;e++)t.call(this,s,e);return this}to1DArray(){let t=[];for(let s=0;s<this.rows;s++)for(let e=0;e<this.columns;e++)t.push(this.get(s,e));return t}to2DArray(){let t=[];for(let s=0;s<this.rows;s++){t.push([]);for(let e=0;e<this.columns;e++)t[s].push(this.get(s,e))}return t}toJSON(){return this.to2DArray()}isRowVector(){return this.rows===1}isColumnVector(){return this.columns===1}isVector(){return this.rows===1||this.columns===1}isSquare(){return this.rows===this.columns}isEmpty(){return this.rows===0||this.columns===0}isSymmetric(){if(this.isSquare()){for(let t=0;t<this.rows;t++)for(let s=0;s<=t;s++)if(this.get(t,s)!==this.get(s,t))return!1;return!0}return!1}isDistance(){if(!this.isSymmetric())return!1;for(let t=0;t<this.rows;t++)if(this.get(t,t)!==0)return!1;return!0}isEchelonForm(){let t=0,s=0,e=-1,n=!0,i=!1;for(;t<this.rows&&n;){for(s=0,i=!1;s<this.columns&&i===!1;)this.get(t,s)===0?s++:this.get(t,s)===1&&s>e?(i=!0,e=s):(n=!1,i=!0);t++}return n}isReducedEchelonForm(){let t=0,s=0,e=-1,n=!0,i=!1;for(;t<this.rows&&n;){for(s=0,i=!1;s<this.columns&&i===!1;)this.get(t,s)===0?s++:this.get(t,s)===1&&s>e?(i=!0,e=s):(n=!1,i=!0);for(let r=s+1;r<this.rows;r++)this.get(t,r)!==0&&(n=!1);t++}return n}echelonForm(){let t=this.clone(),s=0,e=0;for(;s<t.rows&&e<t.columns;){let n=s;for(let i=s;i<t.rows;i++)t.get(i,e)>t.get(n,e)&&(n=i);if(t.get(n,e)===0)e++;else{t.swapRows(s,n);let i=t.get(s,e);for(let r=e;r<t.columns;r++)t.set(s,r,t.get(s,r)/i);for(let r=s+1;r<t.rows;r++){let a=t.get(r,e)/t.get(s,e);t.set(r,e,0);for(let c=e+1;c<t.columns;c++)t.set(r,c,t.get(r,c)-t.get(s,c)*a)}s++,e++}}return t}reducedEchelonForm(){let t=this.echelonForm(),s=t.columns,e=t.rows,n=e-1;for(;n>=0;)if(t.maxRow(n)===0)n--;else{let i=0,r=!1;for(;i<e&&r===!1;)t.get(n,i)===1?r=!0:i++;for(let a=0;a<n;a++){let c=t.get(a,i);for(let l=i;l<s;l++){let u=t.get(a,l)-c*t.get(n,l);t.set(a,l,u)}}n--}return t}set(){throw new Error("set method is unimplemented")}get(){throw new Error("get method is unimplemented")}repeat(t={}){if(typeof t!="object")throw new TypeError("options must be an object");let{rows:s=1,columns:e=1}=t;if(!Number.isInteger(s)||s<=0)throw new TypeError("rows must be a positive integer");if(!Number.isInteger(e)||e<=0)throw new TypeError("columns must be a positive integer");let n=new R(this.rows*s,this.columns*e);for(let i=0;i<s;i++)for(let r=0;r<e;r++)n.setSubMatrix(this,this.rows*i,this.columns*r);return n}fill(t){for(let s=0;s<this.rows;s++)for(let e=0;e<this.columns;e++)this.set(s,e,t);return this}neg(){return this.mulS(-1)}getRow(t){dt(this,t);let s=[];for(let e=0;e<this.columns;e++)s.push(this.get(t,e));return s}getRowVector(t){return R.rowVector(this.getRow(t))}setRow(t,s){dt(this,t),s=Ht(this,s);for(let e=0;e<this.columns;e++)this.set(t,e,s[e]);return this}swapRows(t,s){dt(this,t),dt(this,s);for(let e=0;e<this.columns;e++){let n=this.get(t,e);this.set(t,e,this.get(s,e)),this.set(s,e,n)}return this}getColumn(t){mt(this,t);let s=[];for(let e=0;e<this.rows;e++)s.push(this.get(e,t));return s}getColumnVector(t){return R.columnVector(this.getColumn(t))}setColumn(t,s){mt(this,t),s=$t(this,s);for(let e=0;e<this.rows;e++)this.set(e,t,s[e]);return this}swapColumns(t,s){mt(this,t),mt(this,s);for(let e=0;e<this.rows;e++){let n=this.get(e,t);this.set(e,t,this.get(e,s)),this.set(e,s,n)}return this}addRowVector(t){t=Ht(this,t);for(let s=0;s<this.rows;s++)for(let e=0;e<this.columns;e++)this.set(s,e,this.get(s,e)+t[e]);return this}subRowVector(t){t=Ht(this,t);for(let s=0;s<this.rows;s++)for(let e=0;e<this.columns;e++)this.set(s,e,this.get(s,e)-t[e]);return this}mulRowVector(t){t=Ht(this,t);for(let s=0;s<this.rows;s++)for(let e=0;e<this.columns;e++)this.set(s,e,this.get(s,e)*t[e]);return this}divRowVector(t){t=Ht(this,t);for(let s=0;s<this.rows;s++)for(let e=0;e<this.columns;e++)this.set(s,e,this.get(s,e)/t[e]);return this}addColumnVector(t){t=$t(this,t);for(let s=0;s<this.rows;s++)for(let e=0;e<this.columns;e++)this.set(s,e,this.get(s,e)+t[s]);return this}subColumnVector(t){t=$t(this,t);for(let s=0;s<this.rows;s++)for(let e=0;e<this.columns;e++)this.set(s,e,this.get(s,e)-t[s]);return this}mulColumnVector(t){t=$t(this,t);for(let s=0;s<this.rows;s++)for(let e=0;e<this.columns;e++)this.set(s,e,this.get(s,e)*t[s]);return this}divColumnVector(t){t=$t(this,t);for(let s=0;s<this.rows;s++)for(let e=0;e<this.columns;e++)this.set(s,e,this.get(s,e)/t[s]);return this}mulRow(t,s){dt(this,t);for(let e=0;e<this.columns;e++)this.set(t,e,this.get(t,e)*s);return this}mulColumn(t,s){mt(this,t);for(let e=0;e<this.rows;e++)this.set(e,t,this.get(e,t)*s);return this}max(t){if(this.isEmpty())return NaN;switch(t){case"row":{let s=new Array(this.rows).fill(Number.NEGATIVE_INFINITY);for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.get(e,n)>s[e]&&(s[e]=this.get(e,n));return s}case"column":{let s=new Array(this.columns).fill(Number.NEGATIVE_INFINITY);for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.get(e,n)>s[n]&&(s[n]=this.get(e,n));return s}case void 0:{let s=this.get(0,0);for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.get(e,n)>s&&(s=this.get(e,n));return s}default:throw new Error(`invalid option: ${t}`)}}maxIndex(){Wt(this);let t=this.get(0,0),s=[0,0];for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.get(e,n)>t&&(t=this.get(e,n),s[0]=e,s[1]=n);return s}min(t){if(this.isEmpty())return NaN;switch(t){case"row":{let s=new Array(this.rows).fill(Number.POSITIVE_INFINITY);for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.get(e,n)<s[e]&&(s[e]=this.get(e,n));return s}case"column":{let s=new Array(this.columns).fill(Number.POSITIVE_INFINITY);for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.get(e,n)<s[n]&&(s[n]=this.get(e,n));return s}case void 0:{let s=this.get(0,0);for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.get(e,n)<s&&(s=this.get(e,n));return s}default:throw new Error(`invalid option: ${t}`)}}minIndex(){Wt(this);let t=this.get(0,0),s=[0,0];for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.get(e,n)<t&&(t=this.get(e,n),s[0]=e,s[1]=n);return s}maxRow(t){if(dt(this,t),this.isEmpty())return NaN;let s=this.get(t,0);for(let e=1;e<this.columns;e++)this.get(t,e)>s&&(s=this.get(t,e));return s}maxRowIndex(t){dt(this,t),Wt(this);let s=this.get(t,0),e=[t,0];for(let n=1;n<this.columns;n++)this.get(t,n)>s&&(s=this.get(t,n),e[1]=n);return e}minRow(t){if(dt(this,t),this.isEmpty())return NaN;let s=this.get(t,0);for(let e=1;e<this.columns;e++)this.get(t,e)<s&&(s=this.get(t,e));return s}minRowIndex(t){dt(this,t),Wt(this);let s=this.get(t,0),e=[t,0];for(let n=1;n<this.columns;n++)this.get(t,n)<s&&(s=this.get(t,n),e[1]=n);return e}maxColumn(t){if(mt(this,t),this.isEmpty())return NaN;let s=this.get(0,t);for(let e=1;e<this.rows;e++)this.get(e,t)>s&&(s=this.get(e,t));return s}maxColumnIndex(t){mt(this,t),Wt(this);let s=this.get(0,t),e=[0,t];for(let n=1;n<this.rows;n++)this.get(n,t)>s&&(s=this.get(n,t),e[0]=n);return e}minColumn(t){if(mt(this,t),this.isEmpty())return NaN;let s=this.get(0,t);for(let e=1;e<this.rows;e++)this.get(e,t)<s&&(s=this.get(e,t));return s}minColumnIndex(t){mt(this,t),Wt(this);let s=this.get(0,t),e=[0,t];for(let n=1;n<this.rows;n++)this.get(n,t)<s&&(s=this.get(n,t),e[0]=n);return e}diag(){let t=Math.min(this.rows,this.columns),s=[];for(let e=0;e<t;e++)s.push(this.get(e,e));return s}norm(t="frobenius"){switch(t){case"max":return this.max();case"frobenius":return Math.sqrt(this.dot(this));default:throw new RangeError(`unknown norm type: ${t}`)}}cumulativeSum(){let t=0;for(let s=0;s<this.rows;s++)for(let e=0;e<this.columns;e++)t+=this.get(s,e),this.set(s,e,t);return this}dot(t){o.isMatrix(t)&&(t=t.to1DArray());let s=this.to1DArray();if(s.length!==t.length)throw new RangeError("vectors do not have the same size");let e=0;for(let n=0;n<s.length;n++)e+=s[n]*t[n];return e}mmul(t){t=R.checkMatrix(t);let s=this.rows,e=this.columns,n=t.columns,i=new R(s,n),r=new Float64Array(e);for(let a=0;a<n;a++){for(let c=0;c<e;c++)r[c]=t.get(c,a);for(let c=0;c<s;c++){let l=0;for(let u=0;u<e;u++)l+=this.get(c,u)*r[u];i.set(c,a,l)}}return i}mpow(t){if(!this.isSquare())throw new RangeError("Matrix must be square");if(!Number.isInteger(t)||t<0)throw new RangeError("Exponent must be a non-negative integer");let s=R.eye(this.rows),e=this;for(let n=t;n>=1;n/=2)(n&1)!==0&&(s=s.mmul(e)),e=e.mmul(e);return s}strassen2x2(t){t=R.checkMatrix(t);let s=new R(2,2),e=this.get(0,0),n=t.get(0,0),i=this.get(0,1),r=t.get(0,1),a=this.get(1,0),c=t.get(1,0),l=this.get(1,1),u=t.get(1,1),h=(e+l)*(n+u),f=(a+l)*n,m=e*(r-u),d=l*(c-n),p=(e+i)*u,w=(a-e)*(n+r),g=(i-l)*(c+u),x=h+d-p+g,M=m+p,E=f+d,I=h-f+m+w;return s.set(0,0,x),s.set(0,1,M),s.set(1,0,E),s.set(1,1,I),s}strassen3x3(t){t=R.checkMatrix(t);let s=new R(3,3),e=this.get(0,0),n=this.get(0,1),i=this.get(0,2),r=this.get(1,0),a=this.get(1,1),c=this.get(1,2),l=this.get(2,0),u=this.get(2,1),h=this.get(2,2),f=t.get(0,0),m=t.get(0,1),d=t.get(0,2),p=t.get(1,0),w=t.get(1,1),g=t.get(1,2),x=t.get(2,0),M=t.get(2,1),E=t.get(2,2),I=(e+n+i-r-a-u-h)*w,S=(e-r)*(-m+w),k=a*(-f+m+p-w-g-x+E),T=(-e+r+a)*(f-m+w),C=(r+a)*(-f+m),y=e*f,b=(-e+l+u)*(f-d+g),_=(-e+l)*(d-g),v=(l+u)*(-f+d),D=(e+n+i-a-c-l-u)*g,A=u*(-f+d+p-w-g-x+M),F=(-i+u+h)*(w+x-M),O=(i-h)*(w-M),B=i*x,V=(u+h)*(-x+M),P=(-i+a+c)*(g+x-E),U=(i-c)*(g-E),N=(a+c)*(-x+E),L=n*p,j=c*M,Y=r*d,q=l*m,H=h*E,J=y+B+L,Z=I+T+C+y+F+B+V,Q=y+b+v+D+B+P+N,et=S+k+T+y+B+P+U,ct=S+T+C+y+j,nt=B+P+U+N+Y,st=y+b+_+A+F+O+B,ft=F+O+B+V+q,bt=y+b+_+v+H;return s.set(0,0,J),s.set(0,1,Z),s.set(0,2,Q),s.set(1,0,et),s.set(1,1,ct),s.set(1,2,nt),s.set(2,0,st),s.set(2,1,ft),s.set(2,2,bt),s}mmulStrassen(t){t=R.checkMatrix(t);let s=this.clone(),e=s.rows,n=s.columns,i=t.rows,r=t.columns;n!==i&&console.warn(`Multiplying ${e} x ${n} and ${i} x ${r} matrix: dimensions do not match.`);function a(h,f,m){let d=h.rows,p=h.columns;if(d===f&&p===m)return h;{let w=o.zeros(f,m);return w=w.setSubMatrix(h,0,0),w}}let c=Math.max(e,i),l=Math.max(n,r);s=a(s,c,l),t=a(t,c,l);function u(h,f,m,d){if(m<=512||d<=512)return h.mmul(f);m%2===1&&d%2===1?(h=a(h,m+1,d+1),f=a(f,m+1,d+1)):m%2===1?(h=a(h,m+1,d),f=a(f,m+1,d)):d%2===1&&(h=a(h,m,d+1),f=a(f,m,d+1));let p=parseInt(h.rows/2,10),w=parseInt(h.columns/2,10),g=h.subMatrix(0,p-1,0,w-1),x=f.subMatrix(0,p-1,0,w-1),M=h.subMatrix(0,p-1,w,h.columns-1),E=f.subMatrix(0,p-1,w,f.columns-1),I=h.subMatrix(p,h.rows-1,0,w-1),S=f.subMatrix(p,f.rows-1,0,w-1),k=h.subMatrix(p,h.rows-1,w,h.columns-1),T=f.subMatrix(p,f.rows-1,w,f.columns-1),C=u(o.add(g,k),o.add(x,T),p,w),y=u(o.add(I,k),x,p,w),b=u(g,o.sub(E,T),p,w),_=u(k,o.sub(S,x),p,w),v=u(o.add(g,M),T,p,w),D=u(o.sub(I,g),o.add(x,E),p,w),A=u(o.sub(M,k),o.add(S,T),p,w),F=o.add(C,_);F.sub(v),F.add(A);let O=o.add(b,v),B=o.add(y,_),V=o.sub(C,y);V.add(b),V.add(D);let P=o.zeros(2*F.rows,2*F.columns);return P=P.setSubMatrix(F,0,0),P=P.setSubMatrix(O,F.rows,0),P=P.setSubMatrix(B,0,F.columns),P=P.setSubMatrix(V,F.rows,F.columns),P.subMatrix(0,m-1,0,d-1)}return u(s,t,c,l)}scaleRows(t={}){if(typeof t!="object")throw new TypeError("options must be an object");let{min:s=0,max:e=1}=t;if(!Number.isFinite(s))throw new TypeError("min must be a number");if(!Number.isFinite(e))throw new TypeError("max must be a number");if(s>=e)throw new RangeError("min must be smaller than max");let n=new R(this.rows,this.columns);for(let i=0;i<this.rows;i++){let r=this.getRow(i);r.length>0&&ri(r,{min:s,max:e,output:r}),n.setRow(i,r)}return n}scaleColumns(t={}){if(typeof t!="object")throw new TypeError("options must be an object");let{min:s=0,max:e=1}=t;if(!Number.isFinite(s))throw new TypeError("min must be a number");if(!Number.isFinite(e))throw new TypeError("max must be a number");if(s>=e)throw new RangeError("min must be smaller than max");let n=new R(this.rows,this.columns);for(let i=0;i<this.columns;i++){let r=this.getColumn(i);r.length&&ri(r,{min:s,max:e,output:r}),n.setColumn(i,r)}return n}flipRows(){let t=Math.ceil(this.columns/2);for(let s=0;s<this.rows;s++)for(let e=0;e<t;e++){let n=this.get(s,e),i=this.get(s,this.columns-1-e);this.set(s,e,i),this.set(s,this.columns-1-e,n)}return this}flipColumns(){let t=Math.ceil(this.rows/2);for(let s=0;s<this.columns;s++)for(let e=0;e<t;e++){let n=this.get(e,s),i=this.get(this.rows-1-e,s);this.set(e,s,i),this.set(this.rows-1-e,s,n)}return this}kroneckerProduct(t){t=R.checkMatrix(t);let s=this.rows,e=this.columns,n=t.rows,i=t.columns,r=new R(s*n,e*i);for(let a=0;a<s;a++)for(let c=0;c<e;c++)for(let l=0;l<n;l++)for(let u=0;u<i;u++)r.set(n*a+l,i*c+u,this.get(a,c)*t.get(l,u));return r}kroneckerSum(t){if(t=R.checkMatrix(t),!this.isSquare()||!t.isSquare())throw new Error("Kronecker Sum needs two Square Matrices");let s=this.rows,e=t.rows,n=this.kroneckerProduct(R.eye(e,e)),i=R.eye(s,s).kroneckerProduct(t);return n.add(i)}transpose(){let t=new R(this.columns,this.rows);for(let s=0;s<this.rows;s++)for(let e=0;e<this.columns;e++)t.set(e,s,this.get(s,e));return t}sortRows(t=ci){for(let s=0;s<this.rows;s++)this.setRow(s,this.getRow(s).sort(t));return this}sortColumns(t=ci){for(let s=0;s<this.columns;s++)this.setColumn(s,this.getColumn(s).sort(t));return this}subMatrix(t,s,e,n){Os(this,t,s,e,n);let i=new R(s-t+1,n-e+1);for(let r=t;r<=s;r++)for(let a=e;a<=n;a++)i.set(r-t,a-e,this.get(r,a));return i}subMatrixRow(t,s,e){if(s===void 0&&(s=0),e===void 0&&(e=this.columns-1),s>e||s<0||s>=this.columns||e<0||e>=this.columns)throw new RangeError("Argument out of range");let n=new R(t.length,e-s+1);for(let i=0;i<t.length;i++)for(let r=s;r<=e;r++){if(t[i]<0||t[i]>=this.rows)throw new RangeError(`Row index out of range: ${t[i]}`);n.set(i,r-s,this.get(t[i],r))}return n}subMatrixColumn(t,s,e){if(s===void 0&&(s=0),e===void 0&&(e=this.rows-1),s>e||s<0||s>=this.rows||e<0||e>=this.rows)throw new RangeError("Argument out of range");let n=new R(e-s+1,t.length);for(let i=0;i<t.length;i++)for(let r=s;r<=e;r++){if(t[i]<0||t[i]>=this.columns)throw new RangeError(`Column index out of range: ${t[i]}`);n.set(r-s,i,this.get(r,t[i]))}return n}setSubMatrix(t,s,e){if(t=R.checkMatrix(t),t.isEmpty())return this;let n=s+t.rows-1,i=e+t.columns-1;Os(this,s,n,e,i);for(let r=0;r<t.rows;r++)for(let a=0;a<t.columns;a++)this.set(s+r,e+a,t.get(r,a));return this}selection(t,s){Hs(this,t),$s(this,s);let e=new R(t.length,s.length);for(let n=0;n<t.length;n++){let i=t[n];for(let r=0;r<s.length;r++){let a=s[r];e.set(n,r,this.get(i,a))}}return e}trace(){let t=Math.min(this.rows,this.columns),s=0;for(let e=0;e<t;e++)s+=this.get(e,e);return s}clone(){return this.constructor.copy(this,new R(this.rows,this.columns))}static copy(t,s){for(let[e,n,i]of t.entries())s.set(e,n,i);return s}sum(t){switch(t){case"row":return ar(this);case"column":return cr(this);case void 0:return lr(this);default:throw new Error(`invalid option: ${t}`)}}product(t){switch(t){case"row":return hr(this);case"column":return ur(this);case void 0:return fr(this);default:throw new Error(`invalid option: ${t}`)}}mean(t){let s=this.sum(t);switch(t){case"row":{for(let e=0;e<this.rows;e++)s[e]/=this.columns;return s}case"column":{for(let e=0;e<this.columns;e++)s[e]/=this.rows;return s}case void 0:return s/this.size;default:throw new Error(`invalid option: ${t}`)}}variance(t,s={}){if(typeof t=="object"&&(s=t,t=void 0),typeof s!="object")throw new TypeError("options must be an object");let{unbiased:e=!0,mean:n=this.mean(t)}=s;if(typeof e!="boolean")throw new TypeError("unbiased must be a boolean");switch(t){case"row":{if(!ut.isAnyArray(n))throw new TypeError("mean must be an array");return dr(this,e,n)}case"column":{if(!ut.isAnyArray(n))throw new TypeError("mean must be an array");return mr(this,e,n)}case void 0:{if(typeof n!="number")throw new TypeError("mean must be a number");return gr(this,e,n)}default:throw new Error(`invalid option: ${t}`)}}standardDeviation(t,s){typeof t=="object"&&(s=t,t=void 0);let e=this.variance(t,s);if(t===void 0)return Math.sqrt(e);for(let n=0;n<e.length;n++)e[n]=Math.sqrt(e[n]);return e}center(t,s={}){if(typeof t=="object"&&(s=t,t=void 0),typeof s!="object")throw new TypeError("options must be an object");let{center:e=this.mean(t)}=s;switch(t){case"row":{if(!ut.isAnyArray(e))throw new TypeError("center must be an array");return pr(this,e),this}case"column":{if(!ut.isAnyArray(e))throw new TypeError("center must be an array");return wr(this,e),this}case void 0:{if(typeof e!="number")throw new TypeError("center must be a number");return yr(this,e),this}default:throw new Error(`invalid option: ${t}`)}}scale(t,s={}){if(typeof t=="object"&&(s=t,t=void 0),typeof s!="object")throw new TypeError("options must be an object");let e=s.scale;switch(t){case"row":{if(e===void 0)e=xr(this);else if(!ut.isAnyArray(e))throw new TypeError("scale must be an array");return Mr(this,e),this}case"column":{if(e===void 0)e=br(this);else if(!ut.isAnyArray(e))throw new TypeError("scale must be an array");return Sr(this,e),this}case void 0:{if(e===void 0)e=Er(this);else if(typeof e!="number")throw new TypeError("scale must be a number");return kr(this,e),this}default:throw new Error(`invalid option: ${t}`)}}toString(t){return hi(this,t)}[Symbol.iterator](){return this.entries()}*entries(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)yield[t,s,this.get(t,s)]}*values(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)yield this.get(t,s)}};K.prototype.klass="Matrix";typeof Symbol<"u"&&(K.prototype[Symbol.for("nodejs.util.inspect.custom")]=nr);function ci(o,t){return o-t}function Ir(o){return o.every(t=>typeof t=="number")}K.random=K.rand;K.randomInt=K.randInt;K.diagonal=K.diag;K.prototype.diagonal=K.prototype.diag;K.identity=K.eye;K.prototype.negate=K.prototype.neg;K.prototype.tensorProduct=K.prototype.kroneckerProduct;var R=class o extends K{data;#t(t,s){if(this.data=[],Number.isInteger(s)&&s>=0)for(let e=0;e<t;e++)this.data.push(new Float64Array(s));else throw new TypeError("nColumns must be a positive integer");this.rows=t,this.columns=s}constructor(t,s){if(super(),o.isMatrix(t))this.#t(t.rows,t.columns),o.copy(t,this);else if(Number.isInteger(t)&&t>=0)this.#t(t,s);else if(ut.isAnyArray(t)){let e=t;if(t=e.length,s=t?e[0].length:0,typeof s!="number")throw new TypeError("Data must be a 2D array with at least one element");this.data=[];for(let n=0;n<t;n++){if(e[n].length!==s)throw new RangeError("Inconsistent array dimensions");if(!Ir(e[n]))throw new TypeError("Input data contains non-numeric values");this.data.push(Float64Array.from(e[n]))}this.rows=t,this.columns=s}else throw new TypeError("First argument must be a positive number or an array")}set(t,s,e){return this.data[t][s]=e,this}get(t,s){return this.data[t][s]}removeRow(t){return dt(this,t),this.data.splice(t,1),this.rows-=1,this}addRow(t,s){return s===void 0&&(s=t,t=this.rows),dt(this,t,!0),s=Float64Array.from(Ht(this,s)),this.data.splice(t,0,s),this.rows+=1,this}removeColumn(t){mt(this,t);for(let s=0;s<this.rows;s++){let e=new Float64Array(this.columns-1);for(let n=0;n<t;n++)e[n]=this.data[s][n];for(let n=t+1;n<this.columns;n++)e[n-1]=this.data[s][n];this.data[s]=e}return this.columns-=1,this}addColumn(t,s){typeof s>"u"&&(s=t,t=this.columns),mt(this,t,!0),s=$t(this,s);for(let e=0;e<this.rows;e++){let n=new Float64Array(this.columns+1),i=0;for(;i<t;i++)n[i]=this.data[e][i];for(n[i++]=s[e];i<this.columns+1;i++)n[i]=this.data[e][i-1];this.data[e]=n}return this.columns+=1,this}};rr(K,R);var Ot=class o extends K{#t;get size(){return this.#t.size}get rows(){return this.#t.rows}get columns(){return this.#t.columns}get diagonalSize(){return this.rows}static isSymmetricMatrix(t){return R.isMatrix(t)&&t.klassType==="SymmetricMatrix"}static zeros(t){return new this(t)}static ones(t){return new this(t).fill(1)}constructor(t){if(super(),R.isMatrix(t)){if(!t.isSymmetric())throw new TypeError("not symmetric data");this.#t=R.copy(t,new R(t.rows,t.rows))}else if(Number.isInteger(t)&&t>=0)this.#t=new R(t,t);else if(this.#t=new R(t),!this.isSymmetric())throw new TypeError("not symmetric data")}clone(){let t=new o(this.diagonalSize);for(let[s,e,n]of this.upperRightEntries())t.set(s,e,n);return t}toMatrix(){return new R(this)}get(t,s){return this.#t.get(t,s)}set(t,s,e){return this.#t.set(t,s,e),this.#t.set(s,t,e),this}removeCross(t){return this.#t.removeRow(t),this.#t.removeColumn(t),this}addCross(t,s){s===void 0&&(s=t,t=this.diagonalSize);let e=s.slice();return e.splice(t,1),this.#t.addRow(t,e),this.#t.addColumn(t,s),this}applyMask(t){if(t.length!==this.diagonalSize)throw new RangeError("Mask size do not match with matrix size");let s=[];for(let[e,n]of t.entries())n||s.push(e);s.reverse();for(let e of s)this.removeCross(e);return this}toCompact(){let{diagonalSize:t}=this,s=new Array(t*(t+1)/2);for(let e=0,n=0,i=0;i<s.length;i++)s[i]=this.get(n,e),++e>=t&&(e=++n);return s}static fromCompact(t){let s=t.length,e=(Math.sqrt(8*s+1)-1)/2;if(!Number.isInteger(e))throw new TypeError(`This array is not a compact representation of a Symmetric Matrix, ${JSON.stringify(t)}`);let n=new o(e);for(let i=0,r=0,a=0;a<s;a++)n.set(i,r,t[a]),++i>=e&&(i=++r);return n}*upperRightEntries(){for(let t=0,s=0;t<this.diagonalSize;void 0){let e=this.get(t,s);yield[t,s,e],++s>=this.diagonalSize&&(s=++t)}}*upperRightValues(){for(let t=0,s=0;t<this.diagonalSize;void 0)yield this.get(t,s),++s>=this.diagonalSize&&(s=++t)}};Ot.prototype.klassType="SymmetricMatrix";var Qe=class o extends Ot{static isDistanceMatrix(t){return Ot.isSymmetricMatrix(t)&&t.klassSubType==="DistanceMatrix"}constructor(t){if(super(t),!this.isDistance())throw new TypeError("Provided arguments do no produce a distance matrix")}set(t,s,e){return t===s&&(e=0),super.set(t,s,e)}addCross(t,s){return s===void 0&&(s=t,t=this.diagonalSize),s=s.slice(),s[t]=0,super.addCross(t,s)}toSymmetricMatrix(){return new Ot(this)}clone(){let t=new o(this.diagonalSize);for(let[s,e,n]of this.upperRightEntries())s!==e&&t.set(s,e,n);return t}toCompact(){let{diagonalSize:t}=this,s=(t-1)*t/2,e=new Array(s);for(let n=1,i=0,r=0;r<e.length;r++)e[r]=this.get(i,n),++n>=t&&(n=++i+1);return e}static fromCompact(t){let s=t.length;if(s===0)return new this(0);let e=(Math.sqrt(8*s+1)+1)/2;if(!Number.isInteger(e))throw new TypeError(`This array is not a compact representation of a DistanceMatrix, ${JSON.stringify(t)}`);let n=new this(e);for(let i=1,r=0,a=0;a<s;a++)n.set(i,r,t[a]),++i>=e&&(i=++r+1);return n}};Qe.prototype.klassSubType="DistanceMatrix";var wt=class extends K{constructor(t,s,e){super(),this.matrix=t,this.rows=s,this.columns=e}},Ls=class extends wt{constructor(t,s){mt(t,s),super(t,t.rows,1),this.column=s}set(t,s,e){return this.matrix.set(t,this.column,e),this}get(t){return this.matrix.get(t,this.column)}},Ns=class extends wt{constructor(t,s){$s(t,s),super(t,t.rows,s.length),this.columnIndices=s}set(t,s,e){return this.matrix.set(t,this.columnIndices[s],e),this}get(t,s){return this.matrix.get(t,this.columnIndices[s])}},Bs=class extends wt{constructor(t){super(t,t.rows,t.columns)}set(t,s,e){return this.matrix.set(t,this.columns-s-1,e),this}get(t,s){return this.matrix.get(t,this.columns-s-1)}},js=class extends wt{constructor(t){super(t,t.rows,t.columns)}set(t,s,e){return this.matrix.set(this.rows-t-1,s,e),this}get(t,s){return this.matrix.get(this.rows-t-1,s)}},zs=class extends wt{constructor(t,s){dt(t,s),super(t,1,t.columns),this.row=s}set(t,s,e){return this.matrix.set(this.row,s,e),this}get(t,s){return this.matrix.get(this.row,s)}},qs=class extends wt{constructor(t,s){Hs(t,s),super(t,s.length,t.columns),this.rowIndices=s}set(t,s,e){return this.matrix.set(this.rowIndices[t],s,e),this}get(t,s){return this.matrix.get(this.rowIndices[t],s)}},Xt=class extends wt{constructor(t,s,e){Hs(t,s),$s(t,e),super(t,s.length,e.length),this.rowIndices=s,this.columnIndices=e}set(t,s,e){return this.matrix.set(this.rowIndices[t],this.columnIndices[s],e),this}get(t,s){return this.matrix.get(this.rowIndices[t],this.columnIndices[s])}},Vs=class extends wt{constructor(t,s,e,n,i){Os(t,s,e,n,i),super(t,e-s+1,i-n+1),this.startRow=s,this.startColumn=n}set(t,s,e){return this.matrix.set(this.startRow+t,this.startColumn+s,e),this}get(t,s){return this.matrix.get(this.startRow+t,this.startColumn+s)}},Ws=class extends wt{constructor(t){super(t,t.columns,t.rows)}set(t,s,e){return this.matrix.set(s,t,e),this}get(t,s){return this.matrix.get(s,t)}},ts=class extends K{constructor(t,s={}){let{rows:e=1}=s;if(t.length%e!==0)throw new Error("the data length is not divisible by the number of rows");super(),this.rows=e,this.columns=t.length/e,this.data=t}set(t,s,e){let n=this._calculateIndex(t,s);return this.data[n]=e,this}get(t,s){let e=this._calculateIndex(t,s);return this.data[e]}_calculateIndex(t,s){return t*this.columns+s}},it=class extends K{constructor(t){super(),this.data=t,this.rows=t.length,this.columns=t[0].length}set(t,s,e){return this.data[t][s]=e,this}get(t,s){return this.data[t][s]}};function vr(o,t){if(ut.isAnyArray(o))return o[0]&&ut.isAnyArray(o[0])?new it(o):new ts(o,t);throw new Error("the argument is not an array")}var Yt=class{constructor(t){t=it.checkMatrix(t);let s=t.clone(),e=s.rows,n=s.columns,i=new Float64Array(e),r=1,a,c,l,u,h,f,m,d,p;for(a=0;a<e;a++)i[a]=a;for(d=new Float64Array(e),c=0;c<n;c++){for(a=0;a<e;a++)d[a]=s.get(a,c);for(a=0;a<e;a++){for(p=Math.min(a,c),h=0,l=0;l<p;l++)h+=s.get(a,l)*d[l];d[a]-=h,s.set(a,c,d[a])}for(u=c,a=c+1;a<e;a++)Math.abs(d[a])>Math.abs(d[u])&&(u=a);if(u!==c){for(l=0;l<n;l++)f=s.get(u,l),s.set(u,l,s.get(c,l)),s.set(c,l,f);m=i[u],i[u]=i[c],i[c]=m,r=-r}if(c<e&&s.get(c,c)!==0)for(a=c+1;a<e;a++)s.set(a,c,s.get(a,c)/s.get(c,c))}this.LU=s,this.pivotVector=i,this.pivotSign=r}isSingular(){let t=this.LU,s=t.columns;for(let e=0;e<s;e++)if(t.get(e,e)===0)return!0;return!1}solve(t){t=R.checkMatrix(t);let s=this.LU;if(s.rows!==t.rows)throw new Error("Invalid matrix dimensions");if(this.isSingular())throw new Error("LU matrix is singular");let n=t.columns,i=t.subMatrixRow(this.pivotVector,0,n-1),r=s.columns,a,c,l;for(l=0;l<r;l++)for(a=l+1;a<r;a++)for(c=0;c<n;c++)i.set(a,c,i.get(a,c)-i.get(l,c)*s.get(a,l));for(l=r-1;l>=0;l--){for(c=0;c<n;c++)i.set(l,c,i.get(l,c)/s.get(l,l));for(a=0;a<l;a++)for(c=0;c<n;c++)i.set(a,c,i.get(a,c)-i.get(l,c)*s.get(a,l))}return i}get determinant(){let t=this.LU;if(!t.isSquare())throw new Error("Matrix must be square");let s=this.pivotSign,e=t.columns;for(let n=0;n<e;n++)s*=t.get(n,n);return s}get lowerTriangularMatrix(){let t=this.LU,s=t.rows,e=t.columns,n=new R(s,e);for(let i=0;i<s;i++)for(let r=0;r<e;r++)i>r?n.set(i,r,t.get(i,r)):i===r?n.set(i,r,1):n.set(i,r,0);return n}get upperTriangularMatrix(){let t=this.LU,s=t.rows,e=t.columns,n=new R(s,e);for(let i=0;i<s;i++)for(let r=0;r<e;r++)i<=r?n.set(i,r,t.get(i,r)):n.set(i,r,0);return n}get pivotPermutationVector(){return Array.from(this.pivotVector)}};function kt(o,t){let s=0;return Math.abs(o)>Math.abs(t)?(s=t/o,Math.abs(o)*Math.sqrt(1+s*s)):t!==0?(s=o/t,Math.abs(t)*Math.sqrt(1+s*s)):0}var ae=class{constructor(t){t=it.checkMatrix(t);let s=t.clone(),e=t.rows,n=t.columns,i=new Float64Array(n),r,a,c,l;for(c=0;c<n;c++){let u=0;for(r=c;r<e;r++)u=kt(u,s.get(r,c));if(u!==0){for(s.get(c,c)<0&&(u=-u),r=c;r<e;r++)s.set(r,c,s.get(r,c)/u);for(s.set(c,c,s.get(c,c)+1),a=c+1;a<n;a++){for(l=0,r=c;r<e;r++)l+=s.get(r,c)*s.get(r,a);for(l=-l/s.get(c,c),r=c;r<e;r++)s.set(r,a,s.get(r,a)+l*s.get(r,c))}}i[c]=-u}this.QR=s,this.Rdiag=i}solve(t){t=R.checkMatrix(t);let s=this.QR,e=s.rows;if(t.rows!==e)throw new Error("Matrix row dimensions must agree");if(!this.isFullRank())throw new Error("Matrix is rank deficient");let n=t.columns,i=t.clone(),r=s.columns,a,c,l,u;for(l=0;l<r;l++)for(c=0;c<n;c++){for(u=0,a=l;a<e;a++)u+=s.get(a,l)*i.get(a,c);for(u=-u/s.get(l,l),a=l;a<e;a++)i.set(a,c,i.get(a,c)+u*s.get(a,l))}for(l=r-1;l>=0;l--){for(c=0;c<n;c++)i.set(l,c,i.get(l,c)/this.Rdiag[l]);for(a=0;a<l;a++)for(c=0;c<n;c++)i.set(a,c,i.get(a,c)-i.get(l,c)*s.get(a,l))}return i.subMatrix(0,r-1,0,n-1)}isFullRank(){let t=this.QR.columns;for(let s=0;s<t;s++)if(this.Rdiag[s]===0)return!1;return!0}get upperTriangularMatrix(){let t=this.QR,s=t.columns,e=new R(s,s),n,i;for(n=0;n<s;n++)for(i=0;i<s;i++)n<i?e.set(n,i,t.get(n,i)):n===i?e.set(n,i,this.Rdiag[n]):e.set(n,i,0);return e}get orthogonalMatrix(){let t=this.QR,s=t.rows,e=t.columns,n=new R(s,e),i,r,a,c;for(a=e-1;a>=0;a--){for(i=0;i<s;i++)n.set(i,a,0);for(n.set(a,a,1),r=a;r<e;r++)if(t.get(a,a)!==0){for(c=0,i=a;i<s;i++)c+=t.get(i,a)*n.get(i,r);for(c=-c/t.get(a,a),i=a;i<s;i++)n.set(i,r,n.get(i,r)+c*t.get(i,a))}}return n}},_t=class{constructor(t,s={}){if(t=it.checkMatrix(t),t.isEmpty())throw new Error("Matrix must be non-empty");let e=t.rows,n=t.columns,{computeLeftSingularVectors:i=!0,computeRightSingularVectors:r=!0,autoTranspose:a=!1}=s,c=!!i,l=!!r,u=!1,h;if(e<n)if(!a)h=t.clone(),console.warn("Computing SVD on a matrix with more columns than rows. Consider enabling autoTranspose");else{h=t.transpose(),e=h.rows,n=h.columns,u=!0;let y=c;c=l,l=y}else h=t.clone();let f=Math.min(e,n),m=Math.min(e+1,n),d=new Float64Array(m),p=new R(e,f),w=new R(n,n),g=new Float64Array(n),x=new Float64Array(e),M=new Float64Array(m);for(let y=0;y<m;y++)M[y]=y;let E=Math.min(e-1,n),I=Math.max(0,Math.min(n-2,e)),S=Math.max(E,I);for(let y=0;y<S;y++){if(y<E){d[y]=0;for(let b=y;b<e;b++)d[y]=kt(d[y],h.get(b,y));if(d[y]!==0){h.get(y,y)<0&&(d[y]=-d[y]);for(let b=y;b<e;b++)h.set(b,y,h.get(b,y)/d[y]);h.set(y,y,h.get(y,y)+1)}d[y]=-d[y]}for(let b=y+1;b<n;b++){if(y<E&&d[y]!==0){let _=0;for(let v=y;v<e;v++)_+=h.get(v,y)*h.get(v,b);_=-_/h.get(y,y);for(let v=y;v<e;v++)h.set(v,b,h.get(v,b)+_*h.get(v,y))}g[b]=h.get(y,b)}if(c&&y<E)for(let b=y;b<e;b++)p.set(b,y,h.get(b,y));if(y<I){g[y]=0;for(let b=y+1;b<n;b++)g[y]=kt(g[y],g[b]);if(g[y]!==0){g[y+1]<0&&(g[y]=0-g[y]);for(let b=y+1;b<n;b++)g[b]/=g[y];g[y+1]+=1}if(g[y]=-g[y],y+1<e&&g[y]!==0){for(let b=y+1;b<e;b++)x[b]=0;for(let b=y+1;b<e;b++)for(let _=y+1;_<n;_++)x[b]+=g[_]*h.get(b,_);for(let b=y+1;b<n;b++){let _=-g[b]/g[y+1];for(let v=y+1;v<e;v++)h.set(v,b,h.get(v,b)+_*x[v])}}if(l)for(let b=y+1;b<n;b++)w.set(b,y,g[b])}}let k=Math.min(n,e+1);if(E<n&&(d[E]=h.get(E,E)),e<k&&(d[k-1]=0),I+1<k&&(g[I]=h.get(I,k-1)),g[k-1]=0,c){for(let y=E;y<f;y++){for(let b=0;b<e;b++)p.set(b,y,0);p.set(y,y,1)}for(let y=E-1;y>=0;y--)if(d[y]!==0){for(let b=y+1;b<f;b++){let _=0;for(let v=y;v<e;v++)_+=p.get(v,y)*p.get(v,b);_=-_/p.get(y,y);for(let v=y;v<e;v++)p.set(v,b,p.get(v,b)+_*p.get(v,y))}for(let b=y;b<e;b++)p.set(b,y,-p.get(b,y));p.set(y,y,1+p.get(y,y));for(let b=0;b<y-1;b++)p.set(b,y,0)}else{for(let b=0;b<e;b++)p.set(b,y,0);p.set(y,y,1)}}if(l)for(let y=n-1;y>=0;y--){if(y<I&&g[y]!==0)for(let b=y+1;b<n;b++){let _=0;for(let v=y+1;v<n;v++)_+=w.get(v,y)*w.get(v,b);_=-_/w.get(y+1,y);for(let v=y+1;v<n;v++)w.set(v,b,w.get(v,b)+_*w.get(v,y))}for(let b=0;b<n;b++)w.set(b,y,0);w.set(y,y,1)}let T=k-1,C=Number.EPSILON;for(;k>0;){let y,b;for(y=k-2;y>=-1&&y!==-1;y--){let _=Number.MIN_VALUE+C*Math.abs(d[y]+Math.abs(d[y+1]));if(Math.abs(g[y])<=_||Number.isNaN(g[y])){g[y]=0;break}}if(y===k-2)b=4;else{let _;for(_=k-1;_>=y&&_!==y;_--){let v=(_!==k?Math.abs(g[_]):0)+(_!==y+1?Math.abs(g[_-1]):0);if(Math.abs(d[_])<=C*v){d[_]=0;break}}_===y?b=3:_===k-1?b=1:(b=2,y=_)}switch(y++,b){case 1:{let _=g[k-2];g[k-2]=0;for(let v=k-2;v>=y;v--){let D=kt(d[v],_),A=d[v]/D,F=_/D;if(d[v]=D,v!==y&&(_=-F*g[v-1],g[v-1]=A*g[v-1]),l)for(let O=0;O<n;O++)D=A*w.get(O,v)+F*w.get(O,k-1),w.set(O,k-1,-F*w.get(O,v)+A*w.get(O,k-1)),w.set(O,v,D)}break}case 2:{let _=g[y-1];g[y-1]=0;for(let v=y;v<k;v++){let D=kt(d[v],_),A=d[v]/D,F=_/D;if(d[v]=D,_=-F*g[v],g[v]=A*g[v],c)for(let O=0;O<e;O++)D=A*p.get(O,v)+F*p.get(O,y-1),p.set(O,y-1,-F*p.get(O,v)+A*p.get(O,y-1)),p.set(O,v,D)}break}case 3:{let _=Math.max(Math.abs(d[k-1]),Math.abs(d[k-2]),Math.abs(g[k-2]),Math.abs(d[y]),Math.abs(g[y])),v=d[k-1]/_,D=d[k-2]/_,A=g[k-2]/_,F=d[y]/_,O=g[y]/_,B=((D+v)*(D-v)+A*A)/2,V=v*A*(v*A),P=0;(B!==0||V!==0)&&(B<0?P=0-Math.sqrt(B*B+V):P=Math.sqrt(B*B+V),P=V/(B+P));let U=(F+v)*(F-v)+P,N=F*O;for(let L=y;L<k-1;L++){let j=kt(U,N);j===0&&(j=Number.MIN_VALUE);let Y=U/j,q=N/j;if(L!==y&&(g[L-1]=j),U=Y*d[L]+q*g[L],g[L]=Y*g[L]-q*d[L],N=q*d[L+1],d[L+1]=Y*d[L+1],l)for(let H=0;H<n;H++)j=Y*w.get(H,L)+q*w.get(H,L+1),w.set(H,L+1,-q*w.get(H,L)+Y*w.get(H,L+1)),w.set(H,L,j);if(j=kt(U,N),j===0&&(j=Number.MIN_VALUE),Y=U/j,q=N/j,d[L]=j,U=Y*g[L]+q*d[L+1],d[L+1]=-q*g[L]+Y*d[L+1],N=q*g[L+1],g[L+1]=Y*g[L+1],c&&L<e-1)for(let H=0;H<e;H++)j=Y*p.get(H,L)+q*p.get(H,L+1),p.set(H,L+1,-q*p.get(H,L)+Y*p.get(H,L+1)),p.set(H,L,j)}g[k-2]=U;break}case 4:{if(d[y]<=0&&(d[y]=d[y]<0?-d[y]:0,l))for(let _=0;_<=T;_++)w.set(_,y,-w.get(_,y));for(;y<T&&!(d[y]>=d[y+1]);){let _=d[y];if(d[y]=d[y+1],d[y+1]=_,l&&y<n-1)for(let v=0;v<n;v++)_=w.get(v,y+1),w.set(v,y+1,w.get(v,y)),w.set(v,y,_);if(c&&y<e-1)for(let v=0;v<e;v++)_=p.get(v,y+1),p.set(v,y+1,p.get(v,y)),p.set(v,y,_);y++}k--;break}}}if(u){let y=w;w=p,p=y}this.m=e,this.n=n,this.s=d,this.U=p,this.V=w}solve(t){let s=t,e=this.threshold,n=this.s.length,i=R.zeros(n,n);for(let f=0;f<n;f++)Math.abs(this.s[f])<=e?i.set(f,f,0):i.set(f,f,1/this.s[f]);let r=this.U,a=this.rightSingularVectors,c=a.mmul(i),l=a.rows,u=r.rows,h=R.zeros(l,u);for(let f=0;f<l;f++)for(let m=0;m<u;m++){let d=0;for(let p=0;p<n;p++)d+=c.get(f,p)*r.get(m,p);h.set(f,m,d)}return h.mmul(s)}solveForDiagonal(t){return this.solve(R.diag(t))}inverse(){let t=this.V,s=this.threshold,e=t.rows,n=t.columns,i=new R(e,this.s.length);for(let u=0;u<e;u++)for(let h=0;h<n;h++)Math.abs(this.s[h])>s&&i.set(u,h,t.get(u,h)/this.s[h]);let r=this.U,a=r.rows,c=r.columns,l=new R(e,a);for(let u=0;u<e;u++)for(let h=0;h<a;h++){let f=0;for(let m=0;m<c;m++)f+=i.get(u,m)*r.get(h,m);l.set(u,h,f)}return l}get condition(){return this.s[0]/this.s[Math.min(this.m,this.n)-1]}get norm2(){return this.s[0]}get rank(){let t=Math.max(this.m,this.n)*this.s[0]*Number.EPSILON,s=0,e=this.s;for(let n=0,i=e.length;n<i;n++)e[n]>t&&s++;return s}get diagonal(){return Array.from(this.s)}get threshold(){return Number.EPSILON/2*Math.max(this.m,this.n)*this.s[0]}get leftSingularVectors(){return this.U}get rightSingularVectors(){return this.V}get diagonalMatrix(){return R.diag(this.s)}};function Tr(o,t=!1){return o=it.checkMatrix(o),t?new _t(o).inverse():ui(o,R.eye(o.rows))}function ui(o,t,s=!1){return o=it.checkMatrix(o),t=it.checkMatrix(t),s?new _t(o).solve(t):o.isSquare()?new Yt(o).solve(t):new ae(o).solve(t)}function Ze(o){if(o=R.checkMatrix(o),o.isSquare()){if(o.columns===0)return 1;let t,s,e,n;if(o.columns===2)return t=o.get(0,0),s=o.get(0,1),e=o.get(1,0),n=o.get(1,1),t*n-s*e;if(o.columns===3){let i,r,a;return i=new Xt(o,[1,2],[1,2]),r=new Xt(o,[1,2],[0,2]),a=new Xt(o,[1,2],[0,1]),t=o.get(0,0),s=o.get(0,1),e=o.get(0,2),t*Ze(i)-s*Ze(r)+e*Ze(a)}else return new Yt(o).determinant}else throw Error("determinant can only be calculated for a square matrix")}function _r(o,t){let s=[];for(let e=0;e<o;e++)e!==t&&s.push(e);return s}function Cr(o,t,s,e=1e-9,n=1e-9){if(o>n)return new Array(t.rows+1).fill(0);{let i=t.addRow(s,[0]);for(let r=0;r<i.rows;r++)Math.abs(i.get(r,0))<e&&i.set(r,0,0);return i.to1DArray()}}function Rr(o,t={}){let{thresholdValue:s=1e-9,thresholdError:e=1e-9}=t;o=R.checkMatrix(o);let n=o.rows,i=new R(n,n);for(let r=0;r<n;r++){let a=R.columnVector(o.getRow(r)),c=o.subMatrixRow(_r(n,r)).transpose(),u=new _t(c).solve(a),h=R.sub(a,c.mmul(u)).abs().max();i.setRow(r,Cr(h,u,r,s,e))}return i}function Ar(o,t=Number.EPSILON){if(o=R.checkMatrix(o),o.isEmpty())return o.transpose();let s=new _t(o,{autoTranspose:!0}),e=s.leftSingularVectors,n=s.rightSingularVectors,i=s.diagonal;for(let r=0;r<i.length;r++)Math.abs(i[r])>t?i[r]=1/i[r]:i[r]=0;return n.mmul(R.diag(i).mmul(e.transpose()))}function Ur(o,t=o,s={}){o=new R(o);let e=!1;if(typeof t=="object"&&!R.isMatrix(t)&&!ut.isAnyArray(t)?(s=t,t=o,e=!0):t=new R(t),o.rows!==t.rows)throw new TypeError("Both matrices must have the same number of rows");let{center:n=!0}=s;n&&(o=o.center("column"),e||(t=t.center("column")));let i=o.transpose().mmul(t);for(let r=0;r<i.rows;r++)for(let a=0;a<i.columns;a++)i.set(r,a,i.get(r,a)*(1/(o.rows-1)));return i}function Fr(o,t=o,s={}){o=new R(o);let e=!1;if(typeof t=="object"&&!R.isMatrix(t)&&!ut.isAnyArray(t)?(s=t,t=o,e=!0):t=new R(t),o.rows!==t.rows)throw new TypeError("Both matrices must have the same number of rows");let{center:n=!0,scale:i=!0}=s;n&&(o.center("column"),e||t.center("column")),i&&(o.scale("column"),e||t.scale("column"));let r=o.standardDeviation("column",{unbiased:!0}),a=e?r:t.standardDeviation("column",{unbiased:!0}),c=o.transpose().mmul(t);for(let l=0;l<c.rows;l++)for(let u=0;u<c.columns;u++)c.set(l,u,c.get(l,u)*(1/(r[l]*a[u]))*(1/(o.rows-1)));return c}var es=class{constructor(t,s={}){let{assumeSymmetric:e=!1}=s;if(t=it.checkMatrix(t),!t.isSquare())throw new Error("Matrix is not a square matrix");if(t.isEmpty())throw new Error("Matrix must be non-empty");let n=t.columns,i=new R(n,n),r=new Float64Array(n),a=new Float64Array(n),c=t,l,u,h=!1;if(e?h=!0:h=t.isSymmetric(),h){for(l=0;l<n;l++)for(u=0;u<n;u++)i.set(l,u,c.get(l,u));Pr(n,a,r,i),Dr(n,a,r,i)}else{let f=new R(n,n),m=new Float64Array(n);for(u=0;u<n;u++)for(l=0;l<n;l++)f.set(l,u,c.get(l,u));Or(n,f,m,i),Lr(n,a,r,i,f)}this.n=n,this.e=a,this.d=r,this.V=i}get realEigenvalues(){return Array.from(this.d)}get imaginaryEigenvalues(){return Array.from(this.e)}get eigenvectorMatrix(){return this.V}get diagonalMatrix(){let t=this.n,s=this.e,e=this.d,n=new R(t,t),i,r;for(i=0;i<t;i++){for(r=0;r<t;r++)n.set(i,r,0);n.set(i,i,e[i]),s[i]>0?n.set(i,i+1,s[i]):s[i]<0&&n.set(i,i-1,s[i])}return n}};function Pr(o,t,s,e){let n,i,r,a,c,l,u,h;for(c=0;c<o;c++)s[c]=e.get(o-1,c);for(a=o-1;a>0;a--){for(h=0,r=0,l=0;l<a;l++)h=h+Math.abs(s[l]);if(h===0)for(t[a]=s[a-1],c=0;c<a;c++)s[c]=e.get(a-1,c),e.set(a,c,0),e.set(c,a,0);else{for(l=0;l<a;l++)s[l]/=h,r+=s[l]*s[l];for(n=s[a-1],i=Math.sqrt(r),n>0&&(i=-i),t[a]=h*i,r=r-n*i,s[a-1]=n-i,c=0;c<a;c++)t[c]=0;for(c=0;c<a;c++){for(n=s[c],e.set(c,a,n),i=t[c]+e.get(c,c)*n,l=c+1;l<=a-1;l++)i+=e.get(l,c)*s[l],t[l]+=e.get(l,c)*n;t[c]=i}for(n=0,c=0;c<a;c++)t[c]/=r,n+=t[c]*s[c];for(u=n/(r+r),c=0;c<a;c++)t[c]-=u*s[c];for(c=0;c<a;c++){for(n=s[c],i=t[c],l=c;l<=a-1;l++)e.set(l,c,e.get(l,c)-(n*t[l]+i*s[l]));s[c]=e.get(a-1,c),e.set(a,c,0)}}s[a]=r}for(a=0;a<o-1;a++){if(e.set(o-1,a,e.get(a,a)),e.set(a,a,1),r=s[a+1],r!==0){for(l=0;l<=a;l++)s[l]=e.get(l,a+1)/r;for(c=0;c<=a;c++){for(i=0,l=0;l<=a;l++)i+=e.get(l,a+1)*e.get(l,c);for(l=0;l<=a;l++)e.set(l,c,e.get(l,c)-i*s[l])}}for(l=0;l<=a;l++)e.set(l,a+1,0)}for(c=0;c<o;c++)s[c]=e.get(o-1,c),e.set(o-1,c,0);e.set(o-1,o-1,1),t[0]=0}function Dr(o,t,s,e){let n,i,r,a,c,l,u,h,f,m,d,p,w,g,x,M;for(r=1;r<o;r++)t[r-1]=t[r];t[o-1]=0;let E=0,I=0,S=Number.EPSILON;for(l=0;l<o;l++){for(I=Math.max(I,Math.abs(s[l])+Math.abs(t[l])),u=l;u<o&&!(Math.abs(t[u])<=S*I);)u++;if(u>l)do{for(n=s[l],h=(s[l+1]-n)/(2*t[l]),f=kt(h,1),h<0&&(f=-f),s[l]=t[l]/(h+f),s[l+1]=t[l]*(h+f),m=s[l+1],i=n-s[l],r=l+2;r<o;r++)s[r]-=i;for(E=E+i,h=s[u],d=1,p=d,w=d,g=t[l+1],x=0,M=0,r=u-1;r>=l;r--)for(w=p,p=d,M=x,n=d*t[r],i=d*h,f=kt(h,t[r]),t[r+1]=x*f,x=t[r]/f,d=h/f,h=d*s[r]-x*n,s[r+1]=i+x*(d*n+x*s[r]),c=0;c<o;c++)i=e.get(c,r+1),e.set(c,r+1,x*e.get(c,r)+d*i),e.set(c,r,d*e.get(c,r)-x*i);h=-x*M*w*g*t[l]/m,t[l]=x*h,s[l]=d*h}while(Math.abs(t[l])>S*I);s[l]=s[l]+E,t[l]=0}for(r=0;r<o-1;r++){for(c=r,h=s[r],a=r+1;a<o;a++)s[a]<h&&(c=a,h=s[a]);if(c!==r)for(s[c]=s[r],s[r]=h,a=0;a<o;a++)h=e.get(a,r),e.set(a,r,e.get(a,c)),e.set(a,c,h)}}function Or(o,t,s,e){let n=0,i=o-1,r,a,c,l,u,h,f;for(h=n+1;h<=i-1;h++){for(f=0,l=h;l<=i;l++)f=f+Math.abs(t.get(l,h-1));if(f!==0){for(c=0,l=i;l>=h;l--)s[l]=t.get(l,h-1)/f,c+=s[l]*s[l];for(a=Math.sqrt(c),s[h]>0&&(a=-a),c=c-s[h]*a,s[h]=s[h]-a,u=h;u<o;u++){for(r=0,l=i;l>=h;l--)r+=s[l]*t.get(l,u);for(r=r/c,l=h;l<=i;l++)t.set(l,u,t.get(l,u)-r*s[l])}for(l=0;l<=i;l++){for(r=0,u=i;u>=h;u--)r+=s[u]*t.get(l,u);for(r=r/c,u=h;u<=i;u++)t.set(l,u,t.get(l,u)-r*s[u])}s[h]=f*s[h],t.set(h,h-1,f*a)}}for(l=0;l<o;l++)for(u=0;u<o;u++)e.set(l,u,l===u?1:0);for(h=i-1;h>=n+1;h--)if(t.get(h,h-1)!==0){for(l=h+1;l<=i;l++)s[l]=t.get(l,h-1);for(u=h;u<=i;u++){for(a=0,l=h;l<=i;l++)a+=s[l]*e.get(l,u);for(a=a/s[h]/t.get(h,h-1),l=h;l<=i;l++)e.set(l,u,e.get(l,u)+a*s[l])}}}function Lr(o,t,s,e,n){let i=o-1,r=0,a=o-1,c=Number.EPSILON,l=0,u=0,h=0,f=0,m=0,d=0,p=0,w=0,g,x,M,E,I,S,k,T,C,y,b,_,v,D,A;for(g=0;g<o;g++)for((g<r||g>a)&&(s[g]=n.get(g,g),t[g]=0),x=Math.max(g-1,0);x<o;x++)u=u+Math.abs(n.get(g,x));for(;i>=r;){for(E=i;E>r&&(d=Math.abs(n.get(E-1,E-1))+Math.abs(n.get(E,E)),d===0&&(d=u),!(Math.abs(n.get(E,E-1))<c*d));)E--;if(E===i)n.set(i,i,n.get(i,i)+l),s[i]=n.get(i,i),t[i]=0,i--,w=0;else if(E===i-1){if(k=n.get(i,i-1)*n.get(i-1,i),h=(n.get(i-1,i-1)-n.get(i,i))/2,f=h*h+k,p=Math.sqrt(Math.abs(f)),n.set(i,i,n.get(i,i)+l),n.set(i-1,i-1,n.get(i-1,i-1)+l),T=n.get(i,i),f>=0){for(p=h>=0?h+p:h-p,s[i-1]=T+p,s[i]=s[i-1],p!==0&&(s[i]=T-k/p),t[i-1]=0,t[i]=0,T=n.get(i,i-1),d=Math.abs(T)+Math.abs(p),h=T/d,f=p/d,m=Math.sqrt(h*h+f*f),h=h/m,f=f/m,x=i-1;x<o;x++)p=n.get(i-1,x),n.set(i-1,x,f*p+h*n.get(i,x)),n.set(i,x,f*n.get(i,x)-h*p);for(g=0;g<=i;g++)p=n.get(g,i-1),n.set(g,i-1,f*p+h*n.get(g,i)),n.set(g,i,f*n.get(g,i)-h*p);for(g=r;g<=a;g++)p=e.get(g,i-1),e.set(g,i-1,f*p+h*e.get(g,i)),e.set(g,i,f*e.get(g,i)-h*p)}else s[i-1]=T+h,s[i]=T+h,t[i-1]=p,t[i]=-p;i=i-2,w=0}else{if(T=n.get(i,i),C=0,k=0,E<i&&(C=n.get(i-1,i-1),k=n.get(i,i-1)*n.get(i-1,i)),w===10){for(l+=T,g=r;g<=i;g++)n.set(g,g,n.get(g,g)-T);d=Math.abs(n.get(i,i-1))+Math.abs(n.get(i-1,i-2)),T=C=.75*d,k=-.4375*d*d}if(w===30&&(d=(C-T)/2,d=d*d+k,d>0)){for(d=Math.sqrt(d),C<T&&(d=-d),d=T-k/((C-T)/2+d),g=r;g<=i;g++)n.set(g,g,n.get(g,g)-d);l+=d,T=C=k=.964}for(w=w+1,I=i-2;I>=E&&(p=n.get(I,I),m=T-p,d=C-p,h=(m*d-k)/n.get(I+1,I)+n.get(I,I+1),f=n.get(I+1,I+1)-p-m-d,m=n.get(I+2,I+1),d=Math.abs(h)+Math.abs(f)+Math.abs(m),h=h/d,f=f/d,m=m/d,!(I===E||Math.abs(n.get(I,I-1))*(Math.abs(f)+Math.abs(m))<c*(Math.abs(h)*(Math.abs(n.get(I-1,I-1))+Math.abs(p)+Math.abs(n.get(I+1,I+1))))));)I--;for(g=I+2;g<=i;g++)n.set(g,g-2,0),g>I+2&&n.set(g,g-3,0);for(M=I;M<=i-1&&(D=M!==i-1,M!==I&&(h=n.get(M,M-1),f=n.get(M+1,M-1),m=D?n.get(M+2,M-1):0,T=Math.abs(h)+Math.abs(f)+Math.abs(m),T!==0&&(h=h/T,f=f/T,m=m/T)),T!==0);M++)if(d=Math.sqrt(h*h+f*f+m*m),h<0&&(d=-d),d!==0){for(M!==I?n.set(M,M-1,-d*T):E!==I&&n.set(M,M-1,-n.get(M,M-1)),h=h+d,T=h/d,C=f/d,p=m/d,f=f/h,m=m/h,x=M;x<o;x++)h=n.get(M,x)+f*n.get(M+1,x),D&&(h=h+m*n.get(M+2,x),n.set(M+2,x,n.get(M+2,x)-h*p)),n.set(M,x,n.get(M,x)-h*T),n.set(M+1,x,n.get(M+1,x)-h*C);for(g=0;g<=Math.min(i,M+3);g++)h=T*n.get(g,M)+C*n.get(g,M+1),D&&(h=h+p*n.get(g,M+2),n.set(g,M+2,n.get(g,M+2)-h*m)),n.set(g,M,n.get(g,M)-h),n.set(g,M+1,n.get(g,M+1)-h*f);for(g=r;g<=a;g++)h=T*e.get(g,M)+C*e.get(g,M+1),D&&(h=h+p*e.get(g,M+2),e.set(g,M+2,e.get(g,M+2)-h*m)),e.set(g,M,e.get(g,M)-h),e.set(g,M+1,e.get(g,M+1)-h*f)}}}if(u!==0){for(i=o-1;i>=0;i--)if(h=s[i],f=t[i],f===0)for(E=i,n.set(i,i,1),g=i-1;g>=0;g--){for(k=n.get(g,g)-h,m=0,x=E;x<=i;x++)m=m+n.get(g,x)*n.get(x,i);if(t[g]<0)p=k,d=m;else if(E=g,t[g]===0?n.set(g,i,k!==0?-m/k:-m/(c*u)):(T=n.get(g,g+1),C=n.get(g+1,g),f=(s[g]-h)*(s[g]-h)+t[g]*t[g],S=(T*d-p*m)/f,n.set(g,i,S),n.set(g+1,i,Math.abs(T)>Math.abs(p)?(-m-k*S)/T:(-d-C*S)/p)),S=Math.abs(n.get(g,i)),c*S*S>1)for(x=g;x<=i;x++)n.set(x,i,n.get(x,i)/S)}else if(f<0)for(E=i-1,Math.abs(n.get(i,i-1))>Math.abs(n.get(i-1,i))?(n.set(i-1,i-1,f/n.get(i,i-1)),n.set(i-1,i,-(n.get(i,i)-h)/n.get(i,i-1))):(A=Je(0,-n.get(i-1,i),n.get(i-1,i-1)-h,f),n.set(i-1,i-1,A[0]),n.set(i-1,i,A[1])),n.set(i,i-1,0),n.set(i,i,1),g=i-2;g>=0;g--){for(y=0,b=0,x=E;x<=i;x++)y=y+n.get(g,x)*n.get(x,i-1),b=b+n.get(g,x)*n.get(x,i);if(k=n.get(g,g)-h,t[g]<0)p=k,m=y,d=b;else if(E=g,t[g]===0?(A=Je(-y,-b,k,f),n.set(g,i-1,A[0]),n.set(g,i,A[1])):(T=n.get(g,g+1),C=n.get(g+1,g),_=(s[g]-h)*(s[g]-h)+t[g]*t[g]-f*f,v=(s[g]-h)*2*f,_===0&&v===0&&(_=c*u*(Math.abs(k)+Math.abs(f)+Math.abs(T)+Math.abs(C)+Math.abs(p))),A=Je(T*m-p*y+f*b,T*d-p*b-f*y,_,v),n.set(g,i-1,A[0]),n.set(g,i,A[1]),Math.abs(T)>Math.abs(p)+Math.abs(f)?(n.set(g+1,i-1,(-y-k*n.get(g,i-1)+f*n.get(g,i))/T),n.set(g+1,i,(-b-k*n.get(g,i)-f*n.get(g,i-1))/T)):(A=Je(-m-C*n.get(g,i-1),-d-C*n.get(g,i),p,f),n.set(g+1,i-1,A[0]),n.set(g+1,i,A[1]))),S=Math.max(Math.abs(n.get(g,i-1)),Math.abs(n.get(g,i))),c*S*S>1)for(x=g;x<=i;x++)n.set(x,i-1,n.get(x,i-1)/S),n.set(x,i,n.get(x,i)/S)}for(g=0;g<o;g++)if(g<r||g>a)for(x=g;x<o;x++)e.set(g,x,n.get(g,x));for(x=o-1;x>=r;x--)for(g=r;g<=a;g++){for(p=0,M=r;M<=Math.min(x,a);M++)p=p+e.get(g,M)*n.get(M,x);e.set(g,x,p)}}}function Je(o,t,s,e){let n,i;return Math.abs(s)>Math.abs(e)?(n=e/s,i=s+n*e,[(o+n*t)/i,(t-n*o)/i]):(n=s/e,i=e+n*s,[(n*o+t)/i,(n*t-o)/i])}var ss=class{constructor(t){if(t=it.checkMatrix(t),!t.isSymmetric())throw new Error("Matrix is not symmetric");let s=t,e=s.rows,n=new R(e,e),i=!0,r,a,c;for(a=0;a<e;a++){let l=0;for(c=0;c<a;c++){let u=0;for(r=0;r<c;r++)u+=n.get(c,r)*n.get(a,r);u=(s.get(a,c)-u)/n.get(c,c),n.set(a,c,u),l=l+u*u}for(l=s.get(a,a)-l,i&&=l>0,n.set(a,a,Math.sqrt(Math.max(l,0))),c=a+1;c<e;c++)n.set(a,c,0)}this.L=n,this.positiveDefinite=i}isPositiveDefinite(){return this.positiveDefinite}solve(t){t=it.checkMatrix(t);let s=this.L,e=s.rows;if(t.rows!==e)throw new Error("Matrix dimensions do not match");if(this.isPositiveDefinite()===!1)throw new Error("Matrix is not positive definite");let n=t.columns,i=t.clone(),r,a,c;for(c=0;c<e;c++)for(a=0;a<n;a++){for(r=0;r<c;r++)i.set(c,a,i.get(c,a)-i.get(r,a)*s.get(c,r));i.set(c,a,i.get(c,a)/s.get(c,c))}for(c=e-1;c>=0;c--)for(a=0;a<n;a++){for(r=c+1;r<e;r++)i.set(c,a,i.get(c,a)-i.get(r,a)*s.get(r,c));i.set(c,a,i.get(c,a)/s.get(c,c))}return i}get lowerTriangularMatrix(){return this.L}},ns=class{constructor(t,s={}){t=it.checkMatrix(t);let{Y:e}=s,{scaleScores:n=!1,maxIterations:i=1e3,terminationCriteria:r=1e-10}=s,a;if(e){if(ut.isAnyArray(e)&&typeof e[0]=="number"?e=R.columnVector(e):e=it.checkMatrix(e),e.rows!==t.rows)throw new Error("Y should have the same number of rows as X");a=e.getColumnVector(0)}else a=t.getColumnVector(0);let c=1,l,u,h,f;for(let m=0;m<i&&c>r;m++)h=t.transpose().mmul(a).div(a.transpose().mmul(a).get(0,0)),h=h.div(h.norm()),l=t.mmul(h).div(h.transpose().mmul(h).get(0,0)),m>0&&(c=l.clone().sub(f).pow(2).sum()),f=l.clone(),e?(u=e.transpose().mmul(l).div(l.transpose().mmul(l).get(0,0)),u=u.div(u.norm()),a=e.mmul(u).div(u.transpose().mmul(u).get(0,0))):a=l;if(e){let m=t.transpose().mmul(l).div(l.transpose().mmul(l).get(0,0));m=m.div(m.norm());let d=t.clone().sub(l.clone().mmul(m.transpose())),p=a.transpose().mmul(l).div(l.transpose().mmul(l).get(0,0)),w=e.clone().sub(l.clone().mulS(p.get(0,0)).mmul(u.transpose()));this.t=l,this.p=m.transpose(),this.w=h.transpose(),this.q=u,this.u=a,this.s=l.transpose().mmul(l),this.xResidual=d,this.yResidual=w,this.betas=p}else this.w=h.transpose(),this.s=l.transpose().mmul(l).sqrt(),n?this.t=l.clone().div(this.s.get(0,0)):this.t=l,this.xResidual=t.sub(l.mmul(h.transpose()))}};$.AbstractMatrix=K;$.CHO=ss;$.CholeskyDecomposition=ss;$.DistanceMatrix=Qe;$.EVD=es;$.EigenvalueDecomposition=es;$.LU=Yt;$.LuDecomposition=Yt;$.Matrix=R;$.MatrixColumnSelectionView=Ns;$.MatrixColumnView=Ls;$.MatrixFlipColumnView=Bs;$.MatrixFlipRowView=js;$.MatrixRowSelectionView=qs;$.MatrixRowView=zs;$.MatrixSelectionView=Xt;$.MatrixSubView=Vs;$.MatrixTransposeView=Ws;$.NIPALS=ns;$.Nipals=ns;$.QR=ae;$.QrDecomposition=ae;$.SVD=_t;$.SingularValueDecomposition=_t;$.SymmetricMatrix=Ot;$.WrapperMatrix1D=ts;$.WrapperMatrix2D=it;$.correlation=Fr;$.covariance=Ur;$.default=R;$.determinant=Ze;$.inverse=Tr;$.linearDependencies=Rr;$.pseudoInverse=Ar;$.solve=ui;$.wrap=vr});var z,gt,ce,Yc,os,le=W(()=>{z=oo(fi(),1),gt=z.Matrix,ce=z.SingularValueDecomposition,Yc=z.default.Matrix?z.default.Matrix:z.Matrix,os=z.inverse});var mi,di,Nr,gi=W(()=>{"use strict";le();mi=(o,t)=>{let{normPoints:s,param:e}=di(o),{normPoints:n,param:i}=di(t),r=n.length,a=[],c=[];for(let l=0;l<r;l++){let u=[s[l][0],s[l][1],1,0,0,0,-(s[l][0]*n[l][0]),-(s[l][1]*n[l][0])],h=[0,0,0,s[l][0],s[l][1],1,-(s[l][0]*n[l][1]),-(s[l][1]*n[l][1])];a.push(u),a.push(h),c.push([n[l][0]]),c.push([n[l][1]])}try{let l=new gt(a),u=new gt(c),h=l.transpose(),f=h.mmul(l),m=h.mmul(u),p=os(f).mmul(m).to1DArray();return Nr(p,e,i)}catch{return null}},di=o=>{let t=0,s=0;for(let c=0;c<o.length;c++)t+=o[c][0],s+=o[c][1];let e=t/o.length,n=s/o.length,i=0;for(let c=0;c<o.length;c++){let l=o[c][0]-e,u=o[c][1]-n;i+=Math.sqrt(l*l+u*u)}let r=Math.sqrt(2)*o.length/i,a=[];for(let c=0;c<o.length;c++)a.push([(o[c][0]-e)*r,(o[c][1]-n)*r]);return{normPoints:a,param:{meanX:e,meanY:n,s:r}}},Nr=(o,t,s)=>{let e=s.s*s.meanX,n=s.s*s.meanY,i=[o[0]+e*o[6],o[1]+e*o[7],(o[0]+e*o[6])*-t.meanX+(o[1]+e*o[7])*-t.meanY+(o[2]+e)/t.s,o[3]+n*o[6],o[4]+n*o[7],(o[3]+n*o[6])*-t.meanX+(o[4]+n*o[7])*-t.meanY+(o[5]+n)/t.s,s.s*o[6],s.s*o[7],s.s*o[6]*-t.meanX+s.s*o[7]*-t.meanY+s.s/t.s];for(let r=0;r<9;r++)i[r]=i[r]/i[8];return i}});var Br,jr,zr,qr,Xs,Vr,Wr,Hr,$r,pi=W(()=>{"use strict";Ps();Ds();gi();Br=.01,jr=10,zr=100,qr=50,Xs=o=>{let{srcPoints:t,dstPoints:s,keyframe:e,quickMode:n}=o,i=[[0,0],[e.width,0],[e.width,e.height],[0,e.height]],r=4;if(t.length<r)return null;let a=Br,c=1/(a*a),l=Math.min(jr,t.length),u=He(),h=[];for(let M=0;M<t.length;M++)h[M]=M;u.arrayShuffle({arr:h,sampleSize:h.length});let f=n?qr:zr,m=f*2,d=0,p=[];for(;d<m&&p.length<f;){if(d+=1,u.arrayShuffle({arr:h,sampleSize:r}),!Xn(t[h[0]],t[h[1]],t[h[2]],t[h[3]],s[h[0]],s[h[1]],s[h[2]],s[h[3]]))continue;let M=mi([t[h[0]],t[h[1]],t[h[2]],t[h[3]]],[s[h[0]],s[h[1]],s[h[2]],s[h[3]]]);M!==null&&$r({H:M,testPoints:i})&&p.push(M)}if(p.length===0)return null;let w=[];for(let M=0;M<p.length;M++)w.push({H:p[M],cost:0});let g=l;for(let M=0;M<t.length&&w.length>2;M+=g){g=Math.min(l,t.length-M);let E=M+g;for(let I=0;I<w.length;I++)for(let S=M;S<E;S++){let k=Hr({H:w[I].H,srcPoint:t[S],dstPoint:s[S],oneOverScale2:c});w[I].cost+=k}w.sort((I,S)=>I.cost-S.cost),w.splice(-Math.floor((w.length+1)/2))}let x=null;for(let M=0;M<w.length;M++){let E=Wr({inH:w[M].H});if(Vr({H:E,testPoints:i,keyframe:e})){x=E;break}}return x},Vr=({H:o,testPoints:t,keyframe:s})=>{let e=[];for(let i=0;i<t.length;i++)e.push(Xe(t[i],o));return!(Kn(e[0],e[1],e[2],e[3])<s.width*s.height*1e-4||!Jn(e[0],e[1],e[2],e[3]))},Wr=({inH:o})=>{let t=1/o[8],s=[];for(let e=0;e<8;e++)s[e]=o[e]*t;return s[8]=1,s},Hr=({H:o,srcPoint:t,dstPoint:s,oneOverScale2:e})=>{let n=Xe(t,o),i=[n[0]-s[0],n[1]-s[1]];return Math.log(1+(i[0]*i[0]+i[1]*i[1])*e)},$r=({H:o,testPoints:t})=>{let s=[];for(let e=0;e<t.length;e++)s[e]=Xe(t[e],o);for(let e=0;e<t.length;e++){let n=e,i=(e+1)%t.length,r=(e+2)%t.length;if(!Yn(t[n],t[i],t[r],s[n],s[i],s[r]))return!1}return!0}});function wi({imageData:o,width:t,height:s,targetData:e,initialH:n,iterations:i=3}){let r=[...n],a=[],c=.05;for(let l=0;l<=1;l+=c)a.push({x:l*e.w,y:0}),a.push({x:l*e.w,y:e.h}),a.push({x:0,y:l*e.h}),a.push({x:e.w,y:l*e.h});for(let l=0;l<i;l++){let u=[];for(let f of a){let m=r[6]*f.x+r[7]*f.y+r[8],d=(r[0]*f.x+r[1]*f.y+r[2])/m,p=(r[3]*f.x+r[4]*f.y+r[5])/m;if(d<2||d>=t-2||p<2||p>=s-2)continue;let w=10,g=d,x=p,M=-1;for(let E=-w;E<=w;E+=2)for(let I=-w;I<=w;I+=2){let S=Math.floor(d+I),k=Math.floor(p+E),T=k*t+S,C=o[T+1]-o[T-1],y=o[T+t]-o[T-t],b=C*C+y*y;b>M&&(M=b,g=S,x=k)}M>500&&u.push({src:f,dst:{x:g,y:x},weight:Math.min(1,M/15e3)})}if(u.length<10)break;let h=Xr(u);if(h)for(let f=0;f<9;f++)r[f]=r[f]*.5+h[f]*.5}return r}function Xr(o){let t=o.length,s=new gt(t*2,9);for(let e=0;e<t;e++){let{src:n,dst:i,weight:r}=o[e],a=n.x,c=n.y,l=i.x,u=i.y;s.set(e*2,0,0),s.set(e*2,1,0),s.set(e*2,2,0),s.set(e*2,3,-a*r),s.set(e*2,4,-c*r),s.set(e*2,5,-r),s.set(e*2,6,u*a*r),s.set(e*2,7,u*c*r),s.set(e*2,8,u*r),s.set(e*2+1,0,a*r),s.set(e*2+1,1,c*r),s.set(e*2+1,2,r),s.set(e*2+1,3,0),s.set(e*2+1,4,0),s.set(e*2+1,5,0),s.set(e*2+1,6,-l*a*r),s.set(e*2+1,7,-l*c*r),s.set(e*2+1,8,-l*r)}try{let i=new ce(s).rightSingularVectors.getColumn(8),r=1/i[8];return i.map(a=>a*r)}catch{return null}}var yi=W(()=>{"use strict";le()});function Ct(o){return o=o-(o>>1&1431655765),o=(o&858993459)+(o>>2&858993459),(o+(o>>4)&252645135)*16843009>>24}var Yr,Gr,he,Kr,Ys,xi,Gs=W(()=>{"use strict";Us();Ps();Yr=32,Gr=12,he=8;Kr=o=>{let{descriptors:t,pointIndexes:s,randomizer:e,useHDC:n}=o,i=s.length,r=new Int32Array(i);for(let u=0;u<i;u++)r[u]=u;let a=Number.MAX_SAFE_INTEGER,c=null,l=new Int32Array(he);for(let u=0;u<Gr;u++){e.arrayShuffle({arr:r,sampleSize:he});for(let m=0;m<he;m++)l[m]=s[r[m]];let h=0,f=new Int32Array(i);for(let m=0;m<i;m++){let d=s[m],p=255,w=-1;for(let g=0;g<he;g++){let x=l[g],M;n?M=Ct(t[d]^t[x]):M=As(t,d*2,t,x*2),M<p&&(w=r[g],p=M)}f[m]=w,h+=p}h<a&&(a=h,c=f)}return c},Ys=({points:o})=>{let t=o.length;if(t===0)return{rootNode:{leaf:!0,pointIndexes:[],centerPointIndex:null}};let s=o[0]&&o[0].hdcSignature!==void 0,e=new Uint32Array(s?t:t*2);for(let a=0;a<t;a++)if(s)e[a]=o[a].hdcSignature;else{let c=o[a].descriptors;e[a*2]=c[0],e[a*2+1]=c[1]}let n=new Int32Array(t);for(let a=0;a<t;a++)n[a]=a;let i=He();return{rootNode:xi({descriptors:e,pointIndexes:n,centerPointIndex:null,randomizer:i,useHDC:s})}},xi=o=>{let{descriptors:t,pointIndexes:s,centerPointIndex:e,randomizer:n,useHDC:i}=o,r=s.length,a=!1;(r<=he||r<=Yr)&&(a=!0);let c=new Map;if(!a){let u=Kr({descriptors:t,pointIndexes:s,randomizer:n,useHDC:i});for(let h=0;h<u.length;h++){let f=s[u[h]],m=c.get(f);m===void 0&&(m=[],c.set(f,m)),m.push(s[h])}c.size===1&&(a=!0)}let l={centerPointIndex:e};if(a)return l.leaf=!0,l.pointIndexes=new Int32Array(s),l;l.leaf=!1,l.children=[];for(let[u,h]of c)l.children.push(xi({descriptors:t,pointIndexes:new Int32Array(h),centerPointIndex:u,randomizer:n,useHDC:i}));return l}});var Mi,Ks,Jr,Zr,Qr,bi,Ei,Js,Si,ki=W(()=>{"use strict";Wn();Us();$n();pi();Ds();yi();Gs();Pt();Mi=X.INLIER_THRESHOLD,Ks=X.MIN_NUM_INLIERS,Jr=X.CLUSTER_MAX_POP,Zr=X.HAMMING_THRESHOLD,Qr=X.HDC_RATIO_THRESHOLD,bi=X.MAX_MATCH_QUERY_POINTS,Ei=({keyframe:o,querypoints:t,querywidth:s,queryheight:e,debugMode:n,expectedScale:i})=>{let r={},a=t.length>bi?[...t].sort((P,U)=>(U.score||U.response||0)-(P.score||P.response||0)).slice(0,bi):t,c=[],l=a.length,u=o.max,h=o.min,f=o.hdc===!0||u&&u.hdc===1,m=u&&u.compact===1||h&&h.compact===1,d=f||m?1:2,p=f?Qr:Zr;for(let P=0;P<l;P++){let U=a[P],N=U.maxima?u:h;if(!N||N.x.length===0)continue;let L=N.t,j=[],Y=new ie([],(ct,nt)=>ct.d-nt.d);Js({node:L,descriptors:N.d,querypoint:U,queue:Y,keypointIndexes:j,numPop:0,isHDC:f,descSize:d,isCompact:m});let q=-1,H=Number.MAX_SAFE_INTEGER,J=Number.MAX_SAFE_INTEGER,Z=U.descriptors,Q=N.d,et=m&&Z&&Z.length>=2?(Z[0]^Z[1])>>>0:0;for(let ct=0;ct<j.length;ct++){let nt=j[ct];if(i!==void 0&&N.s){let ft=N.s[nt],bt=(U.scale||1)/i;if(ft<bt*.4||ft>bt*2.5)continue}let st;f?st=Ct(Q[nt]^U.hdcSignature):m?st=Ct(Q[nt]^et):st=We({v1:Q,v1Offset:nt*d,v2:Z}),st<H?(J=H,H=st,q=nt):st<J&&(J=st)}q!==-1&&(J===Number.MAX_SAFE_INTEGER||H/J<p)&&c.push({querypoint:U,keypoint:{x:N.x[q],y:N.y[q],angle:N.a[q],scale:N.s?N.s[q]:o.s},d:H})}if(c.length<Ks)return{debugExtra:r};let w=c;n&&(r.constellationMatches=w);let g=Fs({keywidth:o.w||o.width,keyheight:o.h||o.height,querywidth:s,queryheight:e,matches:w});if(n&&(r.houghMatches=g),g.length<Ks)return{debugExtra:r};let x=Xs({srcPoints:g.map(P=>[P.keypoint.x,P.keypoint.y]),dstPoints:g.map(P=>[P.querypoint.x,P.querypoint.y]),keyframe:{width:o.w||o.width,height:o.h||o.height}});if(x===null)return{debugExtra:r};let M=Si({H:x,matches:g,threshold:Mi});if(n&&(r.inlierMatches=M),M.length<Ks)return{debugExtra:r};n&&Math.random()<.02&&console.log(`MATCH: Homography success with ${M.length} inliers`);let E=Gn(x,1e-5),I=100,S=[],k=E[0],T=E[1],C=E[2],y=E[3],b=E[4],_=E[5],v=E[6],D=E[7],A=E[8];for(let P=0;P<l;P++){let U=a[P],N=U.x,L=U.y,Y=1/(N*v+L*D+A),q=(N*k+L*T+C)*Y,H=(N*y+L*b+_)*Y,J=-1,Z=Number.MAX_SAFE_INTEGER,Q=Number.MAX_SAFE_INTEGER,et=U.maxima?u:h;if(!et)continue;let ct=et.x,nt=et.y,st=et.d,ft=U.descriptors,bt=m&&ft&&ft.length>=2?(ft[0]^ft[1])>>>0:0;for(let St=0,Kt=ct.length;St<Kt;St++){let be=ct[St]-q,jt=nt[St]-H;if(be*be+jt*jt>I)continue;let pt;f?pt=Ct(st[St]^U.hdcSignature):m?pt=Ct(st[St]^bt):pt=We({v1:st,v1Offset:St*d,v2:ft}),pt<Z?(Q=Z,Z=pt,J=St):pt<Q&&(Q=pt)}J!==-1&&(Q===Number.MAX_SAFE_INTEGER||Z/Q<p)&&S.push({querypoint:U,keypoint:{x:et.x[J],y:et.y[J],angle:et.a[J],scale:et.s?et.s[J]:o.s}})}n&&(r.matches2=S);let F=Fs({keywidth:o.w||o.width,keyheight:o.h||o.height,querywidth:s,queryheight:e,matches:S});n&&(r.houghMatches2=F);let O=Xs({srcPoints:F.map(P=>[P.keypoint.x,P.keypoint.y]),dstPoints:F.map(P=>[P.querypoint.x,P.querypoint.y]),keyframe:{width:o.w||o.width,height:o.h||o.height}});if(O===null)return{debugExtra:r};let B=Si({H:O,matches:F,threshold:Mi});return n&&(r.inlierMatches2=B),{H:wi({imageData:t[0].imageData,width:s,height:e,targetData:{w:o.w||o.width,h:o.h||o.height},initialH:O,iterations:3})||O,matches:B,debugExtra:r}},Js=({node:o,descriptors:t,querypoint:s,queue:e,keypointIndexes:n,numPop:i,isHDC:r,descSize:a,isCompact:c})=>{let l=o[0]===1,u=o[2];if(l){for(let w=0;w<u.length;w++)n.push(u[w]);return}let h=s.descriptors,f=c&&h&&h.length>=2?(h[0]^h[1])>>>0:0,m=Number.MAX_SAFE_INTEGER,d=u.length,p=new Int32Array(d);for(let w=0;w<d;w++){let x=u[w][1],M;r?M=Ct(t[x]^s.hdcSignature):c?M=Ct(t[x]^f):M=We({v1:t,v1Offset:x*a,v2:h}),p[w]=M,M<m&&(m=M)}for(let w=0;w<d;w++){let g=p[w];g<=m?Js({node:u[w],descriptors:t,querypoint:s,queue:e,keypointIndexes:n,numPop:i+1,isHDC:r,descSize:a,isCompact:c}):e.push({node:u[w],d:g})}if(i<Jr&&e.length>0){let{node:w}=e.pop();Js({node:w,descriptors:t,querypoint:s,queue:e,keypointIndexes:n,numPop:i+1,isHDC:r,descSize:a,isCompact:c})}},Si=o=>{let{H:t,matches:s,threshold:e}=o,n=e*e,i=t[0],r=t[1],a=t[2],c=t[3],l=t[4],u=t[5],h=t[6],f=t[7],m=t[8],d=[];for(let p=0;p<s.length;p++){let w=s[p],g=w.querypoint,x=w.keypoint,E=1/(x.x*h+x.y*f+m),I=(x.x*i+x.y*r+a)*E,S=(x.x*c+x.y*l+u)*E,k=I-g.x,T=S-g.y;k*k+T*T<=n&&d.push(w)}return d}});var Ii={};hn(Ii,{Matcher:()=>ue});var ue,Zs=W(()=>{"use strict";ki();ue=class{constructor(t,s,e=!1){this.queryWidth=t,this.queryHeight=s,this.debugMode=e}matchDetection(t,s,e){let n={frames:[]},i=null;if(!t||!Array.isArray(t))return{targetIndex:-1,keyframeIndex:-1,debugExtra:n};for(let u=0;u<t.length;u++){let{H:h,matches:f,debugExtra:m}=Ei({keyframe:t[u],querypoints:s,querywidth:this.queryWidth,queryheight:this.queryHeight,debugMode:this.debugMode,expectedScale:e});m&&(m.keyframeIndex=u,n.frames.push(m)),h&&(i===null||i.matches.length<f.length)&&(i={keyframeIndex:u,H:h,matches:f})}if(i===null)return{targetIndex:-1,keyframeIndex:-1,debugExtra:n};let r=[],a=[],c=t[i.keyframeIndex],l=c.s||c.scale||1;for(let u=0;u<i.matches.length;u++){let h=i.matches[u].querypoint,f=i.matches[u].keypoint,m=f.scale||l;r.push({x:h.x,y:h.y}),a.push({x:(f.x+.5)/l,y:(f.y+.5)/l,z:0})}return{screenCoords:r,worldCoords:a,targetIndex:-1,keyframeIndex:i.keyframeIndex,H:i.H,debugExtra:n}}}});function vi({screenCoords:o,worldCoords:t,projectionTransform:s}){let e=new gt(s),n=o.length,i=ta(s),r=new gt(n*2,9);for(let S=0;S<n;S++){let k=o[S],T=t[S],C=i[0]*k.x+i[1]*k.y+i[2],y=i[3]*k.x+i[4]*k.y+i[5],b=i[6]*k.x+i[7]*k.y+i[8],_=C/b,v=y/b,D=T.x,A=T.y;r.set(S*2,0,D),r.set(S*2,1,A),r.set(S*2,2,1),r.set(S*2,3,0),r.set(S*2,4,0),r.set(S*2,5,0),r.set(S*2,6,-_*D),r.set(S*2,7,-_*A),r.set(S*2,8,-_),r.set(S*2+1,0,0),r.set(S*2+1,1,0),r.set(S*2+1,2,0),r.set(S*2+1,3,D),r.set(S*2+1,4,A),r.set(S*2+1,5,1),r.set(S*2+1,6,-v*D),r.set(S*2+1,7,-v*A),r.set(S*2+1,8,-v)}let l=new ce(r).rightSingularVectors.getColumn(8);if(l[8]<0)for(let S=0;S<9;S++)l[S]=-l[S];let u=[l[0],l[3],l[6]],h=[l[1],l[4],l[7]],f=[l[2],l[5],l[8]],m=Math.sqrt(u[0]**2+u[1]**2+u[2]**2),d=Math.sqrt(h[0]**2+h[1]**2+h[2]**2),p=(m+d)/2,w=new gt([[u[0]/m,h[0]/d,0],[u[1]/m,h[1]/d,0],[u[2]/m,h[2]/d,0]]);w.set(0,2,w.get(1,0)*w.get(2,1)-w.get(2,0)*w.get(1,1)),w.set(1,2,w.get(2,0)*w.get(0,1)-w.get(0,0)*w.get(2,1)),w.set(2,2,w.get(0,0)*w.get(1,1)-w.get(1,0)*w.get(0,1));let g=new ce(w),x=g.leftSingularVectors,M=g.rightSingularVectors,E=x.mmul(M.transpose());if((S=>S.get(0,0)*(S.get(1,1)*S.get(2,2)-S.get(1,2)*S.get(2,1))-S.get(0,1)*(S.get(1,0)*S.get(2,2)-S.get(1,2)*S.get(2,0))+S.get(0,2)*(S.get(1,0)*S.get(2,1)-S.get(1,1)*S.get(2,0)))(E)<0){let S=x.clone();for(let k=0;k<3;k++)S.set(k,2,-S.get(k,2));E=S.mmul(M.transpose())}return[[E.get(0,0),E.get(0,1),E.get(0,2),f[0]/p],[E.get(1,0),E.get(1,1),E.get(1,2),f[1]/p],[E.get(2,0),E.get(2,1),E.get(2,2),f[2]/p]]}function ta(o){let t=o[0][0],s=o[0][1],e=o[0][2],n=o[1][0],i=o[1][1],r=o[1][2],a=o[2][0],c=o[2][1],l=o[2][2],h=1/(t*(i*l-c*r)-s*(n*l-r*a)+e*(n*c-i*a));return[(i*l-r*c)*h,(e*c-s*l)*h,(s*r-e*i)*h,(r*a-n*l)*h,(t*l-e*a)*h,(n*e-t*r)*h,(n*c-i*a)*h,(a*s-c*t)*h,(t*i-n*s)*h]}var Ti=W(()=>{"use strict";le()});var _i,Ci=W(()=>{"use strict";Ti();_i=({screenCoords:o,worldCoords:t,projectionTransform:s})=>vi({screenCoords:o,worldCoords:t,projectionTransform:s})});var ea,sa,Ri,na,ia,ot,Lt,tt,Ai,oa,ra,aa,ca,Ui=W(()=>{"use strict";le();gs();ea=5,sa=4,Ri=10,na=.1,ia=.99,ot=[[],[],[]],Lt=[[],[]],tt=[[],[],[]],Ai=({initialModelViewTransform:o,projectionTransform:t,worldCoords:s,screenCoords:e,stabilities:n})=>{let i=0,r=0;for(let f=0;f<s.length;f++)i+=s[f].x,r+=s[f].y;i/=s.length,r/=s.length;let a=[];for(let f=0;f<s.length;f++)a.push({x:s[f].x-i,y:s[f].y-r,z:s[f].z});let c=[[],[],[]];for(let f=0;f<3;f++)for(let m=0;m<3;m++)c[f][m]=o[f][m];c[0][3]=o[0][0]*i+o[0][1]*r+o[0][3],c[1][3]=o[1][0]*i+o[1][1]*r+o[1][3],c[2][3]=o[2][0]*i+o[2][1]*r+o[2][3];let l=[1,.8,.6,.4,0],u=c,h=null;for(let f=0;f<l.length;f++){let m=oa({initialModelViewTransform:u,projectionTransform:t,worldCoords:a,screenCoords:e,stabilities:n,inlierProb:l[f]});if(u=m.modelViewTransform,m.err<ea){h=u;break}}return h===null?null:(h[0][3]=h[0][3]-h[0][0]*i-h[0][1]*r,h[1][3]=h[1][3]-h[1][0]*i-h[1][1]*r,h[2][3]=h[2][3]-h[2][0]*i-h[2][1]*r,h)},oa=({initialModelViewTransform:o,projectionTransform:t,worldCoords:s,screenCoords:e,stabilities:n,inlierProb:i})=>{let r=i<1,a=o,c=0,l=0,u=new Array(s.length),h=new Array(s.length),f=new Array(s.length),m=new Array(s.length);for(let d=0;d<=Ri;d++){let p=Se(t,a);for(let E=0;E<s.length;E++){let I=Ft(p,s[E].x,s[E].y,s[E].z),S=e[E].x-I.x,k=e[E].y-I.y;f[E]=S,m[E]=k,u[E]=S*S+k*k}let w;if(l=0,r){let E=Math.max(3,Math.floor(s.length*i)-1);for(let I=0;I<s.length;I++)h[I]=u[I];h.sort((I,S)=>I-S),w=Math.max(h[E]*sa,16);for(let I=0;I<s.length;I++)h[I]>w?l+=w/6:l+=w/6*(1-(1-h[I]/w)*(1-h[I]/w)*(1-h[I]/w))}else for(let E=0;E<s.length;E++)l+=u[E];if(l/=s.length,l<na||d>0&&l/c>ia||d===Ri)break;c=l;let g=[],x=[];for(let E=0;E<s.length;E++){if(r&&u[E]>w)continue;let I=ca({modelViewProjectionTransform:p,modelViewTransform:a,projectionTransform:t,worldCoord:s[E]});if(r){let S=(1-u[E]/w)*(1-u[E]/w),k=n?n[E]:1,T=k*Math.log10(9*k+1),C=S*T;for(let y=0;y<2;y++)for(let b=0;b<6;b++)I[y][b]*=C;g.push([f[E]*C]),g.push([m[E]*C])}else{let S=n?n[E]:1,k=S*Math.log10(9*S+1);for(let T=0;T<2;T++)for(let C=0;C<6;C++)I[T][C]*=k;g.push([f[E]*k]),g.push([m[E]*k])}for(let S=0;S<I.length;S++)x.push(I[S])}let M=aa({dU:g,J_U_S:x});if(M===null)break;a=ra({modelViewTransform:a,dS:M})}return{modelViewTransform:a,err:l}},ra=({modelViewTransform:o,dS:t})=>{let s=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],e,n,i;s<1e-6?(e=1,n=0,i=0,s=0):(s=Math.sqrt(s),e=t[0]/s,n=t[1]/s,i=t[2]/s);let r=Math.cos(s),a=Math.sin(s),c=1-r;ot[0][0]=e*e*c+r,ot[0][1]=e*n*c-i*a,ot[0][2]=e*i*c+n*a,ot[0][3]=t[3],ot[1][0]=n*e*c+i*a,ot[1][1]=n*n*c+r,ot[1][2]=n*i*c-e*a,ot[1][3]=t[4],ot[2][0]=i*e*c-n*a,ot[2][1]=i*n*c+e*a,ot[2][2]=i*i*c+r,ot[2][3]=t[5];let l=[[],[],[]];for(let u=0;u<3;u++){for(let h=0;h<4;h++)l[u][h]=o[u][0]*ot[0][h]+o[u][1]*ot[1][h]+o[u][2]*ot[2][h];l[u][3]+=o[u][3]}return l},aa=({dU:o,J_U_S:t})=>{let s=new gt(t),e=new gt(o),n=s.transpose(),i=n.mmul(s),r=n.mmul(e),a;try{a=os(i)}catch{return null}return a.mmul(r).to1DArray()},ca=({modelViewProjectionTransform:o,modelViewTransform:t,projectionTransform:s,worldCoord:e})=>{let n=t,{x:i,y:r,z:a}=e,c=ms(o,i,r,a),l=c.z*c.z;Lt[0][0]=s[0][0]*c.z/l,Lt[0][1]=s[0][1]*c.z/l,Lt[0][2]=(s[0][2]*c.z-s[2][2]*c.x)/l,Lt[1][0]=s[1][0]*c.z/l,Lt[1][1]=s[1][1]*c.z/l,Lt[1][2]=(s[1][2]*c.z-s[2][2]*c.y)/l,tt[0][0]=n[0][2]*r,tt[0][1]=-n[0][2]*i,tt[0][2]=n[0][1]*i-n[0][0]*r,tt[0][3]=n[0][0],tt[0][4]=n[0][1],tt[0][5]=n[0][2],tt[1][0]=n[1][2]*r,tt[1][1]=-n[1][2]*i,tt[1][2]=n[1][1]*i-n[1][0]*r,tt[1][3]=n[1][0],tt[1][4]=n[1][1],tt[1][5]=n[1][2],tt[2][0]=n[2][2]*r,tt[2][1]=-n[2][2]*i,tt[2][2]=n[2][1]*i-n[2][0]*r,tt[2][3]=n[2][0],tt[2][4]=n[2][1],tt[2][5]=n[2][2];let u=[[],[]];for(let h=0;h<2;h++)for(let f=0;f<6;f++){u[h][f]=0;for(let m=0;m<3;m++)u[h][f]+=Lt[h][m]*tt[m][f]}return u}});var Qs={};hn(Qs,{Estimator:()=>fe});var fe,rs=W(()=>{"use strict";Ci();Ui();fe=class{constructor(t){this.projectionTransform=t}estimate({screenCoords:t,worldCoords:s}){return _i({screenCoords:t,worldCoords:s,projectionTransform:this.projectionTransform})}refineEstimate({initialModelViewTransform:t,worldCoords:s,screenCoords:e}){return Ai({initialModelViewTransform:t,worldCoords:s,screenCoords:e,projectionTransform:this.projectionTransform})}}});var la={};var Fi,tn,Pi,en,Di,Oi,Li=W(()=>{"use strict";Zs();rs();ps();Ve();Fi=null,tn=!1,Pi=null,en=null,Di=null,Oi=null;onmessage=o=>{let{data:t}=o;switch(t.type){case"setup":Fi=t.matchingDataList,tn=t.debugMode,Pi=new ue(t.inputWidth,t.inputHeight,tn),en=new fe(t.projectionTransform),t.trackingDataList&&t.markerDimensions&&(Di=new zt(t.markerDimensions,t.trackingDataList,t.projectionTransform,t.inputWidth,t.inputHeight,tn)),Oi=new Tt(t.inputWidth,t.inputHeight,{useLSH:!0,maxFeaturesPerBucket:24});break;case"match":let s=t.targetIndexes,e=-1,n=null,i=null,r=null,a=null,c=t.featurePoints;t.inputData&&(c=Oi.detect(t.inputData,{octavesToProcess:t.octavesToProcess}).featurePoints);for(let x=0;x<s.length;x++){let M=s[x],{keyframeIndex:E,screenCoords:I,worldCoords:S,debugExtra:k}=Pi.matchDetection(Fi[M],c,t.expectedScale);if(a=k,E!==-1){let T=en.estimate({screenCoords:I,worldCoords:S});T&&(e=M,n=T,i=I,r=S);break}}postMessage({type:"matchDone",targetIndex:e,modelViewTransform:n,screenCoords:i,worldCoords:r,featurePoints:c,debugExtra:a});break;case"track":let{inputData:l,lastModelViewTransform:u,targetIndex:h}=t,f=Di.track(l,u,h);postMessage({type:"trackDone",targetIndex:h,...f});break;case"trackUpdate":let{modelViewTransform:m,worldCoords:d,screenCoords:p,stabilities:w}=t,g=en.refineEstimate({initialModelViewTransform:m,worldCoords:d,screenCoords:p,stabilities:w});postMessage({type:"trackUpdateDone",modelViewTransform:g});break;case"dispose":close();break;default:throw new Error(`Invalid message type '${t.type}'`)}}});ps();var Ee=class{constructor(t,s){if(this.width=t,this.height=s,this.grayscaleBuffer=new Uint8Array(t*s),typeof document<"u"){let e=document.createElement("canvas");e.width=t,e.height=s,this.context=e.getContext("2d",{willReadFrequently:!0,alpha:!1})}}loadInput(t){if(t instanceof Uint8Array&&t.length===this.width*this.height)return t;if(typeof ImageData<"u"&&t instanceof ImageData)return this._convertToGrayscale(t.data,t.width,t.height),this.grayscaleBuffer;if(this.context){this.context.clearRect(0,0,this.width,this.height);let s=t.width===this.height&&t.height===this.width,e=s?t.height:t.width,n=s?t.width:t.height,i=e/n,r=this.width/this.height,a=0,c=0,l=e,u=n;i>r?(l=n*r,a=(e-l)/2):i<r&&(u=e/r,c=(n-u)/2),s?(this.context.save(),this.context.translate(this.width/2,this.height/2),this.context.rotate(Math.PI/2),this.context.drawImage(t,a,c,l,u,-this.height/2,-this.width/2,this.height,this.width),this.context.restore()):this.context.drawImage(t,a,c,l,u,0,0,this.width,this.height);let h=this.context.getImageData(0,0,this.width,this.height);return this._convertToGrayscale(h.data,this.width,this.height),this.grayscaleBuffer}if(t.data&&t.data instanceof Uint8Array)return this._convertToGrayscale(t.data,t.width||this.width,t.height||this.height),this.grayscaleBuffer;throw new Error("Input no soportado o entorno sin Canvas")}_convertToGrayscale(t,s,e){let n=this.grayscaleBuffer,i=s*e;for(let r=0;r<i;r++){let a=r<<2;n[r]=t[a]*77+t[a+1]*150+t[a+2]*29>>8}}};var ke=class{features=[];addFeature(t){this.features.push(t)}getFeature(t){return this.features.find(s=>s.id===t)}init(t){for(let s of this.features)s.enabled&&s.init&&s.init(t)}beforeProcess(t){for(let s of this.features)s.enabled&&s.beforeProcess&&s.beforeProcess(t)}applyWorldMatrixFilters(t,s,e){let n=s;for(let i of this.features)i.enabled&&i.filterWorldMatrix&&(n=i.filterWorldMatrix(t,n,e));return n}shouldShow(t,s){let e=s;for(let n of this.features)n.enabled&&n.shouldShow&&(e=n.shouldShow(t,s));return e}notifyUpdate(t){for(let s of this.features)s.enabled&&s.onUpdate&&s.onUpdate(t)}dispose(){for(let t of this.features)t.dispose&&t.dispose()}};var Ie=class{constructor(t,s=0){this.y=s,this.s=s,this.alpha=t}setAlpha(t){t<=0||t>1||(this.alpha=t)}filter(t){return this.y=t,this.s=this.alpha*t+(1-this.alpha)*this.s,this.s}filterWithAlpha(t,s){return this.setAlpha(s),this.filter(t)}lastValue(){return this.y}},ve=class{constructor({minCutOff:t=1,beta:s=0,dCutOff:e=1}){this.minCutOff=t,this.beta=s,this.dCutOff=e,this.x=null,this.dx=null,this.lastTime=null}_alpha(t,s){return 1/(1+1/(2*Math.PI*t)/s)}reset(){this.lastTime=null,this.x=null,this.dx=null}filter(t,s){if(this.lastTime===null||this.x===null)return this.lastTime=t,this.x=s.map(i=>new Ie(this._alpha(this.minCutOff,1),i)),this.dx=s.map(i=>new Ie(this._alpha(this.dCutOff,1),0)),s;let e=(t-this.lastTime)/1e3;if(e<=0)return s;this.lastTime=t;let n=[];for(let i=0;i<s.length;i++){let r=(s[i]-this.x[i].lastValue())/e,a=this._alpha(this.dCutOff,e),c=this.dx[i].filterWithAlpha(r,a),l=this.minCutOff+this.beta*Math.abs(c),u=this._alpha(l,e);n[i]=this.x[i].filterWithAlpha(s[i],u)}return n}};var Te=class{id="one-euro-filter";name="One Euro Filter";description="Smooths the tracking matrix to reduce jitter using a One Euro Filter.";enabled=!0;filters=[];minCutOff;beta;constructor(t=.5,s=.1){this.minCutOff=t,this.beta=s}init(t){}getFilter(t){return this.filters[t]||(this.filters[t]=new ve({minCutOff:this.minCutOff,beta:this.beta})),this.filters[t]}filterWorldMatrix(t,s,e){if(!this.enabled)return s;let n=this.getFilter(t),i=e?.stability??1,r=this.minCutOff*(.05+Math.pow(i,2)*.95);return n.minCutOff=r,n.beta=this.beta,n.filter(Date.now(),s)}onUpdate(t){t.type==="reset"&&t.targetIndex!==void 0&&this.filters[t.targetIndex]?.reset()}};var _e=class{id="temporal-filter";name="Temporal Filter";description="Provides warmup tolerance (to avoid false positives) and miss tolerance (to maintain tracking during brief occlusions).";enabled=!0;states=[];warmupTolerance;missTolerance;onToggleShowing;constructor(t=2,s=5,e){this.warmupTolerance=t,this.missTolerance=s,this.onToggleShowing=e}getState(t){return this.states[t]||(this.states[t]={showing:!1,trackCount:0,trackMiss:0}),this.states[t]}shouldShow(t,s){if(!this.enabled)return s;let e=this.getState(t);return e.showing?s?e.trackMiss=0:(e.trackCount=0,e.trackMiss+=1,e.trackMiss>this.missTolerance&&(e.showing=!1,this.onToggleShowing?.(t,!1))):s?(e.trackMiss=0,e.trackCount+=1,e.trackCount>this.warmupTolerance&&(e.showing=!0,this.onToggleShowing?.(t,!0))):e.trackCount=0,e.showing}};var Ce=class{id="auto-rotation";name="Auto Rotation Matrix";description="Automatically adjusts the world matrix if the input video is rotated (e.g. portrait mode).";enabled=!0;inputWidth=0;inputHeight=0;init(t){this.inputWidth=t.inputWidth,this.inputHeight=t.inputHeight}filterWorldMatrix(t,s){return this.enabled,s}rotate(t){return[-t[1],t[0],t[2],t[3],-t[5],t[4],t[6],t[7],-t[9],t[8],t[10],t[11],-t[13],t[12],t[14],t[15]]}};Ve();qe();Pt();var nn,ha=async()=>{if(typeof Worker>"u")return null;try{return(await Promise.resolve().then(()=>(Li(),la))).default}catch{return null}};nn=await ha();var ua=X.ONE_EURO_FILTER_CUTOFF,fa=X.ONE_EURO_FILTER_BETA,da=X.WARMUP_TOLERANCE,ma=X.MISS_TOLERANCE,sn=1e3,Ni=0,as=class{inputWidth;inputHeight;maxTrack;inputLoader;markerDimensions=null;onUpdate;debugMode;processingVideo=!1;interestedTargetIndex=-1;trackingStates=[];worker;projectionTransform;projectionMatrix;tracker=null;matchingDataList;workerMatchDone=null;workerTrackDone=null;workerFullTrackDone=null;mainThreadMatcher;mainThreadEstimator;featureManager;fullDetector=null;constructor({inputWidth:t,inputHeight:s,onUpdate:e=null,debugMode:n=!1,maxTrack:i=1,warmupTolerance:r=null,missTolerance:a=null,filterMinCF:c=null,filterBeta:l=null,worker:u=null}){this.inputWidth=t,this.inputHeight=s,this.maxTrack=i,this.featureManager=new ke,this.featureManager.addFeature(new Te(c===null?ua:c,l===null?fa:l)),this.featureManager.addFeature(new _e(r===null?da:r,a===null?ma:a)),this.featureManager.addFeature(new Ce),this.inputLoader=new Ee(this.inputWidth,this.inputHeight),this.onUpdate=e,this.debugMode=n,this.worker=u,this.worker&&this._setupWorkerListener(),this.fullDetector=new Tt(this.inputWidth,this.inputHeight,{useLSH:X.USE_LSH,maxFeaturesPerBucket:X.MAX_FEATURES_PER_BUCKET}),this.featureManager.init({inputWidth:this.inputWidth,inputHeight:this.inputHeight,projectionTransform:[],debugMode:this.debugMode});let h=X.DEFAULT_NEAR,f=X.DEFAULT_FAR,m=X.DEFAULT_FOVY*Math.PI/180,d=this.inputHeight/2/Math.tan(m/2);this.projectionTransform=[[d,0,this.inputWidth/2],[0,d,this.inputHeight/2],[0,0,1]],this.featureManager.init({inputWidth:this.inputWidth,inputHeight:this.inputHeight,projectionTransform:this.projectionTransform,debugMode:this.debugMode}),this.projectionMatrix=this._glProjectionMatrix({projectionTransform:this.projectionTransform,width:this.inputWidth,height:this.inputHeight,near:h,far:f})}_setupWorkerListener(){this.worker&&(this.worker.onmessage=t=>{t.data.type==="matchDone"&&this.workerMatchDone!==null&&this.workerMatchDone(t.data),t.data.type==="trackDone"&&this.workerFullTrackDone!==null&&this.workerFullTrackDone(t.data),t.data.type==="trackUpdateDone"&&this.workerTrackDone!==null&&this.workerTrackDone(t.data)})}_ensureWorker(){this.worker||nn&&typeof Worker<"u"&&(this.worker=new nn,this._setupWorkerListener())}async addImageTargets(t){let s=Array.isArray(t)?t:[t],e=await Promise.all(s.map(async n=>(await fetch(n)).arrayBuffer()));return this.addImageTargetsFromBuffers(e)}addImageTargetsFromBuffers(t){let s=[],e=[],n=[];for(let i of t){let a=ze(i).dataList||[];for(let c of a)e.push(c.matchingData),s.push(c.trackingData),n.push([c.targetImage.width,c.targetImage.height])}return this.tracker=new zt(n,s,this.projectionTransform,this.inputWidth,this.inputHeight,this.debugMode),this._ensureWorker(),this.worker&&this.worker.postMessage({type:"setup",inputWidth:this.inputWidth,inputHeight:this.inputHeight,projectionTransform:this.projectionTransform,debugMode:this.debugMode,matchingDataList:e,trackingDataList:s,markerDimensions:n}),this.markerDimensions=n,this.matchingDataList=e,{dimensions:n,matchingDataList:e,trackingDataList:s}}addImageTargetsFromBuffer(t){return this.addImageTargetsFromBuffers([t])}dispose(){this.stopProcessVideo(),this.worker&&(this.worker.postMessage({type:"dispose"}),this.worker=null)}dummyRun(t){let s=this.inputLoader.loadInput(t);this.fullDetector?.detect(s),this.tracker.dummyRun(s)}getProjectionMatrix(){return this.projectionMatrix}getRotatedZ90Matrix(t){return[-t[1],t[0],t[2],t[3],-t[5],t[4],t[6],t[7],-t[9],t[8],t[10],t[11],-t[13],t[12],t[14],t[15]]}getWorldMatrix(t,s){return this._glModelViewMatrix(t,s)}async _detectAndMatch(t,s){let e;for(let l of this.trackingStates)if(l.isTracking&&l.currentModelViewTransform){let u=l.currentModelViewTransform;e=Math.sqrt(u[0][0]**2+u[1][0]**2+u[2][0]**2);break}let{targetIndex:n,modelViewTransform:i,screenCoords:r,worldCoords:a,featurePoints:c}=await this._workerMatch(null,s,t,e);return{targetIndex:n,modelViewTransform:i,screenCoords:r,worldCoords:a,featurePoints:c}}async _trackAndUpdate(t,s,e){let{worldCoords:n,screenCoords:i,reliabilities:r,indices:a=[],octaveIndex:c=0,deformedMesh:l}=await this._workerTrack(t,s,e);if(!n||n.length===0)return{modelViewTransform:null,screenCoords:[],reliabilities:[],stabilities:[],deformedMesh:null};let u=this.trackingStates[e];if(u.pointStabilities||(u.pointStabilities=[]),u.lastScreenCoords||(u.lastScreenCoords=[]),!u.pointStabilities[c]){let I=this.tracker.prebuiltData[e][c].px.length;u.pointStabilities[c]=new Float32Array(I).fill(0),u.lastScreenCoords[c]=new Array(I).fill(null)}let h=u.pointStabilities[c],f=u.lastScreenCoords[c];for(let I=0;I<h.length;I++)if(a.includes(I)){let k=a.indexOf(I);h[I]=Math.min(1,h[I]+.4),f[I]=i[k]}else h[I]=Math.max(0,h[I]-.08);let m=[],d=[],p=[],w=[];for(let I=0;I<h.length;I++)if(h[I]>0){let S=a.includes(I);if(m.push({x:f[I].x,y:f[I].y,id:I}),p.push(h[I]),S){let k=a.indexOf(I);d.push(r[k]),w.push(n[k])}else d.push(0)}let g=u.trackCount<15;return w.length<(g?4:5)?{modelViewTransform:null,screenCoords:m,reliabilities:d,stabilities:p}:(u.trackCount++,{modelViewTransform:await this._workerTrackUpdate(s,{worldCoords:w,screenCoords:w.map((I,S)=>{let k=a[S];return f[k]}),stabilities:w.map((I,S)=>{let k=a[S];return h[k]}),deformedMesh:l}),screenCoords:m,reliabilities:d,stabilities:p,deformedMesh:l,octaveIndex:c})}processVideo(t){if(this.processingVideo)return;this.processingVideo=!0;let s=++Ni;this.trackingStates=[];for(let n=0;n<(this.markerDimensions?.length||0);n++)this.trackingStates.push({showing:!1,isTracking:!1,currentModelViewTransform:null,trackCount:0,trackMiss:0});(async()=>{for(;!(!this.processingVideo||s!==Ni);){let n=this.inputLoader.loadInput(t);if(this.trackingStates.reduce((r,a)=>r+(a.isTracking?1:0),0)<this.maxTrack){let r=[];for(let u=0;u<this.trackingStates.length;u++)this.trackingStates[u].isTracking!==!0&&(this.interestedTargetIndex!==-1&&this.interestedTargetIndex!==u||r.push(u));let{targetIndex:a,modelViewTransform:c,featurePoints:l}=await this._detectAndMatch(n,r);a!==-1&&(this.trackingStates[a].isTracking=!0,this.trackingStates[a].currentModelViewTransform=c),this.onUpdate&&this.onUpdate({type:"featurePoints",featurePoints:l})}for(let r=0;r<this.trackingStates.length;r++){let a=this.trackingStates[r];if(a.isTracking){let l=await this._trackAndUpdate(n,a.currentModelViewTransform,r);l===null||l.modelViewTransform===null?(a.isTracking=!1,a.screenCoords=l?.screenCoords||[],a.reliabilities=l?.reliabilities||[],a.stabilities=l?.stabilities||[]):(a.currentModelViewTransform=l.modelViewTransform,a.screenCoords=l.screenCoords,a.reliabilities=l.reliabilities,a.stabilities=l.stabilities,a.deformedMesh=l.deformedMesh)}let c=a.showing;if(a.showing=this.featureManager.shouldShow(r,a.isTracking),c&&!a.showing&&(a.trackingMatrix=null,this.featureManager.notifyUpdate({type:"reset",targetIndex:r})),a.showing||a.screenCoords&&a.screenCoords.length>0||c&&!a.showing){let l=a.showing?this._glModelViewMatrix(a.currentModelViewTransform,r):null,u=null;if(l){let h=a.stabilities||[],f=h.length>0?h.reduce((p,w)=>p+w,0)/h.length:0,m=this.featureManager.applyWorldMatrixFilters(r,l,{stability:f});if(a.trackingMatrix=m,u=[...m],t.width===this.inputHeight&&t.height===this.inputWidth){let p=this.featureManager.getFeature("auto-rotation");p&&(u=p.rotate(u))}}this.onUpdate&&this.onUpdate({type:"updateMatrix",targetIndex:r,worldMatrix:u,modelViewTransform:a.currentModelViewTransform,screenCoords:a.screenCoords,reliabilities:a.reliabilities,stabilities:a.stabilities,deformedMesh:a.deformedMesh})}}this.onUpdate&&this.onUpdate({type:"processDone"}),typeof requestAnimationFrame<"u"?await new Promise(requestAnimationFrame):await new Promise(r=>setTimeout(r,16))}})()}stopProcessVideo(){this.processingVideo=!1}async detect(t){let s=this.inputLoader.loadInput(t),{featurePoints:e}=this.fullDetector.detect(s);return{featurePoints:e,debugExtra:{}}}async match(t,s){let{targetIndex:e,modelViewTransform:n,screenCoords:i,worldCoords:r,debugExtra:a}=await this._workerMatch(t,[s]);return{targetIndex:e,modelViewTransform:n,screenCoords:i,worldCoords:r,debugExtra:a}}async track(t,s,e){let n=this.inputLoader.loadInput(t);return this.tracker.track(n,s,e)}async trackUpdate(t,s){return s.worldCoords.length<4?null:this._workerTrackUpdate(t,s)}_workerMatch(t,s,e=null,n){return new Promise(i=>{if(!this.worker){let a;!t&&e?a=Promise.resolve(this.fullDetector.detect(e).featurePoints):a=Promise.resolve(t),a.then(c=>{this._matchOnMainThread(c,s,n).then(i)}).catch(()=>i({targetIndex:-1}));return}let r=setTimeout(()=>{this.workerMatchDone=null,i({targetIndex:-1})},sn);this.workerMatchDone=a=>{clearTimeout(r),this.workerMatchDone=null,i({targetIndex:a.targetIndex,modelViewTransform:a.modelViewTransform,screenCoords:a.screenCoords,worldCoords:a.worldCoords,featurePoints:a.featurePoints,debugExtra:a.debugExtra})},e?this.worker.postMessage({type:"match",inputData:e,targetIndexes:s,expectedScale:n}):this.worker.postMessage({type:"match",featurePoints:t,targetIndexes:s,expectedScale:n})})}_workerTrack(t,s,e){return new Promise(n=>{if(!this.worker){n(this.tracker.track(t,s,e));return}let i=setTimeout(()=>{this.workerFullTrackDone=null,n({worldCoords:[],screenCoords:[],reliabilities:[]})},sn);this.workerFullTrackDone=r=>{clearTimeout(i),this.workerFullTrackDone=null,n(r)},this.worker.postMessage({type:"track",inputData:t,lastModelViewTransform:s,targetIndex:e})})}async _matchOnMainThread(t,s,e){if(!this.mainThreadMatcher){let{Matcher:l}=await Promise.resolve().then(()=>(Zs(),Ii)),{Estimator:u}=await Promise.resolve().then(()=>(rs(),Qs));this.mainThreadMatcher=new l(this.inputWidth,this.inputHeight,this.debugMode),this.mainThreadEstimator=new u(this.projectionTransform)}let n=-1,i=null,r=null,a=null,c=null;for(let l=0;l<s.length;l++){let u=s[l],{keyframeIndex:h,screenCoords:f,worldCoords:m,debugExtra:d}=this.mainThreadMatcher.matchDetection(this.matchingDataList[u],t,e);if(c=d,h!==-1){let p=this.mainThreadEstimator.estimate({screenCoords:f,worldCoords:m});p&&(n=u,i=p,r=f,a=m);break}}return{targetIndex:n,modelViewTransform:i,screenCoords:r,worldCoords:a,debugExtra:c}}_workerTrackUpdate(t,s){return new Promise(e=>{if(!this.worker){this._trackUpdateOnMainThread(t,s).then(e).catch(()=>e(null));return}let n=setTimeout(()=>{this.workerTrackDone=null,e(null)},sn);this.workerTrackDone=c=>{clearTimeout(n),this.workerTrackDone=null,e(c.modelViewTransform)};let{worldCoords:i,screenCoords:r,stabilities:a}=s;this.worker.postMessage({type:"trackUpdate",modelViewTransform:t,worldCoords:i,screenCoords:r,stabilities:a})})}async _trackUpdateOnMainThread(t,s){if(!this.mainThreadEstimator){let{Estimator:r}=await Promise.resolve().then(()=>(rs(),Qs));this.mainThreadEstimator=new r(this.projectionTransform)}let{worldCoords:e,screenCoords:n,stabilities:i}=s;return this.mainThreadEstimator.refineEstimate({initialModelViewTransform:t,worldCoords:e,screenCoords:n,stabilities:i})}_glModelViewMatrix(t,s){return[t[0][0],-t[1][0],-t[2][0],0,t[0][1],-t[1][1],-t[2][1],0,t[0][2],-t[1][2],-t[2][2],0,t[0][3],-t[1][3],-t[2][3],1]}_glProjectionMatrix({projectionTransform:t,width:s,height:e,near:n,far:i}){let r=[[2*t[0][0]/s,0,-(2*t[0][2]/s-1),0],[0,2*t[1][1]/e,-(2*t[1][2]/e-1),0],[0,0,-(i+n)/(i-n),-2*i*n/(i-n)],[0,0,-1,0]],a=[];for(let c=0;c<4;c++)for(let l=0;l<4;l++)a.push(r[l][c]);return a}};var de=class{constructor(t,s,e){this.width=t,this.height=s,this.config=e,this.minDim=Math.min(t,s),this.foveaRadius=Math.floor(this.minDim*e.FOVEA_RADIUS_RATIO),this.parafoveaRadius=Math.floor(this.minDim*e.PARAFOVEA_RADIUS_RATIO),this._initBuffers()}_initBuffers(){let t=this.foveaRadius*2;this.foveaBuffer=new Uint8Array(t*t);let s=this.parafoveaRadius*2,e=Math.ceil(s*this.config.PARAFOVEA_RESOLUTION);this.parafoveaBuffer=new Uint8Array(e*e);let n=Math.ceil(this.width*this.config.PERIPHERY_RESOLUTION),i=Math.ceil(this.height*this.config.PERIPHERY_RESOLUTION);this.peripheryBuffer=new Uint8Array(n*i),this.peripheryDims={width:n,height:i},this._buildCircularMask()}_buildCircularMask(){let t=this.foveaRadius,s=t*2;this.circularMask=new Uint8Array(s*s);for(let e=0;e<s;e++)for(let n=0;n<s;n++){let i=n-t,r=e-t,a=Math.sqrt(i*i+r*r);this.circularMask[e*s+n]=a<=t?1:0}}extract(t,s,e,n=0){return s=Math.max(this.foveaRadius,Math.min(this.width-this.foveaRadius-1,s)),e=Math.max(this.foveaRadius,Math.min(this.height-this.foveaRadius-1,e)),n===0?this._extractFovea(t,s,e):n===1?this._extractParafovea(t,s,e):this._extractPeriphery(t)}_extractFovea(t,s,e){let n=this.foveaRadius,i=n*2,r=this.foveaBuffer,a=0,c=0;for(let l=-n;l<n;l++){let h=(e+l)*this.width;for(let f=-n;f<n;f++){let m=(l+n)*i+(f+n);if(this.circularMask[m]){let d=s+f;r[a]=t[h+d],c++}else r[a]=0;a++}}return{x:s,y:e,radius:n,resolution:this.config.FOVEA_RESOLUTION,data:r,width:i,height:i,pixelCount:c,type:"fovea",toOriginalCoord:(l,u)=>({x:s-n+l,y:e-n+u}),toLocalCoord:(l,u)=>({x:l-(s-n),y:u-(e-n)})}}_extractParafovea(t,s,e){let n=this.parafoveaRadius,i=this.config.PARAFOVEA_RESOLUTION,a=Math.ceil(n*i)*2,c=this.parafoveaBuffer,l=Math.round(1/i),u=0,h=0;for(let f=0;f<a;f++){let m=e-n+Math.floor(f/i);if(m<0||m>=this.height)continue;let d=m*this.width;for(let p=0;p<a;p++){let w=s-n+Math.floor(p/i);if(w<0||w>=this.width){c[u++]=0;continue}c[u++]=t[d+w],h++}}return{x:s,y:e,radius:n,resolution:i,data:c,width:a,height:a,pixelCount:h,type:"parafovea",toOriginalCoord:(f,m)=>({x:s-n+f/i,y:e-n+m/i}),toLocalCoord:(f,m)=>({x:(f-(s-n))*i,y:(m-(e-n))*i})}}_extractPeriphery(t){let s=this.config.PERIPHERY_RESOLUTION,e=this.peripheryDims.width,n=this.peripheryDims.height,i=this.peripheryBuffer,r=Math.round(1/s),a=0;for(let c=0;c<this.height;c+=r){let l=c*this.width;for(let u=0;u<this.width;u+=r)a<i.length&&(i[a++]=t[l+u])}return{x:this.width/2,y:this.height/2,radius:Math.max(this.width,this.height)/2,resolution:s,data:i,width:e,height:n,pixelCount:e*n,type:"periphery",toOriginalCoord:(c,l)=>({x:c/s,y:l/s}),toLocalCoord:(c,l)=>({x:c*s,y:l*s})}}extractMultiResolution(t,s,e){return{fovea:this._extractFovea(t,s,e),parafovea:this._extractParafovea(t,s,e),periphery:this._extractPeriphery(t),center:{x:s,y:e},totalPixels:this._computeTotalPixels(),originalPixels:this.width*this.height}}_computeTotalPixels(){let t=Math.PI*this.foveaRadius**2,s=Math.PI*this.parafoveaRadius**2*this.config.PARAFOVEA_RESOLUTION**2,e=this.peripheryDims.width*this.peripheryDims.height;return Math.ceil(t+s+e)}configure(t){this.config={...this.config,...t},this.foveaRadius=Math.floor(this.minDim*t.FOVEA_RADIUS_RATIO),this.parafoveaRadius=Math.floor(this.minDim*t.PARAFOVEA_RADIUS_RATIO),this._initBuffers()}};var me=class{constructor(t,s,e){this.width=t,this.height=s,this.config=e,this.recentTargets=[],this.inhibitionRadius=Math.min(t,s)*.1,this.velocityHistory=[],this.lastCenter={x:t/2,y:s/2},this.gridCells=this._buildCoverageGrid(3,3),this.lastVisitedCell=4,this.lastSaccadeTime=0,this.saccadeCount=0}_buildCoverageGrid(t,s){let e=[],n=this.width/s,i=this.height/t;for(let r=0;r<t;r++)for(let a=0;a<s;a++)e.push({x:n*(a+.5),y:i*(r+.5),index:r*s+a,lastVisit:0});return e}computeTargets(t,s,e=null){let n=[],i=this.config.MAX_SACCADES_PER_FRAME;if(e&&e.isTracking){let r=this._predictTrackingCenter(e);r&&n.push({x:r.x,y:r.y,priority:0,reason:"tracking_prediction",saliency:1})}if(t&&t.peaks)for(let r of t.peaks){if(n.length>=i)break;this._isInhibited(r.x,r.y,n)||r.value>this.config.SALIENCY_THRESHOLD&&n.push({x:r.x,y:r.y,priority:n.length,reason:"saliency_peak",saliency:r.value})}if(!e?.isTracking&&n.length<i){let r=this._getNextGridCell();r&&!this._isInhibited(r.x,r.y,n)&&n.push({x:r.x,y:r.y,priority:n.length,reason:"grid_search",saliency:.5})}return n.length===0&&n.push({x:s.x,y:s.y,priority:0,reason:"maintain_position",saliency:.3}),this._updateHistory(n),n}_predictTrackingCenter(t){if(!t.worldMatrix)return null;let s=t.worldMatrix,e=s[12]||this.width/2,n=s[13]||this.height/2;if(this.velocityHistory.length>=2){let i=this._computeAverageVelocity("x"),r=this._computeAverageVelocity("y");return{x:Math.max(0,Math.min(this.width-1,e+i)),y:Math.max(0,Math.min(this.height-1,n+r))}}return{x:e,y:n}}_computeAverageVelocity(t){if(this.velocityHistory.length<2)return 0;let s=0;for(let e=1;e<this.velocityHistory.length;e++)s+=this.velocityHistory[e][t]-this.velocityHistory[e-1][t];return s/(this.velocityHistory.length-1)}_isInhibited(t,s,e){let n=this.inhibitionRadius**2;for(let i of e){let r=t-i.x,a=s-i.y;if(r*r+a*a<n)return!0}for(let i of this.recentTargets){let r=t-i.x,a=s-i.y;if(r*r+a*a<n)return!0}return!1}_getNextGridCell(){let t=this.gridCells[0],s=1/0;for(let e of this.gridCells)e.lastVisit<s&&(s=e.lastVisit,t=e);return t.lastVisit=Date.now(),t}_updateHistory(t){this.recentTargets.push(...t);let s=this.config.MOTION_HISTORY_FRAMES*this.config.MAX_SACCADES_PER_FRAME;for(;this.recentTargets.length>s;)this.recentTargets.shift();if(t.length>0){for(this.velocityHistory.push({x:t[0].x,y:t[0].y});this.velocityHistory.length>this.config.MOTION_HISTORY_FRAMES;)this.velocityHistory.shift();this.lastCenter={x:t[0].x,y:t[0].y}}this.saccadeCount+=t.length,this.lastSaccadeTime=Date.now()}getPredictedLocation(){if(this.velocityHistory.length>=2){let t=this._computeAverageVelocity("x"),s=this._computeAverageVelocity("y");return{x:Math.max(0,Math.min(this.width-1,this.lastCenter.x+t)),y:Math.max(0,Math.min(this.height-1,this.lastCenter.y+s))}}return this.lastCenter}reset(){this.recentTargets=[],this.velocityHistory=[],this.lastCenter={x:this.width/2,y:this.height/2},this.saccadeCount=0;for(let t of this.gridCells)t.lastVisit=0}configure(t){this.config={...this.config,...t},this.inhibitionRadius=Math.min(this.width,this.height)*.1}};var ge=class{constructor(t,s,e){this.width=t,this.height=s,this.config=e,this.frameHistory=[],this.stateHistory=[],this.motionModel={vx:0,vy:0,vtheta:0,vscale:0,confidence:0},this.blockSize=8,this.blocksX=Math.ceil(t/this.blockSize),this.blocksY=Math.ceil(s/this.blockSize),this.blockMeans=new Float32Array(this.blocksX*this.blocksY),this.prevBlockMeans=new Float32Array(this.blocksX*this.blocksY),this.consecutiveSkips=0,this.maxConsecutiveSkips=10}predict(t,s){if(this.frameHistory.length<2)return{canSkip:!1,confidence:0,reason:"insufficient_history"};if(this.consecutiveSkips>=this.maxConsecutiveSkips)return{canSkip:!1,confidence:0,reason:"forced_refresh"};let e=this.getChangeLevel(t),n=s?.isTracking?this.config.CHANGE_THRESHOLD:this.config.CHANGE_THRESHOLD*.5,i=e<n,r=i?Math.min(1,(n-e)/n):0,a=null;return i&&s&&(a=this._predictState(s)),i&&this.consecutiveSkips++,{canSkip:i,confidence:r,changeLevel:e,predictedState:a,reason:i?"low_change":"significant_change"}}getChangeLevel(t){if(this.frameHistory.length===0)return 1;this._computeBlockMeans(t,this.blockMeans);let s=0,e=0,n=this.blocksX*this.blocksY;for(let a=0;a<n;a++){let c=Math.abs(this.blockMeans[a]-this.prevBlockMeans[a])/255;s+=c,e=Math.max(e,c)}let r=s/n*.7+e*.3;return Math.min(1,r)}_computeBlockMeans(t,s){let e=this.blockSize,n=this.width;for(let i=0;i<this.blocksY;i++){let r=i*e,a=Math.min(r+e,this.height);for(let c=0;c<this.blocksX;c++){let l=c*e,u=Math.min(l+e,this.width),h=0,f=0;for(let m=r;m<a;m++){let d=m*n;for(let p=l;p<u;p++)h+=t[d+p],f++}s[i*this.blocksX+c]=h/f}}}_predictState(t){if(!t.worldMatrix)return null;let s=t.worldMatrix,e=new Float32Array(16);for(let i=0;i<16;i++)e[i]=s[i];e[12]+=this.motionModel.vx,e[13]+=this.motionModel.vy;let n=1+this.motionModel.vscale;return e[0]*=n,e[5]*=n,e[10]*=n,{worldMatrix:e,isTracking:!0,isPredicted:!0,predictionConfidence:this.motionModel.confidence}}storeFrame(t,s){for(let e=0;e<this.blockMeans.length;e++)this.prevBlockMeans[e]=this.blockMeans[e];if(this._computeBlockMeans(t,this.blockMeans),s?.worldMatrix)for(this.stateHistory.push({timestamp:Date.now(),matrix:new Float32Array(s.worldMatrix)}),this._updateMotionModel();this.stateHistory.length>this.config.MOTION_HISTORY_FRAMES;)this.stateHistory.shift();for(this.consecutiveSkips=0,this.frameHistory.push(Date.now());this.frameHistory.length>this.config.MOTION_HISTORY_FRAMES;)this.frameHistory.shift()}_updateMotionModel(){let t=this.stateHistory;if(t.length<2){this.motionModel.confidence=0;return}let s=t.length,e=t[s-1].matrix,n=t[s-2].matrix,i=(t[s-1].timestamp-t[s-2].timestamp)/1e3;if(i>0){this.motionModel.vx=(e[12]-n[12])/i*.016,this.motionModel.vy=(e[13]-n[13])/i*.016;let r=(Math.abs(n[0])+Math.abs(n[5]))/2,a=(Math.abs(e[0])+Math.abs(e[5]))/2;if(this.motionModel.vscale=(a-r)/r/i*.016,t.length>=3){let c=t[s-3].matrix,l=(n[12]-c[12])/i*.016,u=(n[13]-c[13])/i*.016,h=Math.abs(this.motionModel.vx-l),f=Math.abs(this.motionModel.vy-u),m=Math.sqrt(h*h+f*f);this.motionModel.confidence=Math.max(0,1-m/10)}else this.motionModel.confidence=.5}}isStaticScene(){return this.stateHistory.length<3?!1:Math.sqrt(this.motionModel.vx**2+this.motionModel.vy**2)<.5&&Math.abs(this.motionModel.vscale)<.01}reset(){this.frameHistory=[],this.stateHistory=[],this.consecutiveSkips=0,this.motionModel={vx:0,vy:0,vtheta:0,vscale:0,confidence:0},this.blockMeans.fill(0),this.prevBlockMeans.fill(0)}configure(t){this.config={...this.config,...t}}};var pe=class{constructor(t,s){this.width=t,this.height=s,this.scale=8,this.scaledW=Math.ceil(t/this.scale),this.scaledH=Math.ceil(s/this.scale),this.intensityMap=new Float32Array(this.scaledW*this.scaledH),this.contrastMap=new Float32Array(this.scaledW*this.scaledH),this.edgeMap=new Float32Array(this.scaledW*this.scaledH),this.saliencyBuffer=new Float32Array(this.scaledW*this.scaledH),this.maxPeaks=5,this.suppressionRadius=Math.max(this.scaledW,this.scaledH)*.15}compute(t){this._downsample(t),this._computeContrast(),this._computeEdges(),this._combineSaliency();let s=this._findPeaks();return{map:this.saliencyBuffer,width:this.scaledW,height:this.scaledH,peaks:s,maxSaliency:s.length>0?s[0].value:0}}_downsample(t){let s=this.scale,e=this.width;for(let n=0;n<this.scaledH;n++){let i=n*s,r=Math.min(i+s,this.height);for(let a=0;a<this.scaledW;a++){let c=a*s,l=Math.min(c+s,this.width),u=0,h=0;for(let f=i;f<r;f++){let m=f*e;for(let d=c;d<l;d++)u+=t[m+d],h++}this.intensityMap[n*this.scaledW+a]=u/h/255}}}_computeContrast(){let t=this.scaledW,s=this.scaledH,e=this.intensityMap,n=this.contrastMap;for(let i=1;i<s-1;i++)for(let r=1;r<t-1;r++){let a=i*t+r,c=e[a],l=0;l+=e[(i-1)*t+(r-1)],l+=e[(i-1)*t+r],l+=e[(i-1)*t+(r+1)],l+=e[i*t+(r-1)],l+=e[i*t+(r+1)],l+=e[(i+1)*t+(r-1)],l+=e[(i+1)*t+r],l+=e[(i+1)*t+(r+1)],l/=8,n[a]=Math.abs(c-l)}for(let i=0;i<s;i++)n[i*t]=0,n[i*t+t-1]=0;for(let i=0;i<t;i++)n[i]=0,n[(s-1)*t+i]=0}_computeEdges(){let t=this.scaledW,s=this.scaledH,e=this.intensityMap,n=this.edgeMap;for(let i=1;i<s-1;i++)for(let r=1;r<t-1;r++){let a=-e[(i-1)*t+(r-1)]+e[(i-1)*t+(r+1)]+-2*e[i*t+(r-1)]+2*e[i*t+(r+1)]+-e[(i+1)*t+(r-1)]+e[(i+1)*t+(r+1)],c=-e[(i-1)*t+(r-1)]-2*e[(i-1)*t+r]-e[(i-1)*t+(r+1)]+e[(i+1)*t+(r-1)]+2*e[(i+1)*t+r]+e[(i+1)*t+(r+1)];n[i*t+r]=Math.sqrt(a*a+c*c)/4}for(let i=0;i<s;i++)n[i*t]=0,n[i*t+t-1]=0;for(let i=0;i<t;i++)n[i]=0,n[(s-1)*t+i]=0}_combineSaliency(){let t=this.saliencyBuffer.length,s=this.contrastMap,e=this.edgeMap,n=this.saliencyBuffer;for(let r=0;r<t;r++)n[r]=s[r]*.6+e[r]*.4;let i=0;for(let r=0;r<t;r++)i=Math.max(i,n[r]);if(i>0)for(let r=0;r<t;r++)n[r]/=i}_findPeaks(){let t=this.scaledW,s=this.scaledH,e=this.saliencyBuffer,n=[],i=this.suppressionRadius,r=i*i,a=[];for(let c=1;c<s-1;c++)for(let l=1;l<t-1;l++){let u=c*t+l,h=e[u];h>e[(c-1)*t+(l-1)]&&h>e[(c-1)*t+l]&&h>e[(c-1)*t+(l+1)]&&h>e[c*t+(l-1)]&&h>e[c*t+(l+1)]&&h>e[(c+1)*t+(l-1)]&&h>e[(c+1)*t+l]&&h>e[(c+1)*t+(l+1)]&&a.push({x:l,y:c,value:h})}a.sort((c,l)=>l.value-c.value);for(let c of a){if(n.length>=this.maxPeaks)break;let l=!1;for(let u of n){let h=c.x-u.x,f=c.y-u.y;if(h*h+f*f<r){l=!0;break}}l||n.push({x:(c.x+.5)*this.scale,y:(c.y+.5)*this.scale,value:c.value})}return n}getSaliencyAt(t,s){let e=Math.floor(t/this.scale),n=Math.floor(s/this.scale);return e<0||e>=this.scaledW||n<0||n>=this.scaledH?0:this.saliencyBuffer[n*this.scaledW+e]}};var we=class{constructor(t,s={}){this.numOctaves=t,this.options={interleaveInterval:10,hysteresis:1,...s},this.frameCount=0,this.lastActiveOctave=-1,this.interleaveOctave=0}getOctavesToProcess(t=null){if(this.frameCount++,!t||!t.isTracking||t.activeOctave===void 0)return this.lastActiveOctave=-1,Array.from({length:this.numOctaves},(i,r)=>r);let s=t.activeOctave;this.lastActiveOctave=s;let e=new Set;for(let i=-this.options.hysteresis;i<=this.options.hysteresis;i++){let r=s+i;r>=0&&r<this.numOctaves&&e.add(r)}this.frameCount%this.options.interleaveInterval===0&&(this.interleaveOctave=(this.interleaveOctave+1)%this.numOctaves,e.has(this.interleaveOctave)&&(this.interleaveOctave=(this.interleaveOctave+1)%this.numOctaves),e.add(this.interleaveOctave),this.options.debug&&console.log(`[ScaleOrchestrator] Interleave check on octave ${this.interleaveOctave}`));let n=Array.from(e).sort((i,r)=>i-r);return this.options.debug&&console.log(`[ScaleOrchestrator] Active: ${s}, Processing: [${n.join(", ")}]`),n}reset(){this.frameCount=0,this.lastActiveOctave=-1}};var Bi={FOVEA_RADIUS_RATIO:.15,PARAFOVEA_RADIUS_RATIO:.3,FOVEA_RESOLUTION:1,PARAFOVEA_RESOLUTION:.5,PERIPHERY_RESOLUTION:.25,MAX_SACCADES_PER_FRAME:3,SACCADE_COOLDOWN_MS:50,SALIENCY_THRESHOLD:.3,CHANGE_THRESHOLD:.05,PREDICTION_CONFIDENCE:.8,MOTION_HISTORY_FRAMES:3,ENABLE_SKIP_FRAMES:!0,MIN_PROCESSING_INTERVAL_MS:8,NUM_OCTAVES:5},Gt=class{constructor(t,s,e={}){this.width=t,this.height=s,this.config={...Bi,...e},this.fovealAttention=new de(t,s,this.config),this.saccadicController=new me(t,s,this.config),this.predictiveCoding=new ge(t,s,this.config),this.saliencyMap=new pe(t,s),this.scaleOrchestrator=new we(this.config.NUM_OCTAVES,{debug:e.debugMode}),this.currentFoveaCenter={x:t/2,y:s/2},this.frameCount=0,this.lastProcessTime=0,this.skipCount=0,this.metrics={totalFrames:0,skippedFrames:0,avgPixelsProcessed:0,avgLatency:0,saccadeCount:0},this._initBuffers()}_initBuffers(){let t=this.width*this.height,s=Math.ceil(t*this.config.FOVEA_RADIUS_RATIO**2*Math.PI);this.outputBuffer={fovea:new Uint8Array(s),parafovea:new Uint8Array(Math.ceil(s*4)),periphery:new Uint8Array(Math.ceil(t*.25))},this.changeBuffer=new Float32Array(Math.ceil(t/64))}process(t,s=null){let e=performance.now();this.frameCount++,this.metrics.totalFrames++;let n=this.predictiveCoding.predict(t,s);if(n.canSkip&&this.config.ENABLE_SKIP_FRAMES)return this.metrics.skippedFrames++,this.skipCount++,{skipped:!0,prediction:n.predictedState,confidence:n.confidence,pixelsProcessed:0,latency:performance.now()-e};this.skipCount=0;let i=this.saliencyMap.compute(t),r=this.saccadicController.computeTargets(i,this.currentFoveaCenter,s),a=[],c=0;for(let h of r){let f=this.fovealAttention.extract(t,h.x,h.y,h.priority);a.push(f),c+=f.pixelCount,this.metrics.saccadeCount++}if(r.length>0){let h=r[0];this.currentFoveaCenter={x:h.x,y:h.y}}let l=this.scaleOrchestrator.getOctavesToProcess(s);this.predictiveCoding.storeFrame(t,s);let u=performance.now()-e;return this._updateMetrics(c,u),{skipped:!1,attentionRegions:a,foveaCenter:this.currentFoveaCenter,saliencyPeaks:i.peaks,octavesToProcess:l,pixelsProcessed:c,pixelsSaved:this.width*this.height-c,savingsPercent:((1-c/(this.width*this.height))*100).toFixed(1),latency:u}}getPrimaryRegion(t){return t.skipped||!t.attentionRegions?.length?null:t.attentionRegions[0]}suggestProcessing(t){let s=this.predictiveCoding.getChangeLevel(t);return{shouldProcessFull:s>.3,shouldProcessPartial:s>.05,canSkip:s<.02,changeLevel:s,recommendedSaccades:Math.ceil(s*this.config.MAX_SACCADES_PER_FRAME)}}_updateMetrics(t,s){this.metrics.avgPixelsProcessed=this.metrics.avgPixelsProcessed*(1-.1)+t*.1,this.metrics.avgLatency=this.metrics.avgLatency*(1-.1)+s*.1}getMetrics(){return{...this.metrics,skipRate:(this.metrics.skippedFrames/this.metrics.totalFrames*100).toFixed(1)+"%",avgSavings:((1-this.metrics.avgPixelsProcessed/(this.width*this.height))*100).toFixed(1)+"%",currentFovea:this.currentFoveaCenter}}reset(){this.currentFoveaCenter={x:this.width/2,y:this.height/2},this.frameCount=0,this.skipCount=0,this.predictiveCoding.reset(),this.saccadicController.reset()}configure(t){this.config={...this.config,...t},this.fovealAttention.configure(this.config),this.saccadicController.configure(this.config),this.predictiveCoding.configure(this.config)}};var cs=class extends as{bioEngine=null;bioEnabled=!0;bioMetricsInterval=null;lastBioResult=null;constructor(t){super(t);let s=t.bioInspired||{};if(this.bioEnabled=s.enabled!==!1,this.bioEnabled){let e={};s.foveaRadiusRatio!==void 0&&(e.FOVEA_RADIUS_RATIO=s.foveaRadiusRatio),s.maxSaccades!==void 0&&(e.MAX_SACCADES_PER_FRAME=s.maxSaccades),s.aggressiveSkipping!==void 0&&(e.ENABLE_SKIP_FRAMES=s.aggressiveSkipping,s.aggressiveSkipping&&(e.CHANGE_THRESHOLD=.03)),this.bioEngine=new Gt(t.inputWidth,t.inputHeight,e)}}processVideo(t){if(!this.bioEnabled||!this.bioEngine)return super.processVideo(t);if(this.processingVideo)return;this.processingVideo=!0,this.trackingStates=[];for(let e=0;e<(this.markerDimensions?.length||0);e++)this.trackingStates.push({showing:!1,isTracking:!1,currentModelViewTransform:null,trackCount:0,trackMiss:0});(async()=>{for(;this.processingVideo;){let e=this.inputLoader.loadInput(t),n=this.trackingStates.find(a=>a.isTracking),i=n?{isTracking:!0,activeOctave:n.lastOctaveIndex,worldMatrix:n.currentModelViewTransform?this._flattenMatrix(n.currentModelViewTransform):null}:null,r=this.bioEngine.process(e,i||void 0);this.lastBioResult=r,r.skipped&&n?.isTracking?this._handleSkippedFrame(n,r):await this._processWithAttention(t,e,r),typeof requestAnimationFrame<"u"?await new Promise(requestAnimationFrame):await new Promise(a=>setTimeout(a,16))}})()}_handleSkippedFrame(t,s){s.prediction&&s.prediction.worldMatrix&&(t.currentModelViewTransform=this._unflattenMatrix(s.prediction.worldMatrix));let e=t.currentModelViewTransform?this._glModelViewMatrix(t.currentModelViewTransform,0):null;this.onUpdate?.({type:"updateMatrix",targetIndex:0,worldMatrix:e?this.featureManager.applyWorldMatrixFilters(0,e,{stability:.9}):null,skipped:!0,bioMetrics:this.bioEngine?.getMetrics()}),this.onUpdate?.({type:"processDone"})}async _processWithAttention(t,s,e){if(this.trackingStates.reduce((i,r)=>i+(r.isTracking?1:0),0)<this.maxTrack){let i=this.trackingStates.map((r,a)=>({state:r,index:a})).filter(({state:r,index:a})=>!r.isTracking&&(this.interestedTargetIndex===-1||this.interestedTargetIndex===a)).map(({index:r})=>r);if(i.length>0){let{targetIndex:r,modelViewTransform:a,featurePoints:c}=await this._detectAndMatch(s,i,e.octavesToProcess||null);r!==-1&&(this.trackingStates[r].isTracking=!0,this.trackingStates[r].currentModelViewTransform=a,e.attentionRegions?.[0]&&this.bioEngine?.reset()),this.onUpdate?.({type:"featurePoints",featurePoints:c})}}for(let i=0;i<this.trackingStates.length;i++){let r=this.trackingStates[i];if(r.isTracking){let c=await this._trackAndUpdate(s,r.currentModelViewTransform,i);!c||!c.modelViewTransform?(r.isTracking=!1,r.screenCoords=c?.screenCoords||[],r.reliabilities=c?.reliabilities||[],r.stabilities=c?.stabilities||[]):(r.currentModelViewTransform=c.modelViewTransform,r.screenCoords=c.screenCoords,r.reliabilities=c.reliabilities,r.stabilities=c.stabilities,r.deformedMesh=c.deformedMesh)}let a=r.showing;if(r.showing=this.featureManager.shouldShow(i,r.isTracking),a&&!r.showing&&(r.trackingMatrix=null,this.featureManager.notifyUpdate({type:"reset",targetIndex:i})),r.showing||r.screenCoords?.length>0||a&&!r.showing){let c=r.showing?this._glModelViewMatrix(r.currentModelViewTransform,i):null,l=null;if(c){let u=r.stabilities||[],h=u.length>0?u.reduce((m,d)=>m+d,0)/u.length:0;if(l=this.featureManager.applyWorldMatrixFilters(i,c,{stability:h}),r.trackingMatrix=l,t.width===this.inputHeight&&t.height===this.inputWidth){let m=this.featureManager.getFeature("auto-rotation");m&&(l=m.rotate(l))}}this.onUpdate?.({type:"updateMatrix",targetIndex:i,worldMatrix:l,modelViewTransform:r.currentModelViewTransform,screenCoords:r.screenCoords,reliabilities:r.reliabilities,stabilities:r.stabilities,deformedMesh:r.deformedMesh,bioMetrics:this.bioEngine?.getMetrics(),foveaCenter:e.foveaCenter,pixelsSaved:e.pixelsSaved})}}this.onUpdate?.({type:"processDone"})}async _detectAndMatch(t,s,e=null){let n;for(let u of this.trackingStates)if(u.isTracking&&u.currentModelViewTransform){let h=u.currentModelViewTransform;n=Math.sqrt(h[0][0]**2+h[1][0]**2+h[2][0]**2);break}let{targetIndex:i,modelViewTransform:r,screenCoords:a,worldCoords:c,featurePoints:l}=await this._workerMatch(null,s,t,n,e);return{targetIndex:i,modelViewTransform:r,screenCoords:a,worldCoords:c,featurePoints:l}}_workerMatch(t,s,e=null,n,i=null){return new Promise(r=>{if(!this.worker){let c;!t&&e?c=Promise.resolve(this.fullDetector.detect(e,{octavesToProcess:i}).featurePoints):c=Promise.resolve(t),c.then(l=>{this._matchOnMainThread(l,s,n).then(r)}).catch(()=>r({targetIndex:-1}));return}let a=setTimeout(()=>{this.workerMatchDone=null,r({targetIndex:-1})},1e3);this.workerMatchDone=c=>{clearTimeout(a),this.workerMatchDone=null,r(c)},e?this.worker.postMessage({type:"match",inputData:e,targetIndexes:s,octavesToProcess:i,expectedScale:n}):this.worker.postMessage({type:"match",featurePoints:t,targetIndexes:s,expectedScale:n})})}async _trackAndUpdate(t,s,e){let n=await super._trackAndUpdate(t,s,e);return n&&n.octaveIndex!==void 0&&(this.trackingStates[e].lastOctaveIndex=n.octaveIndex),n}_flattenMatrix(t){let s=new Float32Array(16);for(let e=0;e<3;e++)for(let n=0;n<4;n++)s[e*4+n]=t[e][n];return s[12]=0,s[13]=0,s[14]=0,s[15]=1,s}_unflattenMatrix(t){return[[t[0],t[1],t[2],t[3]],[t[4],t[5],t[6],t[7]],[t[8],t[9],t[10],t[11]]]}getBioMetrics(){return this.bioEngine?.getMetrics()||null}getLastBioResult(){return this.lastBioResult}setBioEnabled(t){this.bioEnabled=t,t&&!this.bioEngine&&(this.bioEngine=new Gt(this.inputWidth,this.inputHeight))}configureBio(t){this.bioEngine?.configure(t)}dispose(){super.dispose(),this.bioEngine=null,this.bioMetricsInterval&&clearInterval(this.bioMetricsInterval)}};var ga=({image:o})=>{let{data:t,width:s,height:e}=o,n=s>>>1,i=e>>>1,r=new Uint8Array(n*i);for(let a=0;a<i;a++){let c=a*2*s,l=c+s,u=a*n;for(let h=0;h<n;h++){let f=h*2,m=t[c+f]+t[c+f+1]+t[l+f]+t[l+f+1]>>2;r[u+h]=m&255}}return{data:r,width:n,height:i}},on=({image:o,ratio:t})=>{if(t===1)return{data:new Uint8Array(o.data),width:o.width,height:o.height};if(t<=.5)return on({image:ga({image:o}),ratio:t*2});let s=Math.round(o.width*t)|0,e=Math.round(o.height*t)|0,n=new Uint8Array(s*e),i=o.data,r=o.width|0,a=o.height|0,c=r-1|0,l=a-1|0,u=0;for(let h=0;h<e;h++){let f=h/t,m=f|0,d=(m<l?m+1:l)|0,p=f-m,w=1-p,g=m*r|0,x=d*r|0;for(let M=0;M<s;M++){let E=M/t,I=E|0,S=(I<c?I+1:c)|0,k=E-I,T=1-k,C=i[g+I]*T+i[g+S]*k,y=i[x+I]*T+i[x+S]*k,b=C*w+y*p;n[u++]=b|0}}return{data:n,width:s,height:e}};Pt();var dh=X.MIN_IMAGE_PIXEL_SIZE;var ji=o=>{let t=Math.min(o.width,o.height),s=[],e=[];s.push(X.TRACKING_DOWNSCALE_LEVEL_1/t),s.push(X.TRACKING_DOWNSCALE_LEVEL_2/t);for(let n=0;n<s.length;n++)e.push(Object.assign(on({image:o,ratio:s[n]}),{scale:s[n]}));return e};var ye=class{constructor(t,s,e){this.width=s,this.height=e,this.cumsum=new Int32Array(s*e),this.cumsum[0]=t[0];for(let n=1;n<s;n++)this.cumsum[n]=this.cumsum[n-1]+t[n];for(let n=1;n<e;n++)this.cumsum[n*s]=this.cumsum[(n-1)*s]+t[n*s];for(let n=1;n<e;n++)for(let i=1;i<s;i++){let r=n*s+i;this.cumsum[r]=t[r]+this.cumsum[(n-1)*s+i]+this.cumsum[n*s+i-1]-this.cumsum[(n-1)*s+i-1]}}query(t,s,e,n){let{width:i}=this,r=this.cumsum[n*i+e];return s>0&&(r-=this.cumsum[(s-1)*i+e]),t>0&&(r-=this.cumsum[n*i+t-1]),t>0&&s>0&&(r+=this.cumsum[(s-1)*i+t-1]),r}};xs();var Rt=10,At=2,G=6,pa=4;var rn=.9,wa=.2;var zi=8,ya=!0;var Vi=o=>{let{data:t,width:s,height:e}=o,n,i;if(ya){let k=Ae.edgeDetection(t,s,e);n=k.dValue,i=k.isCandidate}else{n=new Float32Array(t.length),i=new Uint8Array(t.length);for(let k=1;k<e-1;k++){let T=k*s,C=(k-1)*s,y=(k+1)*s;for(let b=1;b<s-1;b++){let _=T+b,v=(t[C+b+1]-t[C+b-1]+t[T+b+1]-t[T+b-1]+t[y+b+1]-t[y+b-1])/768,D=(t[y+b-1]-t[C+b-1]+t[y+b]-t[C+b]+t[y+b+1]-t[C+b+1])/768;n[_]=Math.sqrt((v*v+D*D)/2)}}for(let k=1;k<e-1;k++){let T=k*s;for(let C=1;C<s-1;C++){let y=T+C,b=n[y];b>0&&b>=n[y-1]&&b>=n[y+1]&&b>=n[y-s]&&b>=n[y+s]&&(i[y]=1)}}}let r=new Uint32Array(1e3),a=0;for(let k=1;k<e-1;k++){let T=k*s;for(let C=1;C<s-1;C++){let y=T+C;if(i[y]){let b=n[y],_=Math.floor(b*1e3);_>999&&(_=999),r[_]++,a++}}}let c=.1*s*e,l=999,u=0;for(;l>=0&&(u+=r[l],!(u>c));)l--;let h=l/1e3,f=new Float32Array(t.length);for(let k=0;k<t.length;k++)f[k]=t[k]*t[k];let m=new ye(t,s,e),d=new ye(f,s,e),p=[];for(let k=0;k<t.length;k++)i[k]&&n[k]>=h&&p.push({pos:k,dval:n[k],x:k%s,y:Math.floor(k/s)});p.sort((k,T)=>T.dval-k.dval);let w=(G*2+1)*3,g=Math.floor(s/zi)*Math.floor(e/zi)+Math.floor(s/w)*Math.floor(e/w),x=[],M=new Uint8Array(s*e),E=2*G+1,I=E*E,S=Math.floor(Math.min(s,e)/12);for(let k=0;k<p.length;k++){let{x:T,y:C,pos:y}=p[k];if(M[y]||T<G+Rt||T>=s-G-Rt||C<G+Rt||C>=e-G-Rt)continue;let b=xa({image:o,cx:T,cy:C,sdThresh:pa,imageDataCumsum:m,imageDataSqrCumsum:d});if(b===null)continue;let _=m.query(T-G,C-G,T+G,C+G)/I,v=new Uint8Array(E*E),D=0,A=(C-G)*s+(T-G);for(let O=0;O<E;O++){let B=A+O*s;for(let V=0;V<E;V++)v[D++]=t[B+V]}let F=-1;for(let O=-Rt;O<=Rt;O++){for(let B=-Rt;B<=Rt;B++){if(B*B+O*O<=At*At)continue;let V=qi({image:o,cx:T+B,cy:C+O,vlen:b,templateData:v,templateAvg:_,templateWidth:E,imageDataCumsum:m,imageDataSqrCumsum:d,width:s,height:e});if(V!==null&&V>F&&(F=V,F>rn))break}if(F>rn)break}if(F<rn){let O=1,B=-1,V=!1;for(let P=-At;P<=At;P++){for(let U=-At;U<=At;U++){if(U*U+P*P>At*At||U===0&&P===0)continue;let N=qi({image:o,vlen:b,cx:T+U,cy:C+P,templateData:v,templateAvg:_,templateWidth:E,imageDataCumsum:m,imageDataSqrCumsum:d,width:s,height:e});if(N!==null&&(N<O&&(O=N),N>B&&(B=N),O<wa||B>.99)){V=!0;break}}if(V)break}if(!V){x.push({x:T,y:C});for(let P=-S;P<=S;P++){let U=C+P;if(U<0||U>=e)continue;let N=U*s;for(let L=-S;L<=S;L++){let j=T+L;j<0||j>=s||(M[N+j]=1)}}}}if(x.length>=g)break}return x},xa=({image:o,cx:t,cy:s,sdThresh:e,imageDataCumsum:n,imageDataSqrCumsum:i})=>{if(t-G<0||t+G>=o.width||s-G<0||s+G>=o.height)return null;let r=2*G+1,a=r*r,c=n.query(t-G,s-G,t+G,s+G);c/=a;let l=i.query(t-G,s-G,t+G,s+G);return l-=2*c*n.query(t-G,s-G,t+G,s+G),l+=a*c*c,l/a<e*e?null:(l=Math.sqrt(l),l)},qi=o=>{let{cx:t,cy:s,vlen:e,templateData:n,templateAvg:i,templateWidth:r,imageDataCumsum:a,imageDataSqrCumsum:c,width:l,height:u}=o,h=o.image.data,f=(r-1)/2;if(t-f<0||t+f>=l||s-f<0||s+f>=u)return null;let m=r*r,d=a.query(t-f,s-f,t+f,s+f),w=c.query(t-f,s-f,t+f,s+f)-d*d/m;if(w<=0)return null;w=Math.sqrt(w);let g=0,x=(s-f)*l+(t-f);for(let S=0;S<r;S++){let k=x+S*l,T=S*r;for(let C=0;C<r;C++)g+=h[k+C]*n[T+C]}let M=r*r,E=r*r;return g*=E/M,1*(g-i*d)/(e*w)};var Wi=(o,t)=>{let s=[];for(let e=0;e<o.length;e++){let n=o[e],i=Vi(n),r={data:n.data,scale:n.scale,width:n.width,height:n.height,points:i};s.push(r),t(e)}return s};Ve();Gs();qe();function Hi(o){if(o.length<3)return[];let t=1/0,s=1/0,e=-1/0,n=-1/0;for(let d of o)d.x<t&&(t=d.x),d.x>e&&(e=d.x),d.y<s&&(s=d.y),d.y>n&&(n=d.y);let i=e-t,r=n-s,a=Math.max(i,r),c=(t+e)/2,l=(s+n)/2,u={x:c-20*a,y:l-a},h={x:c,y:l+20*a},f={x:c+20*a,y:l-a},m=[{p1:u,p2:h,p3:f,indices:[-1,-2,-3]}];for(let d=0;d<o.length;d++){let p=o[d],w=[];for(let x of m)Ma(p,x)&&w.push(x);let g=[];for(let x of w){let M=[{a:x.p1,b:x.p2,i1:x.indices[0],i2:x.indices[1]},{a:x.p2,b:x.p3,i1:x.indices[1],i2:x.indices[2]},{a:x.p3,b:x.p1,i1:x.indices[2],i2:x.indices[0]}];for(let E of M){let I=!1;for(let S of w)if(x!==S&&ba(E,S)){I=!0;break}I||g.push(E)}}m=m.filter(x=>!w.includes(x));for(let x of g)m.push({p1:x.a,p2:x.b,p3:p,indices:[x.i1,x.i2,d]})}return m.filter(d=>d.indices[0]>=0&&d.indices[1]>=0&&d.indices[2]>=0).map(d=>d.indices)}function Ma(o,t){let s=t.p1.x,e=t.p1.y,n=t.p2.x,i=t.p2.y,r=t.p3.x,a=t.p3.y,c=2*(s*(i-a)+n*(a-e)+r*(e-i)),l=((s*s+e*e)*(i-a)+(n*n+i*i)*(a-e)+(r*r+a*a)*(e-i))/c,u=((s*s+e*e)*(r-n)+(n*n+i*i)*(s-r)+(r*r+a*a)*(n-s))/c,h=(s-l)*(s-l)+(e-u)*(e-u);return(o.x-l)*(o.x-l)+(o.y-u)*(o.y-u)<=h}function ba(o,t){let s=[[t.indices[0],t.indices[1]],[t.indices[1],t.indices[2]],[t.indices[2],t.indices[0]]];for(let e of s)if(o.i1===e[0]&&o.i2===e[1]||o.i1===e[1]&&o.i2===e[0])return!0;return!1}function $i(o){let t=new Set,s=[];for(let e of o){let n=[[e[0],e[1]],[e[1],e[2]],[e[2],e[0]]];for(let i of n){let r=Math.min(i[0],i[1]),a=Math.max(i[0],i[1]),c=`${r}-${a}`;t.has(c)||(t.add(c),s.push([r,a]))}}return s}Pt();var Ch=typeof process<"u"&&process.versions!=null&&process.versions.node!=null,ls=class{data=null;constructor(){console.log("\u26A1 OfflineCompiler: Main thread mode (no workers)")}async compileImageTargets(t,s){console.time("\u23F1\uFE0F Compilaci\xF3n total");let e=[];for(let i=0;i<t.length;i++){let r=t[i];if(!r||!r.width||!r.height||!r.data)throw new Error(`Imagen inv\xE1lida en posici\xF3n ${i}. Debe tener propiedades width, height y data.`);let a=new Uint8Array(r.width*r.height);if(r.data.length===r.width*r.height)a.set(r.data);else if(r.data.length===r.width*r.height*4)for(let c=0;c<a.length;c++){let l=c*4;a[c]=Math.floor((r.data[l]+r.data[l+1]+r.data[l+2])/3)}else throw new Error(`Formato de datos de imagen no soportado en posici\xF3n ${i}`);e.push({data:a,width:r.width,height:r.height})}let n=await this._compileTarget(e,s);return this.data=e.map((i,r)=>({targetImage:i,matchingData:n[r].matchingData,trackingData:n[r].trackingData})),console.timeEnd("\u23F1\uFE0F Compilaci\xF3n total"),this.data}async _compileTarget(t,s){let e=await this._compileMatch(t,i=>s(i*.5)),n=await this._compileTrack(t,i=>s(50+i*.5));return t.map((i,r)=>({matchingData:e[r],trackingData:n[r]}))}async _compileMatch(t,s){let e=100/t.length,n=0,i=[];for(let r=0;r<t.length;r++){let a=t[r],c=new Tt(a.width,a.height,{useLSH:X.USE_LSH,maxFeaturesPerBucket:X.MAX_FEATURES_PER_BUCKET}),{featurePoints:l}=c.detect(a.data),u=[0,1,2,3,4,5],h=[],f=300;for(let x of u){let M=Math.pow(2,x),E=l.filter(I=>Math.abs(I.scale-M)<.1).sort((I,S)=>(S.score||0)-(I.score||0)).slice(0,f);h.push(...E)}let m=h.filter(x=>x.maxima),d=h.filter(x=>!x.maxima),p=Ys({points:m}),w=Ys({points:d}),g={maximaPoints:m,minimaPoints:d,maximaPointsCluster:p,minimaPointsCluster:w,width:a.width,height:a.height,scale:1};i.push([g]),n+=e,s(n)}return i}async _compileTrack(t,s){let e=100/t.length,n=0,i=[];for(let r=0;r<t.length;r++){let a=t[r],c=ji(a),l=e/c.length,u=Wi(c,()=>{n+=l,s(n)});i.push(u)}return i}async compileTrack({progressCallback:t,targetImages:s,basePercent:e=0}){return this._compileTrack(s,n=>{t(e+n*(100-e)/100)})}async compileMatch({progressCallback:t,targetImages:s,basePercent:e=0}){return this._compileMatch(s,n=>{t(e+n*(50-e)/100)})}exportData(){if(!this.data)throw new Error("No hay datos compilados para exportar");let t=this.data.map(s=>({targetImage:{width:s.targetImage.width,height:s.targetImage.height},trackingData:s.trackingData.map(e=>{let n=e.points.length,i=new Float32Array(n),r=new Float32Array(n);for(let u=0;u<n;u++)i[u]=e.points[u].x,r[u]=e.points[u].y;let a=Hi(e.points),c=$i(a),l=new Float32Array(c.length);for(let u=0;u<c.length;u++){let h=e.points[c[u][0]],f=e.points[c[u][1]];l[u]=Math.sqrt((h.x-f.x)**2+(h.y-f.y)**2)}return{w:e.width,h:e.height,s:e.scale,px:i,py:r,d:e.data,mesh:{t:new Uint16Array(a.flat()),e:new Uint16Array(c.flat()),rl:l}}}),matchingData:s.matchingData.map(e=>{let i=X.USE_COMPACT_DESCRIPTORS?Bn:Nn;return{w:e.width,h:e.height,s:e.scale,hdc:!1,max:i(e.maximaPoints,e.maximaPointsCluster,e.width,e.height),min:i(e.minimaPoints,e.minimaPointsCluster,e.width,e.height)}})}));return jn(t)}importData(t){let s=ze(t);return this.data=s.dataList,s}async destroy(){}};function xe(o,t,s,e,n,i,r,a,c=!1){let l=e[0][0]*o+e[0][1]*t+e[0][2]*s+e[0][3],u=e[1][0]*o+e[1][1]*t+e[1][2]*s+e[1][3],h=e[2][0]*o+e[2][1]*t+e[2][2]*s+e[2][3],f=n[0][0]*l/h+n[0][2],m=n[1][1]*u/h+n[1][2],d=c?r:i,p=c?i:r,w=Math.max(a.width/d,a.height/p),g=d*w,x=p*w,M=(a.width-g)/2,E=(a.height-x)/2,I,S;return c?(I=M+g/2-(m-n[1][2])*w,S=E+x/2+(f-n[0][2])*w):(I=M+g/2+(f-n[0][2])*w,S=E+x/2+(m-n[1][2])*w),{sx:I,sy:S}}Pt();var Xi="./assets/test-image.png",rt=X.VIEWPORT_WIDTH,at=X.VIEWPORT_HEIGHT,Ki=document.getElementById("simCanvas"),vt=document.getElementById("arCanvas"),Sa=document.getElementById("logs"),Ut=document.getElementById("overlay"),Me=document.getElementById("arStatus"),hs=document.getElementById("arReliability"),Yi=document.getElementById("arStability"),Ji=document.getElementById("simScale"),Ea=document.getElementById("simPos"),cn=document.getElementById("ar-container"),It=Ki.getContext("2d"),ka=vt.getContext("2d"),xt=document.createElement("canvas");xt.width=rt;xt.height=at;xt.style.position="absolute";xt.style.top="0";xt.style.left="0";xt.style.width="100%";xt.style.height="100%";xt.style.pointerEvents="none";xt.style.zIndex="3";cn.appendChild(xt);var Bt=xt.getContext("2d"),Mt=document.createElement("canvas");Mt.width=rt;Mt.height=at;Mt.style.position="absolute";Mt.style.top="0";Mt.style.left="0";Mt.style.width="100%";Mt.style.height="100%";Mt.style.pointerEvents="none";Mt.style.zIndex="2";cn.appendChild(Mt);var Nt=Mt.getContext("2d"),an=class{history=new Map;lastFiltered=new Map;medianSize=3;deadZone=.3;smooth(t,s,e){this.history.has(t)||this.history.set(t,[]);let n=this.history.get(t);n.push(s),n.length>this.medianSize&&n.shift();let i=[...n].map(d=>d.x).sort((d,p)=>d-p),r=[...n].map(d=>d.y).sort((d,p)=>d-p),a={x:i[Math.floor(i.length/2)],y:r[Math.floor(r.length/2)]},c=.1,l=c+e*(1-c),u=this.lastFiltered.get(t)||a,h=u.x*(1-l)+a.x*l,f=u.y*(1-l)+a.y*l;Math.abs(h-u.x)<this.deadZone&&(h=u.x),Math.abs(f-u.y)<this.deadZone&&(f=u.y);let m={x:h,y:f};return this.lastFiltered.set(t,m),m}reset(t){t!==void 0?(this.history.delete(t),this.lastFiltered.delete(t)):(this.history.clear(),this.lastFiltered.clear())}prune(t){for(let s of this.history.keys())!t.has(s)&&Math.random()<.05&&(this.history.delete(s),this.lastFiltered.delete(s))}},Gi=new an,us=[];function yt(o,t="info"){console.log(`[AR-TEST] ${o}`),us.push(`[${new Date().toLocaleTimeString()}] ${o}`),us.length>50&&us.shift(),(t==="error"||t==="success"||Math.random()<.1)&&(Sa.innerHTML=us.slice().reverse().map(s=>`<div>${s}</div>`).join(""))}async function Ia(o){return new Promise((t,s)=>{let e=new Image;e.onload=()=>t(e),e.onerror=s,e.src=o})}async function va(){yt("Loading target image...");let o;try{o=await Ia(Xi),yt("Target image loaded successfully","success")}catch{yt("Failed to load target image from "+Xi,"error");return}yt("Compiling target image (OfflineCompiler)...");let t=new ls,s=document.createElement("canvas");s.width=o.width,s.height=o.height;let e=s.getContext("2d");e.drawImage(o,0,0);let n=e.getImageData(0,0,o.width,o.height),i=performance.now(),r=await t.compileImageTargets([{width:o.width,height:o.height,data:n.data}],x=>{Math.floor(x)%25===0&&yt(`Compilation progress: ${Math.round(x)}%`)}),a=performance.now()-i;yt(`Compilation finished in ${Math.round(a)}ms`,"success"),vt.style.position="absolute",vt.style.top="0",vt.style.left="0",vt.style.width="100%",vt.style.height="100%",vt.style.objectFit="cover",vt.style.zIndex="1";let c=t.exportData();yt(`Exported data size: ${Math.round(c.byteLength/1024)}KB`);let l=new cs({inputWidth:rt,inputHeight:at,debugMode:!0,bioInspired:{enabled:!0,aggressiveSkipping:!1},onUpdate:x=>Ta(x,o.width,o.height,l)}),u=c.buffer.slice(c.byteOffset,c.byteOffset+c.byteLength);await l.addImageTargetsFromBuffer(u),yt("Controller initialized with compiled targets","success");let h=0,f=.5,m=rt/2,d=at/2,p=o.width,w=o.height;function g(){h+=.015,f=.4+Math.sin(h*.3)*.2,m=rt/2+Math.cos(h*.5)*110,d=at/2+Math.sin(h*.4)*70;let x=Math.max(0,Math.sin(h*.1)*3);It.fillStyle="#222",It.fillRect(0,0,rt,at),It.save(),x>.3&&(It.filter=`blur(${x}px)`),It.translate(m,d),It.scale(f,f),It.drawImage(o,-o.width/2,-o.height/2),It.restore(),It.filter="none",Ji.textContent=f.toFixed(2),Ea.textContent=`${Math.round(m)}, ${Math.round(d)}`,ka.drawImage(Ki,0,0),requestAnimationFrame(g)}l.processVideo(vt),g()}function Ta(o,t,s,e){if(o.type!=="processDone"){if((o.type==="featurePoints"||o.type==="updateMatrix")&&Bt.clearRect(0,0,rt,at),o.type==="featurePoints"){let{featurePoints:n}=o;n&&(_a(n),Math.random()<.05&&yt(`FEAT: Detected ${n.length} points`))}if(o.type==="updateMatrix"){let{targetIndex:n,worldMatrix:i,modelViewTransform:r,reliabilities:a,stabilities:c,screenCoords:l,deformedMesh:u}=o,h=new Set((l||[]).map(m=>m.id));Gi.prune(h);let f=l||[];if(l&&l.length>0&&(f=l.map(m=>{let d=a&&a[m.id]||.5;return{...Gi.smooth(m.id,m,d),id:m.id}})),i){Me.textContent="Tracking",Me.className="status-tag status-tracking",Ut.style.display="block";let m=a&&a.length>0?a.reduce((g,x)=>g+x,0)/a.length:0,d=c&&c.length>0?c.reduce((g,x)=>g+x,0)/c.length:0;hs.textContent=m.toFixed(2),Yi.textContent=d.toFixed(2),m<.5?hs.style.color="#f44":hs.style.color="#10b981";let p=e.projectionTransform[0][0],w=r[2][3];if(Math.random()<.01){let g=p/w,x=parseFloat(Ji.textContent||"0"),M=o.pixelsSaved!==void 0?(o.pixelsSaved/(rt*at)*100).toFixed(1):"0.0";yt(`TRACK: Scale:${g.toFixed(3)} (ideal:${x.toFixed(3)}) | Savings: ${M}% pixels`)}o.foveaCenter&&Ra(o.foveaCenter),Aa(r,t,s,e)}else Me.textContent="Searching",Me.className="status-tag status-searching",Ut.style.display="none",hs.textContent="0.00",Yi.textContent="0.00",Bt.clearRect(0,0,rt,at),Math.random()<.02&&yt(`SEARCH: No target matched. Points detected: ${l?.length||0}`);f.length>0?Ca(f,c||[]):Bt.clearRect(0,0,rt,at)}}}function _a(o){if(Me.textContent==="Searching"){Bt.fillStyle="rgba(255, 255, 0, 0.6)";let t=Math.min(o.length,150);for(let s=0;s<t;s++){let e=o[s];Bt.fillRect(e.x-1,e.y-1,2,2)}}}function Ca(o,t){let s=Math.min(o.length,100);for(let e=0;e<s;e++){let n=o[e],i=t[e]||0,r=i>.8?3:2;Bt.fillStyle=`rgba(0, 255, 0, ${.2+i*.8})`,Bt.fillRect(n.x-r/2,n.y-r/2,r,r)}}function Ra(o){Nt.clearRect(0,0,rt,at),Nt.beginPath(),Nt.arc(o.x,o.y,40,0,Math.PI*2),Nt.strokeStyle="rgba(255, 255, 255, 0.3)",Nt.setLineDash([5,5]),Nt.stroke(),Nt.setLineDash([])}function Aa(o,t,s,e){let n=e.projectionTransform,i=cn.getBoundingClientRect(),r=xe(0,0,0,o,n,rt,at,i,!1),a=xe(t,0,0,o,n,rt,at,i,!1),c=xe(0,s,0,o,n,rt,at,i,!1),l=xe(t,s,0,o,n,rt,at,i,!1),h=((f,m,d,p,w,g)=>{let x=d.sx,M=d.sy,E=p.sx,I=p.sy,S=w.sx,k=w.sy,T=g.sx,C=g.sy,y=E-T,b=S-T,_=x-E+T-S,v=I-C,D=k-C,A=M-I+C-k,F,O,B,V,P,U,N,L,j=y*D-b*v;return N=(_*D-b*A)/j,L=(y*A-_*v)/j,F=E-x+N*E,O=S-x+L*S,B=x,V=I-M+N*I,P=k-M+L*k,U=M,[F/f,V/f,0,N/f,O/m,P/m,0,L/m,0,0,1,0,B,U,0,1]})(t,s,r,a,c,l);Math.random()<.01&&console.log("OVERLAY_DEBUG:",{corners:{pUL:r,pUR:a,pLL:c,pLR:l},matrix:h.map(f=>f.toFixed(2)).join(","),containerSize:{w:i.width,h:i.height}}),Ut.style.width=`${t}px`,Ut.style.height=`${s}px`,Ut.style.transformOrigin="0 0",Ut.style.transform=`matrix3d(${h.join(",")})`,Ut.style.border="2px solid #00ffff",Ut.style.display="block"}va();
